<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LFJC Online Exam System - SECURE MODE</title>
    <style>
        /* ===== BASE STYLES ===== */
        :root {
            --primary-color: #4B0082;
            --secondary-color: #D8BFD8;
            --light-purple: #E6E6FA;
            --white: #fff;
            --black: #000;
            --success: #32CD32;
            --warning: #ff9900;
            --danger: #ff6666;
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "SF Pro Display", Arial, sans-serif;
            margin: 0;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Disable right-click context menu */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Enhanced Screenshot protection */
        #screenshotProtection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 2147483647;
            pointer-events: none;
        }

        .screenshot-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 200px 200px;
            animation: flicker 0.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.9; }
        }

        /* Additional screenshot protection */
        #screenshotBlock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 2147483646;
            pointer-events: none;
        }

        /* ===== HEADER & FOOTER ===== */
        header {
            background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
            color: var(--primary-color);
            text-align: center;
            padding: 20px;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 1.5px;
            box-shadow: var(--shadow);
            text-shadow: 0 1px 2px var(--white);
        }

        footer {
            background: var(--light-purple);
            color: var(--primary-color);
            padding: 10px;
            text-align: center;
            font-weight: bold;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        /* ===== STUDENT ENTRY SECTION ===== */
        #studentEntry {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 140px);
            padding: 16px;
            text-align: center;
        }

        .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin-bottom: 60px;
            width: 100%;
            max-width: 500px;
        }

        .form-group label {
            font-size: 1.15rem;
            font-weight: 600;
            margin-right: 10px;
            color: var(--primary-color);
            width: 180px;
            text-align: right;
        }

        input[type="text"] {
            padding: 12px 14px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 1.5px solid var(--primary-color);
            outline: none;
            min-width: 250px;
            transition: var(--transition);
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
        }

        input.error {
            animation: glowRed 0.5s alternate infinite;
            border-color: var(--danger);
        }

        @keyframes glowRed {
            0% { box-shadow: 0 0 5px var(--danger); }
            100% { box-shadow: 0 0 15px var(--danger); }
        }

        /* ===== BUTTON STYLES ===== */
        button {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            transition: var(--transition);
            box-shadow: 0 6px #aaa;
            background: linear-gradient(to bottom, #fafaff, #dcd6f7);
            color: var(--primary-color);
            font-weight: 600;
            padding: 12px 24px;
            font-size: 18px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,.28);
        }

        button:active {
            transform: translateY(3px) scale(.98);
        }

        button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .optBtn {
            font-size: 16px;
            padding: 8px 18px;
            margin: 6px;
            border: 2px solid var(--primary-color);
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 5px #aaa;
        }

        .optBtn.selected {
            background: var(--success);
            color: var(--white);
            border-color: #2fa92f;
        }

        .optBtn.correct {
            background: #32CD32;
            color: white;
            border-color: #228B22;
        }

        .optBtn.wrong {
            background: #FF6B6B;
            color: white;
            border-color: #DC143C;
        }

        .optBtn.not-attempted {
            background: #B0B0B0;
            color: white;
            border-color: #808080;
        }

        .navBtn {
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 8px;
            color: var(--white);
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(145deg, #1E90FF, #4682B4);
            margin: 0 15px;
        }

        #markReviewBtn {
            background: linear-gradient(145deg, #ffb84d, var(--warning));
        }

        #submitBtn {
            background: linear-gradient(145deg, #c8b88a, #b49e60);
        }

        /* ===== TIMER STYLES ===== */
        #timerEl {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 6px;
            background: #f0f0ff;
            display: inline-block;
            transition: var(--transition);
        }

        #timerEl.blink {
            animation: blinkTimer 1s infinite;
        }

        @keyframes blinkTimer {
            0% { background: var(--danger); color: var(--white); }
            50% { background: var(--white); color: var(--primary-color); }
            100% { background: var(--danger); color: var(--white); }
        }

        /* ===== ENHANCED PALETTE STYLES ===== */
        #paletteContainer {
            display: grid;
            gap: 8px;
            margin: 20px auto;
            max-width: 100%;
            padding: 0 10px;
            justify-content: center;
        }

        #paletteContainer button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 14px;
            margin: 2px;
            border: 1px solid var(--primary-color);
            background: var(--light-purple);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        #paletteContainer button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        #paletteContainer button.selected {
            background: var(--success);
            color: var(--white);
            border-color: #2fa92f;
        }

        #paletteContainer button.reviewed {
            background: yellow;
            color: var(--black);
        }

        #paletteContainer button.current {
            border: 3px solid red;
            transform: scale(1.15);
        }

        #paletteContainer button.correct-answer {
            background: #32CD32;
            color: white;
        }

        #paletteContainer button.wrong-answer {
            background: #FF6B6B;
            color: white;
        }

        #paletteContainer button.not-attempted-answer {
            background: #B0B0B0;
            color: white;
        }

        #paletteContainer button.answered {
            background: var(--success);
            color: white;
        }

        #paletteContainer button.not-answered {
            background: var(--light-purple);
            color: var(--primary-color);
        }

        #paletteContainer button.marked-review {
            background: yellow;
            color: var(--black);
        }

        /* ===== EXAM AREA STYLES ===== */
        #examArea {
            padding: 16px;
            text-align: center;
            display: none;
        }

        #examHeader {
            display: flex;
            align-items: center;
            width: 100%;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #stuInfo {
            flex: 0 0 auto;
            text-align: left;
            white-space: nowrap;
        }

        #stuQInfo {
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }

        .sectionTitle {
            font-size: 22px;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 8px;
        }

        img.questionImg {
            max-width: 95vw;
            width: auto;
            height: auto;
            border-radius: 10px;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: opacity 0.3s ease;
        }

        /* ===== ANIMATIONS ===== */
        .glow {
            animation: glowPulse 1.6s infinite alternate;
            box-shadow: 0 8px 18px rgba(75,0,130,0.12);
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
            50% { box-shadow: 0 12px 30px rgba(75,0,130,0.14); transform: translateY(-2px); }
            100% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
        }

        /* ===== SECURITY OVERLAY STYLES ===== */
        #fullRedOverlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: red;
            z-index: 9999;
            pointer-events: auto;
        }

        #accessDeniedBox {
            position: fixed;
            left: 50%;
            top: 40%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            color: var(--white);
            text-align: center;
            display: none;
            pointer-events: auto;
        }

        #accessDeniedBox h1 {
            font-size: 48px;
            font-weight: 900;
            margin: 0 0 18px 0;
            color: var(--white);
            text-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        #callAdminBtn {
            padding: 12px 22px;
            border-radius: 12px;
            font-weight: 800;
        }

        /* ===== ENHANCED MODAL STYLES ===== */
        .confirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .confirmBox {
            background: var(--white);
            padding: 30px;
            border-radius: 15px;
            min-width: 320px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 2px solid var(--primary-color);
        }

        .confirmBox p {
            font-size: 20px;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 600;
        }

        .confirmBox button {
            margin: 0 12px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            min-width: 80px;
        }

        #adminPassModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        #adminPassBox {
            background: var(--white);
            padding: 25px;
            text-align: center;
            width: 300px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border: 2px solid var(--primary-color);
        }

        #adminPassBox h3 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 22px;
        }

        #adminPassBox input {
            width: 90%;
            padding: 12px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 16px;
            text-align: center;
        }

        #adminPassBox input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
        }

        /* ===== TIMER WARNING STYLES ===== */
        .blinkLine {
            animation: blinkLineAnim 1s infinite;
        }

        @keyframes blinkLineAnim {
            0% { background: #ffcccc; }
            50% { background: var(--white); }
            100% { background: #ffcccc; }
        }

        /* ===== FONT SIZE ADJUSTMENTS ===== */
        #stuInfo, #stuQInfo, #timerEl {
            font-size: 20px !important;
        }

        /* Increase table row height vertically */
        table td, table th {
            padding-top: 20px;
            padding-bottom: 20px;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 600px) {
            #accessDeniedBox h1 {
                font-size: 28px;
            }
            
            #callAdminBtn {
                padding: 10px 14px;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                text-align: left;
                width: auto;
                margin-bottom: 5px;
            }
            
            #examHeader {
                flex-direction: column;
                gap: 10px;
            }
            
            #stuInfo, #stuQInfo {
                text-align: center;
            }
            
            .navContainer {
                flex-direction: column;
                align-items: center;
            }
            
            .navBtn {
                width: 80%;
                margin-bottom: 10px;
                margin-left: 0;
                margin-right: 0;
            }
            
            #paletteContainer {
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 6px;
            }
            
            #paletteContainer button {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }

            .confirmBox {
                min-width: 280px;
                margin: 20px;
            }

            .confirmBox p {
                font-size: 18px;
            }
        }

        @media (min-width: 601px) and (max-width: 900px) {
            #paletteContainer {
                grid-template-columns: repeat(10, 1fr) !important;
            }
        }

        @media (min-width: 901px) and (max-width: 1200px) {
            #paletteContainer {
                grid-template-columns: repeat(15, 1fr) !important;
            }
        }

        @media (min-width: 1201px) {
            #paletteContainer {
                grid-template-columns: repeat(20, 1fr) !important;
            }
        }

        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            color: #ff3333;
            font-weight: 600;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            background: rgba(255, 102, 102, 0.1);
            border: 2px solid #ff6666;
            animation: blinkRed 1s infinite;
            text-align: center;
        }

        @keyframes blinkRed {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ===== RESULTS TABLE STYLES ===== */
        .results-table {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            border-collapse: collapse;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .results-table th {
            background: #E6E6FA;
            padding: 18px;
            border: 2px solid var(--primary-color);
            font-weight: bold;
            color: var(--primary-color);
        }

        .results-table td {
            padding: 18px;
            border: 1px solid var(--primary-color);
        }

        .results-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .results-table tr:hover {
            background: #f0f0ff;
            transform: scale(1.01);
            transition: transform 0.2s ease;
        }

        /* ===== REVIEW MODE STYLES ===== */
        .answer-status {
            margin: 10px 0;
            padding: 12px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }

        .answer-status.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .answer-status.wrong {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .answer-status.not-attempted {
            background: #e2e3e5;
            color: #383d41;
            border: 2px solid #d6d8db;
        }

        .correct-answer {
            color: #155724;
            font-weight: bold;
            font-size: 18px;
        }

        .wrong-answer {
            color: #721c24;
            font-weight: bold;
            font-size: 18px;
        }

        /* ===== AREA STYLES ===== */
        #summaryArea, #reviewArea {
            display: none;
            padding: 20px;
        }

        .area-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
            border-radius: 15px;
            box-shadow: var(--shadow);
        }

        .area-header h2 {
            color: #4B0082;
            margin-bottom: 15px;
            font-size: 28px;
        }

        /* ===== VERTICAL GAP STYLES ===== */
        .options-container {
            margin-bottom: 60px;
        }

        .navContainer {
            margin-top: 40px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        /* ===== SECURITY MESSAGE STYLES ===== */
        .security-message {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* ===== AUTO TRANSITION STYLES ===== */
        .auto-transition-message {
            background: #d4edda;
            border: 2px solid #c3e6cb;
            color: #155724;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
            font-size: 18px;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .waiting-message {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            color: #0c5460;
            padding: 25px;
            border-radius: 10px;
            margin: 30px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .waiting-timer {
            font-size: 28px;
            font-weight: bold;
            color: #4B0082;
            margin: 15px 0;
            font-family: 'SF Pro Display', monospace;
        }

        /* ===== LOADING STYLES ===== */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4B0082;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== WARNING BANNER STYLES ===== */
        .warning-banner {
            background: #ffcccc;
            color: #721c24;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border: 2px solid #f5c6cb;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 16px;
        }

        /* ===== IMAGE ERROR STYLES ===== */
        .image-error {
            background: #ffebee;
            border: 2px solid #ffcdd2;
            color: #c62828;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        .image-error h3 {
            margin: 0 0 15px 0;
            color: #c62828;
            font-size: 22px;
        }

        .loading-message {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            color: #1565c0;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* ===== SUCCESS MESSAGE STYLES ===== */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            border: 2px solid #c3e6cb;
            font-size: 18px;
        }

        .success-message h3 {
            margin: 0 0 15px 0;
            color: #155724;
            font-size: 24px;
        }

        /* ===== SMOOTH TRANSITION STYLES ===== */
        .question-transition {
            transition: all 0.3s ease-in-out;
        }

        .question-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== PRELOADING STYLES ===== */
        .preload-image {
            position: absolute;
            left: -9999px;
            top: -9999px;
            opacity: 0;
        }

        /* ===== DETAILED RESULTS TABLE STYLES ===== */
        .detailed-results-table {
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            border-collapse: collapse;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .detailed-results-table th {
            background: #4B0082;
            color: white;
            padding: 20px;
            border: 2px solid var(--primary-color);
            font-weight: bold;
            font-size: 20px;
        }

        .detailed-results-table td {
            padding: 20px;
            border: 1px solid var(--primary-color);
        }

        .detailed-results-table tr:nth-child(even) {
            background: #f8f6ff;
        }

        .detailed-results-table tr:hover {
            background: #f0f0ff;
            transform: scale(1.01);
            transition: transform 0.2s ease;
        }

        .detailed-results-table .total-row {
            background: #E6E6FA !important;
            font-weight: bold;
            font-size: 20px;
        }

        .detailed-results-table .highlight {
            background: #d4edda;
            font-weight: bold;
        }

        /* ===== FORM ASSIGNMENT STYLES ===== */
        .form-assignment {
            background: #e8f4fd;
            border: 3px solid #4B0082;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .form-assignment h3 {
            color: #4B0082;
            margin: 0 0 15px 0;
            font-size: 22px;
        }

        .assigned-form {
            font-size: 28px;
            font-weight: bold;
            color: #4B0082;
            background: white;
            padding: 15px 30px;
            border-radius: 10px;
            display: inline-block;
            margin: 15px 0;
            border: 3px solid #4B0082;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ===== SECURITY WARNING STYLES ===== */
        .security-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(145deg, #ff6b6b, #dc143c);
            color: white;
            text-align: center;
            padding: 18px;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            animation: pulseWarning 2s infinite;
            font-size: 16px;
        }

        @keyframes pulseWarning {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .network-status {
            position: fixed;
            bottom: 60px;
            right: 15px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 9999;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .network-online {
            background: var(--success);
            color: white;
        }

        .network-offline {
            background: var(--warning);
            color: white;
            animation: blinkOffline 1s infinite;
        }

        @keyframes blinkOffline {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }

        /* ===== TERMINATION SCREEN STYLES ===== */
        .termination-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(145deg, #ff6b6b, #dc143c);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            text-align: center;
        }

        .termination-content {
            background: rgba(0,0,0,0.9);
            padding: 50px;
            border-radius: 20px;
            max-width: 600px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            border: 3px solid #ff6b6b;
        }

        /* ===== DATA INTEGRITY STYLES ===== */
        .data-integrity-check {
            background: #e8f5e8;
            border: 3px solid #4CAF50;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }

        .duplicate-warning {
            background: #fff3cd;
            border: 3px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }

        /* ===== SUBJECT DISPLAY STYLES ===== */
        .subject-display {
            background: linear-gradient(145deg, #4B0082, #6A0DAD);
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: bold;
            margin: 15px 0;
            display: inline-block;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            font-size: 18px;
        }

        .current-subject {
            font-size: 20px;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f0f0ff;
            border-radius: 10px;
            border-left: 5px solid #4B0082;
            font-weight: bold;
            box-shadow: var(--shadow);
        }

        /* ===== SECURITY OVERLAY STYLES ===== */
        #securityOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2147483647;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        #securityWarning {
            background: #ff4444;
            color: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            border: 3px solid #ff6b6b;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #violationCounter {
            position: fixed;
            bottom: 60px;
            left: 15px;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        #autoSaveIndicator {
            position: fixed;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 128, 0, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 9999;
            display: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* ===== ENHANCED PROMPT STYLES ===== */
        .prompt-container {
            background: var(--white);
            border: 3px solid var(--primary-color);
            border-radius: 15px;
            padding: 25px;
            margin: 20px auto;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .prompt-title {
            color: var(--primary-color);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .prompt-message {
            color: var(--black);
            font-size: 18px;
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .prompt-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* ===== ENHANCED KEYBOARD NAVIGATION ===== */
        .keyboard-hint {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 10px 0;
            font-size: 14px;
            color: #6c757d;
            text-align: center;
        }

        .key-shortcut {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            margin: 0 2px;
            font-size: 12px;
        }
    </style>
</head>

<body>

<!-- Security Overlay -->
<div id="securityOverlay">
    <div id="securityWarning">
        <h2>üö´ SECURITY VIOLATION DETECTED</h2>
        <p id="violationMessage">Unauthorized activity detected. Exam may be terminated.</p>
        <button onclick="hideSecurityWarning()" style="
            background: white; color: #ff4444; border: none; 
            padding: 12px 24px; border-radius: 8px; cursor: pointer;
            font-weight: bold; margin-top: 20px; font-size: 16px;">
            ACKNOWLEDGE
        </button>
    </div>
</div>

<!-- Security Banner -->
<div id="globalSecurityBanner" class="security-banner" style="display: none;">
    ‚ö†Ô∏è SECURE EXAM MODE: Tab switching, screenshots, and right-click are disabled
</div>

<!-- Network Status -->
<div id="networkStatus" class="network-status network-online">
    üü¢ Online
</div>

<!-- Violation Counter -->
<div id="violationCounter" class="violation-counter">
    Violations: <span id="violationCount">0</span>
</div>

<!-- Auto-save Indicator -->
<div id="autoSaveIndicator" class="auto-save-indicator">
    üíæ Auto-saved
</div>

<header>LFJC ONLINE EXAMINATION - 10 FORM SYSTEM - SECURE MODE</header>

<div id="studentEntry">
    <div class="warning-banner" id="examWarning" style="display:none;">
        <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
    </div>
    
    <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
    <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
    <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
    <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>
    
    <!-- Form Assignment Display -->
    <div id="formAssignment" class="form-assignment" style="display:none;">
        <h3>üìã ASSIGNED FORM</h3>
        <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
        <p>Your responses will be submitted to this form</p>
    </div>
    
    <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
    <p id="studentMsg"></p>
    <div id="errorMessages"></div>
    
    <div id="resumeExamSection" style="display:none; margin-top: 20px;">
        <div class="security-message">
            <p>You have an exam in progress. Would you like to resume?</p>
            <button id="resumeExamBtn" class="navBtn">Resume Exam</button>
        </div>
    </div>

    <!-- Duplicate Submission Warning -->
    <div id="duplicateWarning" class="duplicate-warning" style="display:none;">
        <h3>‚ö†Ô∏è Previous Submission Detected</h3>
        <p>It appears you have already submitted an exam. Starting a new exam will create a duplicate entry.</p>
        <button id="forceStartBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Start New Exam Anyway</button>
    </div>
</div>

<div id="examArea" style="display:none;">
    <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
        <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
        <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
        <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
            <span id="timerEl">üïí 00:00</span>
        </div>
    </div>

    <!-- Subject Display -->
    <div id="subjectDisplay" class="current-subject"></div>

    <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

    <div class="navContainer">
        <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
        <button class="navBtn" id="markReviewBtn">Review</button>
        <button class="navBtn" id="nextBtn">Next ‚û°</button>
        <button class="navBtn" id="submitBtn">Submit Exam</button>
    </div>

    <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
    <div class="area-header">
        <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
        <div>
            <b>Section:</b> <span id="summarySection"></span> | 
            <b>Roll:</b> <span id="summaryRoll"></span> | 
            <b>Admission No:</b> <span id="summaryAdm"></span> |
            <b>Form:</b> <span id="summaryForm"></span>
        </div>
    </div>
    
    <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
    
    <div style="text-align:center; margin:30px 0;">
        <div id="waitingMessage" class="waiting-message">
            <div>‚è≥ Waiting for Exam Time to Complete</div>
            <div class="waiting-timer" id="waitingTimer">00:00</div>
            <div>Detailed solutions will be available automatically when the exam time is over.</div>
        </div>
        <div id="autoTransitionMessage" class="auto-transition-message" style="display:none;">
            üîÑ Auto-transitioning to detailed solutions in <span id="countdown">5</span> seconds...
        </div>
        <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
    </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
    <div class="area-header">
        <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
        <div>
            <b>Section:</b> <span id="reviewSection"></span> | 
            <b>Roll:</b> <span id="reviewRoll"></span> | 
            <b>Admission No:</b> <span id="reviewAdm"></span> |
            <b>Form:</b> <span id="reviewForm"></span>
        </div>
    </div>
    
    <!-- Results Table in Detailed Solutions -->
    <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
    
    <div id="reviewQuestionsContainer"></div>
    
    <div style="text-align:center; margin:30px 0;">
        <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
    </div>
</div>

<footer>LFJC@2025 All rights reserved - 10 Form System</footer>

<div id="fullRedOverlay"></div>
<div id="accessDeniedBox">
    <h1>ACCESS DENIED</h1>
    <button id="callAdminBtn" class="glow">Enter Password</button>
</div>

<div class="confirmModal" id="confirmModal">
    <div class="confirmBox">
        <p id="confirmText">Confirm?</p>
        <button id="confirmYes">Yes</button>
        <button id="confirmNo">No</button>
    </div>
</div>

<div id="adminPassModal">
    <div id="adminPassBox">
        <h3>Enter Admin Password</h3>
        <input type="password" id="adminPassInput">
        <br><br>
        <button id="adminPassSubmit">Submit</button>
    </div>
</div>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
    <div class="screenshot-dots"></div>
</div>
<div id="screenshotBlock"></div>

<script>
// ===== ENHANCED SECURITY CONFIGURATION =====
const SECURITY_CONFIG = {
    MAX_VIOLATIONS: 5,
    FOCUS_LOSS_LIMIT: 3,
    CLIPBOARD_ATTEMPTS_LIMIT: 2,
    AUTO_SAVE_INTERVAL: 15000, // 15 seconds
    NETWORK_CHECK_INTERVAL: 10000, // 10 seconds
    SECURITY_CHECK_INTERVAL: 5000 // 5 seconds
};

// ===== ENHANCED SECURITY VARIABLES =====
let securityViolations = 0;
let focusLossCount = 0;
let clipboardAccessAttempts = 0;
let isOnline = true;
let securityMonitorInterval = null;
let autoSaveInterval = null;
let networkMonitorInterval = null;
let lastBackupTime = null;

// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 1; // 5 minutes for testing
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const STORAGE_KEY_PREFIX = "lfjc_exam_";
const MAX_QUESTIONS = 60; // Maximum expected questions

// ===== 10-FORM CONFIGURATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
    'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDlY-5BAF5rPvzQS0AeTI6Vs2Rkri0V6_miA0mRivZAEg/formResponse",
    'E': "https://docs.google.com/forms/d/e/1FAIpQLSfK6Skl6Uxj8VyGnhhqfdPHcJ8mbcgpzIKLpWFElzdeQSKMgA/formResponse",
    'F': "https://docs.google.com/forms/d/e/1FAIpQLSeP-Gx2XnUg_Q17asOOeYzkoGtLykVIcQ2W006YTqTpE7xY6g/formResponse",
    'G': "https://docs.google.com/forms/d/e/1FAIpQLSe1vg_I5XR3ljr-UNFi-MXxUgjdTDyrVbHxqi_dkvtmYGUTEA/formResponse",
    'H': "https://docs.google.com/forms/d/e/1FAIpQLScyv8cps4StN2UXrsXqNdLu5UBR7t0Vwk8WSnynU2tvracs1g/formResponse",
    'I': "https://docs.google.com/forms/d/e/1FAIpQLSeyen2hSdhRwztpWnH6lyuL91ZROqwDMKIaa4gN_e-Xvyvb_g/formResponse",
    'J': "https://docs.google.com/forms/d/e/1FAIpQLSelbDi1n1EKWu7G0I92hTML6vWUO2c55p2dqrEOQ7cWflaSNg/formResponse"
};

// DYNAMIC STUDENT DISTRIBUTION - CHANGE THIS NUMBER FOR DIFFERENT CLASS SIZES
const TOTAL_STUDENTS = 150; // Set this to 100, 150, 200, etc.

// Form field mappings - FROM YOUR PRE-FILL URL
const FORM_FIELDS = {
    STUDENT_NAME: "entry.217666919",
    SECTION: "entry.2006392966",
    ROLL_NUMBER: "entry.547275105",
    ADMISSION_NUMBER: "entry.1234063852",
    MATHS_MARKS: "entry.1989859216",
    PHYSICS_MARKS: "entry.1953974928",
    CHEMISTRY_MARKS: "entry.296331194",
    TOTAL_MARKS: "entry.1289040887",
    TIMESTAMP: "entry.2139100252"
};

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let hasSubmitted = false;
let examStartTime = null;
let waitingTimerInterval = null;
let autoTransitionTimer = null;
let examInProgress = false;
let preloadedImages = {}; // Cache for preloaded images
let currentSubjData = null; // Store subject data for detailed solutions
let assignedForm = 'A'; // Default form assignment

const subjects = ["Maths", "Physics", "Chemistry"];

let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
let progress = null, timerInterval = null;

// ===== BULLETPROOF SINGLE SUBMISSION SYSTEM =====
let submissionInProgress = new Set(); // Track ongoing submissions
let submissionHistory = new Map(); // Track all submissions

// ===== ENHANCED SECURITY VARIABLES =====
let powerFailureBackupInterval = null;
let realTimeBackup = null;
let backupVerificationInterval = null;
let submissionQueue = [];
let verifiedSubmissions = new Set();
let formHealthStatus = {};

// ===== ENHANCED KEYBOARD NAVIGATION =====
function setupKeyboardNavigation() {
    document.addEventListener('keydown', function(e) {
        // Handle Enter key in form fields
        if (document.getElementById('studentEntry').style.display !== 'none') {
            if (['stuName', 'stuSection', 'stuRoll', 'stuAdm'].includes(document.activeElement.id) && e.key === 'Enter') {
                e.preventDefault();
                const fields = ['stuName', 'stuSection', 'stuRoll', 'stuAdm'];
                const currentIndex = fields.indexOf(document.activeElement.id);
                if (currentIndex < fields.length - 1) {
                    document.getElementById(fields[currentIndex + 1]).focus();
                } else if (validateStudentInputs()) {
                    document.getElementById('stuStartBtn').focus();
                }
                return;
            }
        }

        // Don't handle modal keyboard events here
        if (document.getElementById('confirmModal').style.display === 'flex') {
            return;
        }

        // Handle admin password modal keyboard navigation
        if (document.getElementById('adminPassModal').style.display === 'flex') {
            if (e.key === 'Enter') {
                e.preventDefault();
                document.getElementById('adminPassSubmit').click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                document.getElementById('adminPassModal').style.display = 'none';
            }
            return;
        }

        // Only handle keyboard navigation when exam is in progress
        if (!progress || document.getElementById('examArea').style.display !== 'block') {
            return;
        }

        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                if (progress.currentQ > 0) {
                    showQuestion(progress.currentQ - 1);
                }
                break;
                
            case 'ArrowRight':
                e.preventDefault();
                if (progress.currentQ < examData.files.length - 1) {
                    showQuestion(progress.currentQ + 1);
                }
                break;
                
            case 'Enter':
                e.preventDefault();
                if (document.activeElement === document.getElementById('submitBtn')) {
                    showConfirmModal("Submit Exam?", calculateAndShowResults);
                }
                break;
                
            case '1':
            case '2':
            case '3':
            case '4':
                e.preventDefault();
                const optionLetters = ['A', 'B', 'C', 'D'];
                const selectedOption = optionLetters[parseInt(e.key) - 1];
                selectOption(progress.currentQ, selectedOption);
                break;
                
            case 'r':
            case 'R':
                e.preventDefault();
                document.getElementById('markReviewBtn').click();
                break;
        }
    });
}

// ===== ENHANCED MODAL KEYBOARD SUPPORT =====
function setupModalKeyboardSupport() {
    const confirmModal = document.getElementById('confirmModal');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    
    confirmModal.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            if (document.activeElement === confirmYes) {
                confirmNo.focus();
            } else {
                confirmYes.focus();
            }
        }
    });
}

// ===== ENHANCED PALETTE FUNCTIONS =====
function initPalette() {
    const palette = document.getElementById('paletteContainer');
    palette.innerHTML = '';
    
    // Determine grid columns based on screen size
    let columns = 20;
    if (window.innerWidth <= 600) columns = 5;
    else if (window.innerWidth <= 900) columns = 10;
    else if (window.innerWidth <= 1200) columns = 15;
    
    palette.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
    
    for (let i = 0; i < examData.files.length; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.dataset.qIndex = i;
        btn.tabIndex = 0; // Make focusable
        
        btn.addEventListener('click', () => {
            if (!hasSubmitted) {
                showQuestion(i);
            }
        });
        
        // Add keyboard support for palette
        btn.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                if (!hasSubmitted) {
                    showQuestion(i);
                }
            }
        });
        
        palette.appendChild(btn);
    }
    
    updatePalette();
}

function updatePalette() {
    if (!progress) return;
    
    const paletteBtns = document.querySelectorAll('#paletteContainer button');
    paletteBtns.forEach(btn => {
        const qIndex = parseInt(btn.dataset.qIndex);
        
        // Remove all state classes
        btn.classList.remove('selected', 'reviewed', 'current', 
                           'answered', 'not-answered', 'marked-review');
        
        // Current question
        if (qIndex === progress.currentQ) {
            btn.classList.add('current');
        }
        
        // Answered questions
        if (progress.answers[qIndex] !== null) {
            btn.classList.add('answered');
        } else {
            btn.classList.add('not-answered');
        }
        
        // Marked for review
        if (progress.markedReview.has(qIndex)) {
            btn.classList.add('reviewed');
        }
    });
}

// ===== ENHANCED PROMPT FUNCTIONS =====
function showEnhancedConfirm(message, confirmCallback, cancelCallback = null) {
    const modal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    
    confirmText.textContent = message;
    
    // Remove existing event listeners
    confirmYes.replaceWith(confirmYes.cloneNode(true));
    confirmNo.replaceWith(confirmNo.cloneNode(true));
    
    // Get new references
    const newConfirmYes = document.getElementById('confirmYes');
    const newConfirmNo = document.getElementById('confirmNo');
    
    newConfirmYes.onclick = () => {
        modal.style.display = 'none';
        confirmCallback();
    };
    
    newConfirmNo.onclick = () => {
        modal.style.display = 'none';
        if (cancelCallback) cancelCallback();
    };
    
    modal.style.display = 'flex';
    
    // Enhanced keyboard navigation
    setTimeout(() => newConfirmYes.focus(), 100);
    
    // Enhanced backdrop click
    modal.onclick = (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
            if (cancelCallback) cancelCallback();
        }
    };
}

// ===== ENHANCED SECURITY FUNCTIONS =====

// üö® COMPREHENSIVE BROWSER LOCKDOWN
function enableBrowserLockdown() {
    console.log('üîí Enabling comprehensive browser lockdown...');
    
    // Disable right-click context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        logSecurityViolation('Right-click attempted');
        return false;
    });
    
    // Disable text selection
    document.addEventListener('selectstart', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Disable drag and drop
    document.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Disable copy/cut/paste
    document.addEventListener('copy', function(e) {
        e.preventDefault();
        clipboardAccessAttempts++;
        logSecurityViolation('Copy attempted');
        return false;
    });
    
    document.addEventListener('cut', function(e) {
        e.preventDefault();
        clipboardAccessAttempts++;
        logSecurityViolation('Cut attempted');
        return false;
    });
    
    document.addEventListener('paste', function(e) {
        e.preventDefault();
        clipboardAccessAttempts++;
        logSecurityViolation('Paste attempted');
        return false;
    });
    
    // üö® DISABLE KEYBOARD SHORTCUTS
    document.addEventListener('keydown', function(e) {
        const forbiddenKeys = [
            'F12', 'F11', 'PrintScreen', 
            'Escape'
        ];
        
        const forbiddenCombinations = [
            e.ctrlKey && e.shiftKey && e.key === 'I', // Dev Tools
            e.ctrlKey && e.shiftKey && e.key === 'J', // Dev Tools
            e.ctrlKey && e.shiftKey && e.key === 'C', // Inspect
            e.ctrlKey && e.key === 'U', // View Source
            e.ctrlKey && e.key === 'S', // Save
            e.ctrlKey && e.key === 'P', // Print
            e.ctrlKey && e.key === 'N', // New Window
            e.metaKey && e.key === 'r', // Refresh (Mac)
            e.ctrlKey && e.key === 'r', // Refresh
            e.ctrlKey && e.key === 'R', // Refresh
            e.altKey && e.key === 'Tab', // Switch Apps
            e.metaKey && e.key === 'Tab' // Switch Apps (Mac)
        ];
        
        if (forbiddenKeys.includes(e.key) || forbiddenCombinations.some(combo => combo)) {
            e.preventDefault();
            e.stopPropagation();
            logSecurityViolation(`Keyboard shortcut attempted: ${e.key}`);
            return false;
        }
    });
    
    // üö® DETECT TAB SWITCHING / WINDOW FOCUS LOSS
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && examInProgress) {
            focusLossCount++;
            logSecurityViolation(`Tab/window focus lost (${focusLossCount} times)`);
            
            if (focusLossCount >= SECURITY_CONFIG.FOCUS_LOSS_LIMIT) {
                showSecurityWarning('Multiple tab switching attempts detected. Exam may be terminated.');
            }
        }
    });
    
    // üö® DETECT DEVELOPER TOOLS
    detectDeveloperTools();
    
    // üö® PREVENT IFRAME EMBEDDING
    if (window.self !== window.top) {
        terminateExamForViolation('Page embedding detected - security violation');
    }
    
    console.log('‚úÖ Browser lockdown enabled');
}

// üö® DETECT DEVELOPER TOOLS - DISABLED FOR TESTING
function detectDeveloperTools() {
    console.log('üîß Developer tools detection disabled for testing');
    // Comment out the actual detection code during development
}

// üö® POWER FAILURE PROTECTION
function setupPowerFailureProtection() {
    console.log('üîã Setting up power failure protection...');
    
    // Auto-save progress at regular intervals
    autoSaveInterval = setInterval(() => {
        if (examInProgress && progress) {
            backupExamProgress();
            showAutoSaveIndicator();
        }
    }, SECURITY_CONFIG.AUTO_SAVE_INTERVAL);
    
    // Save progress before window closes
    window.addEventListener('beforeunload', (e) => {
        if (examInProgress && !hasSubmitted) {
            e.preventDefault();
            backupExamProgress();
            e.returnValue = 'Your exam progress will be saved. You can resume when you return.';
            return e.returnValue;
        }
    });
    
    console.log('‚úÖ Power failure protection enabled');
}

// üö® NETWORK FAILURE PROTECTION
function setupNetworkMonitoring() {
    console.log('üåê Setting up network monitoring...');
    
    window.addEventListener('online', handleNetworkRestored);
    window.addEventListener('offline', handleNetworkLost);
    
    networkMonitorInterval = setInterval(() => {
        updateNetworkStatus();
    }, SECURITY_CONFIG.NETWORK_CHECK_INTERVAL);
    
    console.log('‚úÖ Network monitoring enabled');
}

function handleNetworkLost() {
    isOnline = false;
    console.log('üåê Network connection lost');
    updateNetworkStatus();
    
    if (examInProgress) {
        showNetworkWarning();
        // Increase backup frequency during network issues
        clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(() => {
            if (examInProgress && progress) {
                backupExamProgress();
            }
        }, 5000); // Backup every 5 seconds when offline
    }
}

function handleNetworkRestored() {
    isOnline = true;
    console.log('üåê Network connection restored');
    updateNetworkStatus();
    
    if (examInProgress) {
        hideNetworkWarning();
        // Restore normal backup interval
        clearInterval(autoSaveInterval);
        autoSaveInterval = setInterval(() => {
            if (examInProgress && progress) {
                backupExamProgress();
            }
        }, SECURITY_CONFIG.AUTO_SAVE_INTERVAL);
        
        // Submit any pending data
        processOfflineSubmissions();
    }
}

function updateNetworkStatus() {
    const statusDiv = document.getElementById('networkStatus');
    if (navigator.onLine) {
        statusDiv.textContent = 'üü¢ Online';
        statusDiv.className = 'network-status network-online';
        isOnline = true;
    } else {
        statusDiv.textContent = 'üî¥ Offline';
        statusDiv.className = 'network-status network-offline';
        isOnline = false;
    }
}

// üö® ENHANCED SCREENSHOT PROTECTION
function setupScreenshotProtection() {
    console.log('üì∏ Setting up screenshot protection...');
    
    const protection = document.getElementById('screenshotProtection');
    protection.style.display = 'block';
    
    // Additional CSS protection
    const antiScreenshotStyle = document.createElement('style');
    antiScreenshotStyle.textContent = `
        /* Prevent printing */
        @media print {
            * {
                display: none !important;
            }
        }
        
        /* Disable text selection globally */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        /* Hide scrollbars but maintain functionality */
        ::-webkit-scrollbar {
            display: none;
        }
    `;
    document.head.appendChild(antiScreenshotStyle);
    
    console.log('‚úÖ Screenshot protection enabled');
}

// üö® SECURITY MONITORING
function startSecurityMonitoring() {
    console.log('üëÅÔ∏è Starting security monitoring...');
    
    securityMonitorInterval = setInterval(() => {
        performSecurityChecks();
    }, SECURITY_CONFIG.SECURITY_CHECK_INTERVAL);
    
    console.log('‚úÖ Security monitoring started');
}

function performSecurityChecks() {
    if (!examInProgress) return;
    
    // Check for multiple windows
    if (window.opener) {
        terminateExamForViolation('Multiple windows detected');
    }
    
    // Check for iframe embedding
    if (window.self !== window.top) {
        terminateExamForViolation('Page embedding detected');
    }
    
    // Check violation limits
    if (securityViolations >= SECURITY_CONFIG.MAX_VIOLATIONS) {
        terminateExamForViolation('Maximum security violations reached');
    }
    
    if (clipboardAccessAttempts >= SECURITY_CONFIG.CLIPBOARD_ATTEMPTS_LIMIT) {
        showSecurityWarning('Clipboard access is strictly prohibited');
    }
}

// üö® SECURITY UI FUNCTIONS
function logSecurityViolation(message) {
    if (!examInProgress) return;
    
    securityViolations++;
    console.warn(`üö® Security Violation #${securityViolations}: ${message}`);
    
    // Update violation counter
    const violationCounter = document.getElementById('violationCounter');
    const violationCount = document.getElementById('violationCount');
    
    violationCounter.style.display = 'block';
    violationCount.textContent = securityViolations;
    
    // Show warning for serious violations
    if (securityViolations >= 3) {
        showSecurityWarning(`Security violation detected: ${message}`);
    }
}

function showSecurityWarning(message) {
    const overlay = document.getElementById('securityOverlay');
    const messageElement = document.getElementById('violationMessage');
    
    messageElement.textContent = message;
    overlay.style.display = 'flex';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (overlay.style.display === 'flex') {
            hideSecurityWarning();
        }
    }, 5000);
}

function hideSecurityWarning() {
    document.getElementById('securityOverlay').style.display = 'none';
}

function showNetworkWarning() {
    const warningDiv = document.createElement('div');
    warningDiv.id = 'networkWarning';
    warningDiv.innerHTML = `
        <div style="position:fixed; top:60px; left:0; width:100%; background:#ff9900; 
                   color:white; text-align:center; padding:10px; z-index:10000;
                   font-weight:bold; box-shadow:0 2px 10px rgba(0,0,0,0.3);">
            ‚ö†Ô∏è NETWORK CONNECTION LOST - Working offline. Your progress is being saved locally.
        </div>
    `;
    document.body.appendChild(warningDiv);
}

function hideNetworkWarning() {
    const warningDiv = document.getElementById('networkWarning');
    if (warningDiv) {
        warningDiv.remove();
    }
}

function showAutoSaveIndicator() {
    const indicator = document.getElementById('autoSaveIndicator');
    indicator.style.display = 'block';
    indicator.textContent = 'üíæ Auto-saved';
    
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 2000);
}

// üö® EXAM TERMINATION FOR VIOLATIONS
function terminateExamForViolation(reason) {
    if (hasSubmitted) return;
    
    console.log(`üö´ Exam terminated: ${reason}`);
    
    // Calculate partial marks
    const subjData = calculateSubjectMarks();
    subjData.terminated = true;
    subjData.terminationReason = reason;
    
    // Submit terminated exam
    if (progress && progress.student) {
        sendToGoogleFormWithGuarantee(subjData, progress.student);
    }
    
    // Show termination screen
    showTerminationScreen(reason);
    
    hasSubmitted = true;
    examInProgress = false;
    
    // Clear all intervals
    clearAllIntervals();
}

function showTerminationScreen(reason) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'none';
    
    const terminationDiv = document.createElement('div');
    terminationDiv.className = 'termination-screen';
    terminationDiv.style.display = 'flex';
    terminationDiv.innerHTML = `
        <div class="termination-content">
            <h1 style="font-size:48px; margin:0 0 20px 0; color:#ff6b6b;">üö´ EXAM TERMINATED</h1>
            <h2 style="color:#ff6b6b; margin:0 0 20px 0;">Security Violation Detected</h2>
            <p style="font-size:18px; margin:0 0 20px 0;"><strong>Reason:</strong> ${reason}</p>
            <p style="font-size:16px; opacity:0.8; margin:0 0 30px 0;">
                Your exam has been terminated due to violation of exam rules.<br>
                Partial marks have been recorded up to the point of termination.
            </p>
            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h4 style="margin:0 0 10px 0;">Violation Summary:</h4>
                <p style="margin:5px 0;">‚Ä¢ Focus Loss: ${focusLossCount} times</p>
                <p style="margin:5px 0;">‚Ä¢ Clipboard Attempts: ${clipboardAccessAttempts}</p>
                <p style="margin:5px 0;">‚Ä¢ Total Violations: ${securityViolations}</p>
            </div>
            <button onclick="window.close()" style="
                background:#ff6b6b; color:white; border:none; padding:12px 24px; 
                border-radius:8px; font-size:16px; cursor:pointer; font-weight:bold;">
                Close Window
            </button>
        </div>
    `;
    document.body.appendChild(terminationDiv);
}

function clearAllIntervals() {
    if (timerInterval) clearInterval(timerInterval);
    if (autoSaveInterval) clearInterval(autoSaveInterval);
    if (networkMonitorInterval) clearInterval(networkMonitorInterval);
    if (securityMonitorInterval) clearInterval(securityMonitorInterval);
    if (waitingTimerInterval) clearInterval(waitingTimerInterval);
    if (autoTransitionTimer) clearInterval(autoTransitionTimer);
}

// üö® ENHANCED BACKUP SYSTEM
function backupExamProgress() {
    if (!progress || !examInProgress) return;
    
    const backupData = {
        progress: JSON.parse(JSON.stringify(progress)),
        examData: examData,
        startTime: examStartTime,
        currentTime: Date.now(),
        assignedForm: assignedForm,
        security: {
            violations: securityViolations,
            focusLoss: focusLossCount,
            clipboardAttempts: clipboardAccessAttempts
        },
        backupId: 'backup_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        timestamp: new Date().toISOString()
    };
    
    try {
        // Backup to multiple storage locations
        localStorage.setItem('exam_primary_backup', JSON.stringify(backupData));
        sessionStorage.setItem('exam_secondary_backup', JSON.stringify(backupData));
        localStorage.setItem('exam_backup_timestamp', Date.now().toString());
        
        lastBackupTime = Date.now();
        console.log('‚úÖ Exam progress backed up securely');
        
    } catch (error) {
        console.error('‚ùå Backup failed:', error);
    }
}

function restoreExamProgress() {
    try {
        // Try primary backup first
        let backupData = localStorage.getItem('exam_primary_backup');
        let backupSource = 'primary';
        
        // Fallback to secondary backup
        if (!backupData) {
            backupData = sessionStorage.getItem('exam_secondary_backup');
            backupSource = 'secondary';
        }
        
        if (!backupData) return false;
        
        const parsedData = JSON.parse(backupData);
        const backupAge = Date.now() - (parsedData.currentTime || parsedData.timestamp);
        
        // Only restore if backup is recent (within 10 minutes)
        if (backupAge > 600000) {
            console.log('Backup too old, ignoring');
            return false;
        }
        
        progress = parsedData.progress;
        examData = parsedData.examData;
        examStartTime = parsedData.startTime;
        assignedForm = parsedData.assignedForm;
        
        // Restore security state
        if (parsedData.security) {
            securityViolations = parsedData.security.violations || 0;
            focusLossCount = parsedData.security.focusLoss || 0;
            clipboardAccessAttempts = parsedData.security.clipboardAttempts || 0;
        }
        
        // Calculate remaining time
        const elapsed = Date.now() - examStartTime;
        progress.timeLeftSec = Math.max(0, EXAM_DURATION_MS - elapsed) / 1000;
        
        console.log(`‚úÖ Exam progress restored from ${backupSource} backup`);
        return true;
        
    } catch (error) {
        console.error('‚ùå Restore failed:', error);
        return false;
    }
}

// üö® ENHANCED EXAM START WITH SECURITY
function startExamWithFullSecurity(studentData) {
    console.log('üöÄ Starting exam with full security...');
    
    // Enable all security features
    enableBrowserLockdown();
    setupPowerFailureProtection();
    setupNetworkMonitoring();
    setupScreenshotProtection();
    startSecurityMonitoring();
    
    // Show security banner
    document.getElementById('globalSecurityBanner').style.display = 'block';
    
    // Initialize exam
    examInProgress = true;
    examStartTime = Date.now();
    
    // Initialize progress
    progress = {
        student: studentData,
        answers: new Array(answerKey.length).fill(null),
        currentQ: 0,
        timeLeftSec: EXAM_DURATION_MS / 1000,
        markedReview: new Set(),
        security: {
            startTime: new Date().toISOString(),
            violations: 0
        }
    };
    
    // Initialize exam data
    examData = {
        files: images,
        keys: answerKey,
        subjectNames: Array(answerKey.length).fill(''),
        originalOrder: Array.from({length: answerKey.length}, (_, i) => i)
    };
    
    // Show exam area
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'block';
    document.getElementById('examWarning').style.display = 'block';
    
    // Update student info
    document.getElementById('stuInfo').textContent = 
        `${studentData.name} | ${studentData.sec} | Roll: ${studentData.roll}`;
    
    // Start timer
    startTimer();
    
    // Initialize question palette with enhanced styling
    initPalette();
    
    // Load first question
    showQuestion(0);
    
    // Setup keyboard navigation
    setupKeyboardNavigation();
    setupModalKeyboardSupport();
    
    // Initial backup
    backupExamProgress();
    
    console.log('‚úÖ Exam started with full security');
}

// ===== PERFECT FORM ASSIGNMENT FUNCTIONS =====
function getAssignedForm(studentData) {
    const forms = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    const formsCount = forms.length;
    
    // Method 1: Perfect roll number based distribution
    if (studentData.roll && !isNaN(studentData.roll)) {
        const rollNumber = parseInt(studentData.roll);
        
        // Dynamic calculation based on actual total students
        const studentsPerForm = Math.ceil(TOTAL_STUDENTS / formsCount);
        
        // Perfect distribution formula
        const formIndex = Math.floor((rollNumber - 1) / studentsPerForm) % formsCount;
        return forms[formIndex];
    }
    
    // Method 2: Consistent hash-based fallback
    const hashString = `${studentData.name}|${studentData.roll}|${studentData.adm}`;
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
        hash = hash & hash; // Convert to 32-bit integer
    }
    return forms[Math.abs(hash) % formsCount];
}

function updateFormAssignmentDisplay(studentData) {
    assignedForm = getAssignedForm(studentData);
    document.getElementById('assignedFormDisplay').textContent = `FORM ${assignedForm}`;
    document.getElementById('formAssignment').style.display = 'block';
}

// ===== FIXED ANSWER KEY LOADING =====
function loadAnswerKey() {
    console.log('üîë Loading answer key...');
    
    // Create a sample answer key for testing
    const sampleKey = 'ABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCDABCD';
    answerKey = sampleKey.split('');
    
    console.log(`‚úÖ Using sample answer key with ${answerKey.length} questions`);
    
    // Build image paths
    for (let i = 1; i <= answerKey.length; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    console.log('‚úÖ Answer key loaded successfully');
    
    // Force immediate validation
    setTimeout(() => {
        validateStudentInputs();
    }, 100);
}

// ===== BULLETPROOF SINGLE SUBMISSION FUNCTIONS =====

// üö® ULTRA-STRONG SINGLE SUBMISSION GUARANTEE
async function sendToGoogleFormWithGuarantee(subjData, studentData) {
    const studentId = generateStudentId(studentData);
    const submissionId = generateSubmissionId(studentData);
    
    console.log(`üöÄ Starting submission for: ${studentData.name}`);
    
    // üö® CRITICAL: Check if submission is already in progress
    if (submissionInProgress.has(studentId)) {
        console.warn(`üö® Submission already in progress for: ${studentData.name}`);
        return true; // Return true to prevent retries
    }
    
    // üö® CRITICAL: Check if already successfully submitted
    if (hasStudentAlreadySubmitted(studentData)) {
        console.warn(`üö® Student already submitted: ${studentData.name}`);
        showDuplicateInSummary();
        return true; // Return true to prevent further attempts
    }
    
    try {
        // üö® ACQUIRE SUBMISSION LOCK
        submissionInProgress.add(studentId);
        
        // Double-check duplicate prevention
        if (hasStudentAlreadySubmitted(studentData)) {
            console.warn(`üö® Duplicate detected after lock: ${studentData.name}`);
            return true;
        }
        
        console.log(`üì§ Attempting submission for: ${studentData.name}`);
        
        // Single submission attempt (no retries for duplicates)
        const success = await submitToSingleForm(subjData, studentData);
        
        if (success) {
            // üö® CRITICAL: Mark as submitted IMMEDIATELY
            markAsSubmittedPermanently(studentData, submissionId);
            console.log(`‚úÖ SINGLE SUBMISSION SUCCESS: ${studentData.name}`);
            return true;
        } else {
            console.error(`‚ùå Submission failed for: ${studentData.name}`);
            return false;
        }
        
    } catch (error) {
        console.error(`üí• Submission error for ${studentData.name}:`, error);
        return false;
    } finally {
        // üö® RELEASE SUBMISSION LOCK (with delay to prevent rapid resubmission)
        setTimeout(() => {
            submissionInProgress.delete(studentId);
        }, 5000); // 5 second cooldown
    }
}

// üö® ENHANCED: Check if student already submitted
function hasStudentAlreadySubmitted(studentData) {
    const studentId = generateStudentId(studentData);
    
    // Check multiple storage locations
    const checks = [
        localStorage.getItem(`submitted_${studentId}`),
        sessionStorage.getItem(`submitted_${studentId}`),
        localStorage.getItem(`final_submission_${studentId}`)
    ];
    
    return checks.some(check => check !== null && check !== 'false');
}

// üö® ENHANCED: Permanent submission marker
function markAsSubmittedPermanently(studentData, submissionId) {
    const studentId = generateStudentId(studentData);
    const timestamp = Date.now();
    
    try {
        // üö® MULTIPLE LAYERS OF DUPLICATE PREVENTION
        
        // Layer 1: Primary marker
        localStorage.setItem(`submitted_${studentId}`, timestamp.toString());
        
        // Layer 2: Final submission marker
        localStorage.setItem(`final_submission_${studentId}`, timestamp.toString());
        
        // Layer 3: Session storage
        sessionStorage.setItem(`submitted_${studentId}`, timestamp.toString());
        
        // Layer 4: Submission history
        const submissionRecord = {
            studentId: studentId,
            submissionId: submissionId,
            timestamp: timestamp,
            studentData: studentData,
            assignedForm: assignedForm,
            status: 'completed'
        };
        
        // Store in submission history
        const history = JSON.parse(localStorage.getItem('submission_history') || '[]');
        history.push(submissionRecord);
        
        // Keep only recent history (last 20 submissions)
        if (history.length > 20) {
            history.splice(0, history.length - 20);
        }
        
        localStorage.setItem('submission_history', JSON.stringify(history));
        
        console.log(`‚úÖ PERMANENTLY MARKED AS SUBMITTED: ${studentData.name}`);
        
    } catch (error) {
        console.error('Failed to mark permanent submission:', error);
    }
}

// üö® ENHANCED: Student ID generation
function generateStudentId(studentData) {
    return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
}

// üö® ENHANCED: Submission ID with better uniqueness
function generateSubmissionId(studentData) {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substr(2, 9);
    return `sub_${generateStudentId(studentData)}_${timestamp}_${random}`;
}

// üö® SIMPLIFIED: Single form submission (no retries for duplicates)
async function submitToSingleForm(subjData, studentData) {
    const FORM_URL = GOOGLE_FORMS[assignedForm];
    
    if (!FORM_URL) {
        console.error(`No form URL for ${assignedForm}`);
        return false;
    }

    // Calculate marks
    const marks = calculateMarks(subjData);
    
    // Create form payload
    const formData = new URLSearchParams();
    formData.append(FORM_FIELDS.STUDENT_NAME, studentData.name);
    formData.append(FORM_FIELDS.SECTION, studentData.sec);
    formData.append(FORM_FIELDS.ROLL_NUMBER, studentData.roll);
    formData.append(FORM_FIELDS.ADMISSION_NUMBER, studentData.adm);
    formData.append(FORM_FIELDS.MATHS_MARKS, marks.mathsMarks.toFixed(2));
    formData.append(FORM_FIELDS.PHYSICS_MARKS, marks.physicsMarks.toFixed(2));
    formData.append(FORM_FIELDS.CHEMISTRY_MARKS, marks.chemistryMarks.toFixed(2));
    formData.append(FORM_FIELDS.TOTAL_MARKS, marks.totalMarks.toFixed(2));
    formData.append(FORM_FIELDS.TIMESTAMP, new Date().toLocaleString());

    try {
        console.log(`üìù Submitting to Form ${assignedForm}: ${FORM_URL}`);
        
        // Use no-cors to avoid network issues
        await fetch(FORM_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        });
        
        console.log(`‚úÖ Form submission completed for: ${studentData.name}`);
        return true;
        
    } catch (error) {
        console.error(`‚ùå Form submission error for ${studentData.name}:`, error);
        return false;
    }
}

function calculateMarks(subjData) {
    let mathsMarks = 0, physicsMarks = 0, chemistryMarks = 0, totalMarks = 0;
    
    for (let subject in subjData) {
        const subjectLower = subject.toLowerCase().trim();
        const marks = subjData[subject].marks;
        
        if (subjectLower.includes('math')) {
            mathsMarks = marks;
        } else if (subjectLower.includes('phys')) {
            physicsMarks = marks;
        } else if (subjectLower.includes('chem')) {
            chemistryMarks = marks;
        }
        totalMarks += marks;
    }
    
    return { mathsMarks, physicsMarks, chemistryMarks, totalMarks };
}

// üö® NEW: Cleanup after submission
function cleanupAfterSubmission() {
    try {
        localStorage.removeItem('exam_backup_data');
        localStorage.removeItem('exam_primary_backup');
        sessionStorage.removeItem('exam_secondary_backup');
        localStorage.removeItem('submission_queue');
        
        console.log('‚úÖ Cleaned up after submission');
    } catch (error) {
        console.error('Cleanup error:', error);
    }
}

// üö® NEW: Show submission error message
function showSubmissionError() {
    const errorDiv = document.createElement('div');
    errorDiv.innerHTML = `
        <div style="background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 8px; 
                   padding: 15px; margin: 20px 0; text-align: center; font-weight: bold;">
            ‚ö†Ô∏è Submission Error: Your results may not have been recorded. 
            Please contact the administrator.
        </div>
    `;
    
    const summaryArea = document.getElementById('summaryArea');
    if (summaryArea) {
        summaryArea.prepend(errorDiv);
    }
}

// üö® ENHANCED: Show duplicate warning in summary
function showDuplicateInSummary() {
    const duplicateWarning = document.createElement('div');
    duplicateWarning.innerHTML = `
        <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; 
                   padding: 15px; margin: 20px 0; text-align: center; font-weight: bold;">
            ‚úÖ Your exam has already been submitted and recorded. 
            This is a duplicate submission attempt.
        </div>
    `;
    
    const summaryArea = document.getElementById('summaryArea');
    if (summaryArea) {
        summaryArea.prepend(duplicateWarning);
    }
}

function checkForDuplicateSubmission(studentData) {
    const studentId = generateStudentId(studentData);
    const submissionId = generateSubmissionId(studentData);
    
    // Check multiple storage locations
    const checks = [
        localStorage.getItem(`submitted_${studentId}`),
        localStorage.getItem(`submitted_${submissionId}`),
        sessionStorage.getItem(`submitted_${studentId}`)
    ];
    
    return checks.some(check => check !== null);
}

function showDuplicateWarning(studentData) {
    const duplicateWarning = document.getElementById('duplicateWarning');
    const forceStartBtn = document.getElementById('forceStartBtn');
    
    duplicateWarning.style.display = 'block';
    
    forceStartBtn.onclick = () => {
        duplicateWarning.style.display = 'none';
        startWithSecurity(true);
    };
}

// ===== TIMER FUNCTIONS =====
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        if (!progress) return;
        
        progress.timeLeftSec--;
        
        // Update timer display
        const minutes = Math.floor(progress.timeLeftSec / 60);
        const seconds = Math.floor(progress.timeLeftSec % 60);
        const timerEl = document.getElementById('timerEl');
        timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Warning when 5 minutes left
        if (progress.timeLeftSec === 300) {
            showTimeWarning('5 minutes remaining!');
        }
        
        // Blink when 1 minute left
        if (progress.timeLeftSec <= 60) {
            timerEl.classList.add('blink');
        }
        
        // Auto-submit when time's up
        if (progress.timeLeftSec <= 0) {
            clearInterval(timerInterval);
            autoSubmitExam();
        }
    }, 1000);
}

function showTimeWarning(message) {
    const warningDiv = document.createElement('div');
    warningDiv.innerHTML = `
        <div style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%);
                   background:#ff9900; color:white; padding:20px; border-radius:10px;
                   z-index:10000; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.4);">
            <h3 style="margin:0 0 10px 0;">‚è∞ TIME WARNING</h3>
            <p style="margin:0; font-size:16px;">${message}</p>
        </div>
    `;
    document.body.appendChild(warningDiv);
    
    setTimeout(() => {
        if (warningDiv.parentNode) {
            warningDiv.parentNode.removeChild(warningDiv);
        }
    }, 5000);
}

function autoSubmitExam() {
    if (hasSubmitted) return;
    
    console.log('‚è∞ Time up! Auto-submitting exam...');
    calculateAndShowResults();
}

// ===== QUESTION DISPLAY FUNCTIONS =====
function getCurrentSubject(qIndex) {
    const totalQuestions = examData.files.length;
    const questionsPerSubject = Math.floor(totalQuestions / 3);
    
    if (qIndex < questionsPerSubject) {
        return "Mathematics";
    } else if (qIndex < questionsPerSubject * 2) {
        return "Physics";
    } else {
        return "Chemistry";
    }
}

function showQuestion(qIndex) {
    if (!progress || qIndex < 0 || qIndex >= examData.files.length) return;
    
    progress.currentQ = qIndex;
    
    const container = document.getElementById('questionContainer');
    container.innerHTML = '';
    
    // Add question transition effect
    container.classList.add('question-transition');
    
    // Question number info
    const qInfo = document.getElementById('stuQInfo');
    qInfo.textContent = `Question ${qIndex + 1} of ${examData.files.length}`;
    
    // Update subject display
    const currentSubject = getCurrentSubject(qIndex);
    document.getElementById('subjectDisplay').textContent = `üìö Current Subject: ${currentSubject}`;
    
    // Create question image
    const img = new Image();
    img.src = examData.files[qIndex];
    img.className = 'questionImg';
    img.alt = `Question ${qIndex + 1}`;
    
    // Loading states
    img.onload = function() {
        container.classList.remove('question-transition');
        container.classList.add('question-fade-in');
        setTimeout(() => {
            container.classList.remove('question-fade-in');
        }, 300);
    };
    
    img.onerror = function() {
        container.innerHTML = `
            <div class="image-error">
                <h3>‚ùå Image Load Error</h3>
                <p>Failed to load question ${qIndex + 1}. Please contact administrator.</p>
                <p>Image path: ${examData.files[qIndex]}</p>
            </div>
        `;
    };
    
    container.appendChild(img);
    
    // Create options with enhanced styling
    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'options-container';
    optionsContainer.innerHTML = `
        <div class="sectionTitle">Select your answer:</div>
        <button class="optBtn" data-opt="A">A</button>
        <button class="optBtn" data-opt="B">B</button>
        <button class="optBtn" data-opt="C">C</button>
        <button class="optBtn" data-opt="D">D</button>
        <button class="optBtn" data-opt="null">Clear Response</button>
    `;
    
    container.appendChild(optionsContainer);
    
    // Set current selected option
    const currentAnswer = progress.answers[qIndex];
    if (currentAnswer !== null) {
        const selectedBtn = optionsContainer.querySelector(`[data-opt="${currentAnswer}"]`);
        if (selectedBtn) selectedBtn.classList.add('selected');
    }
    
    // Add event listeners to options
    const optBtns = optionsContainer.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.addEventListener('click', () => selectOption(qIndex, btn.dataset.opt));
    });
    
    // Update palette
    updatePalette();
    
    // Update navigation buttons
    updateNavigationButtons();
}

function selectOption(qIndex, option) {
    if (!progress || hasSubmitted) return;
    
    // Convert "null" string to actual null
    const selectedOption = option === 'null' ? null : option;
    
    progress.answers[qIndex] = selectedOption;
    
    // Update button states
    const optBtns = document.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.opt === option) {
            btn.classList.add('selected');
        }
    });
    
    // Update palette
    updatePalette();
    
    // Auto-save progress
    backupExamProgress();
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const markReviewBtn = document.getElementById('markReviewBtn');
    
    // Previous button
    prevBtn.disabled = progress.currentQ === 0;
    
    // Next button
    nextBtn.disabled = progress.currentQ === examData.files.length - 1;
    
    // Mark review button
    if (progress.markedReview.has(progress.currentQ)) {
        markReviewBtn.textContent = 'Unmark Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #32CD32, #228B22)';
    } else {
        markReviewBtn.textContent = 'Mark Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, #ff9900)';
    }
}

// Navigation event listeners
document.getElementById('prevBtn').addEventListener('click', () => {
    if (progress.currentQ > 0) {
        showQuestion(progress.currentQ - 1);
    }
});

document.getElementById('nextBtn').addEventListener('click', () => {
    if (progress.currentQ < examData.files.length - 1) {
        showQuestion(progress.currentQ + 1);
    }
});

document.getElementById('markReviewBtn').addEventListener('click', () => {
    if (!progress) return;
    
    const currentQ = progress.currentQ;
    if (progress.markedReview.has(currentQ)) {
        progress.markedReview.delete(currentQ);
    } else {
        progress.markedReview.add(currentQ);
    }
    
    updatePalette();
    updateNavigationButtons();
    backupExamProgress();
});

// ===== EXAM SUBMISSION FUNCTIONS =====
document.getElementById('submitBtn').addEventListener('click', () => {
    showEnhancedConfirm(
        'Are you sure you want to submit the exam?',
        calculateAndShowResults
    );
});

function showConfirmModal(message, confirmCallback) {
    showEnhancedConfirm(message, confirmCallback);
}

// üö® ENHANCED: Calculate and show results with single submission
function calculateAndShowResults() {
    if (hasSubmitted) {
        console.warn('üö® Attempted to submit already submitted exam');
        return;
    }
    
    hasSubmitted = true;
    examInProgress = false;
    
    console.log('üìä Calculating results and submitting...');
    
    // Clear timers and intervals
    clearInterval(timerInterval);
    clearInterval(powerFailureBackupInterval);
    clearInterval(networkMonitorInterval);
    clearInterval(securityMonitorInterval);
    clearInterval(realTimeBackup);
    
    // Calculate subject-wise marks
    const subjData = calculateSubjectMarks();
    currentSubjData = subjData; // Store for detailed solutions
    
    // üö® SINGLE SUBMISSION CALL
    const studentData = progress.student;
    const submissionPromise = sendToGoogleFormWithGuarantee(subjData, studentData);
    
    // Show summary immediately (don't wait for submission)
    showSummary(subjData);
    
    // Monitor submission status
    submissionPromise.then(success => {
        if (success) {
            console.log('üéâ Exam submitted successfully!');
            // Clear backup data after successful submission
            cleanupAfterSubmission();
        } else {
            console.error('üí• Exam submission failed!');
            showSubmissionError();
        }
    });
}

function calculateSubjectMarks() {
    const subjData = {};
    const totalQuestions = examData.files.length;
    
    // Assume equal distribution for now
    const questionsPerSubject = Math.floor(totalQuestions / 3);
    
    for (let i = 0; i < totalQuestions; i++) {
        let subjectName;
        if (i < questionsPerSubject) {
            subjectName = 'Maths';
        } else if (i < questionsPerSubject * 2) {
            subjectName = 'Physics';
        } else {
            subjectName = 'Chemistry';
        }
        
        if (!subjData[subjectName]) {
            subjData[subjectName] = {
                correct: 0,
                wrong: 0,
                blank: 0,
                total: 0,
                marks: 0
            };
        }
        
        const answer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        
        if (answer === null) {
            subjData[subjectName].blank++;
        } else if (answer === correctAnswer) {
            subjData[subjectName].correct++;
            subjData[subjectName].marks += MARK_PER_CORRECT;
        } else {
            subjData[subjectName].wrong++;
            subjData[subjectName].marks += MARK_PER_WRONG;
        }
        
        subjData[subjectName].total++;
    }
    
    return subjData;
}

// ===== SUMMARY AND REVIEW FUNCTIONS =====
function showSummary(subjData) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'block';
    
    // Update student info in summary
    const student = progress.student;
    document.getElementById('summaryStudentName').textContent = student.name;
    document.getElementById('summarySection').textContent = student.sec;
    document.getElementById('summaryRoll').textContent = student.roll;
    document.getElementById('summaryAdm').textContent = student.adm;
    document.getElementById('summaryForm').textContent = assignedForm;
    
    // Create summary table
    const tableContainer = document.getElementById('summaryTableContainer');
    tableContainer.innerHTML = createSummaryTable(subjData);
    
    // Start waiting timer if exam time not completed
    const timeUsed = EXAM_DURATION_MS - (progress.timeLeftSec * 1000);
    const timeRemaining = EXAM_DURATION_MS - timeUsed;
    
    if (timeRemaining > 0) {
        startWaitingTimer(timeRemaining);
    } else {
        showAutoTransition();
    }
}

function createSummaryTable(subjData) {
    let tableHTML = `
        <table class="results-table">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Correct</th>
                    <th>Wrong</th>
                    <th>Blank</th>
                    <th>Total</th>
                    <th>Marks</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalMarks = 0;
    
    for (const [subject, data] of Object.entries(subjData)) {
        tableHTML += `
            <tr>
                <td>${subject}</td>
                <td>${data.correct}</td>
                <td>${data.wrong}</td>
                <td>${data.blank}</td>
                <td>${data.total}</td>
                <td>${data.marks.toFixed(2)}</td>
            </tr>
        `;
        
        totalCorrect += data.correct;
        totalWrong += data.wrong;
        totalBlank += data.blank;
        totalMarks += data.marks;
    }
    
    tableHTML += `
            <tr class="total-row">
                <td><strong>Total</strong></td>
                <td><strong>${totalCorrect}</strong></td>
                <td><strong>${totalWrong}</strong></td>
                <td><strong>${totalBlank}</strong></td>
                <td><strong>${totalCorrect + totalWrong + totalBlank}</strong></td>
                <td><strong>${totalMarks.toFixed(2)}</strong></td>
            </tr>
        </tbody>
        </table>
    `;
    
    return tableHTML;
}

function startWaitingTimer(timeRemaining) {
    let remainingMs = timeRemaining;
    
    waitingTimerInterval = setInterval(() => {
        remainingMs -= 1000;
        
        const minutes = Math.floor(remainingMs / 60000);
        const seconds = Math.floor((remainingMs % 60000) / 1000);
        
        document.getElementById('waitingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (remainingMs <= 0) {
            clearInterval(waitingTimerInterval);
            showAutoTransition();
        }
    }, 1000);
}

function showAutoTransition() {
    document.getElementById('waitingMessage').style.display = 'none';
    document.getElementById('autoTransitionMessage').style.display = 'block';
    
    let countdown = 5;
    document.getElementById('countdown').textContent = countdown;
    
    autoTransitionTimer = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(autoTransitionTimer);
            showDetailedSolutions();
        }
    }, 1000);
}

function showDetailedSolutions() {
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'block';
    
    // Update student info in review
    const student = progress.student;
    document.getElementById('reviewStudentName').textContent = student.name;
    document.getElementById('reviewSection').textContent = student.sec;
    document.getElementById('reviewRoll').textContent = student.roll;
    document.getElementById('reviewAdm').textContent = student.adm;
    document.getElementById('reviewForm').textContent = assignedForm;
    
    // Create detailed results table
    const detailedContainer = document.getElementById('detailedResultsContainer');
    detailedContainer.innerHTML = createDetailedResultsTable(currentSubjData);
    
    // Create question-by-question review
    createQuestionReview();
}

function createDetailedResultsTable(subjData) {
    let tableHTML = `
        <table class="detailed-results-table">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Correct</th>
                    <th>Wrong</th>
                    <th>Blank</th>
                    <th>Total Questions</th>
                    <th>Marks Obtained</th>
                    <th>Percentage</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalMarks = 0, totalQuestions = 0;
    
    for (const [subject, data] of Object.entries(subjData)) {
        const percentage = ((data.marks / (data.total * MARK_PER_CORRECT)) * 100).toFixed(2);
        const rowClass = percentage >= 40 ? 'highlight' : '';
        
        tableHTML += `
            <tr class="${rowClass}">
                <td><strong>${subject}</strong></td>
                <td>${data.correct}</td>
                <td>${data.wrong}</td>
                <td>${data.blank}</td>
                <td>${data.total}</td>
                <td>${data.marks.toFixed(2)}</td>
                <td>${percentage}%</td>
            </tr>
        `;
        
        totalCorrect += data.correct;
        totalWrong += data.wrong;
        totalBlank += data.blank;
        totalMarks += data.marks;
        totalQuestions += data.total;
    }
    
    const overallPercentage = ((totalMarks / (totalQuestions * MARK_PER_CORRECT)) * 100).toFixed(2);
    
    tableHTML += `
            <tr class="total-row">
                <td><strong>GRAND TOTAL</strong></td>
                <td><strong>${totalCorrect}</strong></td>
                <td><strong>${totalWrong}</strong></td>
                <td><strong>${totalBlank}</strong></td>
                <td><strong>${totalQuestions}</strong></td>
                <td><strong>${totalMarks.toFixed(2)}</strong></td>
                <td><strong>${overallPercentage}%</strong></td>
            </tr>
        </tbody>
        </table>
    `;
    
    return tableHTML;
}

function createQuestionReview() {
    const container = document.getElementById('reviewQuestionsContainer');
    container.innerHTML = '<h3 style="text-align:center; color:#4B0082;">Question-wise Analysis</h3>';
    
    for (let i = 0; i < examData.files.length; i++) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-review-item';
        questionDiv.style.cssText = `
            border: 2px solid #E6E6FA;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;
        
        const studentAnswer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        const isCorrect = studentAnswer === correctAnswer;
        const isAttempted = studentAnswer !== null;
        
        let statusClass = '', statusText = '', statusEmoji = '';
        
        if (!isAttempted) {
            statusClass = 'not-attempted';
            statusText = 'Not Attempted';
            statusEmoji = '‚ö™';
        } else if (isCorrect) {
            statusClass = 'correct';
            statusText = 'Correct';
            statusEmoji = '‚úÖ';
        } else {
            statusClass = 'wrong';
            statusText = 'Wrong';
            statusEmoji = '‚ùå';
        }
        
        questionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #4B0082;">Question ${i + 1}</h4>
                <div class="answer-status ${statusClass}">
                    ${statusEmoji} ${statusText}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                <div>
                    <strong>Your Answer:</strong> 
                    <span class="${isAttempted ? (isCorrect ? 'correct-answer' : 'wrong-answer') : ''}">
                        ${isAttempted ? studentAnswer : 'Not Attempted'}
                    </span>
                </div>
                <div>
                    <strong>Correct Answer:</strong> 
                    <span class="correct-answer">${correctAnswer}</span>
                </div>
            </div>
            
            <div style="text-align: center;">
                <img src="${examData.files[i]}" 
                     alt="Question ${i + 1}" 
                     style="max-width: 100%; height: auto; border-radius: 8px;"
                     onerror="this.style.display='none'">
            </div>
        `;
        
        container.appendChild(questionDiv);
    }
}

// ===== CLOSE BUTTONS =====
document.getElementById('closeSummaryBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to close? Detailed solutions will not be available if you close now.')) {
        window.close();
    }
});

document.getElementById('closeReviewBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to close the exam window?')) {
        window.close();
    }
});

// ===== ADMIN FUNCTIONS =====
document.getElementById('callAdminBtn').addEventListener('click', () => {
    document.getElementById('adminPassModal').style.display = 'flex';
});

document.getElementById('adminPassSubmit').addEventListener('click', () => {
    const password = document.getElementById('adminPassInput').value;
    // Add your admin password check here
    if (password === 'admin123') { // Change this to your actual password
        document.getElementById('adminPassModal').style.display = 'none';
        document.getElementById('fullRedOverlay').style.display = 'none';
        document.getElementById('accessDeniedBox').style.display = 'none';
    } else {
        alert('Incorrect password!');
    }
});

// ===== ERROR HANDLING =====
function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== PROCESS OFFLINE SUBMISSIONS =====
function processOfflineSubmissions() {
    // This would process any submissions that failed while offline
    console.log('üì§ Processing any offline submissions...');
    // Implementation would depend on your specific offline queue system
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîí Initializing security system...');
    
    // Basic security always enabled
    enableBrowserLockdown();
    setupNetworkMonitoring();
    setupScreenshotProtection();
    
    // Load answer key immediately
    loadAnswerKey();
    
    // Check for existing exam progress
    if (restoreExamProgress()) {
        showResumeOption();
    }
    
    // Initialize event listeners
    initializeEventListeners();
    
    console.log('‚úÖ Security system initialized');
});

function initializeEventListeners() {
    // Student input validation - ADD KEYUP EVENT TOO
    const inputs = ['stuName', 'stuSection', 'stuRoll', 'stuAdm'];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        input.addEventListener('input', validateStudentInputs);
        input.addEventListener('keyup', validateStudentInputs); // ADD THIS
        input.addEventListener('change', validateStudentInputs); // ADD THIS
    });
    
    // Start button
    document.getElementById('stuStartBtn').addEventListener('click', startWithSecurity);
    
    // Resume button
    document.getElementById('resumeExamBtn').addEventListener('click', resumeExam);
}

// SIMPLIFIED VALIDATION FUNCTION
function validateStudentInputs() {
    console.log('üîÑ Validating inputs...');
    
    const name = document.getElementById('stuName').value.trim();
    const section = document.getElementById('stuSection').value.trim();
    const roll = document.getElementById('stuRoll').value.trim();
    const adm = document.getElementById('stuAdm').value.trim();
    
    console.log('Input values:', {name, section, roll, adm});
    console.log('Key loaded:', keyLoaded);
    
    // SIMPLIFIED VALIDATION - JUST CHECK IF FIELDS ARE NOT EMPTY
    const nameValid = name.length >= 2;
    const sectionValid = section.length >= 1;
    const rollValid = roll.length >= 1;
    const admValid = adm.length >= 1;
    const keyValid = keyLoaded;
    
    const allValid = nameValid && sectionValid && rollValid && admValid && keyValid;
    
    console.log('Validation results:', {
        nameValid, sectionValid, rollValid, admValid, keyValid, allValid
    });
    
    if (allValid) {
        document.getElementById('stuStartBtn').style.display = 'block';
        document.getElementById('stuStartBtn').disabled = false;
        clearErrors();
        
        const studentData = {
            name: name,
            sec: section,
            roll: roll,
            adm: adm
        };
        updateFormAssignmentDisplay(studentData);
    } else {
        document.getElementById('stuStartBtn').style.display = 'none';
        
        // Show what's missing
        if (!keyLoaded) {
            showError("‚è≥ Loading answer key...");
        } else if (!nameValid) {
            showError("Please enter a valid name (at least 2 characters)");
        } else if (!sectionValid) {
            showError("Please enter section");
        } else if (!rollValid) {
            showError("Please enter roll number");
        } else if (!admValid) {
            showError("Please enter admission number");
        }
    }
    
    return allValid;
}

function startWithSecurity(forceStart = false) {
    if (!validateStudentInputs() && !forceStart) return;
    
    const studentData = {
        name: document.getElementById('stuName').value.trim(),
        sec: document.getElementById('stuSection').value.trim(),
        roll: document.getElementById('stuRoll').value.trim(),
        adm: document.getElementById('stuAdm').value.trim()
    };
    
    const studentId = generateStudentId(studentData);
    
    // Enhanced duplicate check
    if (!forceStart && checkForDuplicateSubmission(studentData)) {
        showDuplicateWarning(studentData);
        return;
    }
    
    // Clear any existing backup to prevent conflicts
    localStorage.removeItem('exam_primary_backup');
    sessionStorage.removeItem('exam_secondary_backup');
    
    startExamWithFullSecurity(studentData);
}

function showResumeOption() {
    document.getElementById('resumeExamSection').style.display = 'block';
}

function resumeExam() {
    if (progress) {
        // Enable security for resumed exam
        enableBrowserLockdown();
        setupPowerFailureProtection();
        setupNetworkMonitoring();
        setupScreenshotProtection();
        startSecurityMonitoring();
        
        document.getElementById('globalSecurityBanner').style.display = 'block';
        examInProgress = true;
        
        document.getElementById('studentEntry').style.display = 'none';
        document.getElementById('examArea').style.display = 'block';
        document.getElementById('examWarning').style.display = 'block';
        
        // Update student info
        const studentData = progress.student;
        document.getElementById('stuInfo').textContent = 
            `${studentData.name} | ${studentData.sec} | Roll: ${studentData.roll}`;
        
        // Restart timer
        startTimer();
        
        // Initialize question palette with enhanced styling
        initPalette();
        
        // Show current question
        showQuestion(progress.currentQ);
        
        // Update violation counter
        if (securityViolations > 0) {
            document.getElementById('violationCounter').style.display = 'block';
            document.getElementById('violationCount').textContent = securityViolations;
        }
        
        console.log('‚úÖ Exam resumed with security');
    }
}

// EMERGENCY FIX - FORCE BUTTON TO APPEAR AFTER 3 SECONDS
setTimeout(() => {
    console.log('üö® EMERGENCY: Checking if start button is visible...');
    const startBtn = document.getElementById('stuStartBtn');
    if (startBtn.style.display === 'none') {
        console.log('üö® EMERGENCY: Forcing start button to appear');
        startBtn.style.display = 'block';
        startBtn.disabled = false;
        startBtn.style.background = 'linear-gradient(145deg, #32CD32, #228B22)';
        startBtn.style.color = 'white';
        startBtn.innerHTML = 'üöÄ START EXAM (READY)';
        
        // Add test data automatically for quick testing
        document.getElementById('stuName').value = 'Test Student';
        document.getElementById('stuSection').value = 'A1';
        document.getElementById('stuRoll').value = '25';
        document.getElementById('stuAdm').value = '1001';
        
        console.log('‚úÖ Emergency start button activated');
    }
}, 3000);

console.log('‚úÖ LFJC Examination System initialized successfully');
</script>
</body>
</html>
