<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* ===== RESET & BASE STYLES ===== */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: Arial, sans-serif;
  background: white;
  color: black;
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Disable right-click context menu */
body {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* ===== HEADER & FOOTER ===== */
header {
  background: linear-gradient(145deg, #E6E6FA, #D8BFD8);
  color: #4B0082;
  text-align: center;
  padding: 20px;
  font-size: 36px;
  font-weight: bold;
  letter-spacing: 1.5px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  text-shadow: 0 1px 2px white;
}

footer {
  background: #E6E6FA;
  color: #4B0082;
  padding: 10px;
  text-align: center;
  font-weight: bold;
  position: fixed;
  width: 100%;
  bottom: 0;
  z-index: 100;
}

/* ===== ACCESS DENIED SCREEN ===== */
#accessDenied {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #4B0082, #8A2BE2);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
  padding: 20px;
}

#accessDenied h1 {
  font-size: 3em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

#accessDenied p {
  font-size: 1.2em;
  margin: 5px 0;
  max-width: 800px;
  line-height: 1.5;
}

.access-code-input {
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  width: 300px;
  text-align: center;
  margin: 20px 0;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn {
  background: white;
  color: #4B0082;
  border: none;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.access-error {
  color: #ffeb3b;
  margin-top: 10px;
  font-weight: 600;
  display: none;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 140px);
  padding: 20px;
  text-align: center;
}

.form-group {
  margin: 25px 0;
  width: 100%;
  max-width: 500px;
}

.form-group label {
  display: block;
  font-size: 1.2rem;
  font-weight: 600;
  color: #4B0082;
  margin-bottom: 10px;
}

input[type="text"] {
  width: 100%;
  padding: 12px 15px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: 2px solid #4B0082;
  outline: none;
  transition: all 0.3s ease;
}

input[type="text"]:focus {
  border-color: #4B0082;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
  border-color: #ff6666;
  animation: glowRed 0.5s alternate infinite;
}

@keyframes glowRed {
  0% { box-shadow: 0 0 5px #ff6666; }
  100% { box-shadow: 0 0 15px #ff6666; }
}

/* ===== BUTTON STYLES ===== */
button {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: none;
  border-radius: 12px;
  transition: all 0.3s ease;
  background: linear-gradient(to bottom, #fafaff, #dcd6f7);
  color: #4B0082;
  font-weight: 600;
  padding: 12px 24px;
  font-size: 18px;
  margin: 10px;
  box-shadow: 0 6px #aaa;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,0.2);
}

button:active {
  transform: translateY(3px) scale(0.98);
}

/* ===== EXAM AREA STYLES ===== */
#examArea {
  display: none;
  padding: 20px;
  min-height: calc(100vh - 140px);
}

#examHeader {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 15px;
  background: #f0f0ff;
  border-radius: 10px;
  border: 2px solid #E6E6FA;
  flex-wrap: wrap;
}

#stuInfo, #stuQInfo {
  font-weight: bold;
  color: #4B0082;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

#stuInfo {
  flex: 1;
  text-align: left;
}

#stuQInfo {
  flex: 1;
  text-align: center;
}

#timerEl {
  font-size: 20px;
  font-weight: bold;
  color: #4B0082;
  padding: 8px 16px;
  border-radius: 6px;
  background: #f0f0ff;
  display: inline-block;
  transition: all 0.3s ease;
  flex: 1;
  text-align: right;
}

#timerEl.blink {
  animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
  0% { background: #ff6666; color: white; }
  50% { background: white; color: #4B0082; }
  100% { background: #ff6666; color: white; }
}

/* ===== QUESTION CONTAINER STYLES ===== */
#questionContainer {
  text-align: center;
  margin: 20px 0;
}

.question-number {
  font-size: 24px;
  font-weight: bold;
  color: #4B0082;
  margin: 15px 0;
  padding: 10px;
  background: #f0f0ff;
  border-radius: 8px;
  display: inline-block;
}

.sectionTitle {
  font-size: 22px;
  color: #4B0082;
  font-weight: bold;
  margin-bottom: 20px;
}

/* ===== IMAGE DISPLAY STYLES ===== */
.questionImg {
  max-width: 90%;
  height: auto;
  max-height: 500px;
  display: block;
  margin: 20px auto;
  border: 2px solid #E6E6FA;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  background: #f9f9f9;
  object-fit: contain;
}

/* ===== OPTIONS STYLES ===== */
.options-container {
  margin: 30px 0;
  padding: 20px;
}

.optBtn {
  font-size: 18px;
  padding: 12px 24px;
  margin: 10px;
  border: 2px solid #4B0082;
  background: white;
  border-radius: 8px;
  box-shadow: 0 5px #aaa;
  min-width: 80px;
}

.optBtn.selected {
  background: #32CD32;
  color: white;
  border-color: #228B22;
}

.optBtn:hover {
  transform: translateY(-2px);
  box-shadow: 0 7px #888;
}

/* ===== NAVIGATION BUTTONS ===== */
.navContainer {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 30px 0;
  flex-wrap: wrap;
}

.navBtn {
  font-size: 16px;
  padding: 12px 24px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(145deg, #1E90FF, #4682B4);
  min-width: 120px;
}

#markReviewBtn {
  background: linear-gradient(145deg, #ffb84d, #ff9900);
}

#submitBtn {
  background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== PALETTE STYLES ===== */
#paletteContainer {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 10px;
  margin: 30px auto;
  max-width: 500px;
  padding: 20px;
  background: #f8f8ff;
  border-radius: 10px;
  border: 2px solid #E6E6FA;
}

#paletteContainer button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 14px;
  margin: 0;
  border: 1px solid #4B0082;
  background: #E6E6FA;
  color: #4B0082;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  box-shadow: 0 3px #aaa;
}

#paletteContainer button.selected {
  background: #32CD32;
  color: white;
  border-color: #2fa92f;
}

#paletteContainer button.current {
  border: 3px solid red;
  box-shadow: 0 0 0 2px white;
}

#paletteContainer button.reviewed {
  background: yellow;
  color: black;
}

/* ===== NUMERICAL INPUT STYLES ===== */
.fill-blank-container {
  margin: 30px 0;
  padding: 20px;
  background: #f8f8ff;
  border-radius: 10px;
  border: 2px dashed #4B0082;
}

.fill-blank-input {
  padding: 15px;
  font-size: 24px;
  border: 2px solid #4B0082;
  border-radius: 8px;
  width: 200px;
  text-align: center;
  outline: none;
  font-weight: bold;
  margin: 10px;
}

.submit-fill-blank-btn {
  padding: 15px 30px;
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  margin: 10px;
}

.numerical-keypad {
  margin: 20px auto;
  max-width: 250px;
}

.keypad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 10px;
  border: 2px solid #4B0082;
}

.num-key-btn {
  width: 50px;
  height: 50px;
  font-size: 20px;
  font-weight: bold;
  border: 1px solid #4B0082;
  border-radius: 8px;
  background: white;
  color: #4B0082;
  cursor: pointer;
}

.num-key-btn:hover {
  background: #f0f0ff;
  transform: translateY(-2px);
}

.clear-btn {
  background: linear-gradient(145deg, #ff9900, #ff8c00);
  color: white;
  border-color: #ff8c00;
}

.submit-num-btn {
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
  border-color: #228B22;
}

/* ===== LOADING & ERROR STYLES ===== */
.loading-container {
  min-height: 400px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: #f9f9f9;
  border: 2px dashed #4B0082;
  border-radius: 10px;
  margin: 20px 0;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 5px solid #f3f3f3;
  border-top: 5px solid #4B0082;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.image-error {
  background: #ffebee;
  border: 2px solid #ffcdd2;
  color: #c62828;
  padding: 30px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  font-weight: bold;
  min-height: 300px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.image-error h3 {
  margin: 0 0 10px 0;
  color: #c62828;
  font-size: 24px;
}

/* ===== SUMMARY AREA STYLES ===== */
#summaryArea, #reviewArea {
  display: none;
  padding: 20px;
  min-height: calc(100vh - 140px);
}

.area-header {
  text-align: center;
  margin-bottom: 30px;
  padding: 20px;
  background: #f0f0ff;
  border-radius: 10px;
  border: 2px solid #E6E6FA;
}

.area-header h2 {
  color: #4B0082;
  margin-bottom: 10px;
  font-size: 28px;
}

.results-table {
  width: 100%;
  max-width: 900px;
  margin: 30px auto;
  border-collapse: collapse;
  font-size: 18px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.results-table th {
  background: #4B0082;
  color: white;
  padding: 18px;
  border: 1px solid #4B0082;
  font-weight: bold;
}

.results-table td {
  padding: 18px;
  border: 1px solid #4B0082;
}

.results-table tr:nth-child(even) {
  background: #f8f6ff;
}

.results-table tr:hover {
  background: #f0f0ff;
}

.results-table .total-row {
  background: #D8BFD8 !important;
  font-weight: bold;
  font-size: 20px;
}

/* ===== REVIEW AREA STYLES ===== */
.solution-container {
  margin: 20px 0;
  padding: 20px;
  border: 2px solid #E6E6FA;
  border-radius: 10px;
  background: white;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.solution-question {
  font-size: 20px;
  font-weight: bold;
  color: #4B0082;
}

.solution-answer {
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  font-size: 18px;
}

.solution-correct {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.solution-wrong {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.solution-not-attempted {
  background: #e2e3e5;
  color: #383d41;
  border: 1px solid #d6d8db;
}

/* ===== ERROR MESSAGE STYLES ===== */
.error-message {
  color: #ff3333;
  font-weight: 600;
  padding: 15px;
  margin: 15px 0;
  border-radius: 8px;
  background: rgba(255, 102, 102, 0.1);
  border: 1px solid #ff6666;
  text-align: center;
}

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 768px) {
  header {
    font-size: 28px;
    padding: 15px;
  }
  
  #examHeader {
    flex-direction: column;
    gap: 10px;
    text-align: center;
  }
  
  #stuInfo, #stuQInfo, #timerEl {
    text-align: center !important;
    flex: none;
    width: 100%;
  }
  
  .questionImg {
    max-width: 95%;
    max-height: 400px;
  }
  
  .navContainer {
    flex-direction: column;
    align-items: center;
  }
  
  .navBtn {
    width: 90%;
    margin: 5px 0;
  }
  
  #paletteContainer {
    grid-template-columns: repeat(5, 1fr);
    max-width: 300px;
    gap: 8px;
  }
  
  #paletteContainer button {
    width: 35px;
    height: 35px;
    font-size: 12px;
  }
  
  .form-group {
    max-width: 90%;
  }
  
  .access-code-input {
    width: 90%;
  }
  
  #accessDenied h1 {
    font-size: 2em;
  }
  
  .area-header h2 {
    font-size: 24px;
  }
  
  .results-table {
    font-size: 16px;
  }
  
  .results-table th,
  .results-table td {
    padding: 12px;
  }
}

@media (max-width: 480px) {
  header {
    font-size: 24px;
  }
  
  #paletteContainer {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .questionImg {
    max-height: 300px;
  }
  
  .optBtn {
    padding: 10px 15px;
    margin: 5px;
    min-width: 60px;
    font-size: 16px;
  }
  
  .fill-blank-input {
    width: 150px;
    font-size: 20px;
  }
  
  .keypad-grid {
    max-width: 200px;
  }
  
  .num-key-btn {
    width: 40px;
    height: 40px;
    font-size: 16px;
  }
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.question-fade-in {
  animation: fadeIn 0.3s ease-in-out;
}

/* ===== SCROLLBAR STYLES ===== */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
}

::-webkit-scrollbar-thumb {
  background: #4B0082;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: #8A2BE2;
}
</style>
</head>

<body>

<!-- Access Denied Screen -->
<div id="accessDenied">
    <h1>LFJC ONLINE EXAMINATION</h1>
    <p style="font-size: 1.2em; margin: 10px 0;">TOTAL 75 QUESTIONS</p>
    <p style="margin: 5px 0;">‚Ä¢ Maths: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Physics: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Chemistry: 20 (MCQ), 5 (Numerical Input)</p>
    <p style="margin: 10px 0; font-weight: bold;">CORRECT ANSWER + 4 MARKS</p>
    <p style="margin: 5px 0; font-weight: bold;">WRONG ANSWER -1 MARK</p>
    <p style="margin: 15px 0; max-width: 600px; line-height: 1.5;">
        Enter the access code provided by your instructor to begin the examination.
    </p>
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<!-- Student Entry -->
<div id="studentEntry">
  <div class="form-group">
    <label>NAME</label>
    <input type="text" id="stuName" placeholder="Enter your full name" autocomplete="off">
  </div>
  <div class="form-group">
    <label>SECTION</label>
    <input type="text" id="stuSection" placeholder="Enter your section" autocomplete="off">
  </div>
  <div class="form-group">
    <label>ROLL NUMBER</label>
    <input type="text" id="stuRoll" placeholder="Enter roll number" autocomplete="off">
  </div>
  <div class="form-group">
    <label>ADMISSION NUMBER</label>
    <input type="text" id="stuAdm" placeholder="Enter admission number" autocomplete="off">
  </div>
  <button id="stuStartBtn" style="display:none;">Start Exam</button>
  <div id="errorMessages"></div>
</div>

<!-- Exam Area -->
<div id="examArea">
  <div id="examHeader">
    <div id="stuInfo"></div>
    <div id="stuQInfo"></div>
    <div id="timerEl">üïí 00:00</div>
  </div>

  <div id="questionContainer"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Mark for Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div style="margin-top: 10px;">
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeSummaryBtn" class="navBtn">Close</button>
  </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div style="margin-top: 10px;">
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span>
    </div>
  </div>
  
  <div id="detailedResultsContainer" style="overflow-x:auto;"></div>
  
  <div id="reviewQuestionsContainer" style="margin-top: 30px;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn">Close</button>
  </div>
</div>

<footer>@LFJC2025 All Rights Reserved</footer>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4;
const MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 180; // 3 hours
const MAX_QUESTIONS = 75;
const ACCESS_CODE = "lfjc2025";

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let examData = {
  files: [],
  subjectNames: [],
  keys: [],
  originalOrder: [],
  questionTypes: []
};
let progress = null;
let timerInterval = null;
let examInProgress = false;
let hasSubmitted = false;

// ===== EMBEDDED ANSWER KEY =====
const EMBEDDED_ANSWER_KEY = [
  // Physics MCQ Q1-20
  "B","A","A","A","B",      // 1-5
  "B","A","B","C","C",      // 6-10
  "B","A","D","C","A",      // 11-15
  "A","A","C","B","A",      // 16-20
  // Physics Numerical Q21-25
  "7","125","4","7","770",
  // Chemistry MCQ Q26-45
  "B","B","C","A","D",      // 26-30
  "C","B","B","C","A",      // 31-35
  "C","C","A","C","D",      // 36-40
  "A","A","B","C","A",      // 41-45
  // Chemistry Numerical Q46-50
  "3","11","3","4","2",
  // Maths MCQ Q51-70
  "A","A","B","B","A",      // 51-55
  "A","C","B","D","A",      // 56-60
  "C","B","C","B","A",      // 61-65
  "A","D","D","C","B",      // 66-70
  // Maths Numerical Q71-75
  "1328","0","15","0","8"
];

// ===== INITIALIZATION =====
function initializeSystem() {
  console.log("üöÄ Initializing LFJC Online Exam System...");
  
  try {
    // Load answer key
    answerKey = [...EMBEDDED_ANSWER_KEY];
    console.log("‚úÖ Answer key loaded:", answerKey.length, "answers");
    
    // Create image paths
    images = [];
    for (let i = 1; i <= MAX_QUESTIONS; i++) {
      images.push(`questions/${i}.png`);
    }
    console.log("‚úÖ Image paths created:", images.length);
    
    // Setup event listeners
    setupEventListeners();
    
    // Show access screen
    document.getElementById('accessDenied').style.display = 'flex';
    document.getElementById('accessCode').focus();
    
    console.log("‚úÖ System initialized successfully");
    
  } catch (error) {
    console.error("‚ùå Initialization failed:", error);
    showError("System initialization failed. Please refresh the page.");
  }
}

// ===== EVENT LISTENERS =====
function setupEventListeners() {
  // Access code verification
  document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
  document.getElementById('accessCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') verifyAccessCode();
  });
  
  // Student input validation
  const inputIds = ["stuName", "stuSection", "stuRoll", "stuAdm"];
  inputIds.forEach(id => {
    document.getElementById(id).addEventListener("input", validateStudentInputs);
  });
  
  // Start exam button
  document.getElementById('stuStartBtn').addEventListener('click', startExam);
  
  // Navigation buttons
  document.getElementById('prevBtn').addEventListener('click', () => navigate(-1));
  document.getElementById('nextBtn').addEventListener('click', () => navigate(1));
  document.getElementById('markReviewBtn').addEventListener('click', toggleReview);
  document.getElementById('submitBtn').addEventListener('click', confirmSubmit);
  
  // Close buttons
  document.getElementById('closeSummaryBtn').addEventListener('click', () => {
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  });
  
  document.getElementById('closeReviewBtn').addEventListener('click', () => {
    document.getElementById('reviewArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', handleKeyboardShortcuts);
  
  // Prevent context menu
  document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
  });
  
  // Prevent image dragging
  document.addEventListener('dragstart', function(e) {
    if (e.target.tagName === 'IMG') {
      e.preventDefault();
      return false;
    }
  });
}

// ===== ACCESS CODE =====
function verifyAccessCode() {
  const enteredCode = document.getElementById('accessCode').value.trim();
  const errorElement = document.getElementById('accessError');
  
  if (enteredCode === ACCESS_CODE) {
    document.getElementById('accessDenied').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    document.getElementById('stuName').focus();
    document.getElementById('accessCode').value = '';
    errorElement.style.display = 'none';
  } else {
    errorElement.style.display = 'block';
    document.getElementById('accessCode').value = '';
    document.getElementById('accessCode').focus();
  }
}

// ===== STUDENT VALIDATION =====
function validateStudentInputs() {
  const n = document.getElementById('stuName');
  const s = document.getElementById('stuSection');
  const r = document.getElementById('stuRoll');
  const a = document.getElementById('stuAdm');
  
  // Convert section to uppercase
  if (s.value) s.value = s.value.toUpperCase();
  
  const v1 = /^[A-Za-z .]+$/.test(n.value);
  const v2 = /^[A-Za-z0-9]+$/.test(s.value);
  const v3 = /^[0-9]+$/.test(r.value);
  const v4 = /^[0-9]+$/.test(a.value);
  
  // Update input styles
  n.classList.toggle('error', !v1 && n.value !== '');
  s.classList.toggle('error', !v2 && s.value !== '');
  r.classList.toggle('error', !v3 && r.value !== '');
  a.classList.toggle('error', !v4 && a.value !== '');
  
  // Show/hide start button
  const startBtn = document.getElementById('stuStartBtn');
  startBtn.style.display = (v1 && v2 && v3 && v4) ? 'inline-block' : 'none';
  
  // Clear errors if all valid
  if (v1 && v2 && v3 && v4) {
    clearErrors();
  }
  
  return v1 && v2 && v3 && v4;
}

function showError(message) {
  const errorDiv = document.getElementById('errorMessages');
  errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

function clearErrors() {
  document.getElementById('errorMessages').innerHTML = '';
}

// ===== START EXAM =====
function startExam() {
  if (!validateStudentInputs()) {
    showError("Please fill all fields correctly.");
    return;
  }
  
  const stuName = document.getElementById('stuName');
  const stuSection = document.getElementById('stuSection');
  const stuRoll = document.getElementById('stuRoll');
  const stuAdm = document.getElementById('stuAdm');
  
  console.log("üéØ Starting exam for:", stuName.value);
  
  // Prepare exam data
  prepareExamData();
  
  // Initialize progress
  progress = {
    answers: new Array(examData.files.length).fill(null),
    review: new Array(examData.files.length).fill(false),
    currentIndex: 0,
    student: {
      name: stuName.value,
      sec: stuSection.value,
      roll: stuRoll.value,
      adm: stuAdm.value
    },
    timeLeftSec: EXAM_DURATION_MINUTES * 60
  };
  
  // Switch to exam view
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'block';
  
  // Start exam
  renderQuestion();
  renderPalette();
  startTimer();
  updateNavButtons();
  
  examInProgress = true;
  console.log("‚úÖ Exam started successfully");
}

// ===== PREPARE EXAM DATA =====
function prepareExamData() {
  console.log("üìä Preparing exam data...");
  
  // Clear existing data
  examData.files = [];
  examData.subjectNames = [];
  examData.keys = [];
  examData.originalOrder = [];
  examData.questionTypes = [];
  
  // Define subject ranges
  const subjectRanges = [
    { name: "Physics", start: 1, end: 25 },
    { name: "Chemistry", start: 26, end: 50 },
    { name: "Maths", start: 51, end: 75 }
  ];
  
  let groups = [];
  
  // Process each subject
  subjectRanges.forEach(subject => {
    const subjectQuestions = [];
    const subjectKeys = [];
    const subjectOriginalOrder = [];
    const subjectTypes = [];
    
    for (let i = subject.start; i <= subject.end; i++) {
      const imgIndex = i - 1;
      if (images[imgIndex] && answerKey[imgIndex]) {
        subjectQuestions.push(images[imgIndex]);
        subjectKeys.push(answerKey[imgIndex]);
        subjectOriginalOrder.push(imgIndex);
        
        // Determine question type
        let questionType = 'mcq';
        if ((subject.name === "Physics" && i >= 21 && i <= 25) ||
            (subject.name === "Chemistry" && i >= 46 && i <= 50) ||
            (subject.name === "Maths" && i >= 71 && i <= 75)) {
          questionType = 'fill-blank';
        }
        subjectTypes.push(questionType);
      }
    }
    
    console.log(`${subject.name}: ${subjectQuestions.length} questions`);
    
    // Shuffle within subject
    const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
    
    groups.push({
      name: subject.name,
      imgs: shuffledIndices.map(i => subjectQuestions[i]),
      keys: shuffledIndices.map(i => subjectKeys[i]),
      originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i]),
      types: shuffledIndices.map(i => subjectTypes[i])
    });
  });
  
  // Shuffle subjects
  const shuffledGroups = shuffleArray(groups);
  
  // Build final exam data
  shuffledGroups.forEach(g => {
    g.imgs.forEach((img, i) => {
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
      examData.originalOrder.push(g.originalOrder[i]);
      examData.questionTypes.push(g.types[i]);
    });
  });
  
  console.log("‚úÖ Exam data prepared:", examData.files.length, "questions");
  console.log("Subject distribution:");
  console.log("- Physics:", examData.subjectNames.filter(s => s === "Physics").length);
  console.log("- Chemistry:", examData.subjectNames.filter(s => s === "Chemistry").length);
  console.log("- Maths:", examData.subjectNames.filter(s => s === "Maths").length);
}

// ===== RENDER QUESTION =====
function renderQuestion() {
  const idx = progress.currentIndex;
  const container = document.getElementById('questionContainer');
  
  const imagePath = examData.files[idx];
  const questionNumber = idx + 1;
  const subject = examData.subjectNames[idx];
  const questionType = examData.questionTypes[idx];
  
  console.log(`üñºÔ∏è Rendering question ${questionNumber}: ${subject} (${questionType})`);
  
  // Create HTML structure
  let html = `
    <div class="question-fade-in">
      <div class="question-number">Question ${questionNumber} of ${MAX_QUESTIONS}</div>
      <div class="sectionTitle">${subject} ${questionType === 'fill-blank' ? '(Numerical Input)' : '(MCQ)'}</div>
      
      <div id="imageContainer" class="loading-container">
        <div class="loading-spinner"></div>
        <div style="margin-top: 20px; font-weight: bold; color: #4B0082;">
          Loading question image...
        </div>
      </div>
      
      <div class="options-container" id="optionsContainer">
  `;
  
  if (questionType === 'fill-blank') {
    html += `
      <div class="fill-blank-container">
        <div style="margin: 20px 0; font-weight: bold; color: #4B0082; font-size: 18px;">
          Enter numerical answer:
        </div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 25px 0; flex-wrap: wrap;">
          <input type="number" 
                 id="fillBlankInput" 
                 class="fill-blank-input"
                 placeholder="Enter number"
                 value="${progress.answers[idx] || ''}"
                 min="0"
                 step="any"
                 tabindex="0">
          <button class="submit-fill-blank-btn" 
                  onclick="submitNumericalAnswer(${idx})"
                  tabindex="0">
            Submit
          </button>
        </div>
        
        <!-- Numerical Keypad -->
        <div class="numerical-keypad">
          <div class="keypad-grid">
            ${[1,2,3,4,5,6,7,8,9].map(num => `
              <button class="num-key-btn" 
                      onclick="handleKeypadButton('${num}', ${idx})"
                      tabindex="0">
                ${num}
              </button>
            `).join('')}
            <button class="num-key-btn special-btn" 
                    onclick="handleKeypadButton('0', ${idx})"
                    tabindex="0">
              0
            </button>
            <button class="num-key-btn special-btn clear-btn" 
                    onclick="handleKeypadButton('C', ${idx})"
                    tabindex="0">
              C
            </button>
            <button class="num-key-btn special-btn submit-num-btn" 
                    onclick="handleKeypadButton('‚úì', ${idx})"
                    tabindex="0">
              ‚úì
            </button>
          </div>
        </div>
      </div>
    `;
  } else {
    html += `
      <div>
        <button class="optBtn ${progress.answers[idx] === 'A' ? 'selected' : ''}" 
                data-opt="A" tabindex="0">A</button>
        <button class="optBtn ${progress.answers[idx] === 'B' ? 'selected' : ''}" 
                data-opt="B" tabindex="0">B</button>
        <button class="optBtn ${progress.answers[idx] === 'C' ? 'selected' : ''}" 
                data-opt="C" tabindex="0">C</button>
        <button class="optBtn ${progress.answers[idx] === 'D' ? 'selected' : ''}" 
                data-opt="D" tabindex="0">D</button>
      </div>
    `;
  }
  
  html += `</div></div>`;
  
  container.innerHTML = html;
  
  // Load image
  loadQuestionImage(imagePath, questionNumber);
  
  // Setup option buttons for MCQ
  if (questionType === 'mcq') {
    document.querySelectorAll('.optBtn').forEach(btn => {
      btn.addEventListener('click', function() {
        selectOption(this.getAttribute('data-opt'));
      });
    });
  }
  
  // Update info displays
  updateQuestionInfo();
  updatePalette();
}

// ===== LOAD QUESTION IMAGE =====
function loadQuestionImage(imagePath, questionNumber) {
  const container = document.getElementById('imageContainer');
  
  const img = new Image();
  img.className = 'questionImg';
  img.alt = `Question ${questionNumber}`;
  
  img.onload = function() {
    console.log(`‚úÖ Image loaded: ${imagePath}`);
    container.innerHTML = '';
    container.appendChild(img);
  };
  
  img.onerror = function() {
    console.error(`‚ùå Failed to load image: ${imagePath}`);
    container.innerHTML = `
      <div class="image-error">
        <h3>‚ö†Ô∏è Question Image Not Available</h3>
        <p>Question ${questionNumber} image could not be loaded.</p>
        <p style="margin-top: 15px; font-size: 16px;">
          <strong>Please continue with the question using the options below.</strong>
        </p>
        <div style="margin-top: 20px; padding: 15px; background: #fff; border-radius: 8px; border: 1px solid #ddd;">
          <p style="margin: 0; color: #666;">
            <strong>Note:</strong> This does not affect your ability to answer the question.
            <br>Your answer will still be recorded normally.
          </p>
        </div>
      </div>
    `;
  };
  
  // Set a timeout to handle slow loading
  setTimeout(() => {
    if (container.innerHTML.includes('loading-spinner')) {
      console.log(`‚è∞ Image load timeout: ${imagePath}`);
      container.innerHTML = `
        <div class="image-error">
          <h3>‚ö†Ô∏è Image Loading Timeout</h3>
          <p>Question ${questionNumber} image is taking too long to load.</p>
          <p style="margin-top: 15px; font-size: 16px;">
            <strong>Please continue with the question using the options below.</strong>
          </p>
        </div>
      `;
    }
  }, 5000);
  
  img.src = imagePath;
}

// ===== SELECT OPTION =====
function selectOption(opt) {
  const idx = progress.currentIndex;
  
  if (examData.questionTypes[idx] !== 'mcq') {
    console.log(`Cannot select option for non-MCQ question ${idx + 1}`);
    return;
  }
  
  if (progress.answers[idx] === opt) {
    progress.answers[idx] = null;
    console.log(`Deselected option ${opt} for question ${idx + 1}`);
  } else {
    progress.answers[idx] = opt;
    console.log(`Selected option ${opt} for question ${idx + 1}`);
  }
  
  // Update UI
  updateOptionButtons();
  updatePalette();
}

function updateOptionButtons() {
  const idx = progress.currentIndex;
  const currentAnswer = progress.answers[idx];
  
  document.querySelectorAll('.optBtn').forEach(btn => {
    const btnOpt = btn.getAttribute('data-opt');
    btn.classList.toggle('selected', btnOpt === currentAnswer);
  });
}

// ===== NUMERICAL ANSWER HANDLING =====
function handleNumericalKeyPress(event, questionIndex) {
  const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '-', 
                      'Backspace', 'Delete', 'Tab', 'Enter'];
  
  if (!allowedKeys.includes(event.key) && !event.ctrlKey && !event.altKey) {
    event.preventDefault();
    return;
  }
  
  if (event.key === 'Enter') {
    submitNumericalAnswer(questionIndex);
    event.preventDefault();
  }
}

function handleKeypadButton(button, questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  let currentValue = input.value;
  
  switch(button) {
    case 'C':
      input.value = '';
      break;
    case '‚úì':
      submitNumericalAnswer(questionIndex);
      break;
    default:
      input.value = currentValue + button;
      break;
  }
  
  input.focus();
}

function submitNumericalAnswer(questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  const answer = input.value.trim();
  
  if (answer === '') {
    alert('Please enter a numerical answer');
    return;
  }
  
  if (!/^-?\d+(\.\d+)?$/.test(answer)) {
    alert('Please enter a valid number');
    return;
  }
  
  progress.answers[questionIndex] = answer;
  alert('‚úì Answer submitted!');
  updatePalette();
  
  // Auto go to next question
  if (questionIndex < examData.files.length - 1) {
    progress.currentIndex++;
    renderQuestion();
    updateNavButtons();
  }
}

// ===== UPDATE QUESTION INFO =====
function updateQuestionInfo() {
  const idx = progress.currentIndex;
  
  const stuInfo = document.getElementById('stuInfo');
  const stuQInfo = document.getElementById('stuQInfo');
  
  if (stuInfo) {
    stuInfo.textContent = `${progress.student.name} | ${progress.student.sec} | Roll: ${progress.student.roll}`;
  }
  
  if (stuQInfo) {
    stuQInfo.textContent = `Q${idx + 1} of ${MAX_QUESTIONS} | ${examData.subjectNames[idx]}`;
  }
}

// ===== PALETTE FUNCTIONS =====
function renderPalette() {
  const container = document.getElementById('paletteContainer');
  container.innerHTML = '';
  
  for (let i = 0; i < examData.files.length; i++) {
    const btn = document.createElement('button');
    btn.textContent = i + 1;
    btn.tabindex = "0";
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
    
    btn.addEventListener('click', () => {
      progress.currentIndex = i;
      renderQuestion();
      updateNavButtons();
    });
    
    container.appendChild(btn);
  }
}

function updatePalette() {
  const buttons = document.querySelectorAll('#paletteContainer button');
  buttons.forEach((btn, i) => {
    btn.classList.remove('selected', 'reviewed', 'current');
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    } else {
      btn.style.background = '';
      btn.style.color = '';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
  });
}

// ===== NAVIGATION =====
function navigate(direction) {
  const newIndex = progress.currentIndex + direction;
  
  if (newIndex >= 0 && newIndex < examData.files.length) {
    progress.currentIndex = newIndex;
    renderQuestion();
    updateNavButtons();
  }
}

function toggleReview() {
  const idx = progress.currentIndex;
  progress.review[idx] = !progress.review[idx];
  
  const btn = document.getElementById('markReviewBtn');
  btn.textContent = progress.review[idx] ? 'Unmark Review' : 'Mark for Review';
  
  updatePalette();
}

function updateNavButtons() {
  const idx = progress.currentIndex;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  
  prevBtn.disabled = idx === 0;
  nextBtn.disabled = idx === examData.files.length - 1;
  
  const reviewBtn = document.getElementById('markReviewBtn');
  reviewBtn.textContent = progress.review[idx] ? 'Unmark Review' : 'Mark for Review';
}

// ===== TIMER =====
function startTimer() {
  const timerEl = document.getElementById('timerEl');
  
  timerInterval = setInterval(() => {
    progress.timeLeftSec--;
    
    if (progress.timeLeftSec <= 0) {
      clearInterval(timerInterval);
      submitExam();
      return;
    }
    
    const minutes = Math.floor(progress.timeLeftSec / 60);
    const seconds = progress.timeLeftSec % 60;
    timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (progress.timeLeftSec <= 300) { // 5 minutes warning
      timerEl.classList.add('blink');
    }
  }, 1000);
}

// ===== SUBMIT EXAM =====
function confirmSubmit() {
  if (confirm("Are you sure you want to submit the exam? You cannot change answers after submission.")) {
    submitExam();
  }
}

function submitExam() {
  if (hasSubmitted) return;
  
  clearInterval(timerInterval);
  hasSubmitted = true;
  examInProgress = false;
  
  console.log("üì§ Submitting exam...");
  
  // Calculate results
  const subjData = {};
  examData.subjectNames.forEach((s, i) => {
    const subjectName = s;
    if (!subjData[subjectName]) {
      subjData[subjectName] = {
        correct: 0,
        wrong: 0,
        blank: 0,
        total: 0,
        marks: 0,
        mcq: { total: 0, correct: 0 },
        fillBlank: { total: 0, correct: 0 }
      };
    }
    
    const ans = progress.answers[i];
    const questionType = examData.questionTypes[i];
    
    // Track by question type
    if (questionType === 'mcq') {
      subjData[subjectName].mcq.total++;
    } else {
      subjData[subjectName].fillBlank.total++;
    }
    
    if (ans === null) {
      subjData[subjectName].blank++;
    } else if (ans === examData.keys[i]) {
      subjData[subjectName].correct++;
      subjData[subjectName].marks += MARK_PER_CORRECT;
      
      if (questionType === 'mcq') {
        subjData[subjectName].mcq.correct++;
      } else {
        subjData[subjectName].fillBlank.correct++;
      }
    } else {
      subjData[subjectName].wrong++;
      subjData[subjectName].marks += MARK_PER_WRONG;
    }
    subjData[subjectName].total++;
  });
  
  // Store subject data for review
  window.currentSubjData = subjData;
  
  // Show summary
  showSummary(subjData);
}

// ===== SHOW SUMMARY =====
function showSummary(subjData) {
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'block';
  
  document.getElementById('summaryStudentName').textContent = progress.student.name;
  document.getElementById('summarySection').textContent = progress.student.sec;
  document.getElementById('summaryRoll').textContent = progress.student.roll;
  document.getElementById('summaryAdm').textContent = progress.student.adm;
  
  // Create results table
  let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalQs = 0, totalMarks = 0;
  
  let html = `<table class="results-table" border="1">
    <thead>
      <tr>
        <th>Subject</th>
        <th>MCQ (Correct/Total)</th>
        <th>Numerical (Correct/Total)</th>
        <th>Total Correct</th>
        <th>Wrong</th>
        <th>Blank</th>
        <th>Total</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>`;
  
  for (let subject in subjData) {
    const data = subjData[subject];
    const per = ((data.correct / data.total) * 100).toFixed(2);
    
    html += `<tr>
      <td>${subject}</td>
      <td>${data.mcq.correct}/${data.mcq.total}</td>
      <td>${data.fillBlank.correct}/${data.fillBlank.total}</td>
      <td>${data.correct}</td>
      <td>${data.wrong}</td>
      <td>${data.blank}</td>
      <td>${data.total}</td>
      <td>${data.marks.toFixed(2)}</td>
    </tr>`;
    
    totalCorrect += data.correct;
    totalWrong += data.wrong;
    totalBlank += data.blank;
    totalQs += data.total;
    totalMarks += data.marks;
  }
  
  const totalPer = totalQs > 0 ? ((totalCorrect / totalQs) * 100).toFixed(2) : 0;
  
  html += `<tr class="total-row">
    <td><strong>Total</strong></td>
    <td><strong>${subjData.Physics ? subjData.Physics.mcq.correct + subjData.Chemistry.mcq.correct + subjData.Maths.mcq.correct : 0}/${subjData.Physics ? subjData.Physics.mcq.total + subjData.Chemistry.mcq.total + subjData.Maths.mcq.total : 0}</strong></td>
    <td><strong>${subjData.Physics ? subjData.Physics.fillBlank.correct + subjData.Chemistry.fillBlank.correct + subjData.Maths.fillBlank.correct : 0}/${subjData.Physics ? subjData.Physics.fillBlank.total + subjData.Chemistry.fillBlank.total + subjData.Maths.fillBlank.total : 0}</strong></td>
    <td><strong>${totalCorrect}</strong></td>
    <td><strong>${totalWrong}</strong></td>
    <td><strong>${totalBlank}</strong></td>
    <td><strong>${totalQs}</strong></td>
    <td><strong>${totalMarks.toFixed(2)}</strong></td>
  </tr></tbody></table>`;
  
  document.getElementById('summaryTableContainer').innerHTML = html;
  
  // Auto transition to review after 3 seconds
  setTimeout(() => {
    showDetailedSolutions();
  }, 3000);
}

// ===== SHOW DETAILED SOLUTIONS =====
function showDetailedSolutions() {
  document.getElementById('summaryArea').style.display = 'none';
  document.getElementById('reviewArea').style.display = 'block';
  
  document.getElementById('reviewStudentName').textContent = progress.student.name;
  document.getElementById('reviewSection').textContent = progress.student.sec;
  document.getElementById('reviewRoll').textContent = progress.student.roll;
  document.getElementById('reviewAdm').textContent = progress.student.adm;
  
  // Create detailed results table
  const subjData = window.currentSubjData;
  let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalQs = 0, totalMarks = 0;
  
  let html = `<table class="results-table" border="1">
    <thead>
      <tr>
        <th>Subject</th>
        <th>MCQ (Correct/Total)</th>
        <th>Numerical (Correct/Total)</th>
        <th>Total Correct</th>
        <th>Wrong</th>
        <th>Blank</th>
        <th>Total</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>`;
  
  for (let subject in subjData) {
    const data = subjData[subject];
    
    html += `<tr>
      <td>${subject}</td>
      <td>${data.mcq.correct}/${data.mcq.total}</td>
      <td>${data.fillBlank.correct}/${data.fillBlank.total}</td>
      <td>${data.correct}</td>
      <td>${data.wrong}</td>
      <td>${data.blank}</td>
      <td>${data.total}</td>
      <td>${data.marks.toFixed(2)}</td>
    </tr>`;
    
    totalCorrect += data.correct;
    totalWrong += data.wrong;
    totalBlank += data.blank;
    totalQs += data.total;
    totalMarks += data.marks;
  }
  
  html += `<tr class="total-row">
    <td><strong>GRAND TOTAL</strong></td>
    <td><strong>${subjData.Physics ? subjData.Physics.mcq.correct + subjData.Chemistry.mcq.correct + subjData.Maths.mcq.correct : 0}/${subjData.Physics ? subjData.Physics.mcq.total + subjData.Chemistry.mcq.total + subjData.Maths.mcq.total : 0}</strong></td>
    <td><strong>${subjData.Physics ? subjData.Physics.fillBlank.correct + subjData.Chemistry.fillBlank.correct + subjData.Maths.fillBlank.correct : 0}/${subjData.Physics ? subjData.Physics.fillBlank.total + subjData.Chemistry.fillBlank.total + subjData.Maths.fillBlank.total : 0}</strong></td>
    <td><strong>${totalCorrect}</strong></td>
    <td><strong>${totalWrong}</strong></td>
    <td><strong>${totalBlank}</strong></td>
    <td><strong>${totalQs}</strong></td>
    <td><strong>${totalMarks.toFixed(2)}</strong></td>
  </tr></tbody></table>`;
  
  document.getElementById('detailedResultsContainer').innerHTML = html;
  
  // Create question-by-question review
  const solutionsContainer = document.getElementById('reviewQuestionsContainer');
  solutionsContainer.innerHTML = '<h3 style="text-align:center; color:#4B0082; margin:30px 0;">Detailed Question Solutions</h3>';
  
  // Sort questions by original order
  const sortedAnswers = [];
  for (let i = 0; i < examData.files.length; i++) {
    sortedAnswers.push({
      shuffledIndex: i,
      originalIndex: examData.originalOrder[i],
      studentAnswer: progress.answers[i],
      correctAnswer: examData.keys[i],
      subject: examData.subjectNames[i],
      type: examData.questionTypes[i]
    });
  }
  
  sortedAnswers.sort((a, b) => a.originalIndex - b.originalIndex);
  
  // Display each question
  sortedAnswers.forEach((item, index) => {
    const isCorrect = item.studentAnswer === item.correctAnswer;
    const questionNumber = item.originalIndex + 1;
    
    let statusClass = '';
    let statusText = '';
    
    if (item.studentAnswer === null) {
      statusClass = 'solution-not-attempted';
      statusText = 'Not Attempted';
    } else if (isCorrect) {
      statusClass = 'solution-correct';
      statusText = 'Correct';
    } else {
      statusClass = 'solution-wrong';
      statusText = 'Wrong';
    }
    
    const solutionDiv = document.createElement('div');
    solutionDiv.className = 'solution-container';
    
    solutionDiv.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="solution-question">
          Question ${questionNumber} (${item.subject}) - ${item.type === 'fill-blank' ? 'Numerical Input' : 'MCQ'}
        </div>
        <div style="font-size: 24px;">
          ${isCorrect ? '‚úÖ' : '‚ùå'}
        </div>
      </div>
      <div class="solution-answer ${statusClass}">
        <strong>Your Answer:</strong> ${item.studentAnswer || 'Not Attempted'} 
        ${!isCorrect && item.studentAnswer ? ` | <strong>Correct Answer:</strong> ${item.correctAnswer}` : ''}
        ${item.studentAnswer === null ? ` | <strong>Correct Answer:</strong> ${item.correctAnswer}` : ''}
      </div>
      <div style="color: #666; margin-top: 10px;">
        ${isCorrect ? 
          'You answered correctly!' : 
          item.studentAnswer ? 
          'Your answer was incorrect.' : 
          'You did not attempt this question.'}
      </div>
    `;
    
    solutionsContainer.appendChild(solutionDiv);
  });
}

// ===== RESET FORM =====
function resetForm() {
  document.getElementById('stuName').value = '';
  document.getElementById('stuSection').value = '';
  document.getElementById('stuRoll').value = '';
  document.getElementById('stuAdm').value = '';
  document.getElementById('stuStartBtn').style.display = 'none';
  clearErrors();
}

// ===== KEYBOARD SHORTCUTS =====
function handleKeyboardShortcuts(e) {
  if (!examInProgress || document.getElementById('examArea').style.display !== 'block') {
    return;
  }
  
  const idx = progress.currentIndex;
  const questionType = examData.questionTypes[idx];
  
  // MCQ selection (1-4 for A-D)
  if (questionType === 'mcq') {
    const keyMap = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'};
    if (keyMap[e.key]) {
      selectOption(keyMap[e.key]);
      e.preventDefault();
    }
  }
  
  // Navigation
  if (e.key === 'ArrowLeft') {
    navigate(-1);
    e.preventDefault();
  } else if (e.key === 'ArrowRight') {
    navigate(1);
    e.preventDefault();
  }
  
  // Review toggle
  if (e.key === 'r' || e.key === 'R') {
    toggleReview();
    e.preventDefault();
  }
  
  // Submit on Enter for numerical
  if (e.key === 'Enter' && questionType === 'fill-blank') {
    submitNumericalAnswer(idx);
    e.preventDefault();
  }
  
  // Submit exam (Ctrl+Enter)
  if (e.ctrlKey && e.key === 'Enter') {
    confirmSubmit();
    e.preventDefault();
  }
}

// ===== UTILITY FUNCTIONS =====
function shuffleArray(arr) {
  const copy = [...arr];
  for (let i = copy.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

function identifySubject(subjectName) {
  if (subjectName.includes('Math')) return 'Mathematics';
  if (subjectName.includes('Phy')) return 'Physics';
  if (subjectName.includes('Chem')) return 'Chemistry';
  return subjectName;
}

// ===== INITIALIZE ON LOAD =====
window.addEventListener('load', function() {
  console.log('üìö LFJC Online Exam System Loading...');
  console.log('‚Ä¢ Total Questions: 75');
  console.log('‚Ä¢ Subjects: Physics, Chemistry, Maths');
  console.log('‚Ä¢ Duration: 3 hours');
  console.log('‚Ä¢ Marking: +4 correct, -1 wrong');
  
  initializeSystem();
  
  console.log('‚úÖ System ready!');
});
</script>
</body>
</html>
