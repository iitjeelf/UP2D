<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam - COMPLETE LOCKDOWN</title>
<style>
/* ===== COMPLETE LOCKDOWN OVERLAY ===== */
#complete-lockdown-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 0, 0, 0.95);
    z-index: 2147483647;
    display: none;
    pointer-events: all;
    backdrop-filter: blur(20px);
}

#lockdown-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.5);
    text-align: center;
    z-index: 2147483647;
    display: none;
    min-width: 400px;
    border: 5px solid #ff0000;
    animation: lockdownPulse 1s infinite;
}

@keyframes lockdownPulse {
    0% { border-color: #ff0000; box-shadow: 0 0 20px rgba(255, 0, 0, 0.7); }
    50% { border-color: #ff5555; box-shadow: 0 0 30px rgba(255, 0, 0, 0.9); }
    100% { border-color: #ff0000; box-shadow: 0 0 20px rgba(255, 0, 0, 0.7); }
}

#lockdown-countdown {
    font-size: 48px;
    font-weight: bold;
    color: #ff0000;
    margin: 20px 0;
}

/* ===== BASE STYLES ===== */
:root {
    --primary-color: #4B0082;
    --secondary-color: #D8BFD8;
    --light-purple: #E6E6FA;
    --white: #fff;
    --black: #000;
    --success: #32CD32;
    --warning: #ff9900;
    --danger: #ff6666;
    --shadow: 0 5px 15px rgba(0,0,0,0.1);
    --transition: all 0.3s ease;
}

* {
    box-sizing: border-box;
}

body {
    font-family: "SF Pro Display", Arial, sans-serif;
    margin: 0;
    background: var(--white);
    color: var(--black);
    line-height: 1.6;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    overflow-x: hidden;
}

/* ===== FULL SCREEN BLUR OVERLAY FOR CLICKS OUTSIDE ===== */
#full-screen-blur-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    z-index: 2147483645;
    display: none;
    pointer-events: none;
}

#click-outside-warning {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    text-align: center;
    z-index: 2147483646;
    display: none;
    min-width: 350px;
    max-width: 90%;
    border: 4px solid #ff0000;
    animation: warningPulse 1.5s infinite;
}

@keyframes warningPulse {
    0% { border-color: #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }
    50% { border-color: #ff4444; box-shadow: 0 0 25px rgba(255, 0, 0, 0.8); }
    100% { border-color: #ff0000; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); }
}

#return-to-exam-btn {
    background: linear-gradient(145deg, #4B0082, #6A0DAD);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 18px;
    font-weight: bold;
    margin-top: 25px;
    transition: var(--transition);
    box-shadow: 0 6px 0 rgba(75, 0, 130, 0.3);
}

#return-to-exam-btn:hover {
    background: linear-gradient(145deg, #6A0DAD, #8A2BE2);
    transform: translateY(-3px);
    box-shadow: 0 8px 0 rgba(75, 0, 130, 0.4);
}

/* ===== WINDOW VISIBILITY DETECTION ===== */
#window-blur-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    z-index: 2147483647;
    display: none;
    pointer-events: none;
}

/* Disable right-click context menu */
body {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* ===== HEADER & FOOTER ===== */
header {
    background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
    color: var(--primary-color);
    text-align: center;
    padding: 20px;
    font-size: 36px;
    font-weight: 700;
    letter-spacing: 1.5px;
    box-shadow: var(--shadow);
    text-shadow: 0 1px 2px var(--white);
}

footer {
    background: var(--light-purple);
    color: var(--primary-color);
    padding: 10px;
    text-align: center;
    font-weight: bold;
    position: fixed;
    width: 100%;
    bottom: 0;
    z-index: 1000;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    min-height: calc(100vh - 140px);
    padding: 16px;
    text-align: center;
}

.form-group {
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: center;
    margin-bottom: 60px;
    width: 100%;
    max-width: 500px;
}

.form-group label {
    font-size: 1.15rem;
    font-weight: 600;
    margin-right: 10px;
    color: var(--primary-color);
    width: 180px;
    text-align: right;
}

input[type="text"], input[type="number"] {
    padding: 12px 14px;
    font-size: 1.1rem;
    border-radius: 10px;
    border: 1.5px solid var(--primary-color);
    outline: none;
    min-width: 250px;
    transition: var(--transition);
}

input[type="text"]:focus, input[type="number"]:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
    animation: glowRed 0.5s alternate infinite;
    border-color: var(--danger);
}

@keyframes glowRed {
    0% { box-shadow: 0 0 5px var(--danger); }
    100% { box-shadow: 0 0 15px var(--danger); }
}

/* ===== BUTTON STYLES ===== */
button {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    border: none;
    border-radius: 12px;
    transition: var(--transition);
    box-shadow: 0 6px #aaa;
    background: linear-gradient(to bottom, #fafaff, #dcd6f7);
    color: var(--primary-color);
    font-weight: 600;
    padding: 12px 24px;
    font-size: 18px;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 15px rgba(0,0,0,.28);
}

.optBtn {
    font-size: 16px;
    padding: 8px 18px;
    margin: 6px;
    border: 2px solid var(--primary-color);
    background: var(--white);
    border-radius: 8px;
    box-shadow: 0 5px #aaa;
}

.optBtn.selected {
    background: var(--success);
    color: var(--white);
    border-color: #2fa92f;
}

.navBtn {
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 8px;
    color: var(--white);
    font-weight: bold;
    cursor: pointer;
    background: linear-gradient(145deg, #1E90FF, #4682B4);
    margin: 0 15px;
}

#markReviewBtn {
    background: linear-gradient(145deg, #ffb84d, var(--warning));
}

#submitBtn {
    background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== TIMER STYLES ===== */
#timerEl {
    font-size: 20px;
    font-weight: bold;
    color: var(--primary-color);
    padding: 6px 12px;
    border-radius: 6px;
    background: #f0f0ff;
    display: inline-block;
    transition: var(--transition);
}

#timerEl.blink {
    animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
    0% { background: var(--danger); color: var(--white); }
    50% { background: var(--white); color: var(--primary-color); }
    100% { background: var(--danger); color: var(--white); }
}

/* ===== PALETTE STYLES ===== */
#paletteContainer {
    display: grid;
    gap: 8px;
    margin: 20px auto;
    max-width: 100%;
    padding: 0 10px;
    justify-content: center;
}

#paletteContainer button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 14px;
    margin: 2px;
    border: 1px solid var(--primary-color);
    background: var(--light-purple);
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
}

#paletteContainer button.selected {
    background: var(--success);
    color: var(--white);
}

#paletteContainer button.reviewed {
    background: yellow;
    color: var(--black);
}

#paletteContainer button.current {
    border: 3px solid red;
}

/* ===== EXAM AREA STYLES ===== */
#examArea {
    padding: 16px;
    text-align: center;
    display: none;
}

#examHeader {
    display: flex;
    align-items: center;
    width: 100%;
    font-weight: bold;
    margin-bottom: 20px;
}

#stuInfo {
    flex: 0 0 auto;
    text-align: left;
    white-space: nowrap;
}

#stuQInfo {
    flex: 1;
    text-align: center;
    white-space: nowrap;
}

.sectionTitle {
    font-size: 22px;
    color: var(--primary-color);
    font-weight: bold;
    margin-bottom: 8px;
}

/* ===== QUESTION IMAGE STYLES ===== */
.questionImg {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    display: block;
    margin: 0 auto;
    border: 2px solid #E6E6FA;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* ===== ACCESS DENIED SCREEN ===== */
.access-denied {
    display: flex;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #4B0082, #8A2BE2);
    z-index: 10000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
    text-align: center;
    padding: 20px;
}

.access-denied h1 {
    font-size: 3em;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.access-code-input {
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    width: 300px;
    text-align: center;
    margin-bottom: 20px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn {
    background: white;
    color: #4B0082;
    border: none;
    padding: 12px 30px;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.access-error {
    color: #ffeb3b;
    margin-top: 10px;
    font-weight: 600;
    display: none;
}

/* ===== MODAL STYLES ===== */
.confirmModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.45);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.confirmBox {
    background: var(--white);
    padding: 20px;
    border-radius: 12px;
    min-width: 280px;
    text-align: center;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.confirmBox p {
    font-size: 18px;
    color: var(--primary-color);
    margin-bottom: 15px;
}

.confirmBox button {
    margin: 0 10px;
    padding: 8px 16px;
    font-size: 16px;
    cursor: pointer;
}

/* ===== RESULTS AREA STYLES ===== */
#summaryArea, #reviewArea {
    display: none;
    padding: 20px;
}

.results-table {
    width: 100%;
    max-width: 900px;
    margin: 20px auto;
    border-collapse: collapse;
    font-size: 18px;
    text-align: center;
}

.results-table th {
    background: #E6E6FA;
    padding: 15px;
    border: 1px solid var(--primary-color);
}

.results-table td {
    padding: 15px;
    border: 1px solid var(--primary-color);
}

.results-table tr:nth-child(even) {
    background: #f9f9f9;
}

.results-table tr:hover {
    background: #f0f0ff;
}

/* ===== FILL BLANK INPUT STYLES ===== */
.fill-blank-input {
    width: 200px;
    padding: 12px 18px;
    font-size: 22px;
    border: 2px solid #4B0082;
    border-radius: 8px;
    text-align: center;
    outline: none;
    font-weight: bold;
    margin: 20px 0;
    background: white;
    color: #333;
}

.fill-blank-input:focus {
    border-color: #6A0DAD;
    box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

.submit-fill-blank-btn {
    padding: 12px 24px;
    background: linear-gradient(145deg, #32CD32, #228B22);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 15px;
    transition: all 0.2s ease;
}

.submit-fill-blank-btn:hover {
    background: linear-gradient(145deg, #228B22, #1C7A1C);
    transform: translateY(-2px);
}

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 600px) {
    .form-group {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .form-group label {
        text-align: left;
        width: auto;
        margin-bottom: 5px;
    }
    
    #examHeader {
        flex-direction: column;
        gap: 10px;
    }
    
    #paletteContainer {
        grid-template-columns: repeat(5, 1fr) !important;
        gap: 6px;
    }
    
    #lockdown-warning {
        width: 95%;
        min-width: auto;
        padding: 25px 15px;
    }
}

@media (min-width: 601px) and (max-width: 900px) {
    #paletteContainer {
        grid-template-columns: repeat(10, 1fr) !important;
    }
}

@media (min-width: 901px) and (max-width: 1200px) {
    #paletteContainer {
        grid-template-columns: repeat(15, 1fr) !important;
    }
}

@media (min-width: 1201px) {
    #paletteContainer {
        grid-template-columns: repeat(20, 1fr) !important;
    }
}

/* ===== ANIMATIONS ===== */
@keyframes slideIn {
    from { transform: translateY(-20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(-20px); opacity: 0; }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}
</style>
</head>

<body>

<!-- ===== COMPLETE LOCKDOWN OVERLAY ===== -->
<div id="complete-lockdown-overlay"></div>
<div id="lockdown-warning">
    <h2 style="color: #ff0000; font-size: 32px;">üö® EXAM LOCKDOWN ACTIVATED</h2>
    <p style="font-size: 18px; margin: 20px 0; color: #333;">
        <strong>SECURITY VIOLATION DETECTED!</strong>
    </p>
    <p style="margin: 10px 0; color: #555;">
        You attempted to access browser controls during the exam.
    </p>
    <p style="margin: 10px 0; color: #555;">
        Returning to exam in:
    </p>
    <div id="lockdown-countdown">5</div>
    <p style="margin: 20px 0; font-weight: bold; color: #4B0082;">
        WARNING: Multiple violations may result in exam termination!
    </p>
</div>

<!-- Full Screen Blur Overlay for Clicks Outside Browser -->
<div id="full-screen-blur-overlay"></div>

<!-- Click Outside Warning -->
<div id="click-outside-warning">
    <h2>‚ö†Ô∏è SECURITY ALERT</h2>
    <p>You clicked outside the exam browser window!</p>
    <p><strong>Detected Action:</strong> Clicking on browser tabs, address bar, Chrome menu, or other browser elements</p>
    <p>Do not attempt to access browser controls during the exam.</p>
    <button id="return-to-exam-btn">Return to Exam</button>
</div>

<!-- Window Blur Overlay -->
<div id="window-blur-overlay"></div>

<!-- Access Denied Screen - ALWAYS SHOWS FIRST -->
<div id="accessDenied" class="access-denied">
    <h1>LFJC ONLINE EXAMINATION</h1>
    <p style="font-size: 1.2em; margin: 10px 0;">COMPLETE LOCKDOWN MODE</p>
    <p style="margin: 15px 0; max-width: 600px; line-height: 1.5;">
        <strong>‚ö†Ô∏è SECURITY NOTICE:</strong><br>
        During the exam, ALL browser controls will be completely disabled.<br>
        This includes: Chrome menu, tabs, address bar, bookmarks, and all browser UI.
    </p>
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION - COMPLETE LOCKDOWN</header>

<div id="studentEntry" style="display:none;">
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
    <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
    <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span>
    </div>
  </div>
  
  <!-- Detailed Solutions Container -->
  <div id="reviewQuestionsContainer"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<footer>@LFJC2025 All Rights Reserved</footer>

<!-- Modals -->
<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 180;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const MAX_QUESTIONS = 75;
const ACCESS_CODE = "lfjc2025";
const LOCKDOWN_COUNTDOWN_SECONDS = 5;

// QUESTION STRUCTURE
const QUESTION_STRUCTURE = {
  total: 75,
  subjects: [
    { name: "Maths", start: 1, end: 25 },
    { name: "Physics", start: 26, end: 50 },
    { name: "Chemistry", start: 51, end: 75 }
  ]
};

// ===== COMPLETE LOCKDOWN SYSTEM =====
class CompleteLockdownSystem {
    constructor() {
        this.lockdownOverlay = document.getElementById('complete-lockdown-overlay');
        this.lockdownWarning = document.getElementById('lockdown-warning');
        this.lockdownCountdown = document.getElementById('lockdown-countdown');
        this.isLockdownActive = false;
        this.violationCount = 0;
        this.maxViolations = 3;
        this.lockdownInterval = null;
        
        this.init();
    }
    
    init() {
        console.log('üîí COMPLETE LOCKDOWN SYSTEM INITIALIZED');
    }
    
    enableLockdown() {
        console.log('üîí ENABLING COMPLETE LOCKDOWN');
        
        // Disable ALL browser shortcuts
        this.disableAllShortcuts();
        
        // Disable right-click
        this.disableRightClick();
        
        // Monitor window focus
        this.startFocusMonitoring();
        
        // Monitor mouse movements
        this.monitorMouseActivity();
        
        // Monitor keyboard for escape attempts
        this.monitorKeyboard();
        
        console.log('‚úÖ COMPLETE LOCKDOWN ACTIVATED - All browser controls disabled');
    }
    
    disableAllShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Block ALL function keys
            if (e.key.startsWith('F') && e.key.length > 1) {
                e.preventDefault();
                this.triggerLockdown('Function key pressed: ' + e.key);
                return false;
            }
            
            // Block ALL Ctrl/Alt combinations
            if (e.ctrlKey || e.altKey || e.metaKey) {
                e.preventDefault();
                this.triggerLockdown('Keyboard shortcut attempted: ' + 
                    (e.ctrlKey ? 'Ctrl+' : '') + 
                    (e.altKey ? 'Alt+' : '') + 
                    (e.metaKey ? 'Cmd+' : '') + e.key);
                return false;
            }
            
            // Block Print Screen
            if (e.key === 'PrintScreen' || e.code === 'PrintScreen') {
                e.preventDefault();
                this.triggerLockdown('Print Screen attempted');
                return false;
            }
            
            // Block Escape key
            if (e.key === 'Escape') {
                e.preventDefault();
                this.triggerLockdown('Escape key pressed');
                return false;
            }
        }, true);
    }
    
    disableRightClick() {
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            this.triggerLockdown('Right-click attempted');
            return false;
        }, true);
    }
    
    startFocusMonitoring() {
        // Monitor window focus every 50ms
        setInterval(() => {
            if (examInProgress && !document.hasFocus() && !this.isLockdownActive) {
                this.triggerLockdown('Window lost focus (clicked outside)');
            }
        }, 50);
        
        // Monitor visibility changes
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && examInProgress && !this.isLockdownActive) {
                this.triggerLockdown('Tab/window switched');
            }
        });
        
        // Monitor window blur
        window.addEventListener('blur', () => {
            if (examInProgress && !this.isLockdownActive) {
                setTimeout(() => {
                    if (!document.hasFocus()) {
                        this.triggerLockdown('Clicked browser UI');
                    }
                }, 10);
            }
        });
    }
    
    monitorMouseActivity() {
        let lastMousePosition = { x: 0, y: 0 };
        
        document.addEventListener('mousemove', (e) => {
            // Check if mouse is in browser chrome area (top 20px)
            if (e.clientY < 20 && examInProgress && !this.isLockdownActive) {
                this.triggerLockdown('Mouse in browser chrome area');
            }
            
            lastMousePosition = { x: e.clientX, y: e.clientY };
        });
        
        // Monitor mouse leaving window
        document.addEventListener('mouseleave', (e) => {
            if (e.clientY < 0 && examInProgress && !this.isLockdownActive) {
                this.triggerLockdown('Mouse left window (likely clicked browser UI)');
            }
        });
    }
    
    monitorKeyboard() {
        // Log all keyboard activity during exam
        if (examInProgress) {
            document.addEventListener('keydown', (e) => {
                // Log suspicious key combinations
                if (e.ctrlKey || e.altKey || e.metaKey) {
                    console.log('‚ö†Ô∏è Suspicious key combo detected:', {
                        key: e.key,
                        ctrlKey: e.ctrlKey,
                        altKey: e.altKey,
                        metaKey: e.metaKey,
                        timestamp: new Date().toISOString()
                    });
                }
            }, true);
        }
    }
    
    triggerLockdown(reason) {
        if (this.isLockdownActive) return;
        
        this.violationCount++;
        console.log(`üö® LOCKDOWN TRIGGERED: ${reason} (Violation ${this.violationCount}/${this.maxViolations})`);
        
        // Show lockdown overlay
        this.activateLockdown();
        
        // Log the violation
        this.logViolation(reason);
        
        // Check if max violations reached
        if (this.violationCount >= this.maxViolations) {
            this.handleMaxViolations();
        }
    }
    
    activateLockdown() {
        this.isLockdownActive = true;
        
        // Show red overlay
        this.lockdownOverlay.style.display = 'block';
        this.lockdownWarning.style.display = 'block';
        
        // Disable all exam interaction
        this.disableExamInteraction();
        
        // Start countdown
        this.startCountdown();
    }
    
    disableExamInteraction() {
        // Disable all buttons
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = true;
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.5';
        });
        
        // Disable all inputs
        const allInputs = document.querySelectorAll('input');
        allInputs.forEach(input => {
            input.disabled = true;
            input.style.opacity = '0.5';
        });
        
        // Pause timer if exists
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    }
    
    enableExamInteraction() {
        // Enable all buttons
        const allButtons = document.querySelectorAll('button');
        allButtons.forEach(btn => {
            btn.disabled = false;
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        });
        
        // Enable all inputs
        const allInputs = document.querySelectorAll('input');
        allInputs.forEach(input => {
            input.disabled = false;
            input.style.opacity = '1';
        });
        
        // Resume timer if exists
        if (examInProgress && progress) {
            startTimer();
        }
    }
    
    startCountdown() {
        let seconds = LOCKDOWN_COUNTDOWN_SECONDS;
        this.lockdownCountdown.textContent = seconds;
        
        this.lockdownInterval = setInterval(() => {
            seconds--;
            this.lockdownCountdown.textContent = seconds;
            
            if (seconds <= 0) {
                this.deactivateLockdown();
            }
        }, 1000);
    }
    
    deactivateLockdown() {
        clearInterval(this.lockdownInterval);
        
        // Hide lockdown elements
        this.lockdownOverlay.style.display = 'none';
        this.lockdownWarning.style.display = 'none';
        
        // Re-enable exam interaction
        this.enableExamInteraction();
        
        // Focus back to exam
        window.focus();
        
        // Reset lockdown flag after a delay
        setTimeout(() => {
            this.isLockdownActive = false;
            console.log('üîÑ Lockdown deactivated');
        }, 1000);
    }
    
    handleMaxViolations() {
        console.log('üö® MAXIMUM VIOLATIONS REACHED - SUBMITTING EXAM');
        
        // Update warning message
        this.lockdownWarning.innerHTML = `
            <h2 style="color: #ff0000; font-size: 32px;">üö® EXAM TERMINATED</h2>
            <p style="font-size: 18px; margin: 20px 0; color: #333;">
                <strong>MAXIMUM SECURITY VIOLATIONS REACHED</strong>
            </p>
            <p style="margin: 10px 0; color: #555;">
                You have attempted to access browser controls ${this.maxViolations} times.
            </p>
            <p style="margin: 10px 0; color: #555;">
                The exam is being submitted automatically.
            </p>
            <div id="lockdown-countdown" style="font-size: 48px; color: #ff0000; margin: 20px 0;">3</div>
        `;
        
        // Start auto-submission countdown
        let countdown = 3;
        const countdownEl = document.getElementById('lockdown-countdown');
        
        const submissionInterval = setInterval(() => {
            countdown--;
            countdownEl.textContent = countdown;
            
            if (countdown <= 0) {
                clearInterval(submissionInterval);
                this.forceExamSubmission();
            }
        }, 1000);
    }
    
    forceExamSubmission() {
        console.log('üì§ FORCE SUBMITTING EXAM DUE TO SECURITY VIOLATIONS');
        
        // Submit exam immediately
        if (typeof submitExam === 'function') {
            submitExam();
        } else {
            // Fallback submission
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('studentEntry').style.display = 'flex';
            alert('Exam terminated due to security violations.');
        }
    }
    
    logViolation(reason) {
        const violationLog = {
            type: 'security_violation',
            reason: reason,
            timestamp: new Date().toISOString(),
            violationCount: this.violationCount,
            student: progress ? progress.student.name : 'N/A'
        };
        
        console.log('üîí Security Violation:', violationLog);
        
        // Store in localStorage
        const logs = JSON.parse(localStorage.getItem('exam_security_logs') || '[]');
        logs.push(violationLog);
        localStorage.setItem('exam_security_logs', JSON.stringify(logs.slice(-100)));
    }
    
    disable() {
        this.isLockdownActive = false;
        this.lockdownOverlay.style.display = 'none';
        this.lockdownWarning.style.display = 'none';
        
        if (this.lockdownInterval) {
            clearInterval(this.lockdownInterval);
        }
        
        console.log('üîì COMPLETE LOCKDOWN DISABLED');
    }
}

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let sheetReady = false;
let hasSubmitted = false;
let examStartTime = null;
let examInProgress = false;
let progress = null, timerInterval = null;
let currentSubjData = null;

// Initialize lockdown system
const lockdownSystem = new CompleteLockdownSystem();

// ===== INITIALIZE DEMO DATA =====
function initializeDemoData() {
    console.log("üéØ Creating demo data for 75 questions");
    
    answerKey = [];
    for (let i = 1; i <= 75; i++) {
        if (i <= 20 || (i >= 26 && i <= 45) || (i >= 51 && i <= 70)) {
            // MCQ questions
            const options = ['A', 'B', 'C', 'D'];
            answerKey.push(options[Math.floor(Math.random() * options.length)]);
        } else {
            // Numerical input questions
            answerKey.push(String(Math.floor(Math.random() * 100) + 1));
        }
    }
    
    images = [];
    for (let i = 1; i <= 75; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    clearErrors();
    validateStudentInputs();
    console.log('‚úÖ Demo Data Ready');
}

// ===== ANSWER KEY LOADING =====
async function loadAnswerKeyFromRepo() {
    try {
        console.log("üì• Loading answer key...");
        const response = await fetch('Answers/Key');
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const text = await response.text();
        const lines = text.trim().split('\n').filter(line => line.trim() !== '');
        const parsedAnswers = [];
        
        for (let line of lines) {
            if (line.includes(',')) {
                const answers = line.split(',').map(a => a.trim().toUpperCase());
                parsedAnswers.push(...answers);
            } else {
                parsedAnswers.push(line.trim().toUpperCase());
            }
            
            if (parsedAnswers.length >= 75) break;
        }
        
        answerKey = parsedAnswers.slice(0, 75);
        keyLoaded = true;
        
        images = [];
        for (let i = 1; i <= 75; i++) {
            images.push(`questions/${i}.png`);
        }
        
        console.log("‚úÖ Answer key loaded");
        clearErrors();
        validateStudentInputs();
        
    } catch (error) {
        console.error("‚ùå Using demo data");
        initializeDemoData();
    }
}

// ===== EXAM PREPARATION =====
function prepareExamData() {
    examData = {
        files: [],
        subjectNames: [],
        keys: [],
        originalOrder: [],
        questionTypes: []
    };
    
    const subjectRanges = [
        { name: "Maths", start: 1, end: 25 },
        { name: "Physics", start: 26, end: 50 },
        { name: "Chemistry", start: 51, end: 75 }
    ];
    
    let groups = [];
    
    subjectRanges.forEach(subject => {
        const subjectQuestions = [];
        const subjectKeys = [];
        const subjectOriginalOrder = [];
        const subjectTypes = [];
        
        for (let i = subject.start; i <= subject.end; i++) {
            const imgIndex = i - 1;
            subjectQuestions.push(images[imgIndex]);
            subjectKeys.push(answerKey[imgIndex]);
            subjectOriginalOrder.push(imgIndex);
            
            let questionType = 'mcq';
            if ((subject.name === "Maths" && i >= 21 && i <= 25) ||
                (subject.name === "Physics" && i >= 46 && i <= 50) ||
                (subject.name === "Chemistry" && i >= 71 && i <= 75)) {
                questionType = 'fill-blank';
            }
            subjectTypes.push(questionType);
        }
        
        const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
        
        groups.push({
            name: subject.name,
            imgs: shuffledIndices.map(i => subjectQuestions[i]),
            keys: shuffledIndices.map(i => subjectKeys[i]),
            originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i]),
            types: shuffledIndices.map(i => subjectTypes[i])
        });
    });
    
    const shuffledGroups = shuffleArray(groups);
    
    shuffledGroups.forEach(g => {
        g.imgs.forEach((img, i) => {
            examData.files.push(img);
            examData.keys.push(g.keys[i]);
            examData.subjectNames.push(g.name);
            examData.originalOrder.push(g.originalOrder[i]);
            examData.questionTypes.push(g.types[i]);
        });
    });
    
    console.log("üéØ Exam prepared:", examData.files.length, "questions");
}

// ===== RENDER QUESTION =====
function renderQuestion() {
    const idx = progress.currentIndex;
    const container = document.getElementById('questionContainer');
    
    const imagePath = examData.files[idx];
    const questionNumber = idx + 1;
    const questionType = examData.questionTypes[idx];
    const subject = examData.subjectNames[idx];
    
    let optionsHTML = '';
    
    if (questionType === 'fill-blank') {
        optionsHTML = `
            <div class="fill-blank-container">
                <div style="margin: 20px 0; font-weight: bold; color: #4B0082; font-size: 18px;">
                    Enter numerical answer:
                </div>
                <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 25px 0;">
                    <input type="number" 
                           id="fillBlankInput" 
                           class="fill-blank-input"
                           placeholder="Enter number"
                           value="${progress.answers[idx] || ''}"
                           oninput="handleNumericalInput(this, ${idx})"
                           onkeypress="handleNumericalKeyPress(event, ${idx})"
                           tabindex="0">
                    <button class="submit-fill-blank-btn" 
                            onclick="submitNumericalAnswer(${idx})"
                            tabindex="0">
                        Submit
                    </button>
                </div>
            </div>
        `;
    } else {
        optionsHTML = `
            <div class="options-container">
                <button class="optBtn ${progress.answers[idx] === 'A' ? 'selected' : ''}" data-opt="A" tabindex="0">A</button>
                <button class="optBtn ${progress.answers[idx] === 'B' ? 'selected' : ''}" data-opt="B" tabindex="0">B</button>
                <button class="optBtn ${progress.answers[idx] === 'C' ? 'selected' : ''}" data-opt="C" tabindex="0">C</button>
                <button class="optBtn ${progress.answers[idx] === 'D' ? 'selected' : ''}" data-opt="D" tabindex="0">D</button>
            </div>
        `;
    }
    
    container.innerHTML = `
        <div>
            <div class="question-number">Question ${questionNumber} of 75</div>
            <div class="sectionTitle">${subject} (${questionType === 'fill-blank' ? 'Numerical Input' : 'MCQ'})</div>
            
            <div style="width: 100%; overflow: auto; min-height: 300px; display: flex; justify-content: center; align-items: center;">
                <img src="${imagePath}" 
                     class="questionImg" 
                     alt="Question ${questionNumber}"
                     style="max-width: 100%; height: auto;"
                     onerror="handleImageError(this, ${idx})">
            </div>
            
            ${optionsHTML}
        </div>
    `;
    
    if (questionType !== 'fill-blank') {
        document.querySelectorAll('.optBtn').forEach(btn => {
            btn.onclick = function() { 
                selectOption(this.getAttribute('data-opt')); 
            };
        });
    } else {
        setTimeout(() => {
            const input = document.getElementById('fillBlankInput');
            if (input) input.focus();
        }, 100);
    }
    
    updateQuestionInfo();
    updatePalette();
}

// ===== NUMERICAL INPUT HANDLING =====
function handleNumericalInput(inputElement, questionIndex) {
    const value = inputElement.value;
    const cleanedValue = value.replace(/[^0-9\.\-]/g, '');
    if (cleanedValue !== value) {
        inputElement.value = cleanedValue;
    }
}

function handleNumericalKeyPress(event, questionIndex) {
    const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '-', 'Enter', 'Backspace', 'Delete', 'Tab'];
    if (!allowedKeys.includes(event.key) && !event.ctrlKey && !event.altKey && !event.metaKey) {
        event.preventDefault();
        return;
    }
    if (event.key === 'Enter') {
        submitNumericalAnswer(questionIndex);
        event.preventDefault();
    }
}

function submitNumericalAnswer(questionIndex) {
    const input = document.getElementById('fillBlankInput');
    if (!input) return;
    
    const answer = input.value.trim();
    if (answer === '') {
        alert('Please enter a numerical answer');
        return;
    }
    
    if (!/^-?\d+(\.\d+)?$/.test(answer)) {
        alert('Please enter a valid number');
        return;
    }
    
    progress.answers[questionIndex] = answer;
    showToast('‚úì Answer submitted!', 2000);
    updatePalette();
    
    setTimeout(() => {
        if (questionIndex < examData.files.length - 1) {
            progress.currentIndex++;
            renderQuestion();
            updateNavButtons();
        }
    }, 1500);
}

function showToast(message, duration = 2000) {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(145deg, #32CD32, #228B22);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, duration);
}

// ===== IMAGE ERROR HANDLING =====
function handleImageError(imgElement, questionIndex) {
    const questionNumber = questionIndex + 1;
    imgElement.outerHTML = `
        <div style="padding: 20px; text-align: center; background: #ffebee; border-radius: 8px;">
            <h3>‚ö†Ô∏è Image Not Found</h3>
            <p><strong>Question ${questionNumber}</strong></p>
            <p>File: questions/${questionNumber}.png</p>
        </div>
    `;
}

// ===== SELECT OPTION =====
function selectOption(opt) {
    const idx = progress.currentIndex;
    const questionType = examData.questionTypes[idx];
    
    if (questionType === 'fill-blank') {
        const input = document.getElementById('fillBlankInput');
        if (input && opt !== null) {
            input.value = opt;
            submitNumericalAnswer(idx);
        }
        return;
    }
    
    if (progress.answers[idx] === opt) {
        progress.answers[idx] = null;
    } else {
        progress.answers[idx] = opt;
    }
    updateOptionButtons();
    updatePalette();
}

function updateOptionButtons() {
    const idx = progress.currentIndex;
    const currentAnswer = progress.answers[idx];
    const questionType = examData.questionTypes[idx];
    
    if (questionType === 'fill-blank') {
        const input = document.getElementById('fillBlankInput');
        if (input) {
            input.value = currentAnswer || '';
        }
    } else {
        document.querySelectorAll('.optBtn').forEach(btn => {
            const btnOpt = btn.getAttribute('data-opt');
            btn.classList.toggle('selected', btnOpt === currentAnswer);
        });
    }
}

// ===== UPDATE QUESTION INFO =====
function updateQuestionInfo() {
    const idx = progress.currentIndex;
    const stuInfoEl = document.getElementById('stuInfo');
    const stuQInfoEl = document.getElementById('stuQInfo');
    
    if (stuInfoEl) stuInfoEl.textContent = `${progress.student.name} | ${progress.student.sec} | Roll: ${progress.student.roll}`;
    if (stuQInfoEl) stuQInfoEl.textContent = `Q${idx+1} of 75 | ${examData.subjectNames[idx]}`;
}

// ===== PALETTE FUNCTIONS =====
function renderPalette() {
    const container = document.getElementById('paletteContainer');
    container.innerHTML = '';
    
    for (let i = 0; i < examData.files.length; i++) {
        const btn = document.createElement('button');
        btn.className = 'palette-btn';
        btn.textContent = i + 1;
        btn.tabindex = "0";
        
        if (examData.questionTypes[i] === 'fill-blank') {
            btn.style.background = '#FFD700';
            btn.style.color = '#000';
        }
        
        if (progress.answers[i] !== null) btn.classList.add('selected');
        if (progress.review[i]) btn.classList.add('reviewed');
        if (i === progress.currentIndex) btn.classList.add('current');
        
        btn.onclick = () => {
            progress.currentIndex = i;
            renderQuestion();
            updateNavButtons();
        };
        
        container.appendChild(btn);
    }
}

function updatePalette() {
    const buttons = document.querySelectorAll('.palette-btn');
    buttons.forEach((btn, i) => {
        btn.className = 'palette-btn';
        
        if (examData.questionTypes[i] === 'fill-blank') {
            btn.style.background = '#FFD700';
            btn.style.color = '#000';
        } else {
            btn.style.background = '';
            btn.style.color = '';
        }
        
        if (progress.answers[i] !== null) btn.classList.add('selected');
        if (progress.review[i]) btn.classList.add('reviewed');
        if (i === progress.currentIndex) btn.classList.add('current');
    });
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavButtons() {
    const idx = progress.currentIndex;
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const markReviewBtn = document.getElementById('markReviewBtn');
    
    prevBtn.disabled = idx === 0;
    nextBtn.disabled = idx === examData.files.length - 1;
    
    if (progress.review[idx]) {
        markReviewBtn.textContent = 'Unmark Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #dc3545, #c82333)';
    } else {
        markReviewBtn.textContent = 'Mark for Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
    }
}

document.getElementById('prevBtn').onclick = () => {
    if (progress.currentIndex > 0) {
        progress.currentIndex--;
        renderQuestion();
        updateNavButtons();
    }
};

document.getElementById('nextBtn').onclick = () => {
    if (progress.currentIndex < examData.files.length - 1) {
        progress.currentIndex++;
        renderQuestion();
        updateNavButtons();
    }
};

document.getElementById('markReviewBtn').onclick = () => {
    const idx = progress.currentIndex;
    progress.review[idx] = !progress.review[idx];
    updateNavButtons();
    updatePalette();
};

document.getElementById('submitBtn').onclick = () => {
    showConfirm("Submit Exam? You cannot change answers after submission.", submitExam);
};

// ===== TIMER FUNCTIONS =====
function startTimer() {
    timerInterval = setInterval(() => {
        progress.timeLeftSec--;
        
        const minutes = Math.floor(progress.timeLeftSec / 60);
        const seconds = progress.timeLeftSec % 60;
        const timerEl = document.getElementById('timerEl');
        
        timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (progress.timeLeftSec <= 300) timerEl.classList.add('blink');
        
        if (progress.timeLeftSec <= 0) {
            clearInterval(timerInterval);
            submitExam();
        }
    }, 1000);
}

// ===== SUBMIT EXAM =====
function submitExam() {
    if (hasSubmitted) return;
    clearInterval(timerInterval);
    
    hasSubmitted = true;
    examInProgress = false;
    
    // Disable lockdown system
    lockdownSystem.disable();
    
    const subjData = {};
    examData.subjectNames.forEach((s, i) => {
        const subjectName = identifySubject(s);
        if (!subjData[subjectName]) subjData[subjectName] = {
            correct: 0, wrong: 0, blank: 0, total: 0, marks: 0
        };
        
        const ans = progress.answers[i];
        
        if (ans === null) {
            subjData[subjectName].blank++;
        } else if (ans === examData.keys[i]) {
            subjData[subjectName].correct++;
            subjData[subjectName].marks += MARK_PER_CORRECT;
        } else {
            subjData[subjectName].wrong++;
            subjData[subjectName].marks += MARK_PER_WRONG;
        }
        subjData[subjectName].total++;
    });

    currentSubjData = subjData;
    
    console.log("üéØ Exam submitted:", progress.student.name);
    
    showSummaryInterface(subjData);
}

// ===== SHOW SUMMARY =====
function showSummaryInterface(subjData) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'block';
    
    document.getElementById('summaryStudentName').textContent = progress.student.name;
    document.getElementById('summarySection').textContent = progress.student.sec;
    document.getElementById('summaryRoll').textContent = progress.student.roll;
    document.getElementById('summaryAdm').textContent = progress.student.adm;
    
    const table = document.createElement('table');
    table.className = 'results-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Subject</th>
                <th>Correct</th>
                <th>Wrong</th>
                <th>Blank</th>
                <th>Total</th>
                <th>Marks</th>
            </tr>
        </thead>
        <tbody>
            ${Object.entries(subjData).map(([subject, data]) => `
                <tr>
                    <td>${subject}</td>
                    <td>${data.correct}</td>
                    <td>${data.wrong}</td>
                    <td>${data.blank}</td>
                    <td>${data.total}</td>
                    <td>${data.marks.toFixed(2)}</td>
                </tr>
            `).join('')}
            <tr class="total-row">
                <td><strong>Total</strong></td>
                <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td>
                <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td>
                <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td>
                <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.total, 0)}</strong></td>
                <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td>
            </tr>
        </tbody>
    `;
    
    document.getElementById('summaryTableContainer').innerHTML = '';
    document.getElementById('summaryTableContainer').appendChild(table);
    
    document.getElementById('closeSummaryBtn').onclick = () => {
        document.getElementById('summaryArea').style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        resetForm();
    };
}

// ===== IDENTIFY SUBJECT =====
function identifySubject(subjectName) {
    if (subjectName.includes('Math')) return 'Mathematics';
    if (subjectName.includes('Phy')) return 'Physics';
    if (subjectName.includes('Chem')) return 'Chemistry';
    return subjectName;
}

// ===== UTILITY FUNCTIONS =====
function shuffleArray(arr) {
    const c = arr.slice();
    for (let i = c.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [c[i], c[j]] = [c[j], c[i]];
    }
    return c;
}

function validateStudentInputs() {
    const n = document.getElementById('stuName');
    const s = document.getElementById('stuSection');
    const r = document.getElementById('stuRoll');
    const a = document.getElementById('stuAdm');
    
    if (s.value) s.value = s.value.toUpperCase();
    
    let v1 = /^[A-Za-z .]+$/.test(n.value);
    let v2 = /^[A-Za-z0-9]+$/.test(s.value);
    let v3 = /^[0-9]+$/.test(r.value);
    let v4 = /^[0-9]+$/.test(a.value);
    
    n.classList.toggle('error', !v1 && n.value !== "");
    s.classList.toggle('error', !v2 && s.value !== "");
    r.classList.toggle('error', !v3 && r.value !== "");
    a.classList.toggle('error', !v4 && a.value !== "");
    
    const allValid = v1 && v2 && v3 && v4 && keyLoaded;
    document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
    
    if (!keyLoaded) showError("Answer key not loaded - exam disabled.");
    
    return allValid;
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div style="color: #ff3333; padding: 10px; margin: 10px 0; background: rgba(255,102,102,0.1); border-radius: 6px;">${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

function resetForm() {
    document.getElementById('stuName').value = '';
    document.getElementById('stuSection').value = '';
    document.getElementById('stuRoll').value = '';
    document.getElementById('stuAdm').value = '';
    validateStudentInputs();
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    
    errorElement.style.display = 'none';
    
    if (enteredCode === ACCESS_CODE) {
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => accessDenied.style.animation = '', 500);
    }
}

// ===== CONFIRMATION MODAL =====
function showConfirm(message, callback) {
    const modal = document.getElementById('confirmModal');
    const text = document.getElementById('confirmText');
    const yesBtn = document.getElementById('confirmYes');
    const noBtn = document.getElementById('confirmNo');
    
    text.textContent = message;
    modal.style.display = 'flex';
    
    const newYesBtn = yesBtn.cloneNode(true);
    const newNoBtn = noBtn.cloneNode(true);
    
    yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
    noBtn.parentNode.replaceChild(newNoBtn, noBtn);
    
    newYesBtn.onclick = () => { 
        modal.style.display = 'none'; 
        callback(true); 
    };
    
    newNoBtn.onclick = () => { 
        modal.style.display = 'none'; 
        callback(false); 
    };
    
    setTimeout(() => {
        newNoBtn.focus();
    }, 100);
}

// ===== START EXAM WITH LOCKDOWN =====
function startWithSecurity(ok) {
    if (!ok) return;
    
    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');
    
    const studentKey = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
    
    // ENABLE COMPLETE LOCKDOWN
    lockdownSystem.enableLockdown();
    
    startExam(studentKey);
}

function startExam(studentKey) {
    if (!keyLoaded) {
        alert('Answer key not loaded. Contact admin.');
        return;
    }

    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');

    localStorage.setItem(studentKey, Date.now());
    prepareExamData();
    
    progress = {
        answers: Array(examData.files.length).fill(null),
        review: Array(examData.files.length).fill(false),
        currentIndex: 0,
        student: {name: stuName.value, sec: stuSection.value, roll: stuRoll.value, adm: stuAdm.value},
        timeLeftSec: EXAM_DURATION_MINUTES * 60
    };

    examStartTime = Date.now();
    examInProgress = true;
    
    document.getElementById('studentEntry').style.display = "none";
    document.getElementById('examArea').style.display = "block";
    renderQuestion(); 
    renderPalette(); 
    startTimer(); 
    updateNavButtons();
    
    sheetReady = true;
}

// ===== EVENT LISTENERS =====
["stuName", "stuSection", "stuRoll", "stuAdm"].forEach(id => {
    document.getElementById(id).addEventListener("input", validateStudentInputs);
});

document.getElementById('stuStartBtn').onclick = () => { 
    if (!validateStudentInputs()) return; 
    showConfirm("Start Exam? Browser controls will be completely disabled.", startWithSecurity); 
};

document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
document.getElementById('accessCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') verifyAccessCode();
});

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
    console.log('üîí LFJC Online Exam - COMPLETE LOCKDOWN MODE');
    console.log('üõ°Ô∏è SECURITY FEATURES:');
    console.log('1. ALL browser controls completely disabled');
    console.log('2. Detects clicks on Chrome menu, tabs, address bar');
    console.log('3. Blocks ALL keyboard shortcuts (Ctrl, Alt, F keys)');
    console.log('4. 3-strike policy with auto-submission on max violations');
    console.log('5. Full-screen red lockdown overlay on violations');
    
    document.getElementById('accessDenied').style.display = 'flex';
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'none';
    
    document.getElementById('accessCode').focus();
    
    // Load answer key
    loadAnswerKeyFromRepo();
});
</script>
</body>
</html>
