<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC ONLINE EXAMINATION</title>
<style>
/* ===== ULTRA COMPACT STYLE WITH MINIMAL GAPS ===== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

:root {
    --primary: #2c3e50;
    --secondary: #3498db;
    --accent: #9b59b6;
    --success: #27ae60;
    --warning: #e67e22;
    --danger: #e74c3c;
    --light: #ecf0f1;
    --dark: #2c3e50;
    --text: #333333;
    --text-light: #7f8c8d;
    --border: #bdc3c7;
    --shadow: rgba(0, 0, 0, 0.1);
}

body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 0;
    color: var(--text);
}

.container {
    max-width: 100%;
    margin: 0;
    background: white;
    border-radius: 0;
    box-shadow: none;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100vh;
}

.header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 8px;
    text-align: center;
    position: relative;
    flex-shrink: 0;
}

.header h1 {
    font-size: 1.8em;
    margin: 0;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    font-weight: 600;
}

.header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, var(--warning), var(--accent), var(--success));
}

/* Student Entry Section */
.student-entry {
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.student-entry h2 {
    color: var(--primary);
    text-align: center;
    margin: 0 0 10px 0;
    font-size: 1.4em;
    font-weight: 600;
}

.input-group {
    margin-bottom: 8px;
    position: relative;
}

.input-group label {
    display: block;
    margin-bottom: 2px;
    font-weight: 600;
    color: var(--primary);
    font-size: 0.9em;
}

.input-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 14px;
    transition: all 0.2s ease;
    background: white;
}

.input-group input:focus {
    border-color: var(--secondary);
    outline: none;
}

.input-group input.error {
    border-color: var(--danger);
    background-color: #fff5f5;
}

.prompt {
    font-size: 0.75em;
    margin-top: 1px;
    display: none;
    padding: 2px 4px;
    border-radius: 2px;
}

.prompt.error {
    color: var(--danger);
    background: #ffe6e6;
    display: block;
    border-left: 1px solid var(--danger);
}

.start-btn {
    background: linear-gradient(135deg, var(--success), #20c997);
    color: white;
    border: none;
    padding: 10px;
    font-size: 14px;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    font-weight: 600;
    transition: all 0.2s ease;
    margin-top: 8px;
}

.start-btn:hover {
    transform: translateY(-1px);
}

/* Exam Area */
.exam-area {
    display: none;
    flex-grow: 1;
    background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
    overflow: hidden;
}

.exam-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 6px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
}

.timer {
    font-size: 1em;
    font-weight: bold;
    background: rgba(255,255,255,0.2);
    padding: 4px 8px;
    border-radius: 3px;
}

.timer.blink {
    animation: blink 1s infinite;
    background: linear-gradient(135deg, var(--danger), #FF8E53);
}

.timer.blink-line {
    animation: blink-line 0.5s infinite;
    background: linear-gradient(135deg, #FF416C, #FF4B2B);
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes blink-line {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Main Exam Content */
.exam-main-content {
    display: flex;
    flex-grow: 1;
    overflow: hidden;
    padding: 0;
    gap: 0;
}

.question-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    background: white;
    overflow: hidden;
    margin: 2px;
}

.question-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 6px 10px;
    font-size: 0.9em;
    font-weight: 600;
}

.question-container {
    flex-grow: 1;
    padding: 0;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    position: relative;
}

.question-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, var(--warning), var(--accent), var(--success));
}

.question-img-container {
    flex-grow: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    margin: 0;
    background: #f8f9fa;
    padding: 2px;
    min-height: 300px;
    overflow: auto;
}

.question-img {
    width: 100%;
    height: auto;
    max-width: 100%;
    max-height: none;
}

.options-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 4px;
    margin: 0;
    padding: 4px;
}

.optBtn {
    padding: 6px;
    border: 1px solid var(--border);
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    border-radius: 3px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text);
    text-align: center;
}

.optBtn:hover {
    border-color: var(--secondary);
    background: linear-gradient(135deg, var(--secondary), var(--accent));
    color: white;
}

.optBtn.selected {
    background: linear-gradient(135deg, var(--success), #20c997);
    color: white;
    border-color: var(--success);
}

/* Palette Section */
.palette-section {
    width: 200px;
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
    margin: 2px;
}

.palette-header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 6px;
    text-align: center;
    font-weight: 600;
    font-size: 0.9em;
}

.palette-container {
    flex-grow: 1;
    padding: 8px;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 4px;
    overflow-y: auto;
}

.palette-btn {
    width: 28px;
    height: 28px;
    border: 1px solid var(--border);
    background: white;
    border-radius: 3px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    color: var(--text);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 11px;
}

.palette-btn:hover {
    border-color: var(--secondary);
    background: var(--secondary);
    color: white;
}

.palette-btn.selected {
    background: linear-gradient(135deg, var(--success), #20c997);
    color: white;
    border-color: var(--success);
}

.palette-btn.reviewed {
    background: linear-gradient(135deg, var(--warning), #FFA500);
    color: #333;
    border-color: var(--warning);
}

.palette-btn.current {
    border: 1px solid var(--secondary);
    background: var(--secondary);
    color: white;
}

/* Navigation */
.navigation {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    background: white;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
}

.nav-btn {
    padding: 6px 12px;
    border: 1px solid var(--secondary);
    background: white;
    color: var(--secondary);
    border-radius: 3px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 12px;
}

.nav-btn:hover:not(:disabled) {
    background: linear-gradient(135deg, var(--secondary), var(--accent));
    color: white;
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.mark-review {
    background: linear-gradient(135deg, var(--warning), #FFA500);
    border-color: var(--warning);
    color: white;
}

.mark-review:hover {
    background: linear-gradient(135deg, #FFA500, #FF8C00);
    color: white;
}

.mark-review.reviewed {
    background: linear-gradient(135deg, var(--danger), #FF8E53);
    border-color: var(--danger);
    color: white;
}

/* Submit Button */
.submit-section {
    text-align: center;
    padding: 6px;
    background: white;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
}

.submit-btn {
    background: linear-gradient(135deg, var(--danger), #e35d6a);
    color: white;
    border: none;
    padding: 8px 20px;
    font-size: 14px;
    border-radius: 3px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

.submit-btn:hover {
    transform: translateY(-1px);
    background: linear-gradient(135deg, #c82333, var(--danger));
}

/* Summary & Review Areas */
.summary-area, .review-area {
    display: none;
    padding: 10px;
    background: linear-gradient(135deg, #f8f9ff, #e6f3ff);
    flex-grow: 1;
    overflow-y: auto;
}

.summary-area h2, .review-area h2 {
    color: var(--primary);
    text-align: center;
    margin: 0 0 10px 0;
    font-size: 1.5em;
    font-weight: 600;
}

.student-info-bar {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 8px;
    border-radius: 3px;
    margin-bottom: 10px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 4px;
}

.student-info-bar div {
    text-align: center;
    padding: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
}

.results-table, .detailed-results-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background: white;
    border-radius: 3px;
    overflow: hidden;
}

.results-table th, .detailed-results-table th {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 8px;
    text-align: left;
    font-size: 0.9em;
    font-weight: 600;
}

.results-table td, .detailed-results-table td {
    padding: 6px 8px;
    border-bottom: 1px solid var(--border);
    font-size: 0.85em;
}

.results-table tr:hover, .detailed-results-table tr:hover {
    background: #f8f9ff;
}

.total-row {
    background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
    font-weight: bold;
    font-size: 0.9em;
}

.highlight {
    background: #d4edda !important;
    border-left: 2px solid var(--success);
}

/* Question Review */
.question-review-item {
    border: 1px solid #E6E6FA;
    border-radius: 3px;
    padding: 10px;
    margin: 8px 0;
    background: white;
    position: relative;
}

.question-review-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, var(--success), #44A08D);
}

.answer-status {
    padding: 4px 8px;
    border-radius: 2px;
    font-weight: 600;
    font-size: 0.85em;
}

.answer-status.correct {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    color: #155724;
    border: 1px solid var(--success);
}

.answer-status.wrong {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    color: #721c24;
    border: 1px solid var(--danger);
}

.answer-status.not-attempted {
    background: linear-gradient(135deg, #e2e3e5, #d6d8db);
    color: #383d41;
    border: 1px solid var(--text-light);
}

.correct-answer {
    color: var(--success);
    font-weight: bold;
    font-size: 0.9em;
}

.wrong-answer {
    color: var(--danger);
    font-weight: bold;
    font-size: 0.9em;
}

/* Modals & Overlays */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background: linear-gradient(135deg, #ffffff, #f8f9fa);
    padding: 15px;
    border-radius: 4px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    border: 1px solid var(--primary);
    position: relative;
}

.modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(90deg, var(--warning), var(--danger), var(--success));
}

.modal h3 {
    color: var(--primary);
    margin-bottom: 8px;
    font-size: 1.1em;
    font-weight: 600;
}

.modal-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-top: 10px;
}

.modal-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 3px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 13px;
    min-width: 80px;
}

.modal-btn.confirm {
    background: linear-gradient(135deg, var(--success), #20c997);
    color: white;
}

.modal-btn.confirm:hover {
    transform: translateY(-1px);
}

.modal-btn.cancel {
    background: linear-gradient(135deg, var(--text-light), #5a6268);
    color: white;
}

.modal-btn.cancel:hover {
    transform: translateY(-1px);
}

/* Warning Messages */
.warning-message {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 1px solid var(--warning);
    border-radius: 3px;
    padding: 8px;
    margin: 8px 0;
    text-align: center;
    color: #856404;
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .exam-main-content {
        flex-direction: column;
    }
    
    .palette-section {
        width: 100%;
        height: 120px;
    }
    
    .palette-container {
        grid-template-columns: repeat(10, 1fr);
    }
}

@media (max-width: 900px) {
    .palette-container {
        grid-template-columns: repeat(8, 1fr);
    }
    
    .options-container {
        grid-template-columns: 1fr;
    }
    
    .navigation {
        flex-direction: column;
        gap: 4px;
    }
    
    .nav-btn {
        width: 100%;
    }
}

@media (max-width: 600px) {
    .palette-container {
        grid-template-columns: repeat(5, 1fr);
    }
    
    .exam-header {
        flex-direction: column;
        gap: 4px;
        text-align: center;
    }
    
    .student-info-bar {
        grid-template-columns: 1fr;
    }
    
    .modal-buttons {
        flex-direction: column;
        gap: 4px;
    }
    
    .modal-btn {
        width: 100%;
    }
}

/* Additional Elements */
#waitingMessage, #autoTransitionMessage {
    background: linear-gradient(135deg, #e7f3ff, #d1ecf1);
    border: 1px solid var(--secondary);
    border-radius: 3px;
    padding: 10px;
    margin: 10px 0;
    text-align: center;
    color: #0c5460;
}

#autoTransitionMessage {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-color: var(--warning);
    color: #856404;
}

/* Countdown Animations */
#countdown, #waitingTimer, #tabSwitchCountdown {
    font-weight: bold;
    font-size: 1em;
    color: var(--danger);
}

/* Screenshot Protection */
.screenshot-dots {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    background-image: 
        radial-gradient(circle at 25% 25%, rgba(255,0,0,0.1) 1px, transparent 1px),
        radial-gradient(circle at 75% 75%, rgba(255,0,0,0.1) 1px, transparent 1px);
    background-size: 80px 80px;
    z-index: 9999;
    opacity: 0.2;
}

/* Network Warning */
#networkWarning {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(135deg, var(--warning), #ff6b00);
    color: white;
    text-align: center;
    padding: 6px;
    z-index: 10000;
    font-weight: bold;
    font-size: 0.9em;
}
</style>
</head>

<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>LFJC ONLINE EXAMINATION</h1>
        <p style="opacity: 0.9; font-size: 0.8em;">Secure ‚Ä¢ Reliable ‚Ä¢ Efficient</p>
    </div>

    <!-- Student Entry Section -->
    <div id="studentEntry" class="student-entry">
        <h2>üéì Student Information</h2>
        
        <div class="input-group">
            <label for="stuName">üìõ Full Name</label>
            <input type="text" id="stuName" placeholder="Enter your full name" maxlength="50">
            <div id="namePrompt" class="prompt error">‚ùå Only letters, spaces and dots allowed (min 2 characters)</div>
        </div>

        <div class="input-group">
            <label for="stuSection">üè´ Section</label>
            <input type="text" id="stuSection" placeholder="Enter your section" maxlength="10">
            <div id="sectionPrompt" class="prompt error">‚ùå Only letters and digits allowed</div>
        </div>

        <div class="input-group">
            <label for="stuRoll">üéØ Roll Number</label>
            <input type="text" id="stuRoll" placeholder="Enter your roll number" maxlength="10">
            <div id="rollPrompt" class="prompt error">‚ùå Only digits allowed</div>
        </div>

        <div class="input-group">
            <label for="stuAdm">üé´ Admission Number</label>
            <input type="text" id="stuAdm" placeholder="Enter your admission number" maxlength="15">
            <div id="admPrompt" class="prompt error">‚ùå Only digits allowed</div>
        </div>

        <button id="stuStartBtn" class="start-btn">üöÄ START EXAM</button>
    </div>

    <!-- Exam Area -->
    <div id="examArea" class="exam-area">
        <div class="exam-header">
            <div id="stuInfo">üë§ Student Information</div>
            <div id="timerEl" class="timer">‚è∞ 60:00</div>
        </div>

        <div id="examWarning" class="warning-message">
            ‚ö†Ô∏è <strong>Important:</strong> Do not refresh, close the tab, or switch applications during the exam. 
            Any attempt may result in automatic submission.
        </div>

        <div class="exam-main-content">
            <!-- Question Section -->
            <div class="question-section">
                <div class="question-header">
                    <div id="stuQInfo">üìö Subject - Question 1/70</div>
                </div>
                <div id="questionContainer" class="question-container">
                    <!-- Questions will be loaded here -->
                </div>
            </div>

            <!-- Palette Section -->
            <div class="palette-section">
                <div class="palette-header">
                    üìã Question Palette
                </div>
                <div id="paletteContainer" class="palette-container">
                    <!-- Question palette will be generated here -->
                </div>
            </div>
        </div>

        <div class="navigation">
            <button id="prevBtn" class="nav-btn">‚óÄ Previous</button>
            <button id="markReviewBtn" class="nav-btn mark-review">üìå Mark Review</button>
            <button id="nextBtn" class="nav-btn">Next ‚ñ∂</button>
        </div>

        <div class="submit-section">
            <button id="submitBtn" class="submit-btn">‚úÖ SUBMIT EXAM</button>
        </div>
    </div>

    <!-- Summary Area -->
    <div id="summaryArea" class="summary-area">
        <h2>üìä Exam Summary</h2>
        
        <div class="student-info-bar">
            <div><strong>üë§ Name:</strong> <span id="summaryStudentName">-</span></div>
            <div><strong>üè´ Section:</strong> <span id="summarySection">-</span></div>
            <div><strong>üéØ Roll No:</strong> <span id="summaryRoll">-</span></div>
            <div><strong>üé´ Admission No:</strong> <span id="summaryAdm">-</span></div>
            <div><strong>üìã Assigned Form:</strong> <span id="summaryForm">-</span></div>
        </div>

        <div id="summaryTableContainer">
            <!-- Summary table will be generated here -->
        </div>

        <div id="waitingMessage">
            <h3>‚è≥ Please Wait</h3>
            <p>Your results are being processed. This page will automatically transition in <span id="waitingTimer">05:00</span></p>
        </div>

        <div id="autoTransitionMessage" style="display: none;">
            <h3>üìà Detailed Results</h3>
            <p>Transitioning to detailed results in <span id="countdown">5</span> seconds...</p>
        </div>
    </div>

    <!-- Review Area -->
    <div id="reviewArea" class="review-area">
        <h2>üîç Detailed Results & Solutions</h2>
        
        <div class="student-info-bar">
            <div><strong>üë§ Name:</strong> <span id="reviewStudentName">-</span></div>
            <div><strong>üè´ Section:</strong> <span id="reviewSection">-</span></div>
            <div><strong>üéØ Roll No:</strong> <span id="reviewRoll">-</span></div>
            <div><strong>üé´ Admission No:</strong> <span id="reviewAdm">-</span></div>
            <div><strong>üìã Assigned Form:</strong> <span id="reviewForm">-</span></div>
        </div>

        <div id="detailedResultsContainer">
            <!-- Detailed results table will be generated here -->
        </div>

        <div id="reviewQuestionsContainer">
            <!-- Question review will be generated here -->
        </div>
    </div>
</div>

<!-- Modals & Overlays -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3>ü§î Confirm Submission</h3>
        <p id="confirmText">Are you sure you want to submit the exam?</p>
        <div class="modal-buttons">
            <button id="confirmYes" class="modal-btn confirm">‚úÖ Yes, Submit</button>
            <button id="confirmNo" class="modal-btn cancel">‚ùå Cancel</button>
        </div>
    </div>
</div>

<!-- Screenshot Protection -->
<div id="screenshotProtection"></div>

<!-- Network Warning -->
<div id="networkWarning"></div>

<script>
// ===== ULTRA COMPACT JAVASCRIPT =====
// Configuration
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 1;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const MAX_QUESTIONS = 70;

// Global variables
let images = [];
let answerKey = Array(70).fill('B'); // Simplified answer key
let hasSubmitted = false;
let examStartTime = null;
let waitingTimerInterval = null;
let autoTransitionTimer = null;
let examInProgress = false;
let currentSubjData = null;
let assignedForm = 'A';
let tabSwitchDetected = false;
let tabSwitchTimeout = null;
let sessionId = null;

let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
let progress = null, timerInterval = null;

// Initialize images
for (let i = 1; i <= 70; i++) {
    images.push(`questions/${i}.png`);
}

// Simple subject organization
function shuffleQuestionsForStudent(studentData) {
    const shuffledData = {
        files: [...images],
        keys: [...answerKey],
        subjectNames: [],
        originalOrder: Array.from({length: 70}, (_, i) => i)
    };
    
    // Assign subjects: 30 Maths, 20 Physics, 20 Chemistry
    for (let i = 0; i < 70; i++) {
        if (i < 30) shuffledData.subjectNames[i] = "Maths";
        else if (i < 50) shuffledData.subjectNames[i] = "Physics";
        else shuffledData.subjectNames[i] = "Chemistry";
    }
    
    return shuffledData;
}

// Input validation
function validateNameInput(input) {
    const value = input.value.toUpperCase();
    input.value = value;
    
    const namePrompt = document.getElementById('namePrompt');
    const isValid = /^[A-Z\s\.]{2,50}$/.test(value);
    
    if (!isValid && value !== '') {
        input.classList.add('error');
        namePrompt.style.display = 'block';
    } else {
        input.classList.remove('error');
        namePrompt.style.display = 'none';
    }
    
    return isValid;
}

function validateSectionInput(input) {
    const value = input.value.toUpperCase();
    input.value = value;
    
    const sectionPrompt = document.getElementById('sectionPrompt');
    const isValid = /^[A-Z0-9]{1,10}$/.test(value);
    
    if (!isValid && value !== '') {
        input.classList.add('error');
        sectionPrompt.style.display = 'block';
    } else {
        input.classList.remove('error');
        sectionPrompt.style.display = 'none';
    }
    
    return isValid;
}

function validateRollInput(input) {
    const value = input.value;
    const rollPrompt = document.getElementById('rollPrompt');
    const isValid = /^\d{1,10}$/.test(value);
    
    if (!isValid && value !== '') {
        input.classList.add('error');
        rollPrompt.style.display = 'block';
    } else {
        input.classList.remove('error');
        rollPrompt.style.display = 'none';
    }
    
    return isValid;
}

function validateAdmInput(input) {
    const value = input.value;
    const admPrompt = document.getElementById('admPrompt');
    const isValid = /^\d{1,15}$/.test(value);
    
    if (!isValid && value !== '') {
        input.classList.add('error');
        admPrompt.style.display = 'block';
    } else {
        input.classList.remove('error');
        admPrompt.style.display = 'none';
    }
    
    return isValid;
}

function validateStudentInputs() {
    const name = document.getElementById('stuName').value.trim();
    const section = document.getElementById('stuSection').value.trim();
    const roll = document.getElementById('stuRoll').value.trim();
    const adm = document.getElementById('stuAdm').value.trim();
    
    const nameValid = validateNameInput(document.getElementById('stuName'));
    const sectionValid = validateSectionInput(document.getElementById('stuSection'));
    const rollValid = validateRollInput(document.getElementById('stuRoll'));
    const admValid = validateAdmInput(document.getElementById('stuAdm'));
    
    const allValid = nameValid && sectionValid && rollValid && admValid && 
                    name.length >= 2 && section.length >= 1 && roll.length >= 1 && adm.length >= 1;
    
    document.getElementById('stuStartBtn').style.display = allValid ? 'block' : 'none';
    
    return allValid;
}

// Timer functions
function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    const startTime = Date.now();
    
    timerInterval = setInterval(() => {
        if (!progress) return;
        
        const currentTime = Date.now();
        const elapsed = Math.floor((currentTime - startTime) / 1000);
        progress.timeLeftSec = Math.max(0, (EXAM_DURATION_MS / 1000) - elapsed);
        
        const minutes = Math.floor(progress.timeLeftSec / 60);
        const seconds = Math.floor(progress.timeLeftSec % 60);
        const timerEl = document.getElementById('timerEl');
        timerEl.textContent = `‚è∞ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (progress.timeLeftSec <= 300 && progress.timeLeftSec > 60) {
            timerEl.classList.add('blink');
        }
        
        if (progress.timeLeftSec <= 60) {
            timerEl.classList.remove('blink');
            timerEl.classList.add('blink-line');
        }
        
        if (progress.timeLeftSec <= 0) {
            clearInterval(timerInterval);
            calculateAndShowResults();
        }
    }, 1000);
}

// Question display functions
function getCurrentSubject(qIndex) {
    return examData.subjectNames[qIndex] || "Unknown";
}

function showQuestion(qIndex) {
    if (!progress || qIndex < 0 || qIndex >= examData.files.length) return;
    
    progress.currentQ = qIndex;
    
    const container = document.getElementById('questionContainer');
    container.innerHTML = '';
    
    const qInfo = document.getElementById('stuQInfo');
    const currentSubject = getCurrentSubject(qIndex);
    qInfo.textContent = `üìö ${currentSubject} - Question ${qIndex + 1}/${examData.files.length}`;
    
    const imgContainer = document.createElement('div');
    imgContainer.className = 'question-img-container';
    
    const img = new Image();
    img.src = examData.files[qIndex];
    img.className = 'question-img';
    img.alt = `Question ${qIndex + 1}`;
    
    img.onerror = function() {
        imgContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: var(--danger);">
                <h3>‚ùå Image Load Error</h3>
                <p>Failed to load question ${qIndex + 1}.</p>
            </div>
        `;
    };
    
    imgContainer.appendChild(img);
    container.appendChild(imgContainer);
    
    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'options-container';
    optionsContainer.innerHTML = `
        <button class="optBtn" data-opt="A">A</button>
        <button class="optBtn" data-opt="B">B</button>
        <button class="optBtn" data-opt="C">C</button>
        <button class="optBtn" data-opt="D">D</button>
    `;
    
    container.appendChild(optionsContainer);
    
    const currentAnswer = progress.answers[qIndex];
    if (currentAnswer !== null) {
        const selectedBtn = optionsContainer.querySelector(`[data-opt="${currentAnswer}"]`);
        if (selectedBtn) selectedBtn.classList.add('selected');
    }
    
    const optBtns = optionsContainer.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.addEventListener('click', () => selectOption(qIndex, btn.dataset.opt));
    });
    
    updatePalette();
    updateNavigationButtons();
}

function selectOption(qIndex, option) {
    if (!progress || hasSubmitted) return;
    
    if (progress.answers[qIndex] === option) {
        progress.answers[qIndex] = null;
    } else {
        progress.answers[qIndex] = option;
    }
    
    const optBtns = document.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.opt === progress.answers[qIndex]) {
            btn.classList.add('selected');
        }
    });
    
    updatePalette();
}

// Palette functions
function initPalette() {
    const palette = document.getElementById('paletteContainer');
    palette.innerHTML = '';
    
    for (let i = 0; i < examData.files.length; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.dataset.qIndex = i;
        btn.className = 'palette-btn';
        
        btn.addEventListener('click', () => {
            if (!hasSubmitted) {
                showQuestion(i);
            }
        });
        
        palette.appendChild(btn);
    }
    
    updatePalette();
}

function updatePalette() {
    if (!progress) return;
    
    const paletteBtns = document.querySelectorAll('#paletteContainer button');
    paletteBtns.forEach(btn => {
        const qIndex = parseInt(btn.dataset.qIndex);
        
        btn.classList.remove('selected', 'reviewed', 'current');
        
        if (qIndex === progress.currentQ) {
            btn.classList.add('current');
        }
        
        if (progress.answers[qIndex] !== null) {
            btn.classList.add('selected');
        }
        
        if (progress.markedReview.has(qIndex)) {
            btn.classList.add('reviewed');
        }
    });
}

// Navigation functions
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const markReviewBtn = document.getElementById('markReviewBtn');
    
    prevBtn.disabled = progress.currentQ === 0;
    nextBtn.disabled = progress.currentQ === examData.files.length - 1;
    
    if (progress.markedReview.has(progress.currentQ)) {
        markReviewBtn.textContent = '‚ùå Unmark Review';
        markReviewBtn.classList.add('reviewed');
    } else {
        markReviewBtn.textContent = 'üìå Mark Review';
        markReviewBtn.classList.remove('reviewed');
    }
}

document.getElementById('prevBtn').addEventListener('click', () => {
    if (progress.currentQ > 0) {
        showQuestion(progress.currentQ - 1);
    }
});

document.getElementById('nextBtn').addEventListener('click', () => {
    if (progress.currentQ < examData.files.length - 1) {
        showQuestion(progress.currentQ + 1);
    }
});

document.getElementById('markReviewBtn').addEventListener('click', () => {
    if (!progress) return;
    
    const currentQ = progress.currentQ;
    if (progress.markedReview.has(currentQ)) {
        progress.markedReview.delete(currentQ);
    } else {
        progress.markedReview.add(currentQ);
    }
    
    updatePalette();
    updateNavigationButtons();
});

// Exam submission
document.getElementById('submitBtn').addEventListener('click', () => {
    const unanswered = progress.answers.filter(answer => answer === null).length;
    const message = unanswered > 0 
        ? `You have ${unanswered} unanswered questions. Are you sure you want to submit?`
        : 'Are you sure you want to submit the exam?';
    
    showConfirmModal(message, calculateAndShowResults);
});

function showConfirmModal(message, confirmCallback) {
    const modal = document.getElementById('confirmModal');
    const confirmText = document.getElementById('confirmText');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    
    confirmText.textContent = message;
    
    confirmYes.onclick = () => {
        modal.style.display = 'none';
        confirmCallback();
    };
    
    confirmNo.onclick = () => {
        modal.style.display = 'none';
    };
    
    modal.style.display = 'flex';
}

function calculateAndShowResults() {
    if (hasSubmitted) return;
    
    hasSubmitted = true;
    examInProgress = false;
    
    clearInterval(timerInterval);
    clearInterval(waitingTimerInterval);
    if (tabSwitchTimeout) clearInterval(tabSwitchTimeout);
    
    const subjData = calculateSubjectMarks();
    currentSubjData = subjData;
    
    showSummary(subjData);
}

function calculateSubjectMarks() {
    const subjData = {};
    const totalQuestions = examData.files.length;
    
    for (let i = 0; i < totalQuestions; i++) {
        const subjectName = examData.subjectNames[i];
        
        if (!subjData[subjectName]) {
            subjData[subjectName] = {
                correct: 0,
                wrong: 0,
                blank: 0,
                total: 0,
                marks: 0
            };
        }
        
        const answer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        
        if (answer === null) {
            subjData[subjectName].blank++;
        } else if (answer === correctAnswer) {
            subjData[subjectName].correct++;
            subjData[subjectName].marks += MARK_PER_CORRECT;
        } else {
            subjData[subjectName].wrong++;
            subjData[subjectName].marks += MARK_PER_WRONG;
        }
        
        subjData[subjectName].total++;
    }
    
    return subjData;
}

// Summary and review functions
function showSummary(subjData) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'block';
    
    const student = progress.student;
    document.getElementById('summaryStudentName').textContent = student.name;
    document.getElementById('summarySection').textContent = student.sec;
    document.getElementById('summaryRoll').textContent = student.roll;
    document.getElementById('summaryAdm').textContent = student.adm;
    document.getElementById('summaryForm').textContent = assignedForm;
    
    const tableContainer = document.getElementById('summaryTableContainer');
    tableContainer.innerHTML = createSummaryTable(subjData);
    
    startWaitingTimer(5000); // 5 seconds wait
}

function createSummaryTable(subjData) {
    let tableHTML = `
        <table class="results-table">
            <thead>
                <tr>
                    <th>üìö Subject</th>
                    <th>‚úÖ Correct</th>
                    <th>‚ùå Wrong</th>
                    <th>‚ö™ Blank</th>
                    <th>üìä Total</th>
                    <th>üéØ Marks</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalMarks = 0;
    
    for (const [subject, data] of Object.entries(subjData)) {
        tableHTML += `
            <tr>
                <td>${subject}</td>
                <td>${data.correct}</td>
                <td>${data.wrong}</td>
                <td>${data.blank}</td>
                <td>${data.total}</td>
                <td>${data.marks.toFixed(2)}</td>
            </tr>
        `;
        
        totalCorrect += data.correct;
        totalWrong += data.wrong;
        totalBlank += data.blank;
        totalMarks += data.marks;
    }
    
    tableHTML += `
            <tr class="total-row">
                <td><strong>üéØ TOTAL</strong></td>
                <td><strong>${totalCorrect}</strong></td>
                <td><strong>${totalWrong}</strong></td>
                <td><strong>${totalBlank}</strong></td>
                <td><strong>${totalCorrect + totalWrong + totalBlank}</strong></td>
                <td><strong>${totalMarks.toFixed(2)}</strong></td>
            </tr>
        </tbody>
        </table>
    `;
    
    return tableHTML;
}

function startWaitingTimer(timeRemaining) {
    let remainingMs = timeRemaining;
    
    waitingTimerInterval = setInterval(() => {
        remainingMs -= 1000;
        
        const seconds = Math.floor(remainingMs / 1000);
        
        document.getElementById('waitingTimer').textContent = 
            `00:${seconds.toString().padStart(2, '0')}`;
        
        if (remainingMs <= 0) {
            clearInterval(waitingTimerInterval);
            showAutoTransition();
        }
    }, 1000);
}

function showAutoTransition() {
    document.getElementById('waitingMessage').style.display = 'none';
    document.getElementById('autoTransitionMessage').style.display = 'block';
    
    let countdown = 3;
    document.getElementById('countdown').textContent = countdown;
    
    autoTransitionTimer = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(autoTransitionTimer);
            showDetailedSolutions();
        }
    }, 1000);
}

function showDetailedSolutions() {
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'block';
    
    const student = progress.student;
    document.getElementById('reviewStudentName').textContent = student.name;
    document.getElementById('reviewSection').textContent = student.sec;
    document.getElementById('reviewRoll').textContent = student.roll;
    document.getElementById('reviewAdm').textContent = student.adm;
    document.getElementById('reviewForm').textContent = assignedForm;
    
    const detailedContainer = document.getElementById('detailedResultsContainer');
    detailedContainer.innerHTML = createDetailedResultsTable(currentSubjData);
    
    createQuestionReview();
}

function createDetailedResultsTable(subjData) {
    let tableHTML = `
        <table class="detailed-results-table">
            <thead>
                <tr>
                    <th>üìö Subject</th>
                    <th>‚úÖ Correct</th>
                    <th>‚ùå Wrong</th>
                    <th>‚ö™ Blank</th>
                    <th>üìä Total Questions</th>
                    <th>üéØ Marks Obtained</th>
                    <th>üìà Percentage</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalMarks = 0, totalQuestions = 0;
    
    for (const [subject, data] of Object.entries(subjData)) {
        const percentage = ((data.marks / (data.total * MARK_PER_CORRECT)) * 100).toFixed(2);
        
        tableHTML += `
            <tr>
                <td><strong>${subject}</strong></td>
                <td>${data.correct}</td>
                <td>${data.wrong}</td>
                <td>${data.blank}</td>
                <td>${data.total}</td>
                <td>${data.marks.toFixed(2)}</td>
                <td>${percentage}%</td>
            </tr>
        `;
        
        totalCorrect += data.correct;
        totalWrong += data.wrong;
        totalBlank += data.blank;
        totalMarks += data.marks;
        totalQuestions += data.total;
    }
    
    const overallPercentage = ((totalMarks / (totalQuestions * MARK_PER_CORRECT)) * 100).toFixed(2);
    
    tableHTML += `
            <tr class="total-row">
                <td><strong>üéØ GRAND TOTAL</strong></td>
                <td><strong>${totalCorrect}</strong></td>
                <td><strong>${totalWrong}</strong></td>
                <td><strong>${totalBlank}</strong></td>
                <td><strong>${totalQuestions}</strong></td>
                <td><strong>${totalMarks.toFixed(2)}</strong></td>
                <td><strong>${overallPercentage}%</strong></td>
            </tr>
        </tbody>
        </table>
    `;
    
    return tableHTML;
}

function createQuestionReview() {
    const container = document.getElementById('reviewQuestionsContainer');
    container.innerHTML = '<h3 style="text-align:center; color:var(--primary); margin-bottom: 10px;">üîç Question-wise Analysis</h3>';
    
    for (let i = 0; i < 5; i++) { // Show only first 5 for demo
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-review-item';
        
        const studentAnswer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        const isCorrect = studentAnswer === correctAnswer;
        const isAttempted = studentAnswer !== null;
        
        let statusClass = '', statusText = '', statusEmoji = '';
        
        if (!isAttempted) {
            statusClass = 'not-attempted';
            statusText = 'Not Attempted';
            statusEmoji = '‚ö™';
        } else if (isCorrect) {
            statusClass = 'correct';
            statusText = 'Correct';
            statusEmoji = '‚úÖ';
        } else {
            statusClass = 'wrong';
            statusText = 'Wrong';
            statusEmoji = '‚ùå';
        }
        
        questionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <h4 style="margin: 0; color: var(--primary); font-size: 0.9em;">üìù Question ${i + 1}</h4>
                <div class="answer-status ${statusClass}">
                    ${statusEmoji} ${statusText}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 6px; font-size: 0.85em;">
                <div>
                    <strong>üéØ Your Answer:</strong> 
                    <span class="${isAttempted ? (isCorrect ? 'correct-answer' : 'wrong-answer') : ''}">
                        ${isAttempted ? studentAnswer : 'Not Attempted'}
                    </span>
                </div>
                <div>
                    <strong>‚úÖ Correct Answer:</strong> 
                    <span class="correct-answer">${correctAnswer}</span>
                </div>
            </div>
        `;
        
        container.appendChild(questionDiv);
    }
}

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    sessionId = Date.now().toString();
    
    // Setup event listeners
    document.getElementById('stuName').addEventListener('input', function() {
        validateNameInput(this);
        validateStudentInputs();
    });
    
    document.getElementById('stuSection').addEventListener('input', function() {
        validateSectionInput(this);
        validateStudentInputs();
    });
    
    document.getElementById('stuRoll').addEventListener('input', function() {
        validateRollInput(this);
        validateStudentInputs();
    });
    
    document.getElementById('stuAdm').addEventListener('input', function() {
        validateAdmInput(this);
        validateStudentInputs();
    });
    
    document.getElementById('stuStartBtn').addEventListener('click', startExam);
});

function startExam() {
    if (!validateStudentInputs()) return;
    
    examInProgress = true;
    examStartTime = Date.now();
    
    const studentData = {
        name: document.getElementById('stuName').value.trim(),
        sec: document.getElementById('stuSection').value.trim(),
        roll: document.getElementById('stuRoll').value.trim(),
        adm: document.getElementById('stuAdm').value.trim()
    };
    
    examData = shuffleQuestionsForStudent(studentData);
    
    progress = {
        student: studentData,
        answers: new Array(examData.files.length).fill(null),
        currentQ: 0,
        timeLeftSec: EXAM_DURATION_MS / 1000,
        markedReview: new Set(),
        sessionId: sessionId
    };
    
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'block';
    
    document.getElementById('stuInfo').textContent = 
        `üë§ ${studentData.name} | üè´ ${studentData.sec} | üéØ Roll: ${studentData.roll}`;
    
    startTimer();
    initPalette();
    showQuestion(0);
}
</script>
</body>
</html>
