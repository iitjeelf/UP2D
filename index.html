<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* ===== BASE STYLES ===== */
:root {
  --primary-color: #4B0082;
  --secondary-color: #D8BFD8;
  --light-purple: #E6E6FA;
  --white: #fff;
  --black: #000;
  --success: #32CD32;
  --warning: #ff9900;
  --danger: #ff6666;
  --shadow: 0 5px 15px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "SF Pro Display", Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--black);
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Disable text selection */
body {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* ===== ENHANCED SCREENSHOT PROTECTION ===== */
#screenshotProtection {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483647;
  pointer-events: none;
}

.screenshot-dots {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 200px 200px;
  animation: flicker 0.5s infinite;
  pointer-events: none;
}

.screenshot-lines {
  position: absolute;
  width: 100%;
  height: 100%;
  background: repeating-linear-gradient(0deg, 
    transparent, 
    transparent 2px, 
    rgba(255,255,255,0.01) 2px, 
    rgba(255,255,255,0.01) 4px);
  background-size: 20px 20px;
  animation: flicker 0.3s infinite;
  pointer-events: none;
}

.screenshot-grid {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    linear-gradient(rgba(255,255,255,0.01) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,0.01) 1px, transparent 1px);
  background-size: 50px 50px;
  pointer-events: none;
}

@keyframes flicker {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.9; }
}

/* ===== SECURITY WARNING STYLES ===== */
#securityBlurOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(10px);
  z-index: 2147483646;
  display: none;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
  font-size: 24px;
  font-weight: bold;
}

.security-warning-toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: linear-gradient(145deg, #ff0000, #cc0000);
  color: white;
  padding: 15px 25px;
  border-radius: 8px;
  z-index: 2147483647;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* ===== HEADER & FOOTER ===== */
header {
  background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
  color: var(--primary-color);
  text-align: center;
  padding: 20px;
  font-size: 36px;
  font-weight: 700;
  letter-spacing: 1.5px;
  box-shadow: var(--shadow);
  text-shadow: 0 1px 2px var(--white);
}

footer {
  background: var(--light-purple);
  color: var(--primary-color);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  position: fixed;
  width: 100%;
  bottom: 0;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 140px);
  padding: 16px;
  text-align: center;
}

.form-group {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  margin-bottom: 60px;
  width: 100%;
  max-width: 500px;
}

.form-group label {
  font-size: 1.15rem;
  font-weight: 600;
  margin-right: 10px;
  color: var(--primary-color);
  width: 180px;
  text-align: right;
}

input[type="text"], input[type="number"] {
  padding: 12px 14px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: 1.5px solid var(--primary-color);
  outline: none;
  min-width: 250px;
  transition: var(--transition);
}

input[type="text"]:focus, input[type="number"]:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
  animation: glowRed 0.5s alternate infinite;
  border-color: var(--danger);
}

@keyframes glowRed {
  0% { box-shadow: 0 0 5px var(--danger); }
  100% { box-shadow: 0 0 15px var(--danger); }
}

/* ===== BUTTON STYLES ===== */
button {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: none;
  border-radius: 12px;
  transition: var(--transition);
  box-shadow: 0 6px #aaa;
  background: linear-gradient(to bottom, #fafaff, #dcd6f7);
  color: var(--primary-color);
  font-weight: 600;
  padding: 12px 24px;
  font-size: 18px;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,.28);
}

button:active {
  transform: translateY(3px) scale(.98);
}

button:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

.optBtn {
  font-size: 16px;
  padding: 8px 18px;
  margin: 6px;
  border: 2px solid var(--primary-color);
  background: var(--white);
  border-radius: 8px;
  box-shadow: 0 5px #aaa;
}

.optBtn.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

.optBtn.correct {
  background: #32CD32;
  color: white;
  border-color: #228B22;
}

.optBtn.wrong {
  background: #FF6B6B;
  color: white;
  border-color: #DC143C;
}

.optBtn.not-attempted {
  background: #B0B0B0;
  color: white;
  border-color: #808080;
}

.navBtn {
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 8px;
  color: var(--white);
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(145deg, #1E90FF, #4682B4);
  margin: 0 15px;
}

#markReviewBtn {
  background: linear-gradient(145deg, #ffb84d, var(--warning));
}

#submitBtn {
  background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== TIMER STYLES ===== */
#timerEl {
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
  padding: 6px 12px;
  border-radius: 6px;
  background: #f0f0ff;
  display: inline-block;
  transition: var(--transition);
}

#timerEl.blink {
  animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
  0% { background: var(--danger); color: var(--white); }
  50% { background: var(--white); color: var(--primary-color); }
  100% { background: var(--danger); color: var(--white); }
}

/* ===== PALETTE STYLES ===== */
#paletteContainer {
  display: grid;
  gap: 8px;
  margin: 20px auto;
  max-width: 100%;
  padding: 0 10px;
  justify-content: center;
}

#paletteContainer button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 14px;
  margin: 2px;
  border: 1px solid var(--primary-color);
  background: var(--light-purple);
  color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

#paletteContainer button.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

#paletteContainer button.reviewed {
  background: yellow;
  color: var(--black);
}

#paletteContainer button.current {
  border: 3px solid red;
}

#paletteContainer button.correct-answer {
  background: #32CD32;
  color: white;
}

#paletteContainer button.wrong-answer {
  background: #FF6B6B;
  color: white;
}

#paletteContainer button.not-attempted-answer {
  background: #B0B0B0;
  color: white;
}

/* ===== EXAM AREA STYLES ===== */
#examArea {
  padding: 16px;
  text-align: center;
  display: none;
}

#examHeader {
  display: flex;
  align-items: center;
  width: 100%;
  font-weight: bold;
  margin-bottom: 20px;
}

#stuInfo {
  flex: 0 0 auto;
  text-align: left;
  white-space: nowrap;
}

#stuQInfo {
  flex: 1;
  text-align: center;
  white-space: nowrap;
}

.sectionTitle {
  font-size: 22px;
  color: var(--primary-color);
  font-weight: bold;
  margin-bottom: 8px;
}

/* ===== IMAGE STYLES ===== */
.questionImg {
  max-width: 100%;
  height: auto;
  border-radius: 10px;
  display: block;
  margin: 0 auto;
  border: 2px solid #E6E6FA;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.image-error {
  background: #ffebee;
  border: 2px solid #ffcdd2;
  color: #c62828;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  font-weight: bold;
}

.image-error h3 {
  margin: 0 0 10px 0;
  color: #c62828;
}

/* ===== ANIMATIONS ===== */
.glow {
  animation: glowPulse 1.6s infinite alternate;
  box-shadow: 0 8px 18px rgba(75,0,130,0.12);
}

@keyframes glowPulse {
  0% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
  50% { box-shadow: 0 12px 30px rgba(75,0,130,0.14); transform: translateY(-2px); }
  100% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
}

/* ===== ACCESS DENIED SCREEN STYLES ===== */
.access-denied {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #4B0082, #8A2BE2);
  z-index: 10000;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
  padding: 20px;
}

.access-denied h1 {
  font-size: 3em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.access-code-input {
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  width: 300px;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn {
  background: white;
  color: #4B0082;
  border: none;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.access-error {
  color: #ffeb3b;
  margin-top: 10px;
  font-weight: 600;
  display: none;
}

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 600px) {
  .form-group {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .form-group label {
    text-align: left;
    width: auto;
    margin-bottom: 5px;
  }
  
  #examHeader {
    flex-direction: column;
    gap: 10px;
  }
  
  #stuInfo, #stuQInfo {
    text-align: center;
  }
  
  .navContainer {
    flex-direction: column;
    align-items: center;
  }
  
  .navBtn {
    width: 80%;
    margin-bottom: 10px;
    margin-left: 0;
    margin-right: 0;
  }
  
  #paletteContainer {
    grid-template-columns: repeat(5, 1fr) !important;
    gap: 6px;
  }
  
  #paletteContainer button {
    width: 35px;
    height: 35px;
    font-size: 12px;
  }
}

@media (min-width: 601px) and (max-width: 900px) {
  #paletteContainer {
    grid-template-columns: repeat(10, 1fr) !important;
  }
}

@media (min-width: 901px) and (max-width: 1200px) {
  #paletteContainer {
    grid-template-columns: repeat(15, 1fr) !important;
  }
}

@media (min-width: 1201px) {
  #paletteContainer {
    grid-template-columns: repeat(20, 1fr) !important;
  }
}

/* ===== RESULTS TABLE STYLES ===== */
.results-table {
  width: 100%;
  max-width: 900px;
  margin: 20px auto;
  border-collapse: collapse;
  font-size: 18px;
  text-align: center;
}

.results-table th {
  background: #E6E6FA;
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table td {
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table tr:nth-child(even) {
  background: #f9f9f9;
}

.results-table tr:hover {
  background: #f0f0ff;
}

/* ===== 3x3 NUMERICAL KEYPAD STYLES ===== */
.numerical-keypad {
  margin: 25px auto;
  max-width: 320px;
}

.keypad-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
  padding: 15px;
  background: #f8f9fa;
  border-radius: 15px;
  border: 2px solid #4B0082;
  box-shadow: 0 8px 16px rgba(75, 0, 130, 0.1);
}

.num-key-btn {
  width: 70px;
  height: 70px;
  font-size: 28px;
  font-weight: bold;
  border: 3px solid #4B0082;
  border-radius: 15px;
  background: linear-gradient(145deg, #ffffff, #f0f0ff);
  color: #4B0082;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 6px 0 rgba(75, 0, 130, 0.2);
}

.num-key-btn:hover {
  background: linear-gradient(145deg, #f0f0ff, #e6e6fa);
  transform: translateY(-3px);
  box-shadow: 0 8px 0 rgba(75, 0, 130, 0.3);
}

.num-key-btn:active {
  transform: translateY(2px);
  box-shadow: 0 2px 0 rgba(75, 0, 130, 0.2);
}

.num-key-btn:focus {
  outline: 3px solid #4B0082 !important;
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2) !important;
}

.special-btn {
  font-size: 24px;
}

.clear-btn {
  background: linear-gradient(145deg, #ff9900, #ff8c00);
  color: white;
  border-color: #ff8c00;
}

.submit-num-btn {
  background: linear-gradient(145deg, #32CD32, #228B22);
  color: white;
  border-color: #228B22;
  font-size: 26px;
}

/* Tab navigation focus styles */
.fill-blank-input:focus {
  outline: 3px solid #4B0082 !important;
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2) !important;
}

.optBtn:focus {
  outline: 3px solid #4B0082 !important;
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2) !important;
}

.navBtn:focus {
  outline: 3px solid #4B0082 !important;
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2) !important;
}

.palette-btn:focus {
  outline: 3px solid #4B0082 !important;
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2) !important;
}

/* ===== TOAST NOTIFICATION STYLES ===== */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 24px;
  border-radius: 8px;
  color: white;
  font-weight: bold;
  z-index: 10000;
  animation: toastSlideIn 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.toast-success {
  background: linear-gradient(145deg, #32CD32, #228B22);
}

.toast-warning {
  background: linear-gradient(145deg, #FFA500, #FF8C00);
}

.toast-error {
  background: linear-gradient(145deg, #FF4500, #DC143C);
}

.toast-info {
  background: linear-gradient(145deg, #1E90FF, #4682B4);
}

@keyframes toastSlideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes toastSlideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(100%); opacity: 0; }
}

/* ===== QUESTION TRANSITION ANIMATION ===== */
.question-transition {
  animation: fadeIn 0.5s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.question-fade-in {
  animation: fadeIn 0.3s ease;
}

/* ===== SHAKE ANIMATION ===== */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
  20%, 40%, 60%, 80% { transform: translateX(5px); }
}
</style>
</head>

<body>

<!-- Access Denied Screen -->
<div id="accessDenied" class="access-denied">
    <h1>LFJC ONLINE EXAMINATION</h1>
    <p style="font-size: 1.2em; margin: 10px 0;">TOTAL 75 QUESTIONS</p>
    <p style="margin: 5px 0;">‚Ä¢ Maths: Q1-20 (MCQ), Q21-25 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Physics: Q26-45 (MCQ), Q46-50 (Numerical Input)</p>
    <p style="margin: 5px 0;">‚Ä¢ Chemistry: Q51-70 (MCQ), Q71-75 (Numerical Input)</p>
    <p style="margin: 10px 0; font-weight: bold;">CORRECT ANSWER + 4 MARKS</p>
    <p style="margin: 5px 0; font-weight: bold;">WRONG ANSWER -1 MARK</p>
    <p style="margin: 15px 0; max-width: 600px; line-height: 1.5;">
        <strong>Instructions:</strong><br>
        1. First Answer only questions you are sure about<br>
        2. If you spend more than 2-3 minutes on a question without a clear path to the answer, immediately click Mark for Review and move on<br>
        3. Second Tackle marked/review questions
    </p>
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry" style="display:none;">
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <!-- Form Assignment Display -->
  <div id="formAssignment" class="form-assignment" style="display:none;">
    <h3>üìã ASSIGNED FORM</h3>
    <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
    <p>Your responses will be submitted to this form</p>
  </div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
    <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
    <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span> |
      <b>Form:</b> <span id="summaryForm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<footer>@LFJC2025 All Rights Reserved</footer>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
  <div class="screenshot-dots"></div>
  <div class="screenshot-lines"></div>
  <div class="screenshot-grid"></div>
</div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 180; // 3 hours
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const ACCESS_CODE = "lfjc2025";
const ADMIN_PASSWORD = "admin2025";

// QUESTION STRUCTURE CONFIGURATION
const QUESTION_STRUCTURE = {
  total: 75,
  subjects: [
    { 
      name: "Maths", 
      start: 1, 
      end: 25, 
      mcqRange: [1, 20], 
      fillBlanksRange: [21, 25]
    },
    { 
      name: "Physics", 
      start: 26, 
      end: 50, 
      mcqRange: [26, 45], 
      fillBlanksRange: [46, 50]
    },
    { 
      name: "Chemistry", 
      start: 51, 
      end: 75, 
      mcqRange: [51, 70], 
      fillBlanksRange: [71, 75]
    }
  ]
};

// ===== CHROME MENU BLOCKING SYSTEM =====
class ChromeMenuBlocker {
    constructor() {
        this.menuBlocked = false;
        this.mutationObserver = null;
        this.intervalCheck = null;
        this.violationCount = 0;
        this.maxViolations = 3;
        this.examInProgress = false;
    }
    
    enable() {
        console.log('üõ°Ô∏è Enabling Chrome menu blocking...');
        this.menuBlocked = true;
        this.examInProgress = true;
        
        // 1. Block ALL keyboard shortcuts
        this.blockAllKeyboardShortcuts();
        
        // 2. Block right-click and context menu
        this.blockContextMenu();
        
        // 3. Block drag and drop
        this.blockDragDrop();
        
        // 4. Monitor for menu opening
        this.startMenuMonitoring();
        
        // 5. Block ALL screenshot methods
        this.blockAllScreenshotMethods();
        
        // 6. Inject protective styles
        this.injectProtectiveStyles();
        
        console.log('‚úÖ Chrome menu blocking enabled');
    }
    
    blockAllKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // Block ALL function keys
            if (e.key.startsWith('F') && e.key.length > 1) {
                e.preventDefault();
                e.stopPropagation();
                this.logViolation('function_key');
                return false;
            }
            
            // Block Alt key combinations (menu access)
            if (e.altKey) {
                e.preventDefault();
                e.stopPropagation();
                this.logViolation('alt_key');
                return false;
            }
            
            // Block Ctrl/Command key combinations
            if (e.ctrlKey || e.metaKey) {
                // Allow Ctrl+C, Ctrl+V, Ctrl+Z for exam navigation
                if (!(e.key === 'c' || e.key === 'v' || e.key === 'z' || 
                      e.key === 'x' || e.key === 'a')) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.logViolation('ctrl_key');
                    return false;
                }
            }
            
            // Block Print Screen
            if (e.key === 'PrintScreen' || e.keyCode === 44) {
                e.preventDefault();
                e.stopPropagation();
                this.triggerSecurityResponse('screenshot_attempt');
                return false;
            }
            
            // Block Escape key
            if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
                this.logViolation('escape_key');
                return false;
            }
        }, true);
    }
    
    blockContextMenu() {
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            this.showSecurityWarning('Right-click disabled');
            this.logViolation('right_click');
            return false;
        }, true);
        
        // Also block long press on mobile
        document.addEventListener('touchstart', (e) => {
            this.touchStartTime = Date.now();
        }, true);
        
        document.addEventListener('touchend', (e) => {
            const touchDuration = Date.now() - this.touchStartTime;
            if (touchDuration > 1000) { // Long press
                e.preventDefault();
                this.showSecurityWarning('Long press disabled');
                this.logViolation('long_press');
            }
        }, true);
    }
    
    blockDragDrop() {
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
            return false;
        }, true);
        
        document.addEventListener('drop', (e) => {
            e.preventDefault();
            return false;
        }, true);
        
        // Make all images non-draggable
        document.querySelectorAll('img').forEach(img => {
            img.setAttribute('draggable', 'false');
        });
    }
    
    startMenuMonitoring() {
        // Monitor DOM changes for menu elements
        this.mutationObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
                            this.checkForMenuElements(node);
                        }
                    });
                }
            });
        });
        
        this.mutationObserver.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['class', 'id', 'style']
        });
        
        // Periodic check for menu-like elements
        this.intervalCheck = setInterval(() => {
            this.scanForMenuElements();
        }, 2000);
    }
    
    checkForMenuElements(element) {
        const suspiciousClasses = [
            'menu', 'dropdown', 'toolbar', 'chrome', 'browser',
            'settings', 'options', 'more', 'hamburger', 'nav'
        ];
        
        const suspiciousIds = [
            'menu', 'dropdown', 'toolbar', 'chrome', 'browser',
            'settings', 'options', 'more', 'hamburger'
        ];
        
        const classList = element.className?.toString().toLowerCase() || '';
        const id = element.id?.toLowerCase() || '';
        const tag = element.tagName?.toLowerCase();
        
        // Check for suspicious elements
        if (tag === 'menu' || tag === 'menuitem' || tag === 'select') {
            this.handleMenuDetection(element);
            return;
        }
        
        // Check classes
        for (const suspicious of suspiciousClasses) {
            if (classList.includes(suspicious)) {
                this.handleMenuDetection(element);
                return;
            }
        }
        
        // Check IDs
        for (const suspicious of suspiciousIds) {
            if (id.includes(suspicious)) {
                this.handleMenuDetection(element);
                return;
            }
        }
        
        // Check children recursively
        if (element.children) {
            Array.from(element.children).forEach(child => {
                this.checkForMenuElements(child);
            });
        }
    }
    
    scanForMenuElements() {
        // Scan all elements for menu-like properties
        const allElements = document.querySelectorAll('*');
        allElements.forEach(element => {
            const style = window.getComputedStyle(element);
            
            // Check for dropdown-like styles
            if (style.position === 'absolute' || style.position === 'fixed') {
                if (style.zIndex > 1000) {
                    this.checkForMenuElements(element);
                }
            }
            
            // Check for high z-index elements
            if (parseInt(style.zIndex) > 999) {
                this.checkForMenuElements(element);
            }
        });
    }
    
    blockAllScreenshotMethods() {
        // Override screen capture API if available
        if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
            const originalGetDisplayMedia = navigator.mediaDevices.getDisplayMedia;
            navigator.mediaDevices.getDisplayMedia = function() {
                console.warn('‚ö†Ô∏è Screen capture blocked');
                throw new Error('Screen capture disabled for exam security');
            };
        }
        
        // Block clipboard write (screenshots)
        if (navigator.clipboard && navigator.clipboard.write) {
            const originalWrite = navigator.clipboard.write;
            navigator.clipboard.write = function() {
                console.warn('‚ö†Ô∏è Clipboard write blocked');
                throw new Error('Clipboard disabled for exam security');
            };
        }
    }
    
    injectProtectiveStyles() {
        // Inject styles that make screenshots useless
        const style = document.createElement('style');
        style.textContent = `
            /* Make text difficult to screenshot clearly */
            body::before {
                content: "";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: 
                    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.01) 1px, transparent 1px),
                    radial-gradient(circle at 30% 40%, rgba(255,255,255,0.01) 1px, transparent 1px);
                background-size: 100px 100px;
                pointer-events: none;
                z-index: 2147483646;
                mix-blend-mode: overlay;
            }
            
            /* Add noise to confuse OCR */
            .question-container::after {
                content: "";
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.02"><filter id="noise"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="3" stitchTiles="stitch"/></filter><rect width="100" height="100" filter="url(%23noise)"/></svg>');
                pointer-events: none;
                z-index: 1;
            }
        `;
        document.head.appendChild(style);
    }
    
    handleMenuDetection(element) {
        console.warn('‚ö†Ô∏è Menu element detected:', element);
        this.violationCount++;
        
        // Remove the menu element if possible
        try {
            if (element.parentNode) {
                element.parentNode.removeChild(element);
            }
        } catch (e) {
            // Element might be protected
        }
        
        // Show security warning
        this.showSecurityWarning(`Security violation detected (${this.violationCount}/${this.maxViolations})`);
        
        // Blur screen temporarily
        this.blurScreen();
        
        // Auto-submit if too many violations
        if (this.violationCount >= this.maxViolations) {
            this.triggerAutoSubmit();
        }
    }
    
    blurScreen() {
        const blurOverlay = document.createElement('div');
        blurOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2147483645;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            animation: fadeIn 0.3s ease;
        `;
        blurOverlay.innerHTML = `
            <div style="background: rgba(255, 0, 0, 0.8); padding: 30px; border-radius: 15px; border: 3px solid white;">
                ‚ö†Ô∏è SECURITY ALERT<br>
                <div style="font-size: 18px; margin-top: 10px;">
                    Unauthorized action detected
                </div>
            </div>
        `;
        
        document.body.appendChild(blurOverlay);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (blurOverlay.parentNode) {
                blurOverlay.style.opacity = '0';
                blurOverlay.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    if (blurOverlay.parentNode) {
                        document.body.removeChild(blurOverlay);
                    }
                }, 500);
            }
        }, 3000);
    }
    
    showSecurityWarning(message) {
        // Remove existing warnings
        document.querySelectorAll('.security-warning-toast').forEach(w => w.remove());
        
        const warning = document.createElement('div');
        warning.className = 'security-warning-toast';
        warning.textContent = `‚ö†Ô∏è ${message}`;
        
        document.body.appendChild(warning);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (warning.parentNode) {
                warning.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (warning.parentNode) {
                        document.body.removeChild(warning);
                    }
                }, 300);
            }
        }, 3000);
    }
    
    logViolation(type) {
        console.warn(`Security violation: ${type}`);
        
        // Store in localStorage for tracking
        const violations = JSON.parse(localStorage.getItem('exam_violations') || '[]');
        violations.push({
            type: type,
            timestamp: new Date().toISOString(),
            url: window.location.href
        });
        localStorage.setItem('exam_violations', JSON.stringify(violations));
    }
    
    triggerSecurityResponse(type) {
        this.logViolation(type);
        this.showSecurityWarning('Screenshot attempt blocked!');
        this.blurScreen();
        
        if (this.violationCount >= 2) {
            this.triggerAutoSubmit();
        }
    }
    
    triggerAutoSubmit() {
        this.showSecurityWarning('Exam will be submitted due to security violations');
        
        setTimeout(() => {
            if (typeof submitExam === 'function') {
                submitExam();
            } else {
                // Force page reload if submit function not available
                window.location.reload();
            }
        }, 2000);
    }
    
    disable() {
        this.menuBlocked = false;
        this.examInProgress = false;
        
        if (this.mutationObserver) {
            this.mutationObserver.disconnect();
        }
        
        if (this.intervalCheck) {
            clearInterval(this.intervalCheck);
        }
        
        console.log('üîì Chrome menu blocking disabled');
    }
}

// Initialize Chrome menu blocker
const chromeMenuBlocker = new ChromeMenuBlocker();

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let sheetReady = false;
let hasSubmitted = false;
let examStartTime = null;
let examInProgress = false;
let assignedForm = 'A';

const subjects = ["Maths", "Physics", "Chemistry"];
let examData = {files: [], subjectNames: [], keys: [], originalOrder: [], questionTypes: []};
let progress = null, timerInterval = null;

// ===== INITIALIZE DEMO DATA =====
function initializeDemoData() {
    answerKey = [];
    
    for (let i = 1; i <= 75; i++) {
        if (i <= 20 || (i >= 26 && i <= 45) || (i >= 51 && i <= 70)) {
            const options = ['A', 'B', 'C', 'D'];
            answerKey.push(options[Math.floor(Math.random() * options.length)]);
        } else {
            answerKey.push(String(Math.floor(Math.random() * 100) + 1));
        }
    }
    
    images = [];
    for (let i = 1; i <= 75; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    clearErrors();
    validateStudentInputs();
}

// ===== LOAD ANSWER KEY =====
async function loadAnswerKeyFromRepo() {
    try {
        const response = await fetch('Answers/Key');
        
        if (!response.ok) {
            throw new Error(`Failed to fetch answer key: ${response.status}`);
        }
        
        const text = await response.text();
        const lines = text.trim().split('\n').filter(line => line.trim() !== '');
        const parsedAnswers = [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            if (line.includes(',')) {
                const answers = line.split(',').map(a => a.trim().toUpperCase());
                parsedAnswers.push(...answers);
            } else if (line.length > 1 && /^[ABCD0-9]+$/.test(line)) {
                const answers = line.split('').map(a => a.toUpperCase());
                parsedAnswers.push(...answers);
            } else {
                parsedAnswers.push(line.toUpperCase());
            }
            
            if (parsedAnswers.length >= 75) break;
        }
        
        if (parsedAnswers.length === 75) {
            answerKey = parsedAnswers.slice(0, 75);
            keyLoaded = true;
            
            images = [];
            for (let i = 1; i <= 75; i++) {
                images.push(`questions/${i}.png`);
            }
            
            console.log("‚úÖ Answer key loaded");
            clearErrors();
            validateStudentInputs();
        } else {
            throw new Error('Invalid answer key format');
        }
        
    } catch (error) {
        console.error("‚ùå Failed to load answer key, using demo data");
        initializeDemoData();
    }
}

// ===== EXAM PREPARATION =====
function prepareExamData() {
  examData.files = []; examData.subjectNames = []; examData.keys = []; examData.originalOrder = []; examData.questionTypes = [];
  
  const subjectRanges = [
    { name: "Maths", start: 1, end: 25 },
    { name: "Physics", start: 26, end: 50 },
    { name: "Chemistry", start: 51, end: 75 }
  ];
  
  let groups = [];
  
  subjectRanges.forEach(subject => {
    const subjectQuestions = [];
    const subjectKeys = [];
    const subjectOriginalOrder = [];
    const subjectTypes = [];
    
    for (let i = subject.start; i <= subject.end; i++) {
      const imgIndex = i - 1;
      if (images[imgIndex] && answerKey[imgIndex]) {
        subjectQuestions.push(images[imgIndex]);
        subjectKeys.push(answerKey[imgIndex]);
        subjectOriginalOrder.push(imgIndex);
        
        let questionType = 'mcq';
        if ((subject.name === "Maths" && i >= 21 && i <= 25) ||
            (subject.name === "Physics" && i >= 46 && i <= 50) ||
            (subject.name === "Chemistry" && i >= 71 && i <= 75)) {
          questionType = 'fill-blank';
        }
        subjectTypes.push(questionType);
      }
    }
    
    const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
    
    groups.push({
      name: subject.name,
      imgs: shuffledIndices.map(i => subjectQuestions[i]),
      keys: shuffledIndices.map(i => subjectKeys[i]),
      originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i]),
      types: shuffledIndices.map(i => subjectTypes[i])
    });
  });
  
  const shuffledGroups = shuffleArray(groups);
  
  shuffledGroups.forEach(g => {
    g.imgs.forEach((img, i) => {
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
      examData.originalOrder.push(g.originalOrder[i]);
      examData.questionTypes.push(g.types[i]);
    });
  });
}

// ===== RENDER QUESTION =====
function renderQuestion() {
  const idx = progress.currentIndex;
  const container = document.getElementById('questionContainer');
  
  const imagePath = examData.files[idx];
  const questionNumber = idx + 1;
  const questionType = examData.questionTypes[idx];
  const subject = examData.subjectNames[idx];
  
  let optionsHTML = '';
  
  if (questionType === 'fill-blank') {
    optionsHTML = `
      <div class="fill-blank-container">
        <div style="margin: 20px 0; font-weight: bold; color: #4B0082; font-size: 18px;">
          Enter numerical answer:
        </div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 15px; margin: 25px 0;">
          <input type="number" 
                 id="fillBlankInput" 
                 class="fill-blank-input"
                 placeholder="Enter number"
                 value="${progress.answers[idx] || ''}"
                 min="0"
                 step="any"
                 style="
                   padding: 12px 18px;
                   font-size: 22px;
                   border: 2px solid #4B0082;
                   border-radius: 8px;
                   width: 200px;
                   text-align: center;
                   outline: none;
                   font-weight: bold;
                 "
                 oninput="handleNumericalInput(this, ${idx})"
                 onkeypress="handleNumericalKeyPress(event, ${idx})"
                 tabindex="0">
          <button class="submit-fill-blank-btn" 
                  onclick="submitNumericalAnswer(${idx})"
                  tabindex="0"
                  style="
                    padding: 12px 24px;
                    background: linear-gradient(145deg, #32CD32, #228B22);
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                  ">
            Submit
          </button>
        </div>
        
        <div class="numerical-keypad">
          <div class="keypad-grid">
            ${[1,2,3,4,5,6,7,8,9].map(num => `
              <button class="num-key-btn" 
                      onclick="handleKeypadButton('${num}', ${idx})"
                      tabindex="0">
                ${num}
              </button>
            `).join('')}
            <button class="num-key-btn special-btn" 
                    onclick="handleKeypadButton('0', ${idx})"
                    tabindex="0">
              0
            </button>
            <button class="num-key-btn special-btn clear-btn" 
                    onclick="handleKeypadButton('C', ${idx})"
                    tabindex="0">
              C
            </button>
            <button class="num-key-btn special-btn submit-num-btn" 
                    onclick="handleKeypadButton('‚úì', ${idx})"
                    tabindex="0">
              ‚úì
            </button>
          </div>
        </div>
      </div>
    `;
  } else {
    optionsHTML = `
      <div class="options-container">
        <button class="optBtn ${progress.answers[idx] === 'A' ? 'selected' : ''}" data-opt="A" tabindex="0">A</button>
        <button class="optBtn ${progress.answers[idx] === 'B' ? 'selected' : ''}" data-opt="B" tabindex="0">B</button>
        <button class="optBtn ${progress.answers[idx] === 'C' ? 'selected' : ''}" data-opt="C" tabindex="0">C</button>
        <button class="optBtn ${progress.answers[idx] === 'D' ? 'selected' : ''}" data-opt="D" tabindex="0">D</button>
      </div>
    `;
  }
  
  container.innerHTML = `
    <div class="question-transition question-fade-in">
      <div class="question-number">Question ${questionNumber} of 75</div>
      <div class="sectionTitle">${subject} (${questionType === 'fill-blank' ? 'Numerical Input' : 'MCQ'})</div>
      
      <div style="width: 100%; overflow: auto; min-height: 300px; display: flex; justify-content: center; align-items: center;">
        <img src="${imagePath}" 
             class="questionImg" 
             alt="Question ${questionNumber}"
             style="max-width: 100%; height: auto;"
             onload="console.log('‚úÖ Image loaded: ${imagePath}')"
             onerror="handleSimpleImageError(this, ${idx})">
      </div>
      
      ${optionsHTML}
    </div>
  `;
  
  if (questionType !== 'fill-blank') {
    document.querySelectorAll('.optBtn').forEach(btn => {
      btn.onclick = function() { 
        selectOption(this.getAttribute('data-opt')); 
      };
    });
  } else {
    setTimeout(() => {
      const input = document.getElementById('fillBlankInput');
      if (input) input.focus();
    }, 100);
  }
  
  updateQuestionInfo();
  updatePalette();
}

// ===== NUMERICAL INPUT FUNCTIONS =====
function handleNumericalInput(inputElement, questionIndex) {
  const value = inputElement.value;
  const cleanedValue = value.replace(/[^0-9\.\-]/g, '');
  const decimalCount = (cleanedValue.match(/\./g) || []).length;
  if (decimalCount > 1) {
    const parts = cleanedValue.split('.');
    inputElement.value = parts[0] + '.' + parts.slice(1).join('');
  } else if (cleanedValue !== value) {
    inputElement.value = cleanedValue;
  }
}

function handleNumericalKeyPress(event, questionIndex) {
  const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '-', 'Enter', 'Backspace', 'Delete', 'Tab'];
  if (!allowedKeys.includes(event.key) && !event.ctrlKey && !event.altKey && !event.metaKey) {
    event.preventDefault();
    return;
  }
  if (event.key === 'Enter') {
    submitNumericalAnswer(questionIndex);
    event.preventDefault();
  }
}

function handleKeypadButton(button, questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  let currentValue = input.value;
  
  switch(button) {
    case 'C': input.value = ''; break;
    case '‚úì': submitNumericalAnswer(questionIndex); break;
    default: input.value = currentValue + button; break;
  }
  
  input.focus();
}

function submitNumericalAnswer(questionIndex) {
  const input = document.getElementById('fillBlankInput');
  if (!input) return;
  
  const answer = input.value.trim();
  
  if (answer === '') {
    showToast('Please enter a numerical answer', 'warning', 2000);
    return;
  }
  
  if (!/^-?\d+(\.\d+)?$/.test(answer)) {
    showToast('Please enter a valid number', 'error', 2000);
    return;
  }
  
  progress.answers[questionIndex] = answer;
  showToast('‚úì Answer submitted!', 'success', 2000);
  updatePalette();
  
  setTimeout(() => {
    if (questionIndex < examData.files.length - 1) {
      progress.currentIndex++;
      renderQuestion();
      updateNavButtons();
    }
  }, 1500);
}

function showToast(message, type = 'info', duration = 2000) {
  const existingToasts = document.querySelectorAll('.toast');
  existingToasts.forEach(toast => {
    toast.style.animation = 'toastSlideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  });
  
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    z-index: 10000;
    animation: toastSlideIn 0.3s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  `;
  
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'toastSlideOut 0.3s ease';
    setTimeout(() => {
      if (toast.parentNode) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, duration);
}

// ===== UTILITY FUNCTIONS =====
function shuffleArray(arr) {
    const c = arr.slice();
    for (let i = c.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [c[i], c[j]] = [c[j], c[i]];
    }
    return c;
}

// ===== INPUT VALIDATION =====
function validateStudentInputs() {
  const n = document.getElementById('stuName'), 
        s = document.getElementById('stuSection'), 
        r = document.getElementById('stuRoll'), 
        a = document.getElementById('stuAdm');
  
  if (s.value) s.value = s.value.toUpperCase();
  
  let v1 = /^[A-Za-z .]+$/.test(n.value), 
      v2 = /^[A-Za-z0-9]+$/.test(s.value),
      v3 = /^[0-9]+$/.test(r.value), 
      v4 = /^[0-9]+$/.test(a.value);
  
  n.classList.toggle('error', !v1 && n.value !== ""); 
  s.classList.toggle('error', !v2 && s.value !== "");
  r.classList.toggle('error', !v3 && r.value !== ""); 
  a.classList.toggle('error', !v4 && a.value !== "");
  
  const allValid = v1 && v2 && v3 && v4 && keyLoaded;
  document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
  
  return allValid;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    
    errorElement.style.display = 'none';
    
    if (enteredCode === ACCESS_CODE) {
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => accessDenied.style.animation = '', 500);
    }
}

// ===== EXAM START =====
function startExam() {
    if (!keyLoaded) {
        alert('Answer key not loaded. Contact admin.');
        return;
    }

    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');

    // Enable Chrome menu blocking BEFORE starting exam
    chromeMenuBlocker.enable();
    
    prepareExamData();
    
    progress = {
        answers: Array(examData.files.length).fill(null),
        review: Array(examData.files.length).fill(false),
        currentIndex: 0,
        student: {name: stuName.value, sec: stuSection.value, roll: stuRoll.value, adm: stuAdm.value},
        timeLeftSec: EXAM_DURATION_MINUTES * 60
    };

    examStartTime = Date.now();
    examInProgress = true;
    
    document.getElementById('studentEntry').style.display = "none";
    document.getElementById('examArea').style.display = "block";
    renderQuestion(); 
    renderPalette(); 
    startTimer(); 
    updateNavButtons();
    
    sheetReady = true;
}

// ===== PALETTE FUNCTIONS =====
function renderPalette() {
  const container = document.getElementById('paletteContainer');
  container.innerHTML = '';
  
  for (let i = 0; i < examData.files.length; i++) {
    const btn = document.createElement('button');
    btn.className = 'palette-btn';
    btn.textContent = i + 1;
    btn.tabindex = "0";
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
    
    btn.onclick = () => {
      progress.currentIndex = i;
      renderQuestion();
      updateNavButtons();
    };
    
    container.appendChild(btn);
  }
}

function updatePalette() {
  const buttons = document.querySelectorAll('.palette-btn');
  buttons.forEach((btn, i) => {
    btn.className = 'palette-btn';
    
    if (examData.questionTypes[i] === 'fill-blank') {
      btn.style.background = '#FFD700';
      btn.style.color = '#000';
    } else {
      btn.style.background = '';
      btn.style.color = '';
    }
    
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
  });
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavButtons() {
  const idx = progress.currentIndex;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const markReviewBtn = document.getElementById('markReviewBtn');
  
  prevBtn.disabled = idx === 0;
  nextBtn.disabled = idx === examData.files.length - 1;
  
  if (progress.review[idx]) {
    markReviewBtn.textContent = 'Unmark Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #dc3545, #c82333)';
  } else {
    markReviewBtn.textContent = 'Mark for Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
  }
}

document.getElementById('prevBtn').onclick = () => {
  if (progress.currentIndex > 0) {
    progress.currentIndex--;
    renderQuestion();
    updateNavButtons();
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (progress.currentIndex < examData.files.length - 1) {
    progress.currentIndex++;
    renderQuestion();
    updateNavButtons();
  }
};

document.getElementById('markReviewBtn').onclick = () => {
  const idx = progress.currentIndex;
  progress.review[idx] = !progress.review[idx];
  updateNavButtons();
  updatePalette();
};

// ===== TIMER FUNCTIONS =====
function startTimer() {
  timerInterval = setInterval(() => {
    progress.timeLeftSec--;
    
    const minutes = Math.floor(progress.timeLeftSec / 60);
    const seconds = progress.timeLeftSec % 60;
    const timerEl = document.getElementById('timerEl');
    
    timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (progress.timeLeftSec <= 300) timerEl.classList.add('blink');
    
    if (progress.timeLeftSec <= 0) {
      clearInterval(timerInterval);
      submitExam();
    }
  }, 1000);
}

// ===== SUBMISSION FUNCTIONS =====
function submitExam() {
  if (hasSubmitted) return;
  clearInterval(timerInterval);
  
  hasSubmitted = true;
  examInProgress = false;
  
  // Disable Chrome menu blocking after exam
  chromeMenuBlocker.disable();
  
  const subjData = {};
  examData.subjectNames.forEach((s, i) => {
    const subjectName = s;
    if (!subjData[subjectName]) subjData[subjectName] = {
      correct: 0, wrong: 0, blank: 0, total: 0, marks: 0,
      mcq: { total: 0, correct: 0 },
      fillBlank: { total: 0, correct: 0 }
    };
    
    const ans = progress.answers[i];
    const questionType = examData.questionTypes[i];
    
    if (questionType === 'mcq') {
      subjData[subjectName].mcq.total++;
    } else {
      subjData[subjectName].fillBlank.total++;
    }
    
    if (ans === null) {
      subjData[subjectName].blank++;
    } else if (ans === examData.keys[i]) {
      subjData[subjectName].correct++;
      subjData[subjectName].marks += MARK_PER_CORRECT;
      
      if (questionType === 'mcq') {
        subjData[subjectName].mcq.correct++;
      } else {
        subjData[subjectName].fillBlank.correct++;
      }
    } else {
      subjData[subjectName].wrong++;
      subjData[subjectName].marks += MARK_PER_WRONG;
    }
    subjData[subjectName].total++;
  });

  // Show summary
  showSummaryInterface(subjData);
}

// ===== SUMMARY INTERFACE =====
function showSummaryInterface(subjData) {
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'block';
  
  document.getElementById('summaryStudentName').textContent = progress.student.name;
  document.getElementById('summarySection').textContent = progress.student.sec;
  document.getElementById('summaryRoll').textContent = progress.student.roll;
  document.getElementById('summaryAdm').textContent = progress.student.adm;
  document.getElementById('summaryForm').textContent = assignedForm;
  
  const table = document.createElement('table');
  table.className = 'results-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>Subject</th>
        <th>MCQ (Correct/Total)</th>
        <th>Numerical (Correct/Total)</th>
        <th>Total Correct</th>
        <th>Wrong</th>
        <th>Blank</th>
        <th>Total</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>
      ${Object.entries(subjData).map(([subject, data]) => `
        <tr>
          <td>${subject}</td>
          <td>${data.mcq.correct}/${data.mcq.total}</td>
          <td>${data.fillBlank.correct}/${data.fillBlank.total}</td>
          <td>${data.correct}</td>
          <td>${data.wrong}</td>
          <td>${data.blank}</td>
          <td>${data.total}</td>
          <td>${data.marks.toFixed(2)}</td>
        </tr>
      `).join('')}
      <tr class="total-row">
        <td><strong>Total</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.mcq.correct, 0)}/${Object.values(subjData).reduce((sum, d) => sum + d.mcq.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.fillBlank.correct, 0)}/${Object.values(subjData).reduce((sum, d) => sum + d.fillBlank.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.total, 0)}</strong></td>
        <td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td>
      </tr>
    </tbody>
  `;
  
  document.getElementById('summaryTableContainer').innerHTML = '';
  document.getElementById('summaryTableContainer').appendChild(table);
  
  document.getElementById('closeSummaryBtn').onclick = () => {
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  };
}

// ===== EVENT LISTENERS =====
["stuName", "stuSection", "stuRoll", "stuAdm"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateStudentInputs);
});

document.getElementById('stuStartBtn').onclick = () => { 
  if (!validateStudentInputs()) return; 
  startExam(); 
};

document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
document.getElementById('accessCode').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') verifyAccessCode();
});

document.getElementById('submitBtn').onclick = () => {
  if (confirm("Submit Exam? You cannot change answers after submission.")) {
    submitExam();
  }
};

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
  console.log('LFJC Online Exam System Initialized');
  
  document.getElementById('accessDenied').style.display = 'flex';
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'none';
  
  document.getElementById('accessCode').focus();
  
  // Load answer key
  loadAnswerKeyFromRepo();
});

// Additional security measures
window.addEventListener('beforeunload', function (e) {
    if (examInProgress && !hasSubmitted) {
        e.preventDefault();
        e.returnValue = 'Are you sure you want to leave? The exam will be submitted.';
        return e.returnValue;
    }
});

// Prevent going back
history.pushState(null, null, location.href);
window.onpopstate = function () {
    history.go(1);
};

console.log("üéØ LFJC Online Exam System Loaded");
console.log("‚úÖ 75 questions with specified structure");
console.log("‚úÖ Enhanced Chrome menu blocking enabled");
console.log("‚úÖ Anti-screenshot protection active");
</script>
</body>
</html>
