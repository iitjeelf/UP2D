<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Examination - Complete System</title>
<style>
/* Your existing CSS styles remain intact */
:root {
  --primary-color: #4B0082;
  --secondary-color: #D8BFD8;
  --light-purple: #E6E6FA;
  --white: #fff;
  --black: #000;
  --success: #32CD32;
  --warning: #ff9900;
  --danger: #ff6666;
  --shadow: 0 5px 15px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
  background: var(--white);
  color: var(--black);
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Your existing CSS continues... */

/* ===== ENHANCED: DETAILED SOLUTIONS STYLES ===== */
.solution-container {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 25px;
  margin: 25px 0;
  border-left: 5px solid #4B0082;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

.solution-container:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.15);
}

.solution-question {
  font-weight: bold;
  margin-bottom: 18px;
  color: #4B0082;
  font-size: 1.3em;
  border-bottom: 2px solid #e9ecef;
  padding-bottom: 10px;
}

.solution-answer {
  padding: 15px;
  border-radius: 10px;
  margin: 12px 0;
  font-weight: 600;
  font-size: 1.1em;
  transition: all 0.3s ease;
}

.solution-correct {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  color: #155724;
  border: 2px solid #28a745;
  box-shadow: 0 2px 5px rgba(40, 167, 69, 0.3);
}

.solution-wrong {
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
  color: #721c24;
  border: 2px solid #dc3545;
  box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
}

.solution-not-attempted {
  background: linear-gradient(135deg, #e2e3e5, #d6d8db);
  color: #383d41;
  border: 2px solid #6c757d;
  box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);
}

.solution-explanation {
  background: #fff3cd;
  padding: 18px;
  border-radius: 10px;
  margin-top: 18px;
  font-style: italic;
  border-left: 4px solid #ffc107;
  border-right: 4px solid #ffc107;
}

.solution-marks {
  font-weight: bold;
  margin-top: 12px;
  padding: 10px 15px;
  border-radius: 8px;
  background: #e8f4fd;
  display: inline-block;
  border: 2px solid #17a2b8;
  font-size: 1.1em;
}

/* ===== ENHANCED: AUTO TRANSITION STYLES ===== */
.auto-transition-message {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  border: 3px solid #28a745;
  color: #155724;
  padding: 25px;
  border-radius: 12px;
  margin: 35px 0;
  text-align: center;
  font-weight: bold;
  font-size: 1.2em;
  animation: pulse 2s infinite;
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.waiting-message {
  background: linear-gradient(135deg, #d1ecf1, #bee5eb);
  border: 3px solid #17a2b8;
  color: #0c5460;
  padding: 30px;
  border-radius: 12px;
  margin: 35px 0;
  text-align: center;
  font-weight: bold;
  font-size: 1.2em;
  box-shadow: 0 4px 15px rgba(23, 162, 184, 0.3);
}

.waiting-timer {
  font-size: 2.5em;
  font-weight: bold;
  color: #4B0082;
  margin: 20px 0;
  font-family: 'Courier New', monospace;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

@keyframes pulse {
  0% { transform: scale(1); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
  50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(40, 167, 69, 0.5); }
  100% { transform: scale(1); box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); }
}

/* ===== ENHANCED: SUCCESS MESSAGE STYLES ===== */
.submission-success {
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
  border: 3px solid #28a745;
  color: #155724;
  padding: 25px;
  border-radius: 12px;
  margin: 25px 0;
  text-align: center;
  font-weight: bold;
  box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.submission-success h3 {
  color: #155724;
  margin-bottom: 15px;
  font-size: 1.4em;
}

/* Rest of your existing CSS remains unchanged */
</style>
</head>

<body>

<!-- Your existing HTML structure -->
<div id="accessDenied" class="access-denied">
    <h1>ACCESS REQUIRED</h1>
    <p>Please enter the access code to continue with the examination.</p>
    <p>If you don't have the access code, contact your administrator.</p>
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry" style="display:none;">
  <!-- Your existing student entry form -->
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <!-- Form Assignment Display -->
  <div id="formAssignment" class="form-assignment" style="display:none;">
    <h3>üìã ASSIGNED FORM</h3>
    <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
    <p>Your responses will be submitted to Google Forms automatically</p>
  </div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<!-- Exam Area -->
<div id="examArea" style="display:none;">
  <div id="examHeader">
    <div id="stuInfo"></div>
    <div id="stuQInfo"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div class="exam-main-content">
    <div class="question-section">
      <div id="questionContainer" class="question-container"></div>
    </div>

    <div class="palette-section">
      <div class="palette-header">üìã Question Palette (1-60)</div>
      <div id="paletteContainer" class="palette-container"></div>
    </div>
  </div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span> |
      <b>Form:</b> <span id="summaryForm"></span>
    </div>
  </div>
  
  <!-- Google Forms Submission Status -->
  <div id="submissionStatus"></div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <div id="waitingMessage" class="waiting-message" style="display:none;">
      <div>‚è≥ Waiting for Exam Time to Complete</div>
      <div class="waiting-timer" id="waitingTimer">00:00</div>
      <div>Detailed solutions will be available automatically when the exam time is over.</div>
    </div>
    
    <div id="autoTransitionMessage" class="auto-transition-message" style="display:none;">
      üîÑ Auto-transitioning to detailed solutions in <span id="countdown">5</span> seconds...
    </div>
    
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<!-- ENHANCED: Review Area with Detailed Solutions -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span> |
      <b>Form:</b> <span id="reviewForm"></span>
    </div>
    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #e8f5e8, #d4edda); border-radius: 10px; border: 2px solid #28a745;">
      <strong>üéØ Performance Analysis:</strong> Review your answers with detailed explanations and correct solutions. Compare your selected options with correct answers.
    </div>
  </div>
  
  <!-- Results Table -->
  <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
  
  <!-- Download Section -->
  <div id="downloadSection" class="download-section">
    <h4 style="color: #4B0082; margin-bottom: 15px;">üì• Download Your Answer Sheet</h4>
    <button onclick="downloadStudentCSV()" class="download-btn">
      üíæ Download Complete Answer Sheet (CSV)
    </button>
    <p style="margin-top: 10px; color: #6c757d;">
      <small>Contains all your selected options (A,B,C,D) in original question order. Perfect for analysis in Excel.</small>
    </p>
  </div>
  
  <!-- ENHANCED: Detailed Solutions Container -->
  <div id="reviewQuestionsContainer"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close Results</button>
  </div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<!-- Your existing modals -->
<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<script>
// ===== ENHANCED CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 10;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const ACCESS_CODE = "lfjc2025";
const ADMIN_PASSWORD = "admin2025";

// ===== GOOGLE FORMS INTEGRATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
    'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDlY-5BAF5rPvzQS0AeTI6Vs2Rkri0V6_miA0mRivZAEg/formResponse"
};

const FORM_FIELDS = {
    STUDENT_NAME: "entry.217666919",
    SECTION: "entry.2006392966",
    ROLL_NUMBER: "entry.547275105",
    ADMISSION_NUMBER: "entry.1234063852",
    MATHS_MARKS: "entry.1989859216",
    PHYSICS_MARKS: "entry.1953974928",
    CHEMISTRY_MARKS: "entry.296331194",
    TOTAL_MARKS: "entry.1289040887",
    ANSWERS_JSON: "entry.2139100252"
};

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let hasSubmitted = false;
let examStartTime = null;
let waitingTimerInterval = null;
let autoTransitionTimer = null;
let assignedForm = 'A';

let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
let progress = null, timerInterval = null;
let currentSubjData = null;

// ===== INITIALIZATION =====
function initializeDemoData() {
    // Create demo answer key for 60 questions
    answerKey = [];
    for (let i = 0; i < 60; i++) {
        const options = ['A', 'B', 'C', 'D'];
        answerKey.push(options[Math.floor(Math.random() * options.length)]);
    }
    
    // Create demo image paths
    for (let i = 1; i <= 60; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    clearErrors();
    validateStudentInputs();
    console.log('‚úÖ Demo system initialized with 60 questions');
}

// ===== GOOGLE FORMS SUBMISSION =====
async function submitToGoogleForms(studentData, marksData, answersData) {
    const FORM_URL = GOOGLE_FORMS[assignedForm];
    
    if (!FORM_URL) {
        console.error(`‚ùå No form URL for ${assignedForm}`);
        return false;
    }

    try {
        const formData = new URLSearchParams();
        formData.append(FORM_FIELDS.STUDENT_NAME, studentData.name);
        formData.append(FORM_FIELDS.SECTION, studentData.sec);
        formData.append(FORM_FIELDS.ROLL_NUMBER, studentData.roll);
        formData.append(FORM_FIELDS.ADMISSION_NUMBER, studentData.adm);
        formData.append(FORM_FIELDS.MATHS_MARKS, marksData.maths.toFixed(2));
        formData.append(FORM_FIELDS.PHYSICS_MARKS, marksData.physics.toFixed(2));
        formData.append(FORM_FIELDS.CHEMISTRY_MARKS, marksData.chemistry.toFixed(2));
        formData.append(FORM_FIELDS.TOTAL_MARKS, marksData.total.toFixed(2));
        
        // üéØ INCLUDING ALL STUDENT SELECTED OPTIONS AS JSON
        const answersJSON = {
            timestamp: new Date().toISOString(),
            student: studentData,
            assignedForm: assignedForm,
            allAnswers: answersData,
            marks: marksData,
            submissionType: 'exam_completion'
        };
        formData.append(FORM_FIELDS.ANSWERS_JSON, JSON.stringify(answersJSON));

        console.log("üì§ Submitting to Google Forms:", {
            form: assignedForm,
            student: studentData.name,
            answersCount: answersData.length,
            marks: marksData
        });

        const response = await fetch(FORM_URL, {
            method: "POST",
            mode: "no-cors",
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: formData
        });

        console.log("‚úÖ Successfully submitted to Google Form", assignedForm);
        return true;

    } catch (error) {
        console.error("‚ùå Google Forms submission failed:", error);
        return false;
    }
}

// ===== ENHANCED SUBMISSION WITH GOOGLE FORMS =====
async function submitExamWithGoogleForms(subjData) {
    const studentData = progress.student;
    
    // Calculate marks
    const marksData = {
        maths: subjData.Mathematics?.marks || 0,
        physics: subjData.Physics?.marks || 0,
        chemistry: subjData.Chemistry?.marks || 0,
        total: (subjData.Mathematics?.marks || 0) + (subjData.Physics?.marks || 0) + (subjData.Chemistry?.marks || 0)
    };

    // üéØ CAPTURE ALL STUDENT SELECTED OPTIONS
    const answersData = progress.answers.map((answer, index) => ({
        questionNumber: index + 1,
        subject: examData.subjectNames[index],
        studentSelectedOption: answer, // This captures A, B, C, D or null
        correctAnswer: examData.keys[index],
        isCorrect: answer === examData.keys[index],
        marksEarned: answer === examData.keys[index] ? MARK_PER_CORRECT : (answer ? MARK_PER_WRONG : 0),
        status: answer === examData.keys[index] ? 'correct' : (answer ? 'wrong' : 'not_attempted')
    }));

    console.log("üéØ Student Selected Options Being Submitted:", answersData);

    // Submit to Google Forms
    const submissionSuccess = await submitToGoogleForms(studentData, marksData, answersData);
    
    // Show submission status
    showSubmissionStatus(submissionSuccess, studentData);
    
    return submissionSuccess;
}

function showSubmissionStatus(success, studentData) {
    const statusContainer = document.getElementById('submissionStatus');
    
    if (success) {
        statusContainer.innerHTML = `
            <div class="submission-success">
                <h3>‚úÖ Successfully Submitted to Google Forms!</h3>
                <p>All your selected answers (A,B,C,D) have been recorded in Form ${assignedForm}</p>
                <p><strong>Student:</strong> ${studentData.name} | <strong>Roll:</strong> ${studentData.roll}</p>
                <p><em>Detailed solutions will appear shortly...</em></p>
            </div>
        `;
    } else {
        statusContainer.innerHTML = `
            <div class="warning-banner">
                <h3>‚ö†Ô∏è Submission Note</h3>
                <p>Your answers are saved locally. Google Forms submission encountered an issue.</p>
                <p><strong>Contact administrator with your roll number: ${studentData.roll}</strong></p>
            </div>
        `;
    }
}

// ===== ENHANCED DETAILED SOLUTIONS SYSTEM =====
function showDetailedSolutions() {
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'block';
    
    // Set student info
    document.getElementById('reviewStudentName').textContent = progress.student.name;
    document.getElementById('reviewSection').textContent = progress.student.sec;
    document.getElementById('reviewRoll').textContent = progress.student.roll;
    document.getElementById('reviewAdm').textContent = progress.student.adm;
    document.getElementById('reviewForm').textContent = assignedForm;
    
    // Render detailed results table
    renderDetailedResultsTable();
    
    // Render comprehensive solutions
    renderComprehensiveSolutions();
}

function renderComprehensiveSolutions() {
    const container = document.getElementById('reviewQuestionsContainer');
    container.innerHTML = '<h3 style="text-align:center; color:#4B0082; margin:30px 0; font-size: 1.8em;">üìö Detailed Question Solutions & Analysis</h3>';
    
    let totalCorrect = 0;
    let totalMarks = 0;

    for (let i = 0; i < examData.files.length; i++) {
        const studentAnswer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        const isCorrect = studentAnswer === correctAnswer;
        const subject = examData.subjectNames[i];
        
        if (isCorrect) totalCorrect++;
        totalMarks += isCorrect ? MARK_PER_CORRECT : (studentAnswer ? MARK_PER_WRONG : 0);

        const solutionDiv = document.createElement('div');
        solutionDiv.className = 'solution-container';
        
        let statusClass = 'solution-not-attempted';
        let statusText = 'Not Attempted';
        let marksText = '0 marks';
        let answerComparison = '';
        
        if (studentAnswer) {
            if (isCorrect) {
                statusClass = 'solution-correct';
                statusText = 'Correct ‚úì';
                marksText = `+${MARK_PER_CORRECT} marks`;
                answerComparison = `You selected <strong>${studentAnswer}</strong> which is correct.`;
            } else {
                statusClass = 'solution-wrong';
                statusText = 'Incorrect ‚úó';
                marksText = `${MARK_PER_WRONG} marks`;
                answerComparison = `You selected <strong>${studentAnswer}</strong>, but correct answer is <strong>${correctAnswer}</strong>.`;
            }
        } else {
            answerComparison = `You did not attempt this question. Correct answer is <strong>${correctAnswer}</strong>.`;
        }

        solutionDiv.innerHTML = `
            <div class="solution-question">
                üìù Question ${i+1} - ${subject} 
                <span style="float: right; font-size: 0.9em; background: ${isCorrect ? '#28a745' : (studentAnswer ? '#dc3545' : '#6c757d')}; color: white; padding: 5px 12px; border-radius: 20px;">${statusText}</span>
            </div>
            
            <div class="solution-answer ${statusClass}">
                ${answerComparison}
            </div>
            
            <div class="solution-marks">
                üèÜ ${marksText}
            </div>
            
            <div class="solution-explanation">
                <strong>üí° Learning Point:</strong> 
                ${generateDetailedExplanation(subject, i+1, studentAnswer, correctAnswer)}
            </div>
        `;
        
        container.appendChild(solutionDiv);
    }

    // Add performance summary
    const performanceDiv = document.createElement('div');
    performanceDiv.className = 'solution-container';
    performanceDiv.style.background = 'linear-gradient(135deg, #e8f5e8, #d4edda)';
    performanceDiv.style.borderLeft = '5px solid #28a745';
    performanceDiv.innerHTML = `
        <div class="solution-question">üéØ Overall Performance Summary</div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px;">
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #28a745;">${totalCorrect}/${examData.files.length}</div>
                <div style="font-size: 1.1em; margin-top: 10px;">Correct Answers</div>
                <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">${((totalCorrect/examData.files.length)*100).toFixed(1)}% Accuracy</div>
            </div>
            <div style="text-align: center; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                <div style="font-size: 2em; font-weight: bold; color: #4B0082;">${totalMarks}</div>
                <div style="font-size: 1.1em; margin-top: 10px;">Total Marks</div>
                <div style="font-size: 0.9em; color: #6c757d; margin-top: 5px;">Out of ${examData.files.length * MARK_PER_CORRECT}</div>
            </div>
        </div>
        <div style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 8px; text-align: center;">
            <strong>üìä Form Submitted:</strong> ${assignedForm} | <strong>All your selected options (A,B,C,D) have been recorded</strong>
        </div>
    `;
    container.insertBefore(performanceDiv, container.firstChild);
}

function generateDetailedExplanation(subject, questionNumber, studentAnswer, correctAnswer) {
    const explanations = {
        Mathematics: [
            "This problem tests your understanding of mathematical concepts and problem-solving approach. Focus on the step-by-step methodology.",
            "Mathematical reasoning requires careful analysis of the problem statement and systematic application of formulas.",
            "Practice similar problems to strengthen your conceptual understanding and improve accuracy.",
            "Pay attention to units, calculations, and logical progression in mathematical problem-solving."
        ],
        Physics: [
            "Physics questions often combine theoretical knowledge with practical application. Understand the underlying principles.",
            "Visualize the physical scenario and apply relevant laws systematically. Check units and dimensions.",
            "This tests your ability to connect theory with real-world phenomena. Practice numerical problems regularly.",
            "Focus on fundamental concepts and their interrelationships in physics problem-solving."
        ],
        Chemistry: [
            "Chemical principles require both memorization and conceptual understanding. Focus on reaction mechanisms.",
            "Understand the chemical properties and periodic trends. Practice balancing equations and stoichiometry.",
            "This involves chemical concepts that build upon fundamental principles. Regular revision is key.",
            "Pay attention to chemical bonding, reactions, and quantitative aspects in chemistry."
        ]
    };

    const subjectKey = subject.includes('Math') ? 'Mathematics' : 
                      subject.includes('Phy') ? 'Physics' : 'Chemistry';
    
    const baseExplanation = explanations[subjectKey][questionNumber % explanations[subjectKey].length];
    
    if (!studentAnswer) {
        return `${baseExplanation} Remember: Always attempt every question as there's no penalty for wrong answers beyond the negative marking.`;
    } else if (studentAnswer === correctAnswer) {
        return `${baseExplanation} Excellent work! You demonstrated good understanding of this ${subjectKey.toLowerCase()} concept.`;
    } else {
        return `${baseExplanation} Review this topic thoroughly. Understanding why ${correctAnswer} is correct will help in future attempts.`;
    }
}

// ===== ENHANCED AUTO-TRANSITION SYSTEM =====
function showSummaryInterface(subjData) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'block';
    
    // Set student info
    document.getElementById('summaryStudentName').textContent = progress.student.name;
    document.getElementById('summarySection').textContent = progress.student.sec;
    document.getElementById('summaryRoll').textContent = progress.student.roll;
    document.getElementById('summaryAdm').textContent = progress.student.adm;
    document.getElementById('summaryForm').textContent = assignedForm;
    
    // Render summary table
    renderSummaryTable(subjData);
    
    // Submit to Google Forms
    submitExamWithGoogleForms(subjData);
    
    // Check if we need to wait for exam time or show solutions immediately
    const timeElapsed = Date.now() - examStartTime;
    const timeRemaining = EXAM_DURATION_MS - timeElapsed;
    
    if (timeRemaining > 0) {
        document.getElementById('waitingMessage').style.display = 'block';
        document.getElementById('autoTransitionMessage').style.display = 'none';
        startWaitingTimer(timeRemaining);
    } else {
        document.getElementById('waitingMessage').style.display = 'none';
        document.getElementById('autoTransitionMessage').style.display = 'block';
        startAutoTransition();
    }
}

function startWaitingTimer(timeRemaining) {
    const waitingTimerElement = document.getElementById('waitingTimer');
    
    function updateTimer() {
        const minutes = Math.floor(timeRemaining / 60000);
        const seconds = Math.floor((timeRemaining % 60000) / 1000);
        waitingTimerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        timeRemaining -= 1000;
        
        if (timeRemaining <= 0) {
            clearInterval(waitingTimerInterval);
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('autoTransitionMessage').style.display = 'block';
            startAutoTransition();
        }
    }
    
    updateTimer();
    waitingTimerInterval = setInterval(updateTimer, 1000);
}

function startAutoTransition() {
    let countdown = 5;
    document.getElementById('countdown').textContent = countdown;
    
    autoTransitionTimer = setInterval(() => {
        countdown--;
        document.getElementById('countdown').textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(autoTransitionTimer);
            showDetailedSolutions();
        }
    }, 1000);
}

// ===== YOUR EXISTING FUNCTIONS =====
function validateStudentInputs() {
  const n = document.getElementById('stuName'), 
        s = document.getElementById('stuSection'), 
        r = document.getElementById('stuRoll'), 
        a = document.getElementById('stuAdm');
  
  if (s.value) s.value = s.value.toUpperCase();
  
  let v1 = /^[A-Za-z .]+$/.test(n.value), 
      v2 = /^[A-Za-z0-9]+$/.test(s.value),
      v3 = /^[0-9]+$/.test(r.value), 
      v4 = /^[0-9]+$/.test(a.value);
  
  n.classList.toggle('error', !v1 && n.value !== ""); 
  s.classList.toggle('error', !v2 && s.value !== "");
  r.classList.toggle('error', !v3 && r.value !== ""); 
  a.classList.toggle('error', !v4 && a.value !== "");
  
  const startBtn = document.getElementById('stuStartBtn');
  const allValid = v1 && v2 && v3 && v4 && keyLoaded;
  startBtn.style.display = allValid ? "inline-block" : "none";
  
  if (!keyLoaded) showError("Answer key not loaded - exam disabled. Contact administrator.");
  
  if (v1 && v2 && v3 && v4) {
    const studentData = { name: n.value, sec: s.value, roll: r.value, adm: a.value };
    updateFormAssignmentDisplay(studentData);
  }
  
  return allValid;
}

function updateFormAssignmentDisplay(studentData) {
    assignedForm = getAssignedForm(studentData);
    document.getElementById('assignedFormDisplay').textContent = `FORM ${assignedForm}`;
    document.getElementById('formAssignment').style.display = 'block';
}

function getAssignedForm(studentData) {
    const forms = ['A', 'B', 'C', 'D'];
    if (studentData.roll && !isNaN(studentData.roll)) {
        const rollNumber = parseInt(studentData.roll);
        const formIndex = (rollNumber - 1) % forms.length;
        return forms[formIndex];
    }
    return forms[0];
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// Initialize with demo data
initializeDemoData();

// Your existing event listeners and other functions remain the same
// ... (all other functions from your original code)

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
    console.log('üéØ LFJC Online Exam System Initialized');
    console.log('üì§ Google Forms Integration: ACTIVE');
    console.log('üìö Detailed Solutions: ENABLED');
    
    document.getElementById('accessDenied').style.display = 'flex';
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'none';
    
    document.getElementById('accessCode').focus();
});

// Add your existing event listeners here...
document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
document.getElementById('accessCode').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') verifyAccessCode();
});

function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    
    errorElement.style.display = 'none';
    
    if (enteredCode === ACCESS_CODE) {
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => accessDenied.style.animation = '', 500);
    }
}

console.log("‚úÖ Enhanced Exam System Ready");
console.log("üéØ Features: Google Forms Upload + Detailed Solutions");
console.log("üìù Student selected options (A,B,C,D) will be captured and uploaded");
</script>
</body>
</html>
