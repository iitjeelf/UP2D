<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LFJC Online Exam</title>
    <style>
        /* ===== BASE STYLES ===== */
        :root {
            --primary-color: #4B0082;
            --secondary-color: #D8BFD8;
            --light-purple: #E6E6FA;
            --white: #fff;
            --black: #000;
            --success: #32CD32;
            --warning: #ff9900;
            --danger: #ff6666;
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "SF Pro Display", Arial, sans-serif;
            margin: 0;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            /* Disable text selection and right-click */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Disable right-click context menu */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Enhanced Screenshot protection - IMPROVED */
        #screenshotProtection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 2147483647;
            pointer-events: none;
        }

        .screenshot-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 200px 200px;
            animation: flicker 0.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 0.9; }
        }

        /* Additional screenshot protection */
        #screenshotBlock {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            z-index: 2147483646;
            pointer-events: none;
        }

        /* ===== HEADER & FOOTER ===== */
        header {
            background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
            color: var(--primary-color);
            text-align: center;
            padding: 20px;
            font-size: 36px;
            font-weight: 700;
            letter-spacing: 1.5px;
            box-shadow: var(--shadow);
            text-shadow: 0 1px 2px var(--white);
        }

        footer {
            background: var(--light-purple);
            color: var(--primary-color);
            padding: 10px;
            text-align: center;
            font-weight: bold;
            position: fixed;
            width: 100%;
            bottom: 0;
        }

        /* ===== STUDENT ENTRY SECTION ===== */
        #studentEntry {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 140px);
            padding: 16px;
            text-align: center;
        }

        .form-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            margin-bottom: 60px;
            width: 100%;
            max-width: 500px;
        }

        .form-group label {
            font-size: 1.15rem;
            font-weight: 600;
            margin-right: 10px;
            color: var(--primary-color);
            width: 180px;
            text-align: right;
        }

        input[type="text"] {
            padding: 12px 14px;
            font-size: 1.1rem;
            border-radius: 10px;
            border: 1.5px solid var(--primary-color);
            outline: none;
            min-width: 250px;
            transition: var(--transition);
        }

        input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
        }

        input.error {
            animation: glowRed 0.5s alternate infinite;
            border-color: var(--danger);
        }

        @keyframes glowRed {
            0% { box-shadow: 0 0 5px var(--danger); }
            100% { box-shadow: 0 0 15px var(--danger); }
        }

        /* ===== BUTTON STYLES ===== */
        button {
            position: relative;
            overflow: hidden;
            cursor: pointer;
            border: none;
            border-radius: 12px;
            transition: var(--transition);
            box-shadow: 0 6px #aaa;
            background: linear-gradient(to bottom, #fafaff, #dcd6f7);
            color: var(--primary-color);
            font-weight: 600;
            padding: 12px 24px;
            font-size: 18px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,.28);
        }

        button:active {
            transform: translateY(3px) scale(.98);
        }

        button:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .optBtn {
            font-size: 16px;
            padding: 8px 18px;
            margin: 6px;
            border: 2px solid var(--primary-color);
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 5px #aaa;
        }

        .optBtn.selected {
            background: var(--success);
            color: var(--white);
            border-color: #2fa92f;
        }

        .optBtn.correct {
            background: #32CD32;
            color: white;
            border-color: #228B22;
        }

        .optBtn.wrong {
            background: #FF6B6B;
            color: white;
            border-color: #DC143C;
        }

        .optBtn.not-attempted {
            background: #B0B0B0;
            color: white;
            border-color: #808080;
        }

        .navBtn {
            font-size: 16px;
            padding: 10px 20px;
            border-radius: 8px;
            color: var(--white);
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(145deg, #1E90FF, #4682B4);
            margin: 0 15px; /* Added gap between navigation buttons */
        }

        #markReviewBtn {
            background: linear-gradient(145deg, #ffb84d, var(--warning));
        }

        #submitBtn {
            background: linear-gradient(145deg, #c8b88a, #b49e60);
        }

        /* ===== TIMER STYLES ===== */
        #timerEl {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-color);
            padding: 6px 12px;
            border-radius: 6px;
            background: #f0f0ff;
            display: inline-block;
            transition: var(--transition);
        }

        #timerEl.blink {
            animation: blinkTimer 1s infinite;
        }

        @keyframes blinkTimer {
            0% { background: var(--danger); color: var(--white); }
            50% { background: var(--white); color: var(--primary-color); }
            100% { background: var(--danger); color: var(--white); }
        }

        /* ===== PALETTE STYLES ===== */
        #paletteContainer {
            display: grid;
            gap: 8px;
            margin: 20px auto;
            max-width: 100%;
            padding: 0 10px;
            justify-content: center;
        }

        #paletteContainer button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 14px;
            margin: 2px;
            border: 1px solid var(--primary-color);
            background: var(--light-purple);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #paletteContainer button.selected {
            background: var(--success);
            color: var(--white);
            border-color: #2fa92f;
        }

        #paletteContainer button.reviewed {
            background: yellow;
            color: var(--black);
        }

        #paletteContainer button.current {
            border: 3px solid red;
        }

        #paletteContainer button.correct-answer {
            background: #32CD32;
            color: white;
        }

        #paletteContainer button.wrong-answer {
            background: #FF6B6B;
            color: white;
        }

        #paletteContainer button.not-attempted-answer {
            background: #B0B0B0;
            color: white;
        }

        /* ===== EXAM AREA STYLES ===== */
        #examArea {
            padding: 16px;
            text-align: center;
            display: none;
        }

        #examHeader {
            display: flex;
            align-items: center;
            width: 100%;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #stuInfo {
            flex: 0 0 auto;
            text-align: left;
            white-space: nowrap;
        }

        #stuQInfo {
            flex: 1;
            text-align: center;
            white-space: nowrap;
        }

        .sectionTitle {
            font-size: 22px;
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 8px;
        }

        img.questionImg {
            max-width: 95vw;  /* ‚Üê Use viewport width */
            width: auto;      /* ‚Üê Maintain aspect ratio */
            height: auto;     /* ‚Üê Maintain aspect ratio */
            border-radius: 10px;
            /* Prevent image dragging and selection */
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            display: block;
            margin-left: auto;
            margin-right: auto;
            transition: opacity 0.3s ease;
        }

        /* ===== ANIMATIONS ===== */
        .glow {
            animation: glowPulse 1.6s infinite alternate;
            box-shadow: 0 8px 18px rgba(75,0,130,0.12);
        }

        @keyframes glowPulse {
            0% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
            50% { box-shadow: 0 12px 30px rgba(75,0,130,0.14); transform: translateY(-2px); }
            100% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
        }

        /* ===== SECURITY OVERLAY STYLES ===== */
        #fullRedOverlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            display: none;
            background: red;
            z-index: 9999;
            pointer-events: auto;
        }

        #accessDeniedBox {
            position: fixed;
            left: 50%;
            top: 40%;
            transform: translate(-50%, -50%);
            z-index: 10000;
            color: var(--white);
            text-align: center;
            display: none;
            pointer-events: auto;
        }

        #accessDeniedBox h1 {
            font-size: 48px;
            font-weight: 900;
            margin: 0 0 18px 0;
            color: var(--white);
            text-shadow: 0 2px 6px rgba(0,0,0,0.4);
        }

        #callAdminBtn {
            padding: 12px 22px;
            border-radius: 12px;
            font-weight: 800;
        }

        /* ===== MODAL STYLES ===== */
        .confirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .confirmBox {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            min-width: 280px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .confirmBox p {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .confirmBox button {
            margin: 0 10px;
            padding: 8px 16px;
            font-size: 16px;
            cursor: pointer;
        }

        #adminPassModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20000;
        }

        #adminPassBox {
            background: var(--white);
            padding: 20px;
            text-align: center;
            width: 260px;
            border-radius: 12px;
        }

        #adminPassBox input {
            width: 90%;
            padding: 10px;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        /* ===== TIMER WARNING STYLES ===== */
        .blinkLine {
            animation: blinkLineAnim 1s infinite;
        }

        @keyframes blinkLineAnim {
            0% { background: #ffcccc; }
            50% { background: var(--white); }
            100% { background: #ffcccc; }
        }

        /* ===== FONT SIZE ADJUSTMENTS ===== */
        #stuInfo, #stuQInfo, #timerEl {
            font-size: 20px !important;
        }

        /* Increase table row height vertically */
        table td, table th {
            padding-top: 20px;
            padding-bottom: 20px;
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 600px) {
            #accessDeniedBox h1 {
                font-size: 28px;
            }
            
            #callAdminBtn {
                padding: 10px 14px;
            }
            
            .form-group {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .form-group label {
                text-align: left;
                width: auto;
                margin-bottom: 5px;
            }
            
            #examHeader {
                flex-direction: column;
                gap: 10px;
            }
            
            #stuInfo, #stuQInfo {
                text-align: center;
            }
            
            .navContainer {
                flex-direction: column;
                align-items: center;
            }
            
            .navBtn {
                width: 80%;
                margin-bottom: 10px;
                margin-left: 0;
                margin-right: 0;
            }
            
            #paletteContainer {
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 6px;
            }
            
            #paletteContainer button {
                width: 35px;
                height: 35px;
                font-size: 12px;
            }
        }

        @media (min-width: 601px) and (max-width: 900px) {
            #paletteContainer {
                grid-template-columns: repeat(10, 1fr) !important;
            }
        }

        @media (min-width: 901px) and (max-width: 1200px) {
            #paletteContainer {
                grid-template-columns: repeat(15, 1fr) !important;
            }
        }

        @media (min-width: 1201px) {
            #paletteContainer {
                grid-template-columns: repeat(20, 1fr) !important;
            }
        }

        /* ===== ERROR MESSAGE STYLES ===== */
        .error-message {
            color: #ff3333;
            font-weight: 600;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            background: rgba(255, 102, 102, 0.1);
            border: 1px solid #ff6666;
            animation: blinkRed 1s infinite;
        }

        @keyframes blinkRed {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        /* ===== RESULTS TABLE STYLES ===== */
        .results-table {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            border-collapse: collapse;
            font-size: 18px;
            text-align: center;
        }

        .results-table th {
            background: #E6E6FA;
            padding: 15px;
            border: 1px solid var(--primary-color);
        }

        .results-table td {
            padding: 15px;
            border: 1px solid var(--primary-color);
        }

        .results-table tr:nth-child(even) {
            background: #f9f9f9;
        }

        .results-table tr:hover {
            background: #f0f0ff;
        }

        /* ===== REVIEW MODE STYLES ===== */
        .answer-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .answer-status.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .answer-status.wrong {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .answer-status.not-attempted {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        .correct-answer {
            color: #155724;
            font-weight: bold;
        }

        .wrong-answer {
            color: #721c24;
            font-weight: bold;
        }

        /* ===== AREA STYLES ===== */
        #summaryArea, #reviewArea {
            display: none;
            padding: 20px;
        }

        .area-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .area-header h2 {
            color: #4B0082;
            margin-bottom: 10px;
        }

        /* ===== VERTICAL GAP STYLES ===== */
        .options-container {
            margin-bottom: 60px; /* Increased gap between options and navigation */
        }

        .navContainer {
            margin-top: 40px; /* Additional gap above navigation */
            display: flex;
            justify-content: center;
            gap: 20px; /* Added gap between navigation buttons */
            flex-wrap: wrap;
        }

        /* ===== SECURITY MESSAGE STYLES ===== */
        .security-message {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }

        /* ===== AUTO TRANSITION STYLES ===== */
        .auto-transition-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .waiting-message {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
        }

        .waiting-timer {
            font-size: 24px;
            font-weight: bold;
            color: #4B0082;
            margin: 10px 0;
        }

        /* ===== LOADING STYLES ===== */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #4B0082;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== WARNING BANNER STYLES ===== */
        .warning-banner {
            background: #ffcccc;
            color: #721c24;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            margin: 20px 0;
        }

        /* ===== IMAGE ERROR STYLES ===== */
        .image-error {
            background: #ffebee;
            border: 2px solid #ffcdd2;
            color: #c62828;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }

        .image-error h3 {
            margin: 0 0 10px 0;
            color: #c62828;
        }

        .loading-message {
            background: #e3f2fd;
            border: 2px solid #bbdefb;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        /* ===== SUCCESS MESSAGE STYLES ===== */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            border: 1px solid #c3e6cb;
        }

        .success-message h3 {
            margin: 0 0 10px 0;
            color: #155724;
        }

        /* ===== SMOOTH TRANSITION STYLES ===== */
        .question-transition {
            transition: all 0.3s ease-in-out;
        }

        .question-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== PRELOADING STYLES ===== */
        .preload-image {
            position: absolute;
            left: -9999px;
            top: -9999px;
            opacity: 0;
        }

        /* ===== DETAILED RESULTS TABLE STYLES ===== */
        .detailed-results-table {
            width: 100%;
            max-width: 900px;
            margin: 30px auto;
            border-collapse: collapse;
            font-size: 18px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .detailed-results-table th {
            background: #4B0082;
            color: white;
            padding: 18px;
            border: 1px solid var(--primary-color);
            font-weight: bold;
        }

        .detailed-results-table td {
            padding: 18px;
            border: 1px solid var(--primary-color);
        }

        .detailed-results-table tr:nth-child(even) {
            background: #f8f6ff;
        }

        .detailed-results-table tr:hover {
            background: #f0f0ff;
            transform: scale(1.01);
            transition: transform 0.2s ease;
        }

        .detailed-results-table .total-row {
            background: #E6E6FA !important;
            font-weight: bold;
            font-size: 20px;
        }

        .detailed-results-table .highlight {
            background: #d4edda;
            font-weight: bold;
        }

        /* ===== FORM ASSIGNMENT STYLES ===== */
        .form-assignment {
            background: #e8f4fd;
            border: 2px solid #4B0082;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .form-assignment h3 {
            color: #4B0082;
            margin: 0 0 10px 0;
        }

        .assigned-form {
            font-size: 24px;
            font-weight: bold;
            color: #4B0082;
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            display: inline-block;
            margin: 10px 0;
        }

        /* ===== ANTI-TAB SWITCHING OVERLAY ===== */
        #tabSwitchWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 99999;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #tabSwitchWarning h1 {
            font-size: 48px;
            color: #ff4444;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(255, 0, 0, 0.5);
        }

        #tabSwitchWarning p {
            font-size: 24px;
            margin-bottom: 30px;
            max-width: 80%;
            line-height: 1.5;
        }

        #tabSwitchWarning .warning-icon {
            font-size: 80px;
            margin-bottom: 30px;
            animation: pulse 1.5s infinite;
        }

        /* ===== RECOVERY STYLES ===== */
        .recovery-message {
            background: #e8f4fd;
            border: 2px solid #4B0082;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .recovery-message h3 {
            color: #4B0082;
            margin: 0 0 15px 0;
        }

        .recovery-progress {
            background: #f0f0ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .progress-bar {
            height: 20px;
            background: #4B0082;
            border-radius: 10px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .backup-status {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 14px;
        }

        .backup-status span {
            padding: 5px 10px;
            border-radius: 5px;
            background: #f0f0ff;
        }

        .backup-status .active {
            background: #4B0082;
            color: white;
        }

        /* ===== OFFLINE INDICATOR STYLES ===== */
        #offlineIndicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff4444;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        #offlineIndicator.online {
            background: #32CD32;
        }

        /* ===== AUTO-SAVE INDICATOR ===== */
        #autoSaveIndicator {
            position: fixed;
            bottom: 50px;
            right: 10px;
            background: #4B0082;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>

<body>

<!-- Offline Indicator -->
<div id="offlineIndicator">üî¥ OFFLINE</div>

<!-- Auto-save Indicator -->
<div id="autoSaveIndicator">Auto-saving...</div>

<!-- Anti-Tab Switching Warning -->
<div id="tabSwitchWarning">
    <div class="warning-icon">‚ö†Ô∏è</div>
    <h1>TAB SWITCHING DETECTED</h1>
    <p>You have switched away from the exam window. This is a violation of exam rules.</p>
    <p><strong>Return to the exam immediately to continue.</strong></p>
    <p>Multiple violations may result in exam disqualification.</p>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry">
    <div class="warning-banner" id="examWarning" style="display:none;">
        <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
    </div>
    
    <!-- Recovery Message -->
    <div id="recoveryMessage" class="recovery-message" style="display:none;">
        <h3>üîÑ Exam Recovery Detected</h3>
        <p>We've detected a previous exam session. Your progress has been automatically restored.</p>
        <div class="recovery-progress">
            <div class="backup-status">
                <span id="localBackupStatus" class="active">Local Backup: Active</span>
                <span id="sessionBackupStatus">Session Backup: Active</span>
            </div>
            <div class="progress-bar" id="recoveryProgressBar"></div>
        </div>
        <p><strong>Recovery Time:</strong> <span id="recoveryTime">0</span> seconds</p>
    </div>
    
    <!-- Form Assignment Display -->
    <div id="formAssignment" class="form-assignment" style="display:none;">
        <h3>üìã ASSIGNED FORM</h3>
        <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
        <p>Your responses will be submitted to this form</p>
    </div>
    
    <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
    <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
    <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
    <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>
    <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
    <p id="studentMsg"></p>
    <div id="errorMessages"></div>
    
    <div id="resumeExamSection" style="display:none; margin-top: 20px;">
        <div class="security-message">
            <p>You have an exam in progress. Would you like to resume?</p>
            <button id="resumeExamBtn" class="navBtn">Resume Exam</button>
        </div>
    </div>
</div>

<div id="examArea" style="display:none;">
    <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
        <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
        <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
        <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
            <span id="timerEl">üïí 00:00</span>
        </div>
    </div>

    <!-- Backup Status in Exam -->
    <div id="examBackupStatus" style="text-align: center; margin: 10px 0; font-size: 14px;">
        <span id="backupStatusText">üîÑ Auto-saving enabled</span>
        <span id="lastSaveTime" style="margin-left: 15px;">Last save: Just now</span>
    </div>

    <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

    <div class="navContainer">
        <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
        <button class="navBtn" id="markReviewBtn">Review</button>
        <button class="navBtn" id="nextBtn">Next ‚û°</button>
        <button class="navBtn" id="submitBtn">Submit Exam</button>
    </div>

    <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
    <div class="area-header">
        <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
        <div>
            <b>Section:</b> <span id="summarySection"></span> | 
            <b>Roll:</b> <span id="summaryRoll"></span> | 
            <b>Admission No:</b> <span id="summaryAdm"></span> |
            <b>Form:</b> <span id="summaryForm"></span>
        </div>
    </div>
    
    <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
    
    <div style="text-align:center; margin:30px 0;">
        <div id="waitingMessage" class="waiting-message">
            <div>‚è≥ Waiting for Exam Time to Complete</div>
            <div class="waiting-timer" id="waitingTimer">00:00</div>
            <div>Detailed solutions will be available automatically when the exam time is over.</div>
        </div>
        <div id="autoTransitionMessage" class="auto-transition-message" style="display:none;">
            üîÑ Auto-transitioning to detailed solutions in <span id="countdown">5</span> seconds...
        </div>
        <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
    </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
    <div class="area-header">
        <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
        <div>
            <b>Section:</b> <span id="reviewSection"></span> | 
            <b>Roll:</b> <span id="reviewRoll"></span> | 
            <b>Admission No:</b> <span id="reviewAdm"></span> |
            <b>Form:</b> <span id="reviewForm"></span>
        </div>
    </div>
    
    <!-- Results Table in Detailed Solutions -->
    <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
    
    <div id="reviewQuestionsContainer"></div>
    
    <div style="text-align:center; margin:30px 0;">
        <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
    </div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<div id="fullRedOverlay"></div>
<div id="accessDeniedBox">
    <h1>ACCESS DENIED</h1>
    <button id="callAdminBtn" class="glow">Enter Password</button>
</div>

<div class="confirmModal" id="confirmModal">
    <div class="confirmBox">
        <p id="confirmText">Confirm?</p>
        <button id="confirmYes">Yes</button>
        <button id="confirmNo">No</button>
    </div>
</div>

<div id="adminPassModal">
    <div id="adminPassBox">
        <h3>Enter Admin Password</h3>
        <input type="password" id="adminPassInput">
        <br><br>
        <button id="adminPassSubmit">Submit</button>
    </div>
</div>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
    <div class="screenshot-dots"></div>
</div>
<div id="screenshotBlock"></div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 115;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const STORAGE_KEY_PREFIX = "lfjc_exam_";
const MAX_QUESTIONS = 60;
const AUTO_SAVE_INTERVAL = 15000; // 15 seconds
const BACKUP_INTERVAL = 30000; // 30 seconds

// ===== 10 GOOGLE FORMS CONFIGURATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
    'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDl6zQNp7oV9hYJ5GqT7Vk8qQ8xH5h6j7kLmN4oR9bVw/formResponse",
    'E': "https://docs.google.com/forms/d/e/1FAIpQLSdX9v7b8q3w2z1x4y5z6a7b8c9d0e1f2g3h4i5j6k7l8m9n0o/formResponse",
    'F': "https://docs.google.com/forms/d/e/1FAIpQLSf1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w/formResponse",
    'G': "https://docs.google.com/forms/d/e/1FAIpQLSg2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x/formResponse",
    'H': "https://docs.google.com/forms/d/e/1FAIpQLSh3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y/formResponse",
    'I': "https://docs.google.com/forms/d/e/1FAIpQLSi4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z/formResponse",
    'J': "https://docs.google.com/forms/d/e/1FAIpQLSj5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a/formResponse"
};

// ===== SAMPLE QUESTIONS DATA =====
const QUESTIONS = [
    {
        id: 1,
        question: "What is the capital of France?",
        options: ["London", "Berlin", "Paris", "Madrid"],
        correct: 2,
        image: null
    },
    {
        id: 2,
        question: "Which planet is known as the Red Planet?",
        options: ["Venus", "Mars", "Jupiter", "Saturn"],
        correct: 1,
        image: null
    },
    {
        id: 3,
        question: "What is 5 + 7?",
        options: ["10", "11", "12", "13"],
        correct: 2,
        image: null
    },
    {
        id: 4,
        question: "Who wrote 'Romeo and Juliet'?",
        options: ["Charles Dickens", "William Shakespeare", "Jane Austen", "Mark Twain"],
        correct: 1,
        image: null
    },
    {
        id: 5,
        question: "What is the chemical symbol for gold?",
        options: ["Go", "Gd", "Au", "Ag"],
        correct: 2,
        image: null
    },
    {
        id: 6,
        question: "Which gas do plants absorb from the atmosphere?",
        options: ["Oxygen", "Nitrogen", "Carbon Dioxide", "Hydrogen"],
        correct: 2,
        image: null
    },
    {
        id: 7,
        question: "What is the largest mammal in the world?",
        options: ["Elephant", "Blue Whale", "Giraffe", "Polar Bear"],
        correct: 1,
        image: null
    },
    {
        id: 8,
        question: "Which country is known as the Land of the Rising Sun?",
        options: ["China", "Japan", "Thailand", "South Korea"],
        correct: 1,
        image: null
    },
    {
        id: 9,
        question: "What is the square root of 64?",
        options: ["6", "7", "8", "9"],
        correct: 2,
        image: null
    },
    {
        id: 10,
        question: "Who painted the Mona Lisa?",
        options: ["Vincent van Gogh", "Pablo Picasso", "Leonardo da Vinci", "Michelangelo"],
        correct: 2,
        image: null
    }
];

// ===== GLOBAL VARIABLES =====
let currentQuestion = 0;
let studentAnswers = Array(MAX_QUESTIONS).fill(null);
let reviewFlags = Array(MAX_QUESTIONS).fill(false);
let examStartTime = null;
let examTimer = null;
let studentData = null;
let assignedForm = null;
let autoSaveTimer = null;
let backupTimer = null;
let lastSaveTime = null;
let isOnline = navigator.onLine;
let recoveryInProgress = false;

// ===== DOM ELEMENTS =====
const studentEntry = document.getElementById('studentEntry');
const examArea = document.getElementById('examArea');
const summaryArea = document.getElementById('summaryArea');
const reviewArea = document.getElementById('reviewArea');
const stuName = document.getElementById('stuName');
const stuSection = document.getElementById('stuSection');
const stuRoll = document.getElementById('stuRoll');
const stuAdm = document.getElementById('stuAdm');
const stuStartBtn = document.getElementById('stuStartBtn');
const resumeExamBtn = document.getElementById('resumeExamBtn');
const examWarning = document.getElementById('examWarning');
const formAssignment = document.getElementById('formAssignment');
const assignedFormDisplay = document.getElementById('assignedFormDisplay');
const errorMessages = document.getElementById('errorMessages');
const stuInfo = document.getElementById('stuInfo');
const stuQInfo = document.getElementById('stuQInfo');
const timerEl = document.getElementById('timerEl');
const questionContainer = document.getElementById('questionContainer');
const paletteContainer = document.getElementById('paletteContainer');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const markReviewBtn = document.getElementById('markReviewBtn');
const submitBtn = document.getElementById('submitBtn');
const fullRedOverlay = document.getElementById('fullRedOverlay');
const accessDeniedBox = document.getElementById('accessDeniedBox');
const callAdminBtn = document.getElementById('callAdminBtn');
const confirmModal = document.getElementById('confirmModal');
const confirmText = document.getElementById('confirmText');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const adminPassModal = document.getElementById('adminPassModal');
const adminPassInput = document.getElementById('adminPassInput');
const adminPassSubmit = document.getElementById('adminPassSubmit');
const tabSwitchWarning = document.getElementById('tabSwitchWarning');
const summaryStudentName = document.getElementById('summaryStudentName');
const summarySection = document.getElementById('summarySection');
const summaryRoll = document.getElementById('summaryRoll');
const summaryAdm = document.getElementById('summaryAdm');
const summaryForm = document.getElementById('summaryForm');
const summaryTableContainer = document.getElementById('summaryTableContainer');
const waitingMessage = document.getElementById('waitingMessage');
const waitingTimer = document.getElementById('waitingTimer');
const autoTransitionMessage = document.getElementById('autoTransitionMessage');
const countdown = document.getElementById('countdown');
const closeSummaryBtn = document.getElementById('closeSummaryBtn');
const reviewStudentName = document.getElementById('reviewStudentName');
const reviewSection = document.getElementById('reviewSection');
const reviewRoll = document.getElementById('reviewRoll');
const reviewAdm = document.getElementById('reviewAdm');
const reviewForm = document.getElementById('reviewForm');
const detailedResultsContainer = document.getElementById('detailedResultsContainer');
const reviewQuestionsContainer = document.getElementById('reviewQuestionsContainer');
const closeReviewBtn = document.getElementById('closeReviewBtn');
const offlineIndicator = document.getElementById('offlineIndicator');
const autoSaveIndicator = document.getElementById('autoSaveIndicator');
const recoveryMessage = document.getElementById('recoveryMessage');
const recoveryProgressBar = document.getElementById('recoveryProgressBar');
const recoveryTime = document.getElementById('recoveryTime');
const localBackupStatus = document.getElementById('localBackupStatus');
const sessionBackupStatus = document.getElementById('sessionBackupStatus');
const examBackupStatus = document.getElementById('examBackupStatus');
const backupStatusText = document.getElementById('backupStatusText');
const lastSaveTimeElement = document.getElementById('lastSaveTime');

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    // Setup network monitoring
    setupNetworkMonitoring();
    
    // Check if there's an exam in progress
    checkExamInProgress();
    
    // Set up event listeners
    setupEventListeners();
    
    // Security features
    setupSecurityFeatures();
    
    // Initialize backup systems
    initializeBackupSystems();
});

function setupNetworkMonitoring() {
    // Monitor online/offline status
    window.addEventListener('online', handleOnlineStatus);
    window.addEventListener('offline', handleOfflineStatus);
    
    // Update initial status
    updateOnlineStatus();
}

function handleOnlineStatus() {
    isOnline = true;
    updateOnlineStatus();
    console.log("Internet connection restored");
    
    // Try to submit pending data if any
    submitPendingData();
}

function handleOfflineStatus() {
    isOnline = false;
    updateOnlineStatus();
    console.log("Internet connection lost");
    
    // Show warning to user
    if (examArea.style.display !== 'none') {
        showTemporaryMessage("‚ö†Ô∏è Internet connection lost. Working offline. Answers are being saved locally.", 5000);
    }
}

function updateOnlineStatus() {
    if (isOnline) {
        offlineIndicator.textContent = "üü¢ ONLINE";
        offlineIndicator.className = "online";
    } else {
        offlineIndicator.textContent = "üî¥ OFFLINE";
        offlineIndicator.className = "";
    }
    offlineIndicator.style.display = 'block';
}

function setupEventListeners() {
    // Student entry form
    stuName.addEventListener('input', validateStudentInfo);
    stuSection.addEventListener('input', validateStudentInfo);
    stuRoll.addEventListener('input', validateStudentInfo);
    stuAdm.addEventListener('input', validateStudentInfo);
    stuStartBtn.addEventListener('click', startExam);
    resumeExamBtn.addEventListener('click', resumeExam);
    
    // Exam navigation
    prevBtn.addEventListener('click', showPreviousQuestion);
    nextBtn.addEventListener('click', showNextQuestion);
    markReviewBtn.addEventListener('click', toggleReviewFlag);
    submitBtn.addEventListener('click', confirmSubmitExam);
    
    // Modals
    confirmYes.addEventListener('click', handleConfirmYes);
    confirmNo.addEventListener('click', handleConfirmNo);
    callAdminBtn.addEventListener('click', showAdminPassModal);
    adminPassSubmit.addEventListener('click', checkAdminPassword);
    
    // Summary and Review
    closeSummaryBtn.addEventListener('click', closeSummary);
    closeReviewBtn.addEventListener('click', closeReview);
    
    // Prevent right-click context menu
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        showSecurityViolation("Right-click is disabled during the exam.");
    });
    
    // Prevent keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
        if (e.key === 'F12' || 
            (e.ctrlKey && e.shiftKey && e.key === 'I') ||
            (e.ctrlKey && e.shiftKey && e.key === 'J') ||
            (e.ctrlKey && e.key === 'u')) {
            e.preventDefault();
            showSecurityViolation("Developer tools are disabled during the exam.");
        }
    });
    
    // Save on page unload
    window.addEventListener('beforeunload', handleBeforeUnload);
    
    // Handle page visibility changes (tab switching)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && examArea.style.display !== 'none') {
            showTabSwitchWarning();
        } else {
            // Save when returning to the tab
            if (examArea.style.display !== 'none') {
                saveExamData();
            }
        }
    });
}

function handleBeforeUnload(event) {
    if (examArea.style.display !== 'none' && !studentData.examCompleted) {
        // Save data immediately before unload
        saveExamDataImmediate();
        
        // Show warning message
        event.preventDefault();
        event.returnValue = 'Your exam progress will be saved. Are you sure you want to leave?';
        return event.returnValue;
    }
}

function setupSecurityFeatures() {
    // Tab switching detection
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && examArea.style.display !== 'none') {
            showTabSwitchWarning();
        }
    });
    
    // Prevent copy/paste
    document.addEventListener('copy', function(e) {
        e.preventDefault();
        showSecurityViolation("Copying is disabled during the exam.");
    });
    
    document.addEventListener('cut', function(e) {
        e.preventDefault();
        showSecurityViolation("Cutting is disabled during the exam.");
    });
    
    document.addEventListener('paste', function(e) {
        e.preventDefault();
        showSecurityViolation("Pasting is disabled during the exam.");
    });
    
    // Prevent drag and drop
    document.addEventListener('dragstart', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('drop', function(e) {
        e.preventDefault();
    });
}

function initializeBackupSystems() {
    // Check if we have multiple backup sources
    checkBackupSources();
}

function checkBackupSources() {
    const localData = localStorage.getItem(STORAGE_KEY_PREFIX + 'student_data');
    const sessionData = sessionStorage.getItem(STORAGE_KEY_PREFIX + 'student_data');
    
    if (localData && sessionData) {
        // Both backups exist
        localBackupStatus.classList.add('active');
        sessionBackupStatus.classList.add('active');
    } else if (localData) {
        // Only local backup exists
        localBackupStatus.classList.add('active');
    } else if (sessionData) {
        // Only session backup exists
        sessionBackupStatus.classList.add('active');
    }
}

function checkExamInProgress() {
    let recoveredFrom = null;
    
    // Check multiple backup sources in order of reliability
    const localData = localStorage.getItem(STORAGE_KEY_PREFIX + 'student_data');
    const sessionData = sessionStorage.getItem(STORAGE_KEY_PREFIX + 'student_data');
    
    if (localData) {
        try {
            const data = JSON.parse(localData);
            if (data.examStarted && !data.examCompleted) {
                studentData = data;
                recoveredFrom = 'localStorage';
            }
        } catch (e) {
            console.error('Error parsing local exam data:', e);
        }
    }
    
    // If local storage failed, try session storage
    if (!studentData && sessionData) {
        try {
            const data = JSON.parse(sessionData);
            if (data.examStarted && !data.examCompleted) {
                studentData = data;
                recoveredFrom = 'sessionStorage';
            }
        } catch (e) {
            console.error('Error parsing session exam data:', e);
        }
    }
    
    if (studentData) {
        // Show recovery process
        showRecoveryProcess(recoveredFrom);
    }
}

function showRecoveryProcess(source) {
    recoveryMessage.style.display = 'block';
    recoveryInProgress = true;
    
    let progress = 0;
    const recoveryInterval = setInterval(() => {
        progress += 10;
        recoveryProgressBar.style.width = progress + '%';
        recoveryTime.textContent = (progress / 10);
        
        if (progress >= 100) {
            clearInterval(recoveryInterval);
            recoveryInProgress = false;
            
            // Update recovery message
            document.querySelector('#recoveryMessage h3').textContent = '‚úÖ Recovery Complete';
            document.querySelector('#recoveryMessage p').innerHTML = 
                `<strong>Successfully recovered from ${source}</strong><br>
                 Your exam progress has been restored. You can now resume your exam.`;
            
            // Show resume section after a delay
            setTimeout(() => {
                showResumeExamSection();
            }, 2000);
        }
    }, 200);
}

function showResumeExamSection() {
    document.getElementById('resumeExamSection').style.display = 'block';
    examWarning.style.display = 'block';
}

// ===== STUDENT VALIDATION =====
function validateStudentInfo() {
    const nameValid = /^[A-Za-z\s]+$/.test(stuName.value.trim());
    const sectionValid = /^[A-Za-z0-9]+$/.test(stuSection.value.trim());
    const rollValid = /^\d+$/.test(stuRoll.value.trim());
    const admValid = /^\d+$/.test(stuAdm.value.trim());
    
    // Clear previous errors
    errorMessages.innerHTML = '';
    stuName.classList.toggle('error', !nameValid && stuName.value.trim() !== '');
    stuSection.classList.toggle('error', !sectionValid && stuSection.value.trim() !== '');
    stuRoll.classList.toggle('error', !rollValid && stuRoll.value.trim() !== '');
    stuAdm.classList.toggle('error', !admValid && stuAdm.value.trim() !== '');
    
    // Show error messages
    if (!nameValid && stuName.value.trim() !== '') {
        showError('Name should contain only letters and spaces.');
    }
    if (!sectionValid && stuSection.value.trim() !== '') {
        showError('Section should contain only letters and digits.');
    }
    if (!rollValid && stuRoll.value.trim() !== '') {
        showError('Roll number should contain only digits.');
    }
    if (!admValid && stuAdm.value.trim() !== '') {
        showError('Admission number should contain only digits.');
    }
    
    // Enable start button if all fields are valid and not empty
    const allValid = nameValid && sectionValid && rollValid && admValid &&
                    stuName.value.trim() !== '' && stuSection.value.trim() !== '' &&
                    stuRoll.value.trim() !== '' && stuAdm.value.trim() !== '';
    
    stuStartBtn.style.display = allValid ? 'block' : 'none';
    
    return allValid;
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    errorMessages.appendChild(errorDiv);
}

// ===== EXAM START =====
function startExam() {
    if (!validateStudentInfo()) return;
    
    // Assign random form
    const forms = Object.keys(GOOGLE_FORMS);
    assignedForm = forms[Math.floor(Math.random() * forms.length)];
    
    // Save student data
    studentData = {
        name: stuName.value.trim(),
        section: stuSection.value.trim(),
        roll: stuRoll.value.trim(),
        adm: stuAdm.value.trim(),
        form: assignedForm,
        examStarted: true,
        examCompleted: false,
        startTime: Date.now(),
        answers: studentAnswers,
        reviewFlags: reviewFlags,
        lastSaveTime: Date.now()
    };
    
    saveExamData();
    startAutoSave();
    
    // Show form assignment
    formAssignment.style.display = 'block';
    assignedFormDisplay.textContent = `FORM ${assignedForm}`;
    
    // Confirm start
    showConfirmModal(
        `You have been assigned FORM ${assignedForm}. Once started, you cannot go back. Are you ready to begin?`,
        proceedWithExamStart
    );
}

function proceedWithExamStart() {
    examStartTime = Date.now();
    studentData.startTime = examStartTime;
    saveExamData();
    
    // Switch to exam area
    studentEntry.style.display = 'none';
    examArea.style.display = 'block';
    
    // Initialize exam
    initializeExam();
    startTimer();
    showQuestion(currentQuestion);
    updatePalette();
}

function resumeExam() {
    // Load saved data
    examStartTime = studentData.startTime;
    studentAnswers = studentData.answers || Array(MAX_QUESTIONS).fill(null);
    reviewFlags = studentData.reviewFlags || Array(MAX_QUESTIONS).fill(false);
    assignedForm = studentData.form;
    
    // Switch to exam area
    studentEntry.style.display = 'none';
    examArea.style.display = 'block';
    
    // Initialize exam
    initializeExam();
    startTimer();
    startAutoSave();
    showQuestion(currentQuestion);
    updatePalette();
}

// ===== BACKUP AND AUTO-SAVE FUNCTIONS =====
function startAutoSave() {
    // Clear any existing timers
    if (autoSaveTimer) clearInterval(autoSaveTimer);
    if (backupTimer) clearInterval(backupTimer);
    
    // Start auto-save timer
    autoSaveTimer = setInterval(() => {
        saveExamData();
        showAutoSaveIndicator();
    }, AUTO_SAVE_INTERVAL);
    
    // Start backup timer (more comprehensive save)
    backupTimer = setInterval(() => {
        createComprehensiveBackup();
    }, BACKUP_INTERVAL);
}

function showAutoSaveIndicator() {
    autoSaveIndicator.style.display = 'block';
    setTimeout(() => {
        autoSaveIndicator.style.display = 'none';
    }, 2000);
    
    // Update last save time
    lastSaveTime = new Date();
    lastSaveTimeElement.textContent = `Last save: ${formatTimeAgo(lastSaveTime)}`;
}

function formatTimeAgo(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    
    if (diffSec < 10) return 'Just now';
    if (diffSec < 60) return `${diffSec} seconds ago`;
    
    const diffMin = Math.floor(diffSec / 60);
    if (diffMin === 1) return '1 minute ago';
    if (diffMin < 60) return `${diffMin} minutes ago`;
    
    return 'Over an hour ago';
}

function saveExamData() {
    if (!studentData) return;
    
    studentData.answers = studentAnswers;
    studentData.reviewFlags = reviewFlags;
    studentData.lastSaveTime = Date.now();
    
    // Save to multiple storage locations for redundancy
    try {
        localStorage.setItem(STORAGE_KEY_PREFIX + 'student_data', JSON.stringify(studentData));
        sessionStorage.setItem(STORAGE_KEY_PREFIX + 'student_data', JSON.stringify(studentData));
        
        // Update backup status
        backupStatusText.textContent = '‚úÖ All changes saved';
        setTimeout(() => {
            backupStatusText.textContent = 'üîÑ Auto-saving enabled';
        }, 3000);
        
    } catch (e) {
        console.error('Error saving exam data:', e);
        backupStatusText.textContent = '‚ö†Ô∏è Save failed - working offline';
    }
}

function saveExamDataImmediate() {
    // Force immediate save without waiting for timer
    saveExamData();
}

function createComprehensiveBackup() {
    if (!studentData) return;
    
    const backupData = {
        ...studentData,
        backupTimestamp: Date.now(),
        backupType: 'comprehensive',
        answers: [...studentAnswers],
        reviewFlags: [...reviewFlags]
    };
    
    // Save comprehensive backup
    try {
        localStorage.setItem(STORAGE_KEY_PREFIX + 'backup_data', JSON.stringify(backupData));
    } catch (e) {
        console.error('Error creating backup:', e);
    }
}

function submitPendingData() {
    // Check if there's pending data to submit to server
    // This would be implemented based on your specific server API
    console.log("Submitting pending data to server...");
}

function showTemporaryMessage(message, duration) {
    const messageDiv = document.createElement('div');
    messageDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        z-index: 10000;
        text-align: center;
        max-width: 80%;
    `;
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    setTimeout(() => {
        document.body.removeChild(messageDiv);
    }, duration);
}

// ===== EXAM FUNCTIONS =====
function initializeExam() {
    // Display student info
    stuInfo.textContent = `${studentData.name} | ${studentData.section} | Roll: ${studentData.roll}`;
    
    // Initialize question palette
    updatePalette();
    
    // Show backup status
    examBackupStatus.style.display = 'block';
}

function showQuestion(index) {
    if (index < 0 || index >= QUESTIONS.length) return;
    
    currentQuestion = index;
    
    // Update question info
    stuQInfo.textContent = `Question ${index + 1} of ${QUESTIONS.length}`;
    
    // Get current question
    const question = QUESTIONS[index];
    
    // Create question HTML
    let questionHTML = `
        <div class="sectionTitle">Question ${index + 1}</div>
        <div style="font-size: 20px; margin-bottom: 20px;">${question.question}</div>
    `;
    
    // Add image if available
    if (question.image) {
        questionHTML += `
            <img src="${question.image}" alt="Question ${index + 1}" class="questionImg" 
                 onerror="this.style.display='none'; document.getElementById('imageError${index}').style.display='block';">
            <div id="imageError${index}" class="image-error" style="display:none;">
                <h3>‚ö†Ô∏è Image Not Available</h3>
                <p>The question image could not be loaded. Please proceed with the text question.</p>
            </div>
        `;
    }
    
    // Add options
    questionHTML += `<div class="options-container">`;
    question.options.forEach((option, optIndex) => {
        const isSelected = studentAnswers[index] === optIndex;
        questionHTML += `
            <button class="optBtn ${isSelected ? 'selected' : ''}" 
                    onclick="selectOption(${optIndex})">
                ${String.fromCharCode(65 + optIndex)}. ${option}
            </button>
            <br>
        `;
    });
    questionHTML += `</div>`;
    
    // Update question container
    questionContainer.innerHTML = questionHTML;
    
    // Update navigation buttons
    prevBtn.disabled = index === 0;
    nextBtn.disabled = index === QUESTIONS.length - 1;
    
    // Update review button
    markReviewBtn.textContent = reviewFlags[index] ? "Unmark Review" : "Mark for Review";
    markReviewBtn.style.background = reviewFlags[index] ? 
        "linear-gradient(145deg, #ffcc00, #ff9900)" : 
        "linear-gradient(145deg, #ffb84d, var(--warning))";
    
    // Update palette
    updatePalette();
}

function selectOption(optionIndex) {
    studentAnswers[currentQuestion] = optionIndex;
    saveExamData();
    showQuestion(currentQuestion);
}

function toggleReviewFlag() {
    reviewFlags[currentQuestion] = !reviewFlags[currentQuestion];
    saveExamData();
    showQuestion(currentQuestion);
}

function showPreviousQuestion() {
    if (currentQuestion > 0) {
        showQuestion(currentQuestion - 1);
    }
}

function showNextQuestion() {
    if (currentQuestion < QUESTIONS.length - 1) {
        showQuestion(currentQuestion + 1);
    }
}

function updatePalette() {
    paletteContainer.innerHTML = '';
    
    // Determine grid layout based on screen size
    let gridCols = 20;
    if (window.innerWidth <= 600) gridCols = 5;
    else if (window.innerWidth <= 900) gridCols = 10;
    else if (window.innerWidth <= 1200) gridCols = 15;
    
    paletteContainer.style.gridTemplateColumns = `repeat(${gridCols}, 1fr)`;
    
    for (let i = 0; i < QUESTIONS.length; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.addEventListener('click', () => showQuestion(i));
        
        // Set button style based on status
        if (i === currentQuestion) {
            btn.classList.add('current');
        }
        if (studentAnswers[i] !== null) {
            btn.classList.add('selected');
        }
        if (reviewFlags[i]) {
            btn.classList.add('reviewed');
        }
        
        paletteContainer.appendChild(btn);
    }
}

// ===== TIMER FUNCTIONS =====
function startTimer() {
    clearInterval(examTimer);
    
    examTimer = setInterval(() => {
        const now = Date.now();
        const elapsed = now - examStartTime;
        const remaining = EXAM_DURATION_MS - elapsed;
        
        if (remaining <= 0) {
            // Time's up!
            clearInterval(examTimer);
            timerEl.textContent = "üïí 00:00";
            timerEl.classList.add('blink');
            autoSubmitExam();
            return;
        }
        
        // Calculate minutes and seconds
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        
        // Format time
        const timeStr = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timerEl.textContent = timeStr;
        
        // Blink when 5 minutes or less remain
        if (minutes < 5) {
            timerEl.classList.add('blink');
        }
        
        // Save progress every 30 seconds
        if (seconds % 30 === 0) {
            saveExamData();
        }
    }, 1000);
}

// ===== EXAM SUBMISSION =====
function confirmSubmitExam() {
    const unanswered = studentAnswers.filter(answer => answer === null).length;
    const reviewed = reviewFlags.filter(flag => flag).length;
    
    let message = "Are you sure you want to submit your exam?";
    if (unanswered > 0) {
        message += `\n\nYou have ${unanswered} unanswered question${unanswered > 1 ? 's' : ''}.`;
    }
    if (reviewed > 0) {
        message += `\nYou have ${reviewed} question${reviewed > 1 ? 's' : ''} marked for review.`;
    }
    
    showConfirmModal(message, submitExam);
}

function submitExam() {
    // Stop all timers
    clearInterval(examTimer);
    clearInterval(autoSaveTimer);
    clearInterval(backupTimer);
    
    // Mark exam as completed
    studentData.examCompleted = true;
    studentData.endTime = Date.now();
    studentData.answers = studentAnswers;
    studentData.reviewFlags = reviewFlags;
    
    // Calculate score
    const results = calculateResults();
    studentData.results = results;
    
    // Save final data
    saveExamData();
    
    // Submit to Google Form
    submitToGoogleForm();
    
    // Clear backup data
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'backup_data');
    
    // Show summary
    showSummary(results);
}

function autoSubmitExam() {
    // Auto-submit when time is up
    clearInterval(autoSaveTimer);
    clearInterval(backupTimer);
    
    studentData.examCompleted = true;
    studentData.endTime = Date.now();
    studentData.answers = studentAnswers;
    studentData.reviewFlags = reviewFlags;
    
    // Calculate score
    const results = calculateResults();
    studentData.results = results;
    
    // Save final data
    saveExamData();
    
    // Submit to Google Form
    submitToGoogleForm();
    
    // Clear backup data
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'backup_data');
    
    // Show summary
    showSummary(results);
}

function calculateResults() {
    let correct = 0;
    let wrong = 0;
    let unattempted = 0;
    
    for (let i = 0; i < QUESTIONS.length; i++) {
        if (studentAnswers[i] === null) {
            unattempted++;
        } else if (studentAnswers[i] === QUESTIONS[i].correct) {
            correct++;
        } else {
            wrong++;
        }
    }
    
    const score = (correct * MARK_PER_CORRECT) + (wrong * MARK_PER_WRONG);
    const maxScore = QUESTIONS.length * MARK_PER_CORRECT;
    
    return {
        correct,
        wrong,
        unattempted,
        score,
        maxScore,
        percentage: ((score / maxScore) * 100).toFixed(2)
    };
}

function submitToGoogleForm() {
    if (!assignedForm || !GOOGLE_FORMS[assignedForm]) return;
    
    const formUrl = GOOGLE_FORMS[assignedForm];
    
    // Create a form data object (this is a simplified version)
    // In a real implementation, you would map each question to a form field
    const formData = new FormData();
    formData.append('entry.123456789', studentData.name); // Example entry ID
    formData.append('entry.987654321', studentData.section);
    formData.append('entry.555555555', studentData.roll);
    formData.append('entry.444444444', studentData.adm);
    formData.append('entry.333333333', assignedForm);
    formData.append('entry.222222222', studentData.results.score);
    
    // Submit using fetch (this would need CORS to work properly)
    fetch(formUrl, {
        method: 'POST',
        body: formData,
        mode: 'no-cors'
    }).catch(error => {
        console.log('Form submission attempted (may not have reached server due to CORS)');
    });
}

// ===== SUMMARY AND REVIEW =====
function showSummary(results) {
    examArea.style.display = 'none';
    summaryArea.style.display = 'block';
    
    // Set student info
    summaryStudentName.textContent = studentData.name;
    summarySection.textContent = studentData.section;
    summaryRoll.textContent = studentData.roll;
    summaryAdm.textContent = studentData.adm;
    summaryForm.textContent = `FORM ${assignedForm}`;
    
    // Create results table
    const tableHTML = `
        <table class="results-table">
            <tr>
                <th>Total Questions</th>
                <th>Correct</th>
                <th>Wrong</th>
                <th>Unattempted</th>
                <th>Score</th>
                <th>Percentage</th>
            </tr>
            <tr>
                <td>${QUESTIONS.length}</td>
                <td style="color: green; font-weight: bold;">${results.correct}</td>
                <td style="color: red; font-weight: bold;">${results.wrong}</td>
                <td style="color: gray; font-weight: bold;">${results.unattempted}</td>
                <td style="font-weight: bold;">${results.score}/${results.maxScore}</td>
                <td style="font-weight: bold;">${results.percentage}%</td>
            </tr>
        </table>
    `;
    
    summaryTableContainer.innerHTML = tableHTML;
    
    // Check if we need to wait for exam time to complete
    const now = Date.now();
    const examEndTime = examStartTime + EXAM_DURATION_MS;
    const timeUntilEnd = examEndTime - now;
    
    if (timeUntilEnd > 0) {
        // Still waiting for exam time to complete
        waitingMessage.style.display = 'block';
        autoTransitionMessage.style.display = 'none';
        
        // Start waiting timer
        const waitingTimerInterval = setInterval(() => {
            const remaining = examEndTime - Date.now();
            if (remaining <= 0) {
                clearInterval(waitingTimerInterval);
                showAutoTransition();
            } else {
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                waitingTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }, 1000);
    } else {
        // Exam time is already over, show transition immediately
        showAutoTransition();
    }
}

function showAutoTransition() {
    waitingMessage.style.display = 'none';
    autoTransitionMessage.style.display = 'block';
    
    let countdownValue = 5;
    countdown.textContent = countdownValue;
    
    const countdownInterval = setInterval(() => {
        countdownValue--;
        countdown.textContent = countdownValue;
        
        if (countdownValue <= 0) {
            clearInterval(countdownInterval);
            showReview();
        }
    }, 1000);
}

function showReview() {
    summaryArea.style.display = 'none';
    reviewArea.style.display = 'block';
    
    // Set student info
    reviewStudentName.textContent = studentData.name;
    reviewSection.textContent = studentData.section;
    reviewRoll.textContent = studentData.roll;
    reviewAdm.textContent = studentData.adm;
    reviewForm.textContent = `FORM ${assignedForm}`;
    
    // Create detailed results table
    const results = studentData.results;
    const detailedTableHTML = `
        <table class="detailed-results-table">
            <tr>
                <th>Category</th>
                <th>Count</th>
                <th>Marks</th>
                <th>Total</th>
            </tr>
            <tr>
                <td>Correct Answers</td>
                <td>${results.correct}</td>
                <td>+${MARK_PER_CORRECT}</td>
                <td>+${results.correct * MARK_PER_CORRECT}</td>
            </tr>
            <tr>
                <td>Wrong Answers</td>
                <td>${results.wrong}</td>
                <td>${MARK_PER_WRONG}</td>
                <td>${results.wrong * MARK_PER_WRONG}</td>
            </tr>
            <tr>
                <td>Unattempted</td>
                <td>${results.unattempted}</td>
                <td>0</td>
                <td>0</td>
            </tr>
            <tr class="total-row highlight">
                <td><strong>TOTAL</strong></td>
                <td><strong>${QUESTIONS.length}</strong></td>
                <td></td>
                <td><strong>${results.score}/${results.maxScore}</strong></td>
            </tr>
            <tr class="highlight">
                <td colspan="3"><strong>PERCENTAGE</strong></td>
                <td><strong>${results.percentage}%</strong></td>
            </tr>
        </table>
    `;
    
    detailedResultsContainer.innerHTML = detailedTableHTML;
    
    // Create question review
    let reviewHTML = '<div class="sectionTitle" style="margin-top: 40px;">Question-wise Analysis</div>';
    
    QUESTIONS.forEach((question, index) => {
        const userAnswer = studentAnswers[index];
        const isCorrect = userAnswer === question.correct;
        const correctAnswer = question.options[question.correct];
        
        let statusClass = '';
        let statusText = '';
        let answerText = '';
        
        if (userAnswer === null) {
            statusClass = 'not-attempted';
            statusText = 'Not Attempted';
            answerText = `Correct answer: <span class="correct-answer">${String.fromCharCode(65 + question.correct)}. ${correctAnswer}</span>`;
        } else if (isCorrect) {
            statusClass = 'correct';
            statusText = 'Correct';
            answerText = `Your answer: <span class="correct-answer">${String.fromCharCode(65 + userAnswer)}. ${question.options[userAnswer]}</span>`;
        } else {
            statusClass = 'wrong';
            statusText = 'Wrong';
            answerText = `
                Your answer: <span class="wrong-answer">${String.fromCharCode(65 + userAnswer)}. ${question.options[userAnswer]}</span><br>
                Correct answer: <span class="correct-answer">${String.fromCharCode(65 + question.correct)}. ${correctAnswer}</span>
            `;
        }
        
        reviewHTML += `
            <div style="margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
                <div style="font-weight: bold; font-size: 18px; margin-bottom: 10px;">
                    Question ${index + 1}: ${question.question}
                </div>
                <div class="answer-status ${statusClass}">
                    ${statusText}
                </div>
                <div style="margin-top: 10px;">
                    ${answerText}
                </div>
            </div>
        `;
    });
    
    reviewQuestionsContainer.innerHTML = reviewHTML;
}

function closeSummary() {
    summaryArea.style.display = 'none';
    studentEntry.style.display = 'flex';
    
    // Clear exam data if they choose to close
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'student_data');
    sessionStorage.removeItem(STORAGE_KEY_PREFIX + 'student_data');
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'backup_data');
}

function closeReview() {
    reviewArea.style.display = 'none';
    studentEntry.style.display = 'flex';
    
    // Clear exam data
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'student_data');
    sessionStorage.removeItem(STORAGE_KEY_PREFIX + 'student_data');
    localStorage.removeItem(STORAGE_KEY_PREFIX + 'backup_data');
}

// ===== SECURITY FUNCTIONS =====
function showSecurityViolation(message) {
    fullRedOverlay.style.display = 'block';
    accessDeniedBox.style.display = 'block';
    
    // Log the violation (in a real system, this would be sent to a server)
    console.log(`SECURITY VIOLATION: ${message}`);
}

function showTabSwitchWarning() {
    if (examArea.style.display !== 'none') {
        tabSwitchWarning.style.display = 'flex';
        
        // Focus on the warning to prevent easy dismissal
        tabSwitchWarning.focus();
    }
}

// Hide tab switch warning when user returns to the tab
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        tabSwitchWarning.style.display = 'none';
    }
});

function showAdminPassModal() {
    adminPassModal.style.display = 'flex';
    adminPassInput.focus();
}

function checkAdminPassword() {
    const password = adminPassInput.value;
    // In a real system, this would be a secure server-side check
    if (password === 'admin123') { // Example password
        adminPassModal.style.display = 'none';
        fullRedOverlay.style.display = 'none';
        accessDeniedBox.style.display = 'none';
        adminPassInput.value = '';
    } else {
        alert('Incorrect password!');
        adminPassInput.value = '';
        adminPassInput.focus();
    }
}

// ===== MODAL FUNCTIONS =====
function showConfirmModal(message, confirmCallback) {
    confirmText.textContent = message;
    confirmModal.style.display = 'flex';
    
    // Store the callback
    confirmYes.callback = confirmCallback;
}

function handleConfirmYes() {
    confirmModal.style.display = 'none';
    if (confirmYes.callback) {
        confirmYes.callback();
    }
}

function handleConfirmNo() {
    confirmModal.style.display = 'none';
}

// ===== UTILITY FUNCTIONS =====
function formatTime(ms) {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}
</script>
</body>
</html>
