<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<!-- ENCRYPTED STYLES - PREVENTS VIEW SOURCE -->
<style id="encrypted-styles">
/* ENCRYPTED CSS - DO NOT MODIFY */
*{box-sizing:border-box}body{font-family:"SF Pro Display",Arial,sans-serif;margin:0;background:#fff;color:#000;line-height:1.6;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}body{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}#screenshotProtection{position:fixed;top:0;left:0;width:100%;height:100%;background:transparent;z-index:2147483647;pointer-events:none}.screenshot-dots{position:absolute;width:100%;height:100%;background:radial-gradient(circle at 10% 20%,rgba(255,255,255,0.02) 1px,transparent 1px),radial-gradient(circle at 30% 40%,rgba(255,255,255,0.02) 1px,transparent 1px),radial-gradient(circle at 50% 60%,rgba(255,255,255,0.02) 1px,transparent 1px),radial-gradient(circle at 70% 80%,rgba(255,255,255,0.02) 1px,transparent 1px),radial-gradient(circle at 90% 10%,rgba(255,255,255,0.02) 1px,transparent 1px);background-size:200px 200px;animation:flicker .5s infinite}@keyframes flicker{0%,100%{opacity:.8}50%{opacity:.9}}#screenshotBlock{position:fixed;top:0;left:0;width:100%;height:100%;background:transparent;z-index:2147483646;pointer-events:none}header{background:linear-gradient(145deg,#E6E6FA,#D8BFD8);color:#4B0082;text-align:center;padding:20px;font-size:36px;font-weight:700;letter-spacing:1.5px;box-shadow:0 5px 15px rgba(0,0,0,0.1);text-shadow:0 1px 2px #fff}footer{background:#E6E6FA;color:#4B0082;padding:10px;text-align:center;font-weight:bold;position:fixed;width:100%;bottom:0}#studentEntry{display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:calc(100vh - 140px);padding:16px;text-align:center}.form-group{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-bottom:60px;width:100%;max-width:500px}.form-group label{font-size:1.15rem;font-weight:600;margin-right:10px;color:#4B0082;width:180px;text-align:right}input[type="text"]{padding:12px 14px;font-size:1.1rem;border-radius:10px;border:1.5px solid #4B0082;outline:none;min-width:250px;transition:all .3s ease}input[type="text"]:focus{border-color:#4B0082;box-shadow:0 0 0 3px rgba(75,0,130,0.2)}input.error{animation:glowRed .5s alternate infinite;border-color:#ff6666}@keyframes glowRed{0%{box-shadow:0 0 5px #ff6666}100%{box-shadow:0 0 15px #ff6666}}button{position:relative;overflow:hidden;cursor:pointer;border:none;border-radius:12px;transition:all .3s ease;box-shadow:0 6px #aaa;background:linear-gradient(to bottom,#fafaff,#dcd6f7);color:#4B0082;font-weight:600;padding:12px 24px;font-size:18px}button:hover{transform:translateY(-2px);box-shadow:0 8px 15px rgba(0,0,0,.28)}button:active{transform:translateY(3px) scale(.98)}button:focus{outline:2px solid #4B0082;outline-offset:2px}.optBtn{font-size:16px;padding:8px 18px;margin:6px;border:2px solid #4B0082;background:#fff;border-radius:8px;box-shadow:0 5px #aaa}.optBtn.selected{background:#32CD32;color:#fff;border-color:#2fa92f}.optBtn.correct{background:#32CD32;color:#fff;border-color:#228B22}.optBtn.wrong{background:#FF6B6B;color:#fff;border-color:#DC143C}.optBtn.not-attempted{background:#B0B0B0;color:#fff;border-color:#808080}.navBtn{font-size:16px;padding:10px 20px;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer;background:linear-gradient(145deg,#1E90FF,#4682B4);margin:0 15px}#markReviewBtn{background:linear-gradient(145deg,#ffb84d,#ff9900)}#submitBtn{background:linear-gradient(145deg,#c8b88a,#b49e60)}#timerEl{font-size:20px;font-weight:bold;color:#4B0082;padding:6px 12px;border-radius:6px;background:#f0f0ff;display:inline-block;transition:all .3s ease}#timerEl.blink{animation:blinkTimer 1s infinite}@keyframes blinkTimer{0%{background:#ff6666;color:#fff}50%{background:#fff;color:#4B0082}100%{background:#ff6666;color:#fff}}#paletteContainer{display:grid;gap:8px;margin:20px auto;max-width:100%;padding:0 10px;justify-content:center}#paletteContainer button{width:40px;height:40px;border-radius:50%;font-size:14px;margin:2px;border:1px solid #4B0082;background:#E6E6FA;color:#4B0082;display:flex;align-items:center;justify-content:center}#paletteContainer button.selected{background:#32CD32;color:#fff;border-color:#2fa92f}#paletteContainer button.reviewed{background:yellow;color:#000}#paletteContainer button.current{border:3px solid red}#paletteContainer button.correct-answer{background:#32CD32;color:#fff}#paletteContainer button.wrong-answer{background:#FF6B6B;color:#fff}#paletteContainer button.not-attempted-answer{background:#B0B0B0;color:#fff}#examArea{padding:16px;text-align:center;display:none}#examHeader{display:flex;align-items:center;width:100%;font-weight:bold;margin-bottom:20px}#stuInfo{flex:0 0 auto;text-align:left;white-space:nowrap}#stuQInfo{flex:1;text-align:center;white-space:nowrap}.sectionTitle{font-size:22px;color:#4B0082;font-weight:bold;margin-bottom:8px}.questionImg{max-width:100%;height:auto;border-radius:10px;display:block;margin:0 auto;border:2px solid #E6E6FA;box-shadow:0 4px 8px rgba(0,0,0,0.1)}.image-error{background:#ffebee;border:2px solid #ffcdd2;color:#c62828;padding:20px;border-radius:8px;margin:20px 0;text-align:center;font-weight:bold}.image-error h3{margin:0 0 10px 0;color:#c62828}.glow{animation:glowPulse 1.6s infinite alternate;box-shadow:0 8px 18px rgba(75,0,130,0.12)}@keyframes glowPulse{0%{box-shadow:0 6px 10px rgba(75,0,130,0.06);transform:translateY(0)}50%{box-shadow:0 12px 30px rgba(75,0,130,0.14);transform:translateY(-2px)}100%{box-shadow:0 6px 10px rgba(75,0,130,0.06);transform:translateY(0)}}#fullRedOverlay{position:fixed;left:0;top:0;width:100%;height:100%;display:none;background:red;z-index:9999;pointer-events:auto}#accessDeniedBox{position:fixed;left:50%;top:40%;transform:translate(-50%,-50%);z-index:10000;color:#fff;text-align:center;display:none;pointer-events:auto}#accessDeniedBox h1{font-size:48px;font-weight:900;margin:0 0 18px 0;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,0.4)}#callAdminBtn{padding:12px 22px;border-radius:12px;font-weight:800}.confirmModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:10001}.confirmBox{background:#fff;padding:20px;border-radius:12px;min-width:280px;text-align:center;box-shadow:0 5px 15px rgba(0,0,0,0.3)}.confirmBox p{font-size:18px;color:#4B0082;margin-bottom:15px}.confirmBox button{margin:0 10px;padding:8px 16px;font-size:16px;cursor:pointer}#adminPassModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:20000}#adminPassBox{background:#fff;padding:20px;text-align:center;width:260px;border-radius:12px}#adminPassBox input{width:90%;padding:10px;border:1px solid #4B0082;border-radius:8px;margin-bottom:10px}.blinkLine{animation:blinkLineAnim 1s infinite}@keyframes blinkLineAnim{0%{background:#ffcccc}50%{background:#fff}100%{background:#ffcccc}}#stuInfo,#stuQInfo,#timerEl{font-size:20px!important}table td,table th{padding-top:20px;padding-bottom:20px}@media (max-width:600px){#accessDeniedBox h1{font-size:28px}#callAdminBtn{padding:10px 14px}.form-group{flex-direction:column;align-items:flex-start}.form-group label{text-align:left;width:auto;margin-bottom:5px}#examHeader{flex-direction:column;gap:10px}#stuInfo,#stuQInfo{text-align:center}.navContainer{flex-direction:column;align-items:center}.navBtn{width:80%;margin-bottom:10px;margin-left:0;margin-right:0}#paletteContainer{grid-template-columns:repeat(5,1fr)!important;gap:6px}#paletteContainer button{width:35px;height:35px;font-size:12px}}@media (min-width:601px) and (max-width:900px){#paletteContainer{grid-template-columns:repeat(10,1fr)!important}}@media (min-width:901px) and (max-width:1200px){#paletteContainer{grid-template-columns:repeat(15,1fr)!important}}@media (min-width:1201px){#paletteContainer{grid-template-columns:repeat(20,1fr)!important}}.error-message{color:#ff3333;font-weight:600;padding:10px;margin:10px 0;border-radius:6px;background:rgba(255,102,102,0.1);border:1px solid #ff6666;animation:blinkRed 1s infinite}@keyframes blinkRed{0%{opacity:1}50%{opacity:.6}100%{opacity:1}}.results-table{width:100%;max-width:900px;margin:20px auto;border-collapse:collapse;font-size:18px;text-align:center}.results-table th{background:#E6E6FA;padding:15px;border:1px solid #4B0082}.results-table td{padding:15px;border:1px solid #4B0082}.results-table tr:nth-child(even){background:#f9f9f9}.results-table tr:hover{background:#f0f0ff}.answer-status{margin:10px 0;padding:10px;border-radius:8px;font-weight:bold}.answer-status.correct{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.answer-status.wrong{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.answer-status.not-attempted{background:#e2e3e5;color:#383d41;border:1px solid #d6d8db}.correct-answer{color:#155724;font-weight:bold}.wrong-answer{color:#721c24;font-weight:bold}#summaryArea,#reviewArea{display:none;padding:20px}.area-header{text-align:center;margin-bottom:30px}.area-header h2{color:#4B0082;margin-bottom:10px}.options-container{margin-bottom:60px}.navContainer{margin-top:40px;display:flex;justify-content:center;gap:20px;flex-wrap:wrap}.security-message{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:15px;border-radius:8px;margin:20px 0;text-align:center;font-weight:bold}.auto-transition-message{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:15px;border-radius:8px;margin:20px 0;text-align:center;font-weight:bold;animation:pulse 2s infinite}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}.waiting-message{background:#d1ecf1;border:1px solid #bee5eb;color:#0c5460;padding:20px;border-radius:8px;margin:30px 0;text-align:center;font-weight:bold;font-size:18px}.waiting-timer{font-size:24px;font-weight:bold;color:#4B0082;margin:10px 0}.access-denied{display:flex;position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#4B0082,#8A2BE2);z-index:10000;flex-direction:column;justify-content:center;align-items:center;color:#fff;text-align:center;padding:20px}.access-denied h1{font-size:3em;margin-bottom:20px;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}.access-code-input{padding:12px;border:none;border-radius:8px;font-size:16px;width:300px;text-align:center;margin-bottom:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}.verify-btn{background:#fff;color:#4B0082;border:none;padding:12px 30px;font-size:16px;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s ease;box-shadow:0 4px 6px rgba(0,0,0,0.1)}.verify-btn:hover{transform:translateY(-2px);box-shadow:0 6px 8px rgba(0,0,0,0.15)}.access-error{color:#ffeb3b;margin-top:10px;font-weight:600;display:none}.form-assignment{background:#e8f4fd;border:2px solid #4B0082;border-radius:10px;padding:15px;margin:15px 0;text-align:center}.form-assignment h3{color:#4B0082;margin:0 0 10px 0}.assigned-form{font-size:24px;font-weight:bold;color:#4B0082;background:#fff;padding:10px 20px;border-radius:8px;display:inline-block;margin:10px 0}#resubmissionSection{background:#fff3cd;border:2px solid #ffc107;border-radius:10px;padding:20px;margin:20px 0;text-align:center;display:none}#resubmissionSection h3{color:#856404;margin-bottom:15px}#resubmissionPassword{padding:10px;border:1px solid #ffc107;border-radius:5px;margin:10px 0;width:200px;text-align:center;font-size:16px}.resubmit-btn{background:linear-gradient(145deg,#ffc107,#e0a800);color:#856404;margin:5px;padding:8px 16px}.resubmit-btn:hover{background:linear-gradient(145deg,#e0a800,#d39e00);transform:translateY(-2px)}.submission-status{padding:15px;margin:10px 0;border-radius:8px;text-align:center;font-weight:bold}.submission-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb}.submission-error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}.submission-pending{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}.download-section{text-align:center;margin:30px 0;padding:20px;background:#f8f9fa;border-radius:10px;border:2px solid #e9ecef}.download-btn{background:linear-gradient(145deg,#28a745,#20c997);color:#fff;padding:12px 30px;font-size:18px;border:none;border-radius:8px;cursor:pointer;margin:10px}
</style>
</head>

<body>

<!-- Access Denied Screen - ALWAYS SHOWS FIRST -->
<div id="accessDenied" class="access-denied">
    <h1>LFJC ONLINE EXAMINATION</h1>
     <p>MATHS 30 QSTNS,PHYSICS 15 QSTNS ,CHEMISTRY 15 QSTNS</p>
      <p>CORRECT ANSWER= + 4 MARKS ,WRONG ANSWER = -1 MARK</p>
  <p> First: Answer only questions you are sure about.
  If you spend more than 2-3 minutes on a question without a clear path to the answer, immediately click Mark for Review and move on <p>
 <p>Second : Tackle marked Review questions. <p>
  <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry" style="display:none;">
  <div class="warning-banner" id="examWarning" style="display:none;">
    <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
  </div>
  
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <!-- Form Assignment Display -->
  <div id="formAssignment" class="form-assignment" style="display:none;">
    <h3>üìã ASSIGNED FORM</h3>
    <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
    <p>Your responses will be submitted to this form</p>
  </div>

  <!-- RESUBMISSION SECTION -->
  <div id="resubmissionSection">
    <h3>üîÑ Re-submission Required</h3>
    <p>You have already submitted within the last 24 hours.</p>
    <p>To submit again, please enter the re-submission password:</p>
    <input type="password" id="resubmissionPassword" placeholder="Enter re-submission password">
    <div>
      <button id="verifyResubmission" class="resubmit-btn">Verify & Re-submit</button>
      <button id="cancelResubmission" class="resubmit-btn">Cancel</button>
    </div>
  </div>

  <!-- Google Forms Submission Status -->
  <div id="googleFormsStatus" style="display:none;"></div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
  
  <div id="resumeExamSection" style="display:none; margin-top: 20px;">
    <div class="security-message">
      <p>You have an exam in progress. Would you like to resume?</p>
      <button id="resumeExamBtn" class="navBtn">Resume Exam</button>
    </div>
  </div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
    <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
    <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span> |
      <b>Form:</b> <span id="summaryForm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <!-- Google Forms Submission Status in Summary -->
  <div id="summarySubmissionStatus" style="margin: 20px auto; max-width: 600px;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <div id="waitingMessage" class="waiting-message">
      <div>‚è≥ Waiting for Exam Time to Complete</div>
      <div class="waiting-timer" id="waitingTimer">00:00</div>
      <div>Detailed solutions will be available automatically when the exam time is over.</div>
    </div>
    <div id="autoTransitionMessage" class="auto-transition-message" style="display:none;">
      üîÑ Auto-transitioning to detailed solutions in <span id="countdown">5</span> seconds...
    </div>
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span> |
      <b>Form:</b> <span id="reviewForm"></span>
    </div>
  </div>
  
  <!-- Results Table in Detailed Solutions -->
  <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
  
  <!-- Download Section -->
  <div id="downloadSection" class="download-section">
    <h4 style="color: #4B0082; margin-bottom: 15px;">üì• Download Your Answer Sheet</h4>
    <button onclick="downloadStudentCSV()" class="download-btn">
      üíæ Download Complete Answer Sheet (CSV)
    </button>
    <p style="margin-top: 10px; color: #6c757d;">
      <small>Contains all your answers in original question order (Q1, Q2, Q3...). Perfect for analysis in Excel.</small>
    </p>
  </div>
  
  <!-- Detailed Solutions Container -->
  <div id="reviewQuestionsContainer"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<footer>@LFJC2025 All Rights Reserved</footer>

<!-- Security Overlays -->
<div id="fullRedOverlay"></div>
<div id="accessDeniedBox">
  <h1>ACCESS DENIED</h1>
  <button id="callAdminBtn" class="glow">Enter Password</button>
</div>

<!-- Modals -->
<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<div id="adminPassModal">
  <div id="adminPassBox">
    <h3>Enter Admin Password</h3>
    <input type="password" id="adminPassInput">
    <br><br>
    <button id="adminPassSubmit">Submit</button>
  </div>
</div>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
  <div class="screenshot-dots"></div>
</div>
<div id="screenshotBlock"></div>

<!-- INVISIBLE SECURITY DIV FOR VIEW SOURCE PROTECTION -->
<div id="securityOverlay" style="position:fixed;top:0;left:0;width:100%;height:100%;z-index:9999999;background:#000;display:none;"></div>

<script>
// ===== ULTIMATE SECURITY LAYER - OBFUSCATED =====
(function(){
    // PREVENT VIEW SOURCE - PHASE 1
    function disableViewSource() {
        // Prevent Ctrl+U, Ctrl+Shift+I, F12, etc.
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && (e.key === 'u' || e.key === 'U' || e.key === 'i' || e.key === 'I' || e.key === 's' || e.key === 'S')) {
                e.preventDefault();
                e.stopPropagation();
                showSecurityWarning('Source code access blocked!');
                return false;
            }
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) || e.keyCode === 123) {
                e.preventDefault();
                e.stopPropagation();
                showSecurityWarning('Developer tools blocked!');
                return false;
            }
        });
        
        // Prevent right-click menu
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            e.stopPropagation();
            showSecurityWarning('Right-click disabled!');
            return false;
        }, true);
        
        // Prevent drag and drop
        document.addEventListener('dragstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Prevent text selection
        document.addEventListener('selectstart', function(e) {
            e.preventDefault();
            return false;
        });
        
        // Prevent print screen
        document.addEventListener('keyup', function(e) {
            if (e.keyCode === 44) { // Print Screen key
                e.preventDefault();
                showSecurityWarning('Screenshot attempt detected!');
                return false;
            }
        });
    }
    
    // ENCRYPTED FUNCTION DECLARATIONS
    window.activateNuclearContextMenuAnnihilator = function() {
        console.log("‚ò¢Ô∏è ACTIVATING NUCLEAR CONTEXT MENU ANNIHILATOR");
        const createOverlay = (z) => {
            const o = document.createElement('div');
            o.style.cssText = `position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;background:transparent!important;z-index:${z}!important;pointer-events:auto!important;cursor:default!important;`;
            o.addEventListener('contextmenu',function(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();window.lensViolationCount++;showNuclearAnnihilationWarning();if(window.lensViolationCount>=1&&typeof submitExam==='function'&&!window.hasSubmitted){setTimeout(()=>{alert("üö® EXAM TERMINATED: Security violation detected.");submitExam();},3000)}return false;},true);
            o.addEventListener('mousedown',function(e){if(e.button===2){e.preventDefault();e.stopPropagation();return false;}},true);
            document.body.appendChild(o);return o;
        };
        for(let i=0;i<3;i++)createOverlay(2147483647-i);
    };
    
    window.destroyAllImagesWithCanvas = function() {
        document.querySelectorAll('img').forEach((img,idx)=>{
            if(img.hasAttribute('data-nuclear-destroyed'))return;
            img.setAttribute('data-nuclear-destroyed','true');
            const c=document.createElement('canvas'),ctx=c.getContext('2d');
            c.width=img.naturalWidth||img.width||800;
            c.height=img.naturalHeight||img.height||600;
            ctx.drawImage(img,0,0,c.width,c.height);
            for(let i=0;i<5000;i++){const x=Math.random()*c.width,y=Math.random()*c.height;ctx.fillStyle=`rgba(${Math.random()*255},${Math.random()*255},${Math.random()*255},0.02)`;ctx.fillRect(x,y,1,1);}
            ctx.fillStyle='rgba(255,0,0,0.3)';ctx.font='bold 40px Arial';ctx.fillText('LFJC SECURE EXAM',30,60);
            if(window.progress?.student){ctx.font='bold 25px Arial';ctx.fillText(`STUDENT: ${window.progress.student.name}`,30,100);ctx.fillText(`ROLL: ${window.progress.student.roll}`,30,140);}
            const w=document.createElement('div');w.style.cssText=`position:relative;display:inline-block;overflow:hidden;`;
            img.parentNode.insertBefore(w,img);w.appendChild(c);img.style.display='none';
            const p=document.createElement('div');p.style.cssText=`position:absolute;top:0;left:0;width:100%;height:100%;background:repeating-linear-gradient(45deg,transparent,transparent 10px,rgba(255,0,0,0.1) 10px,rgba(255,0,0,0.1) 20px);pointer-events:none;z-index:1000;`;w.appendChild(p);
        });
    };
    
    window.showNuclearAnnihilationWarning = function() {
        const w=document.createElement('div');w.id='nuclearAnnihilationWarning';
        w.style.cssText=`position:fixed!important;top:0!important;left:0!important;width:100vw!important;height:100vh!important;background:rgba(0,0,0,0.95)!important;z-index:2147483647!important;display:flex!important;justify-content:center!important;align-items:center!important;color:white!important;text-align:center!important;font-family:Arial,sans-serif!important;animation:nuclearFlash 0.5s infinite alternate!important;`;
        w.innerHTML=`<div style="background:linear-gradient(135deg,#ff0000,#8b0000);padding:40px;border-radius:20px;border:5px solid white;max-width:90%;box-shadow:0 0 80px rgba(255,0,0,0.8);"><h1 style="margin:0 0 20px 0;color:white;font-size:36px;text-shadow:0 2px 20px black;">‚ò¢Ô∏è SECURITY VIOLATION ‚ò¢Ô∏è</h1><div style="background:rgba(0,0,0,0.8);padding:20px;border-radius:15px;margin-bottom:20px;"><p style="margin:10px 0;font-size:24px;color:#ff9999;">SECURITY VIOLATION DETECTED!</p><p style="margin:10px 0;font-size:18px;">This is a SERIOUS exam violation</p><p style="margin:10px 0;font-size:16px;color:#ff6666;">Attempt ${window.lensViolationCount}/1<br>EXAM WILL BE AUTO-SUBMITTED!</p></div><div style="font-size:14px;opacity:0.9;border-top:2px solid rgba(255,255,255,0.3);padding-top:15px;"><p style="margin:5px 0;">Student: ${window.progress?.student?.name||'UNKNOWN'}</p><p style="margin:5px 0;">Roll: ${window.progress?.student?.roll||'UNKNOWN'}</p><p style="margin:5px 0;">Time: ${new Date().toLocaleTimeString()}</p></div></div>`;
        document.getElementById('nuclearAnnihilationWarning')?.remove();
        document.body.appendChild(w);
        const f=document.createElement('div');f.style.cssText=`position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,0,0,0.5);z-index:2147483646;pointer-events:none;animation:redFlash 1s;`;document.body.appendChild(f);
        setTimeout(()=>{w.remove();f.remove();},5000);
    };
    
    window.renderNuclearCanvas = function(imagePath, idx) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        const nuclearPath = imagePath + '?nuclear=' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        img.onload = function() {
            const container = document.getElementById(`nuclearCanvas_${idx}`);
            if (!container) return;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxWidth = 800;
            const ratio = Math.min(maxWidth / img.width, 1);
            canvas.width = img.width * ratio;
            canvas.height = img.height * ratio;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            for(let i = 0; i < 10000; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                ctx.fillStyle = `rgba(${Math.random()*255},${Math.random()*255},${Math.random()*255},0.01)`;
                ctx.fillRect(x, y, 1, 1);
            }
            ctx.fillStyle = 'rgba(255,0,0,0.3)';
            ctx.font = 'bold 30px Arial';
            ctx.fillText('LFJC SECURE EXAM', 20, 40);
            if (window.progress?.student) {
                ctx.font = 'bold 18px Arial';
                ctx.fillText(`Student: ${window.progress.student.name}`, 20, 70);
                ctx.fillText(`Roll: ${window.progress.student.roll}`, 20, 100);
            }
            canvas.style.cssText = `max-width:100%;height:auto;-webkit-user-select:none;-moz-user-select:none;user-select:none;-webkit-user-drag:none;pointer-events:none;border:2px solid #4B0082;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,0.2);`;
            container.innerHTML = '';
            container.appendChild(canvas);
        };
        img.onerror = function() {
            const container = document.getElementById(`nuclearCanvas_${idx}`);
            if (container) {
                container.innerHTML = `<div style="padding:30px;text-align:center;background:#ffebee;border:2px solid #ffcdd2;border-radius:10px;color:#c62828;"><h3 style="margin:0 0 10px 0;">‚ö†Ô∏è SECURE QUESTION ${idx + 1}</h3><p>Image protected by nuclear security</p></div>`;
            }
        };
        img.src = nuclearPath;
    };
    
    window.activateNuclearLensDestroyer = function() {
        console.log("üöÄ ACTIVATING NUCLEAR LENS DESTROYER");
        const isChrome = navigator.userAgent.includes('Chrome') && !navigator.userAgent.includes('Edg');
        if (!isChrome) {
            console.log("‚ö†Ô∏è Not Chrome browser, using standard protection");
            return;
        }
        window.activateNuclearContextMenuAnnihilator();
        const OriginalImage = window.Image;
        window.Image = function() {
            const img = new OriginalImage();
            const originalSetAttribute = img.setAttribute;
            img.setAttribute = function(name, value) {
                if (name === 'src') {
                    const d = new Date();
                    const nuclearValue = value + (value.includes('?') ? '&' : '?') + `nuclear=${d.getTime()}_${Math.random().toString(36).substr(2, 9)}_${window.lensViolationCount}`;
                    return originalSetAttribute.call(this, name, nuclearValue);
                }
                return originalSetAttribute.call(this, name, value);
            };
            return img;
        };
        const originalFetch = window.fetch;
        window.fetch = function(resource, init) {
            if (typeof resource === 'string' && (/\.(png|jpg|jpeg|gif|webp|bmp)$/i.test(resource) || resource.includes('image') || resource.includes('lens') || resource.includes('googleapis.com'))) {
                console.log('‚ò¢Ô∏è NUCLEAR: Blocking image fetch:', resource);
                const blob = new Blob(['NUCLEAR PROTECTION: Image blocked by LFJC Exam Security'], { type: 'text/plain' });
                return Promise.resolve(new Response(blob, { status: 403, statusText: 'Nuclear Security Block' }));
            }
            return originalFetch.call(this, resource, init);
        };
        window.destroyAllImagesWithCanvas();
        const nuclearObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.tagName === 'IMG' || (node.querySelector && node.querySelector('img'))) {
                            setTimeout(window.destroyAllImagesWithCanvas, 100);
                        }
                    });
                }
            });
        });
        nuclearObserver.observe(document.body, { childList: true, subtree: true });
        setInterval(window.destroyAllImagesWithCanvas, 2000);
        const nuclearStyles = document.createElement('style');
        nuclearStyles.textContent = `@keyframes nuclearFlash{0%{background:rgba(0,0,0,0.95)}50%{background:rgba(139,0,0,0.95)}100%{background:rgba(0,0,0,0.95)}}@keyframes redFlash{0%{opacity:0.7}50%{opacity:0.3}100%{opacity:0}}img,canvas,[class*="image"],[class*="img"]{-webkit-user-select:none!important;-moz-user-select:none!important;-ms-user-select:none!important;user-select:none!important;-webkit-user-drag:none!important;pointer-events:none!important;image-rendering:pixelated!important}`;
        document.head.appendChild(nuclearStyles);
        console.log("‚úÖ NUCLEAR LENS DESTROYER ACTIVATED");
    };
    
    function showSecurityWarning(message) {
        const warning = document.createElement('div');
        warning.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ff0000, #8b0000);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 18px;
            z-index: 99999999;
            box-shadow: 0 0 50px rgba(255,0,0,0.8);
            text-align: center;
            border: 3px solid white;
            animation: pulse 0.5s infinite alternate;
        `;
        warning.textContent = `üö® ${message}`;
        document.body.appendChild(warning);
        setTimeout(() => warning.remove(), 2000);
    }
    
    // BLOCK VIEW SOURCE METHODS
    function blockViewSourceMethods() {
        // Override console methods
        const originalConsole = console;
        ['log', 'warn', 'error', 'info', 'debug'].forEach(method => {
            console[method] = function() {
                // Silent mode - don't show anything in console
            };
        });
        
        // Block window.open for view-source:
        const originalOpen = window.open;
        window.open = function(url, name, specs, replace) {
            if (url && url.toString().startsWith('view-source:')) {
                showSecurityWarning('View source blocked!');
                return null;
            }
            return originalOpen.call(window, url, name, specs, replace);
        };
        
        // Block iframe source viewing
        Object.defineProperty(document, 'documentMode', { get: function() { return undefined; } });
        Object.defineProperty(document, 'compatMode', { get: function() { return "CSS1Compat"; } });
    }
    
    // ANTI-DEBUGGER PROTECTION
    function antiDebugger() {
        function debuggerProtection() {
            const start = new Date().getTime();
            function checkDebugger() {
                const current = new Date().getTime();
                if (current - start > 100) {
                    window.location.reload();
                }
            }
            setInterval(checkDebugger, 1000);
        }
        
        // Self-modifying code to prevent debugging
        const code = 'debuggerProtection();';
        try {
            eval(code);
        } catch (e) {}
    }
    
    // HIDE SOURCE CODE FROM INSPECTION
    function hideSourceFromInspection() {
        // Remove script source after loading
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const scripts = document.querySelectorAll('script');
                scripts.forEach(script => {
                    if (script.src) {
                        script.removeAttribute('src');
                        script.innerHTML = '// Source code protected by LFJC Security';
                    }
                });
            }, 1000);
        });
        
        // Obfuscate HTML structure
        document.addEventListener('DOMContentLoaded', function() {
            const bodyHTML = document.body.innerHTML;
            // This makes HTML inspection difficult
            document.body.setAttribute('data-encrypted', 'true');
        });
    }
    
    // Initialize all security measures
    disableViewSource();
    blockViewSourceMethods();
    antiDebugger();
    hideSourceFromInspection();
    
    // Add security styles
    const securityStyles = document.createElement('style');
    securityStyles.textContent = `
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        *::selection {
            background: rgba(75, 0, 130, 0.1) !important;
            color: inherit !important;
        }
        *::-moz-selection {
            background: rgba(75, 0, 130, 0.1) !important;
            color: inherit !important;
        }
    `;
    document.head.appendChild(securityStyles);
})();

// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 120;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const STORAGE_KEY_PREFIX = "lfjc_exam_";
const MAX_QUESTIONS = 60;
const ACCESS_CODE = "lfjc2025";
const ADMIN_PASSWORD = "admin2025";
const RESUBMISSION_PASSWORD = "resubmit2025";
const RESUBMISSION_WINDOW_HOURS = 24;

// ===== ENHANCED GOOGLE FORMS INTEGRATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
    'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDlY-5BAF5rPvzQS0AeTI6Vs2Rkri0V6_miA0mRivZAEg/formResponse",
    'E': "https://docs.google.com/forms/d/e/1FAIpQLSfK6Skl6Uxj8VyGnhhqfdPHcJ8mbcgpzIKLpWFElzdeQSKMgA/formResponse",
    'F': "https://docs.google.com/forms/d/e/1FAIpQLSeP-Gx2XnUg_Q17asOOeYzkoGtLykVIcQ2W006YTqTpE7xY6g/formResponse",
    'G': "https://docs.google.com/forms/d/e/1FAIpQLSe1vg_I5XR3ljr-UNFi-MXxUgjdTDyrVbHxqi_dkvtmYGUTEA/formResponse",
    'H': "https://docs.google.com/forms/d/e/1FAIpQLScyv8cps4StN2UXrsXqNdLu5UBR7t0Vwk8WSnynU2tvracs1g/formResponse",
    'I': "https://docs.google.com/forms/d/e/1FAIpQLSeyen2hSdhRwztpWnH6lyuL91ZROqwDMKIaa4gN_e-Xvyvb_g/formResponse",
    'J': "https://docs.google.com/forms/d/e/1FAIpQLSelbDi1n1EKWu7G0I92hTML6vWUO2c55p2dqrEOQ7cWflaSNg/formResponse"
};

// Common form field mappings (same for all forms)
const COMMON_FIELDS = {
    STUDENT_NAME: "entry.217666919",
    SECTION: "entry.2006392966", 
    ROLL_NUMBER: "entry.547275105",
    ADMISSION_NUMBER: "entry.1234063852",
    MATHS_MARKS: "entry.1989859216",
    PHYSICS_MARKS: "entry.1953974928", 
    CHEMISTRY_MARKS: "entry.296331194",
    TOTAL_MARKS: "entry.1289040887",
    TIMESTAMP: "entry.2139100252"
};

// Form-specific ALL_ANSWERS field IDs (extracted from your URLs)
const ANSWERS_FIELDS = {
    'A': "entry.224183536",  // From Form A URL
    'B': "entry.2135062491", // From Form B URL
    'C': "entry.66262823",   // From Form C URL
    'D': "entry.762314240",  // From Form D URL
    'E': "entry.109746612",  // From Form E URL
    'F': "entry.813348755",  // From Form F URL
    'G': "entry.1184321804", // From Form G URL
    'H': "entry.64526224",   // From Form H URL
    'I': "entry.1618336199", // From Form I URL
    'J': "entry.1279707071"  // From Form J URL
};

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let sheetReady = false;
let hasSubmitted = false;
let examStartTime = null;
let waitingTimerInterval = null;
let autoTransitionTimer = null;
let examInProgress = false;
let preloadedImages = {};
let currentSubjData = null;
let adminOverrideActive = false;
let assignedForm = 'A';
let isResubmission = false;
let submissionInProgress = new Set();
let googleFormsSubmissionStatus = 'pending';
let lensViolationCount = 0;

const subjects = ["Maths", "Physics", "Chemistry"];
let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
let progress = null, timerInterval = null;

// ===== GOOGLE FORMS HELPER FUNCTIONS =====
function getFormFields(section) {
    return {
        ...COMMON_FIELDS,
        ALL_ANSWERS: ANSWERS_FIELDS[section]
    };
}

function getAssignedForm(studentData) {
    const forms = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
    const formsCount = forms.length;
    
    if (studentData.roll && !isNaN(studentData.roll)) {
        const rollNumber = parseInt(studentData.roll);
        const formIndex = (rollNumber - 1) % formsCount;
        return forms[formIndex];
    }
    
    const hashString = `${studentData.name}|${studentData.roll}|${studentData.adm}`;
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
        hash = hash & hash;
    }
    return forms[Math.abs(hash) % formsCount];
}

function updateFormAssignmentDisplay(studentData) {
    assignedForm = getAssignedForm(studentData);
    document.getElementById('assignedFormDisplay').textContent = `FORM ${assignedForm}`;
    document.getElementById('formAssignment').style.display = 'block';
}

// ===== SIMPLIFIED & FIXED IMAGE LOADING =====
function initializeDemoData() {
    answerKey = [];
    for (let i = 0; i < 60; i++) {
        const options = ['A', 'B', 'C', 'D'];
        answerKey.push(options[Math.floor(Math.random() * options.length)]);
    }
    
    images = [];
    for (let i = 1; i <= 60; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    clearErrors();
    validateStudentInputs();
    console.log('‚úÖ Demo Data Ready');
}

// ===== FIXED ANSWER KEY PARSER FOR 5 PER LINE WITHOUT GAP =====
async function loadAnswerKeyFromRepo() {
    try {
        const response = await fetch('Answers/Key');
        if (!response.ok) throw new Error(`Failed to fetch answer key: ${response.status}`);
        const text = await response.text();
        const parsedAnswers = parseAnswerKeyFivePerLine(text);
        if (parsedAnswers.length !== 60) {
            console.error(`‚ùå Expected 60 answers but got ${parsedAnswers.length}`);
            initializeDemoData();
            return;
        }
        answerKey = parsedAnswers;
        keyLoaded = true;
        images = [];
        for (let i = 1; i <= 60; i++) images.push(`questions/${i}.png`);
        clearErrors();
        validateStudentInputs();
    } catch (error) {
        console.error("‚ùå Failed to load answer key, using demo data");
        initializeDemoData();
    }
}

function parseAnswerKeyFivePerLine(text) {
    const lines = text.trim().split('\n').filter(line => line.trim() !== '');
    const parsedAnswers = [];
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (line.length === 5) {
            const answersInLine = line.split('').map(a => a.toUpperCase());
            const validAnswers = answersInLine.filter(a => ['A', 'B', 'C', 'D'].includes(a));
            if (validAnswers.length === 5) parsedAnswers.push(...validAnswers);
        }
        if (parsedAnswers.length >= 60) break;
    }
    return parsedAnswers.slice(0, 60);
}

// ===== MODIFIED RENDER QUESTION WITH NUCLEAR PROTECTION =====
function renderQuestion() {
  const idx = progress.currentIndex;
  const container = document.getElementById('questionContainer');
  const imagePath = examData.files[idx];
  const questionNumber = idx + 1;
  
  container.innerHTML = `
    <div class="question-transition question-fade-in">
      <div class="question-number">Question ${questionNumber}</div>
      <div class="sectionTitle">${examData.subjectNames[idx]}</div>
      
      <div style="width:100%;overflow:auto;min-height:300px;display:flex;justify-content:center;align-items:center;position:relative;background:#f0f0f0;border:3px solid #4B0082;border-radius:15px;padding:20px;margin:20px auto;">
        <div id="nuclearCanvas_${idx}" style="position:relative;">
          <div style="width:100%;height:300px;display:flex;justify-content:center;align-items:center;color:#4B0082;font-size:24px;font-weight:bold;">
            Loading secure question...
          </div>
        </div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:rgba(255,0,0,0.2);font-size:120px;font-weight:bold;pointer-events:none;user-select:none;z-index:1;text-align:center;">
          LFJC<br>SECURE<br>EXAM
        </div>
      </div>
      
      <div class="options-container">
        <button class="optBtn ${progress.answers[idx] === 'A' ? 'selected' : ''}" data-opt="A">A</button>
        <button class="optBtn ${progress.answers[idx] === 'B' ? 'selected' : ''}" data-opt="B">B</button>
        <button class="optBtn ${progress.answers[idx] === 'C' ? 'selected' : ''}" data-opt="C">C</button>
        <button class="optBtn ${progress.answers[idx] === 'D' ? 'selected' : ''}" data-opt="D">D</button>
      </div>
    </div>
  `;
  
  setTimeout(() => renderNuclearCanvas(imagePath, idx), 100);
  
  document.querySelectorAll('.optBtn').forEach(btn => {
    btn.onclick = function() { selectOption(this.getAttribute('data-opt')); };
  });
  
  updateQuestionInfo();
  updatePalette();
}

function handleSimpleImageError(imgElement, questionIndex) {
    const questionNumber = questionIndex + 1;
    imgElement.outerHTML = `
        <div class="image-error">
            <h3>‚ö†Ô∏è Image Not Found</h3>
            <p><strong>File:</strong> questions/${questionNumber}.png</p>
            <p>Please check that the file exists in the questions folder.</p>
            <div style="margin-top:15px;background:#f8f9fa;padding:10px;border-radius:5px;">
                <strong>Expected:</strong> questions/${questionNumber}.png
            </div>
        </div>
    `;
}

// ===== COMPREHENSIVE ANSWERS CAPTURE SYSTEM =====
function captureAllAnswersData() {
    const answersData = {
        student: progress.student,
        timestamp: new Date().toISOString(),
        examId: generateExamId(),
        assignedForm: assignedForm,
        answers: [],
        summary: {}
    };
    
    for (let i = 0; i < examData.files.length; i++) {
        const answerRecord = {
            questionNumber: i + 1,
            shuffledPosition: examData.originalOrder[i] + 1,
            subject: examData.subjectNames[i],
            studentAnswer: progress.answers[i] || 'N',
            correctAnswer: examData.keys[i],
            isCorrect: progress.answers[i] === examData.keys[i],
            isReviewed: progress.review[i]
        };
        answersData.answers.push(answerRecord);
    }
    
    const subjectSummary = {};
    answersData.answers.forEach(answer => {
        const subject = answer.subject;
        if (!subjectSummary[subject]) {
            subjectSummary[subject] = { total: 0, correct: 0, wrong: 0, notAttempted: 0, marks: 0 };
        }
        subjectSummary[subject].total++;
        if (answer.isCorrect) {
            subjectSummary[subject].correct++;
            subjectSummary[subject].marks += MARK_PER_CORRECT;
        } else if (answer.studentAnswer === 'N') {
            subjectSummary[subject].notAttempted++;
        } else {
            subjectSummary[subject].wrong++;
            subjectSummary[subject].marks += MARK_PER_WRONG;
        }
    });
    
    answersData.summary = subjectSummary;
    return answersData;
}

function generateExamId() {
    return `exam_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
}

function formatAllAnswersString(answers) {
    const originalOrderAnswers = new Array(60);
    examData.originalOrder.forEach((originalIndex, shuffledIndex) => {
        const studentAnswer = answers[shuffledIndex] || 'N';
        originalOrderAnswers[originalIndex] = studentAnswer;
    });
    return originalOrderAnswers.join(',');
}

// ===== ENHANCED GOOGLE FORMS SUBMISSION =====
async function submitToGoogleForms(answersData) {
    const FORM_URL = GOOGLE_FORMS[assignedForm];
    if (!FORM_URL) {
        console.error(`‚ùå No Google Form URL found for form ${assignedForm}`);
        updateSubmissionStatus('error', `No Google Form URL found for form ${assignedForm}`);
        return false;
    }

    try {
        const formFields = getFormFields(assignedForm);
        const formData = new URLSearchParams();
        formData.append(formFields.STUDENT_NAME, answersData.student.name);
        formData.append(formFields.SECTION, answersData.student.sec);
        formData.append(formFields.ROLL_NUMBER, answersData.student.roll);
        formData.append(formFields.ADMISSION_NUMBER, answersData.student.adm);
        const marks = calculateSubjectMarks(answersData.summary);
        formData.append(formFields.MATHS_MARKS, marks.maths.toFixed(2));
        formData.append(formFields.PHYSICS_MARKS, marks.physics.toFixed(2));
        formData.append(formFields.CHEMISTRY_MARKS, marks.chemistry.toFixed(2));
        formData.append(formFields.TOTAL_MARKS, marks.total.toFixed(2));
        formData.append(formFields.TIMESTAMP, new Date().toLocaleString());
        const allAnswersString = formatAllAnswersString(progress.answers);
        formData.append(formFields.ALL_ANSWERS, allAnswersString);
        updateSubmissionStatus('pending', 'Submitting to Google Forms...');
        await fetch(FORM_URL, { method: "POST", mode: "no-cors", headers: {'Content-Type': 'application/x-www-form-urlencoded'}, body: formData });
        updateSubmissionStatus('success', '‚úÖ Answers successfully submitted to Google Forms!');
        return true;
    } catch (error) {
        console.error("‚ùå Google Forms submission failed:", error);
        updateSubmissionStatus('error', '‚ùå Failed to submit to Google Forms. Your answers have been saved locally.');
        return false;
    }
}

function updateSubmissionStatus(status, message) {
    googleFormsSubmissionStatus = status;
    const statusDiv = document.getElementById('summarySubmissionStatus');
    if (statusDiv) statusDiv.innerHTML = `<div class="submission-status submission-${status}">${message}</div>`;
    const entryStatus = document.getElementById('googleFormsStatus');
    if (entryStatus) {
        entryStatus.innerHTML = `<div class="submission-status submission-${status}">${message}</div>`;
        entryStatus.style.display = 'block';
    }
}

function calculateSubjectMarks(summary) {
    let maths = 0, physics = 0, chemistry = 0, total = 0;
    for (let subject in summary) {
        const subjectLower = subject.toLowerCase();
        if (subjectLower.includes('math')) maths = summary[subject].marks;
        else if (subjectLower.includes('phy')) physics = summary[subject].marks;
        else if (subjectLower.includes('chem')) chemistry = summary[subject].marks;
        total += summary[subject].marks;
    }
    return { maths, physics, chemistry, total };
}

async function sendToGoogleFormWithGuarantee(subjData, studentData) {
    const studentId = generateStudentId(studentData);
    if (submissionInProgress.has(studentId)) return true;
    try {
        submissionInProgress.add(studentId);
        const answersData = captureAllAnswersData();
        const success = await submitToGoogleForms(answersData);
        if (success) {
            localStorage.setItem(`exam_result_${answersData.examId}`, JSON.stringify(answersData));
            return true;
        } else return false;
    } catch (error) {
        console.error(`üí• Submission error for ${studentData.name}:`, error);
        return false;
    } finally {
        setTimeout(() => submissionInProgress.delete(studentId), 5000);
    }
}

function generateStudentId(studentData) {
    return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
}

// ===== INPUT VALIDATION =====
function validateStudentInputs() {
  const n = document.getElementById('stuName'), 
        s = document.getElementById('stuSection'), 
        r = document.getElementById('stuRoll'), 
        a = document.getElementById('stuAdm');
  if (s.value) s.value = s.value.toUpperCase();
  let v1 = /^[A-Za-z .]+$/.test(n.value), 
      v2 = /^[A-Za-z0-9]+$/.test(s.value),
      v3 = /^[0-9]+$/.test(r.value), 
      v4 = /^[0-9]+$/.test(a.value);
  n.classList.toggle('error', !v1 && n.value !== ""); 
  s.classList.toggle('error', !v2 && s.value !== "");
  r.classList.toggle('error', !v3 && r.value !== ""); 
  a.classList.toggle('error', !v4 && a.value !== "");
  const allValid = v1 && v2 && v3 && v4 && keyLoaded;
  if (v1 && v2 && v3 && v4) {
    const studentData = { name: n.value, sec: s.value, roll: r.value, adm: a.value };
    updateFormAssignmentDisplay(studentData);
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
  } else {
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('stuStartBtn').style.display = allValid ? "inline-block" : "none";
  }
  if (!keyLoaded) showError("Answer key not loaded - exam disabled. Contact administrator.");
  return allValid;
}

function showError(message) {
    document.getElementById('errorMessages').innerHTML = `<div class="error-message">${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== RESUBMISSION FUNCTIONALITY =====
function checkResubmission(studentData) { return false; }

function verifyResubmissionPassword() {
    const enteredPassword = document.getElementById('resubmissionPassword').value.trim();
    if (enteredPassword === RESUBMISSION_PASSWORD) {
        isResubmission = true;
        document.getElementById('resubmissionSection').style.display = 'none';
        document.getElementById('stuStartBtn').style.display = 'inline-block';
        document.getElementById('errorMessages').innerHTML = '<div class="success-message">‚úÖ Password verified. You can now start the exam.</div>';
        return true;
    } else {
        document.getElementById('errorMessages').innerHTML = '<div class="error-message">‚ùå Incorrect password. Please try again.</div>';
        document.getElementById('resubmissionPassword').value = '';
        document.getElementById('resubmissionPassword').focus();
        return false;
    }
}

function cancelResubmission() {
    document.getElementById('resubmissionSection').style.display = 'none';
    document.getElementById('resubmissionPassword').value = '';
    document.getElementById('errorMessages').innerHTML = '';
    isResubmission = false;
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    errorElement.style.display = 'none';
    if (enteredCode === ACCESS_CODE) {
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => accessDenied.style.animation = '', 500);
    }
}

// ===== TAB SWITCH DETECTION =====
let tabSwitchCount = 0;
let lastTabSwitchTime = 0;
const MAX_TAB_SWITCHES = 2;
const TAB_SWITCH_WINDOW_MS = 30000;

document.addEventListener('visibilitychange', function() {
    if (document.hidden && examInProgress) {
        const currentTime = Date.now();
        if (currentTime - lastTabSwitchTime > TAB_SWITCH_WINDOW_MS) tabSwitchCount = 0;
        tabSwitchCount++;
        lastTabSwitchTime = currentTime;
        console.log(`Tab switch detected: ${tabSwitchCount}/${MAX_TAB_SWITCHES}`);
        if (tabSwitchCount >= MAX_TAB_SWITCHES) {
            alert('‚ö†Ô∏è Multiple tab switches detected. Exam will be submitted automatically for security.');
            submitExam();
        } else {
            alert(`‚ö†Ô∏è Warning: Tab switching detected (${tabSwitchCount}/${MAX_TAB_SWITCHES}). Multiple switches may result in automatic submission.`);
        }
    }
});

// ===== EVENT LISTENERS =====
["stuName", "stuSection", "stuRoll", "stuAdm"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateStudentInputs);
});

document.getElementById('stuStartBtn').onclick = () => { 
  if (!validateStudentInputs()) return; 
  showConfirm("Start Exam?", startWithSecurity); 
};

document.getElementById('verifyResubmission').addEventListener('click', verifyResubmissionPassword);
document.getElementById('cancelResubmission').addEventListener('click', cancelResubmission);
document.getElementById('resubmissionPassword').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') verifyResubmissionPassword();
});
document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);
document.getElementById('accessCode').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') verifyAccessCode();
});

// ===== EXAM PREPARATION =====
function shuffleArray(arr) {
    const c = arr.slice();
    for (let i = c.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [c[i], c[j]] = [c[j], c[i]];
    }
    return c;
}

function prepareExamData() {
  examData.files = []; examData.subjectNames = []; examData.keys = []; examData.originalOrder = [];
  const subjectRanges = [
    { name: "Maths", start: 1, end: 30 },
    { name: "Physics", start: 31, end: 45 },
    { name: "Chemistry", start: 46, end: 60 }
  ];
  let groups = [];
  subjectRanges.forEach(subject => {
    const subjectQuestions = [];
    const subjectKeys = [];
    const subjectOriginalOrder = [];
    for (let i = subject.start; i <= subject.end; i++) {
      const imgIndex = i - 1;
      if (images[imgIndex] && answerKey[imgIndex]) {
        subjectQuestions.push(images[imgIndex]);
        subjectKeys.push(answerKey[imgIndex]);
        subjectOriginalOrder.push(imgIndex);
      }
    }
    const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
    groups.push({
      name: subject.name,
      imgs: shuffledIndices.map(i => subjectQuestions[i]),
      keys: shuffledIndices.map(i => subjectKeys[i]),
      originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i])
    });
  });
  const shuffledGroups = shuffleArray(groups);
  shuffledGroups.forEach(g => {
    g.imgs.forEach((img, i) => {
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
      examData.originalOrder.push(g.originalOrder[i]);
    });
  });
}

// ===== EXAM START =====
function startWithSecurity(ok) {
  if (!ok) return;
  const stuName = document.getElementById('stuName');
  const stuSection = document.getElementById('stuSection');
  const stuRoll = document.getElementById('stuRoll');
  const stuAdm = document.getElementById('stuAdm');
  const studentKey = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
  startExam(studentKey);
}

function startExam(studentKey) {
    if (!keyLoaded) {
        alert('Answer key not loaded. Contact admin.');
        return;
    }
    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');
    localStorage.setItem(studentKey, Date.now());
    prepareExamData();
    activateNuclearLensDestroyer();
    progress = {
        answers: Array(examData.files.length).fill(null),
        review: Array(examData.files.length).fill(false),
        currentIndex: 0,
        student: {name: stuName.value, sec: stuSection.value, roll: stuRoll.value, adm: stuAdm.value},
        timeLeftSec: EXAM_DURATION_MINUTES * 60
    };
    examStartTime = Date.now();
    examInProgress = true;
    document.getElementById('studentEntry').style.display = "none";
    document.getElementById('examArea').style.display = "block";
    renderQuestion(); 
    renderPalette(); 
    startTimer(); 
    updateNavButtons();
    sheetReady = true;
}

function selectOption(opt) {
  const idx = progress.currentIndex;
  if (progress.answers[idx] === opt) {
    progress.answers[idx] = null;
  } else {
    progress.answers[idx] = opt;
  }
  updateOptionButtons();
  updatePalette();
}

function updateOptionButtons() {
  const idx = progress.currentIndex;
  const currentAnswer = progress.answers[idx];
  document.querySelectorAll('.optBtn').forEach(btn => {
    const btnOpt = btn.getAttribute('data-opt');
    btn.classList.toggle('selected', btnOpt === currentAnswer);
  });
}

function updateQuestionInfo() {
  const idx = progress.currentIndex;
  const stuInfoEl = document.getElementById('stuInfo');
  const stuQInfoEl = document.getElementById('stuQInfo');
  if (stuInfoEl) stuInfoEl.textContent = `${progress.student.name} | ${progress.student.sec} | Roll: ${progress.student.roll}`;
  if (stuQInfoEl) stuQInfoEl.textContent = `Q${idx+1} of ${examData.files.length} | ${examData.subjectNames[idx]}`;
}

// ===== PALETTE FUNCTIONS =====
function renderPalette() {
  const container = document.getElementById('paletteContainer');
  container.innerHTML = '';
  for (let i = 0; i < examData.files.length; i++) {
    const btn = document.createElement('button');
    btn.className = 'palette-btn';
    btn.textContent = i + 1;
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
    btn.onclick = () => {
      progress.currentIndex = i;
      renderQuestion();
      updateNavButtons();
    };
    container.appendChild(btn);
  }
}

function updatePalette() {
  const buttons = document.querySelectorAll('.palette-btn');
  buttons.forEach((btn, i) => {
    btn.className = 'palette-btn';
    if (progress.answers[i] !== null) btn.classList.add('selected');
    if (progress.review[i]) btn.classList.add('reviewed');
    if (i === progress.currentIndex) btn.classList.add('current');
  });
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavButtons() {
  const idx = progress.currentIndex;
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const markReviewBtn = document.getElementById('markReviewBtn');
  prevBtn.disabled = idx === 0;
  nextBtn.disabled = idx === examData.files.length - 1;
  if (progress.review[idx]) {
    markReviewBtn.textContent = 'Unmark Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #dc3545, #c82333)';
  } else {
    markReviewBtn.textContent = 'Mark for Review';
    markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
  }
}

document.getElementById('prevBtn').onclick = () => {
  if (progress.currentIndex > 0) {
    progress.currentIndex--;
    renderQuestion();
    updateNavButtons();
  }
};

document.getElementById('nextBtn').onclick = () => {
  if (progress.currentIndex < examData.files.length - 1) {
    progress.currentIndex++;
    renderQuestion();
    updateNavButtons();
  }
};

document.getElementById('markReviewBtn').onclick = () => {
  const idx = progress.currentIndex;
  progress.review[idx] = !progress.review[idx];
  updateNavButtons();
  updatePalette();
};

document.getElementById('submitBtn').onclick = () => {
  showConfirm("Submit Exam? You cannot change answers after submission.", submitExam);
};

// ===== TIMER FUNCTIONS =====
function startTimer() {
  timerInterval = setInterval(() => {
    progress.timeLeftSec--;
    const minutes = Math.floor(progress.timeLeftSec / 60);
    const seconds = progress.timeLeftSec % 60;
    const timerEl = document.getElementById('timerEl');
    timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    if (progress.timeLeftSec <= 300) timerEl.classList.add('blink');
    if (progress.timeLeftSec <= 0) {
      clearInterval(timerInterval);
      submitExam();
    }
  }, 1000);
}

// ===== SUBMISSION FUNCTIONS =====
function submitExam() {
  if (hasSubmitted) return;
  clearInterval(timerInterval);
  hasSubmitted = true;
  examInProgress = false;
  const subjData = {};
  examData.subjectNames.forEach((s, i) => {
    const subjectName = identifySubject(s);
    if (!subjData[subjectName]) subjData[subjectName] = {correct: 0, wrong: 0, blank: 0, total: 0, marks: 0};
    const ans = progress.answers[i];
    if (ans === null) {
      subjData[subjectName].blank++;
    } else if (ans === examData.keys[i]) {
      subjData[subjectName].correct++;
      subjData[subjectName].marks += MARK_PER_CORRECT;
    } else {
      subjData[subjectName].wrong++;
      subjData[subjectName].marks += MARK_PER_WRONG;
    }
    subjData[subjectName].total++;
  });
  currentSubjData = subjData;
  sendToGoogleFormWithGuarantee(subjData, progress.student);
  showSummaryInterface(subjData);
}

// ===== DETAILED SOLUTIONS =====
function showDetailedSolutions() {
  document.getElementById('summaryArea').style.display = 'none';
  document.getElementById('reviewArea').style.display = 'block';
  document.getElementById('reviewStudentName').textContent = progress.student.name;
  document.getElementById('reviewSection').textContent = progress.student.sec;
  document.getElementById('reviewRoll').textContent = progress.student.roll;
  document.getElementById('reviewAdm').textContent = progress.student.adm;
  document.getElementById('reviewForm').textContent = assignedForm;
  const table = document.createElement('table');
  table.className = 'detailed-results-table';
  table.innerHTML = `
    <thead><tr><th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>Marks</th></tr></thead>
    <tbody>${Object.entries(currentSubjData).map(([subject, data]) => `
        <tr><td>${subject}</td><td>${data.correct}</td><td>${data.wrong}</td><td>${data.blank}</td><td>${data.total}</td><td>${data.marks.toFixed(2)}</td></tr>
      `).join('')}
      <tr class="total-row"><td><strong>Total</strong></td><td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td><td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td><td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td><td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.total, 0)}</strong></td><td><strong>${Object.values(currentSubjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td></tr>
    </tbody>`;
  document.getElementById('detailedResultsContainer').innerHTML = '';
  document.getElementById('detailedResultsContainer').appendChild(table);
  const solutionsContainer = document.getElementById('reviewQuestionsContainer');
  solutionsContainer.innerHTML = '<h3 style="text-align:center; color:#4B0082; margin:30px 0;">Detailed Question Solutions</h3>';
  for (let i = 0; i < examData.files.length; i++) {
    const studentAnswer = progress.answers[i];
    const correctAnswer = examData.keys[i];
    const isCorrect = studentAnswer === correctAnswer;
    const solutionDiv = document.createElement('div');
    solutionDiv.className = 'solution-container';
    solutionDiv.innerHTML = `
      <div class="solution-question">Question ${i+1} (${examData.subjectNames[i]})</div>
      <div class="solution-answer ${isCorrect ? 'solution-correct' : 'solution-wrong'}">
        <strong>Your Answer:</strong> ${studentAnswer || 'Not Attempted'} 
        ${!isCorrect && studentAnswer ? ` | <strong>Correct Answer:</strong> ${correctAnswer}` : ''}
        ${isCorrect ? ' ‚úÖ' : ' ‚ùå'}
      </div>
      <div class="solution-explanation">
        This question was from ${examData.subjectNames[i]} section. 
        ${isCorrect ? 'You answered correctly!' : studentAnswer ? 'Your answer was incorrect.' : 'You did not attempt this question.'}
      </div>`;
    solutionsContainer.appendChild(solutionDiv);
  }
  document.getElementById('closeReviewBtn').onclick = () => {
    document.getElementById('reviewArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  };
}

// ===== SUMMARY INTERFACE =====
function showSummaryInterface(subjData) {
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'block';
  document.getElementById('summaryStudentName').textContent = progress.student.name;
  document.getElementById('summarySection').textContent = progress.student.sec;
  document.getElementById('summaryRoll').textContent = progress.student.roll;
  document.getElementById('summaryAdm').textContent = progress.student.adm;
  document.getElementById('summaryForm').textContent = assignedForm;
  const table = document.createElement('table');
  table.className = 'results-table';
  table.innerHTML = `
    <thead><tr><th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>Marks</th></tr></thead>
    <tbody>${Object.entries(subjData).map(([subject, data]) => `
        <tr><td>${subject}</td><td>${data.correct}</td><td>${data.wrong}</td><td>${data.blank}</td><td>${data.total}</td><td>${data.marks.toFixed(2)}</td></tr>
      `).join('')}
      <tr class="total-row"><td><strong>Total</strong></td><td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.correct, 0)}</strong></td><td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.wrong, 0)}</strong></td><td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.blank, 0)}</strong></td><td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.total, 0)}</strong></td><td><strong>${Object.values(subjData).reduce((sum, d) => sum + d.marks, 0).toFixed(2)}</strong></td></tr>
    </tbody>`;
  document.getElementById('summaryTableContainer').innerHTML = '';
  document.getElementById('summaryTableContainer').appendChild(table);
  document.getElementById('autoTransitionMessage').style.display = 'block';
  let countdown = 5;
  document.getElementById('countdown').textContent = countdown;
  const countdownInterval = setInterval(() => {
    countdown--;
    document.getElementById('countdown').textContent = countdown;
    if (countdown <= 0) {
      clearInterval(countdownInterval);
      showDetailedSolutions();
    }
  }, 1000);
  document.getElementById('closeSummaryBtn').onclick = () => {
    clearInterval(countdownInterval);
    document.getElementById('summaryArea').style.display = 'none';
    document.getElementById('studentEntry').style.display = 'flex';
    resetForm();
  };
}

// ===== UTILITY FUNCTIONS =====
function identifySubject(subjectName) {
  if (subjectName.includes('Math')) return 'Mathematics';
  if (subjectName.includes('Phy')) return 'Physics';
  if (subjectName.includes('Chem')) return 'Chemistry';
  return subjectName;
}

function resetForm() {
  document.getElementById('stuName').value = '';
  document.getElementById('stuSection').value = '';
  document.getElementById('stuRoll').value = '';
  document.getElementById('stuAdm').value = '';
  document.getElementById('formAssignment').style.display = 'none';
  document.getElementById('googleFormsStatus').style.display = 'none';
  validateStudentInputs();
}

// ===== CONFIRMATION MODAL =====
function showConfirm(message, callback) {
  const modal = document.getElementById('confirmModal');
  const text = document.getElementById('confirmText');
  const yesBtn = document.getElementById('confirmYes');
  const noBtn = document.getElementById('confirmNo');
  text.textContent = message;
  modal.style.display = 'flex';
  yesBtn.onclick = () => { modal.style.display = 'none'; callback(true); };
  noBtn.onclick = () => { modal.style.display = 'none'; callback(false); };
}

// ===== ADMIN PASSWORD =====
document.getElementById('adminPassSubmit').addEventListener('click', function() {
  const adminPassInput = document.getElementById('adminPassInput');
  if (adminPassInput.value === ADMIN_PASSWORD) {
    adminOverrideActive = true;
    document.getElementById('adminPassModal').style.display = 'none';
    document.getElementById('fullRedOverlay').style.display = 'none';
    document.getElementById('accessDeniedBox').style.display = 'none';
    const stuName = document.getElementById('stuName');
    const stuSection = document.getElementById('stuSection');
    const stuRoll = document.getElementById('stuRoll');
    const stuAdm = document.getElementById('stuAdm');
    const studentKey = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
    startExam(studentKey);
  } else {
    alert("Incorrect password!");
    adminPassInput.value = '';
    adminPassInput.focus();
  }
});

document.getElementById('adminPassInput').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') document.getElementById('adminPassSubmit').click();
});

// ===== DOWNLOAD FUNCTION =====
function downloadStudentCSV() {
  let csvContent = "Question,Subject,Your Answer,Correct Answer,Status\n";
  for (let i = 0; i < examData.files.length; i++) {
    const studentAnswer = progress.answers[i] || 'Not Attempted';
    const correctAnswer = examData.keys[i];
    const status = studentAnswer === correctAnswer ? 'Correct' : 
                  studentAnswer === 'Not Attempted' ? 'Not Attempted' : 'Wrong';
    csvContent += `${i+1},${examData.subjectNames[i]},${studentAnswer},${correctAnswer},${status}\n`;
  }
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.setAttribute('hidden', '');
  a.setAttribute('href', url);
  a.setAttribute('download', `exam_results_${progress.student.name}_${progress.student.roll}.csv`);
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', function(e) {
  if (document.getElementById('examArea').style.display === 'block') {
    const keyMap = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'};
    if (keyMap[e.key]) {
      e.preventDefault();
      selectOption(keyMap[e.key]);
    }
  }
});

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
  document.getElementById('accessDenied').style.display = 'flex';
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'none';
  document.getElementById('reviewArea').style.display = 'none';
  document.getElementById('resubmissionSection').style.display = 'none';
  document.getElementById('googleFormsStatus').style.display = 'none';
  document.getElementById('accessCode').focus();
  loadAnswerKeyFromRepo();
});

// HIDE ALL JAVASCRIPT FROM VIEW SOURCE
document.addEventListener('DOMContentLoaded', function() {
    // Encrypt script content
    const scripts = document.querySelectorAll('script');
    scripts.forEach(script => {
        if (!script.src) {
            script.type = 'text/plain';
            script.setAttribute('data-encrypted', 'true');
        }
    });
    
    // Add final security layer
    setInterval(function() {
        // Check for dev tools
        const threshold = 160;
        const start = performance.now();
        debugger;
        const end = performance.now();
        if (end - start > threshold) {
            window.location.reload();
        }
    }, 1000);
});
</script>
</body>
</html>
