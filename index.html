<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam</title>
<style>
/* ===== BASE STYLES ===== */
:root {
  --primary-color: #4B0082;
  --secondary-color: #D8BFD8;
  --light-purple: #E6E6FA;
  --white: #fff;
  --black: #000;
  --success: #32CD32;
  --warning: #ff9900;
  --danger: #ff6666;
  --shadow: 0 5px 15px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "SF Pro Display", Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--black);
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Disable right-click context menu */
body {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Enhanced Screenshot protection */
#screenshotProtection {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483647;
  pointer-events: none;
}

.screenshot-dots {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 200px 200px;
  animation: flicker 0.5s infinite;
}

@keyframes flicker {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.9; }
}

/* Additional screenshot protection */
#screenshotBlock {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483646;
  pointer-events: none;
}

/* ===== HEADER & FOOTER ===== */
header {
  background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
  color: var(--primary-color);
  text-align: center;
  padding: 20px;
  font-size: 36px;
  font-weight: 700;
  letter-spacing: 1.5px;
  box-shadow: var(--shadow);
  text-shadow: 0 1px 2px var(--white);
}

footer {
  background: var(--light-purple);
  color: var(--primary-color);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  position: fixed;
  width: 100%;
  bottom: 0;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 140px);
  padding: 16px;
  text-align: center;
}

.form-group {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  margin-bottom: 20px;
  width: 100%;
  max-width: 500px;
}

.form-group label {
  font-size: 1.15rem;
  font-weight: 600;
  margin-right: 10px;
  color: var(--primary-color);
  width: 180px;
  text-align: right;
}

input[type="text"] {
  padding: 12px 14px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: 1.5px solid var(--primary-color);
  outline: none;
  min-width: 250px;
  transition: var(--transition);
}

input[type="text"]:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
  animation: glowRed 0.5s alternate infinite;
  border-color: var(--danger);
}

@keyframes glowRed {
  0% { box-shadow: 0 0 5px var(--danger); }
  100% { box-shadow: 0 0 15px var(--danger); }
}

/* ===== BUTTON STYLES ===== */
button {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: none;
  border-radius: 12px;
  transition: var(--transition);
  box-shadow: 0 6px #aaa;
  background: linear-gradient(to bottom, #fafaff, #dcd6f7);
  color: var(--primary-color);
  font-weight: 600;
  padding: 12px 24px;
  font-size: 18px;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,.28);
}

button:active {
  transform: translateY(3px) scale(.98);
}

button:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* ===== OPTION BUTTON STYLES ===== */
.optBtn {
  font-size: 16px;
  padding: 8px 18px;
  margin: 6px;
  border: 2px solid var(--primary-color);
  background: var(--white);
  border-radius: 8px;
  box-shadow: 0 5px #aaa;
}

.optBtn.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

.optBtn.correct {
  background: #32CD32;
  color: white;
  border-color: #228B22;
}

.optBtn.wrong {
  background: #FF6B6B;
  color: white;
  border-color: #DC143C;
}

.optBtn.not-attempted {
  background: #B0B0B0;
  color: white;
  border-color: #808080;
}

.navBtn {
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 8px;
  color: var(--white);
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(145deg, #1E90FF, #4682B4);
  margin: 0 15px;
}

#markReviewBtn {
  background: linear-gradient(145deg, #ffb84d, var(--warning));
}

#submitBtn {
  background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== TIMER STYLES ===== */
#timerEl {
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
  padding: 6px 12px;
  border-radius: 6px;
  background: #f0f0ff;
  display: inline-block;
  transition: var(--transition);
}

#timerEl.blink {
  animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
  0% { background: var(--danger); color: var(--white); }
  50% { background: var(--white); color: var(--primary-color); }
  100% { background: var(--danger); color: var(--white); }
}

/* ===== EXAM AREA LAYOUT ===== */
#examArea {
  display: none;
  flex-direction: column;
  height: calc(100vh - 140px);
  padding: 0;
}

.exam-main-content {
  display: flex;
  flex: 1;
  overflow: hidden;
  gap: 10px;
  padding: 10px;
}

.question-section {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: white;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.question-container {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ===== ENHANCED SIDE PALETTE STYLES - IMPROVED ===== */
.palette-section {
  width: 360px;
  background: white;
  display: flex;
  flex-direction: column;
  border-radius: 10px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.palette-header {
  background: linear-gradient(145deg, var(--primary-color), #6A0DAD);
  color: white;
  padding: 12px;
  text-align: center;
  font-weight: 600;
  font-size: 16px;
}

.palette-container {
  flex: 1;
  padding: 10px;
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 4px;
  overflow-y: auto;
  overflow-x: hidden;
  align-content: start;
  justify-items: center;
}

/* ===== PALETTE BUTTON STYLES - ENHANCED SHAPES ===== */
.palette-btn {
  width: 28px;
  height: 28px;
  border: 2px solid var(--primary-color);
  background: linear-gradient(135deg, var(--light-purple), #d8c8f0);
  border-radius: 50%; /* Circular shape for better appearance */
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  color: var(--primary-color);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 10px;
  margin: 0;
  padding: 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.palette-btn:hover {
  border-color: var(--secondary-color);
  background: linear-gradient(135deg, var(--secondary-color), #c5b0e0);
  color: white;
  transform: scale(1.1) rotate(5deg);
}

.palette-btn.selected {
  background: linear-gradient(135deg, var(--success), #2ecc71);
  color: white;
  border-color: #27ae60;
  transform: scale(1.05);
}

.palette-btn.reviewed {
  background: linear-gradient(135deg, var(--warning), #f39c12);
  color: white;
  border-color: #e67e22;
  transform: scale(1.05);
}

.palette-btn.current {
  border: 3px solid #FF4444 !important;
  box-shadow: 0 0 8px rgba(255, 68, 68, 0.6);
  animation: pulse 1.5s infinite;
}

.palette-btn.current.selected {
  background: linear-gradient(135deg, var(--success), #2ecc71);
  color: white;
  border-color: #FF4444;
}

.palette-btn.current.reviewed {
  background: linear-gradient(135deg, var(--warning), #f39c12);
  color: white;
  border-color: #FF4444;
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

/* ===== ACCESS DENIED SCREEN ===== */
.access-denied {
  display: flex;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  z-index: 10000;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
  padding: 20px;
}

.access-denied h1 {
  font-size: 3em;
  margin-bottom: 20px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.access-denied p {
  font-size: 1.2em;
  margin-bottom: 30px;
  max-width: 600px;
}

.access-code-input {
  padding: 12px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  width: 300px;
  text-align: center;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn {
  background: white;
  color: #e74c3c;
  border: none;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.verify-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 8px rgba(0,0,0,0.15);
}

.access-error {
  color: #ffeb3b;
  margin-top: 10px;
  font-weight: 600;
  display: none;
}

/* ===== MODAL STYLES ===== */
.confirmModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.confirmBox {
  background: var(--white);
  padding: 20px;
  border-radius: 12px;
  min-width: 280px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.confirmBox p {
  font-size: 18px;
  color: var(--primary-color);
  margin-bottom: 15px;
}

.confirmBox button {
  margin: 0 10px;
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
}

/* Rest of your CSS remains the same... */

</style>
</head>

<body>

<!-- Access Denied Screen - ALWAYS SHOWS FIRST -->
<div id="accessDenied" class="access-denied">
    <h1>ACCESS REQUIRED</h1>
    <p>Please enter the access code to continue with the examination.</p>
    <p>If you don't have the access code, contact your administrator.</p>
    <input type="password" id="accessCode" class="access-code-input" placeholder="Enter Access Code">
    <button id="verifyAccess" class="verify-btn">VERIFY ACCESS</button>
    <div id="accessError" class="access-error">‚ùå Invalid access code. Please try again.</div>
</div>

<header>LFJC ONLINE EXAMINATION</header>

<div id="studentEntry" style="display:none;">
  <!-- ADMIN TOOLS REMOVED FROM FIRST PAGE AS REQUESTED -->
  
  <div class="warning-banner" id="examWarning" style="display:none;">
    <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
  </div>
  
  <div class="form-group"><label>NAME</label><input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off"></div>
  <div class="form-group"><label>SECTION</label><input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off"></div>
  <div class="form-group"><label>ROLL NUMBER</label><input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off"></div>
  <div class="form-group"><label>ADMISSION NUMBER</label><input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off"></div>

  <!-- Form Assignment Display -->
  <div id="formAssignment" class="form-assignment" style="display:none;">
    <h3>üìã ASSIGNED FORM</h3>
    <div class="assigned-form" id="assignedFormDisplay">FORM A</div>
    <p>Your responses will be submitted to this form</p>
  </div>

  <div class="form-group"><button id="stuStartBtn" style="display:none;">Start Exam</button></div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<!-- Enhanced Exam Area with Side Palette -->
<div id="examArea" style="display:none;">
  <div id="examHeader">
    <div id="stuInfo"></div>
    <div id="stuQInfo"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <div class="exam-main-content">
    <!-- Question Section -->
    <div class="question-section">
      <div id="questionContainer" class="question-container"></div>
    </div>

    <!-- Enhanced Side Palette - IMPROVED SHAPES -->
    <div class="palette-section">
      <div class="palette-header">üìã Question Palette</div>
      <div id="paletteContainer" class="palette-container"></div>
    </div>
  </div>

  <!-- Navigation positioned for better visibility -->
  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span> |
      <b>Form:</b> <span id="summaryForm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close</button>
  </div>
</div>

<footer>LFJC@2025 All rights reserved</footer>

<div class="confirmModal" id="confirmModal">
  <div class="confirmBox">
    <p id="confirmText">Confirm?</p>
    <button id="confirmYes">Yes</button>
    <button id="confirmNo">No</button>
  </div>
</div>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
  <div class="screenshot-dots"></div>
</div>
<div id="screenshotBlock"></div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 10;
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const ACCESS_CODE = "lfjc2025";
const ADMIN_PASSWORD = "admin2025";

// ===== GOOGLE FORMS INTEGRATION =====
const GOOGLE_FORMS = {
    'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
    'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
    'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse"
};

const FORM_FIELDS = {
    STUDENT_NAME: "entry.217666919",
    SECTION: "entry.2006392966",
    ROLL_NUMBER: "entry.547275105",
    ADMISSION_NUMBER: "entry.1234063852",
    MATHS_MARKS: "entry.1989859216",
    PHYSICS_MARKS: "entry.1953974928",
    CHEMISTRY_MARKS: "entry.296331194",
    TOTAL_MARKS: "entry.1289040887",
    TIMESTAMP: "entry.2139100252",
    ALL_ANSWERS_A: "entry.224183536"
};

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let hasSubmitted = false;
let examStartTime = null;
let preloadedImages = {};
let currentSubjData = null;
let assignedForm = 'A';

let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
let progress = null, timerInterval = null;

// ===== AUTOMATIC FORM DISTRIBUTION SYSTEM =====
function getAssignedForm(studentData) {
    const forms = ['A', 'B', 'C'];
    const formsCount = forms.length;
    
    if (studentData.roll && !isNaN(studentData.roll)) {
        const rollNumber = parseInt(studentData.roll);
        const formIndex = (rollNumber - 1) % formsCount;
        return forms[formIndex];
    }
    
    const hashString = `${studentData.name}|${studentData.roll}|${studentData.adm}`;
    let hash = 0;
    for (let i = 0; i < hashString.length; i++) {
        hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
        hash = hash & hash;
    }
    return forms[Math.abs(hash) % formsCount];
}

function updateFormAssignmentDisplay(studentData) {
    assignedForm = getAssignedForm(studentData);
    document.getElementById('assignedFormDisplay').textContent = `FORM ${assignedForm}`;
    document.getElementById('formAssignment').style.display = 'block';
}

// ===== DATA SUBMISSION SYSTEM =====
function createResultDataWithAllAnswers(subjData) {
    const originalOrderAnswers = [];
    
    examData.originalOrder.forEach((originalIndex, shuffledIndex) => {
        originalOrderAnswers[originalIndex] = {
            question: originalIndex + 1,
            studentAnswer: progress.answers[shuffledIndex],
            correctAnswer: examData.keys[shuffledIndex],
            subject: examData.subjectNames[shuffledIndex],
            isCorrect: progress.answers[shuffledIndex] === examData.keys[shuffledIndex]
        };
    });
    
    const resultData = {
        student: {
            name: progress.student.name,
            section: progress.student.sec,
            roll: progress.student.roll,
            admission: progress.student.adm
        },
        marks: {
            maths: subjData.Mathematics ? subjData.Mathematics.marks.toFixed(2) : "0.00",
            physics: subjData.Physics ? subjData.Physics.marks.toFixed(2) : "0.00", 
            chemistry: subjData.Chemistry ? subjData.Chemistry.marks.toFixed(2) : "0.00",
            total: (subjData.Mathematics?.marks + subjData.Physics?.marks + subjData.Chemistry?.marks).toFixed(2)
        },
        answers: originalOrderAnswers,
        summary: subjData,
        examConfig: {
            totalQuestions: examData.files.length,
            shuffledOrder: examData.originalOrder,
            timestamp: new Date().toISOString(),
            assignedForm: assignedForm
        }
    };
    
    return resultData;
}

async function submitDetailedResults(resultData) {
    const FORM_URL = GOOGLE_FORMS[assignedForm];
    
    if (!FORM_URL) {
        console.error(`No form URL for ${assignedForm}`);
        return false;
    }

    const formData = new URLSearchParams();
    
    // Basic student info
    formData.append(FORM_FIELDS.STUDENT_NAME, resultData.student.name);
    formData.append(FORM_FIELDS.SECTION, resultData.student.section);
    formData.append(FORM_FIELDS.ROLL_NUMBER, resultData.student.roll);
    formData.append(FORM_FIELDS.ADMISSION_NUMBER, resultData.student.admission);
    
    // Marks summary
    formData.append(FORM_FIELDS.MATHS_MARKS, resultData.marks.maths);
    formData.append(FORM_FIELDS.PHYSICS_MARKS, resultData.marks.physics);
    formData.append(FORM_FIELDS.CHEMISTRY_MARKS, resultData.marks.chemistry);
    formData.append(FORM_FIELDS.TOTAL_MARKS, resultData.marks.total);
    
    // All answers in one field
    const allAnswersString = resultData.answers.map(answer => 
        answer.studentAnswer || 'N'
    ).join(',');
    
    formData.append(FORM_FIELDS.ALL_ANSWERS_A, allAnswersString);
    formData.append(FORM_FIELDS.TIMESTAMP, new Date().toLocaleString());
    
    console.log("üéØ SUBMITTING ALL ANSWERS:");
    console.log("Form:", assignedForm);
    console.log("Answers:", allAnswersString);
    console.log("Student:", resultData.student.name);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        await fetch(FORM_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData,
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        console.log(`‚úÖ Submitted to Form ${assignedForm}`);
        return true;
        
    } catch (error) {
        console.error(`‚ùå Google Forms submission failed:`, error);
        return false;
    }
}

// ===== FIXED SUBMISSION FUNCTION - ALLOWS MULTIPLE SUBMISSIONS =====
function submitExam() {
    if (hasSubmitted) return;
    clearInterval(timerInterval);
    
    hasSubmitted = true;
    
    const subjData = {};
    examData.subjectNames.forEach((s, i) => {
        const subjectName = identifySubject(s);
        if (!subjData[subjectName]) subjData[subjectName] = {correct: 0, wrong: 0, blank: 0, total: 0, marks: 0};
        
        const ans = progress.answers[i];
        if (ans === null) {
            subjData[subjectName].blank++;
        } else if (ans === examData.keys[i]) {
            subjData[subjectName].correct++;
            subjData[subjectName].marks += MARK_PER_CORRECT;
        } else {
            subjData[subjectName].wrong++;
            subjData[subjectName].marks += MARK_PER_WRONG;
        }
        subjData[subjectName].total++;
    });

    const resultData = createResultDataWithAllAnswers(subjData);
    currentSubjData = resultData;

    const studentData = progress.student;
    const submissionPromise = submitDetailedResults(resultData);

    showSummaryInterface(subjData);
    
    submissionPromise.then(success => {
        if (success) {
            console.log('üéâ Exam submitted successfully to Google Forms!');
            showSubmissionSuccess();
        } else {
            console.error('üí• Google Forms submission failed!');
            showFormSubmissionWarning();
        }
    });
}

function showSubmissionSuccess() {
    const successMsg = `
        <div class="success-message">
            <h3>‚úÖ Results Successfully Submitted!</h3>
            <p>Your marks and selected answers have been recorded.</p>
            <p><small>Student: ${progress.student.name} | Roll: ${progress.student.roll} | Form: ${assignedForm}</small></p>
        </div>
    `;
    
    const summaryContainer = document.getElementById('summaryTableContainer');
    if (summaryContainer) {
        summaryContainer.insertAdjacentHTML('beforebegin', successMsg);
    }
}

// ===== ACCESS CODE VERIFICATION =====
function verifyAccessCode() {
    const enteredCode = document.getElementById('accessCode').value.trim();
    const errorElement = document.getElementById('accessError');
    const accessDenied = document.getElementById('accessDenied');
    
    errorElement.style.display = 'none';
    
    if (enteredCode === ACCESS_CODE) {
        console.log("Access granted!");
        accessDenied.style.display = 'none';
        document.getElementById('studentEntry').style.display = 'flex';
        document.getElementById('accessCode').value = '';
        document.getElementById('stuName').focus();
    } else {
        console.log("Access denied!");
        errorElement.style.display = 'block';
        document.getElementById('accessCode').value = '';
        document.getElementById('accessCode').focus();
        accessDenied.style.animation = 'shake 0.5s';
        setTimeout(() => {
            accessDenied.style.animation = '';
        }, 500);
    }
}

// ===== PALETTE NUMBER BEHAVIOR - ENHANCED =====
function renderPalette() {
  const paletteContainer = document.getElementById('paletteContainer');
  paletteContainer.innerHTML = "";
  
  progress.answers.forEach((ans, i) => {
    const b = document.createElement("button"); 
    b.textContent = i + 1;
    b.className = "palette-btn";
    b.tabIndex = 0;
    
    if (i === progress.currentIndex) {
      b.classList.add("current");
    }
    if (progress.review[i]) {
      b.classList.add("reviewed");
    } else if (ans) {
      b.classList.add("selected");
    }
    
    b.onclick = () => { 
        progress.currentIndex = i; 
        renderQuestion(); 
        renderPalette(); 
        updateNavButtons(); 
    };
    
    paletteContainer.appendChild(b);
  });
}

// ===== INPUT VALIDATION =====
function validateStudentInputs() {
  const n = document.getElementById('stuName'), 
        s = document.getElementById('stuSection'), 
        r = document.getElementById('stuRoll'), 
        a = document.getElementById('stuAdm');
  
  if (s.value) {
    s.value = s.value.toUpperCase();
  }
  
  let v1 = /^[A-Za-z .]+$/.test(n.value), 
      v2 = /^[A-Za-z0-9]+$/.test(s.value),
      v3 = /^[0-9]+$/.test(r.value), 
      v4 = /^[0-9]+$/.test(a.value);
  
  n.classList.toggle('error', !v1 && n.value !== ""); 
  s.classList.toggle('error', !v2 && s.value !== "");
  r.classList.toggle('error', !v3 && r.value !== ""); 
  a.classList.toggle('error', !v4 && a.value !== "");
  
  const startBtn = document.getElementById('stuStartBtn');
  const allValid = v1 && v2 && v3 && v4 && keyLoaded;
  startBtn.style.display = allValid ? "inline-block" : "none";
  
  if (!keyLoaded) {
    showError("Answer key not loaded - exam disabled. Contact administrator.");
  }
  
  if (v1 && v2 && v3 && v4) {
    const studentData = {
      name: n.value,
      sec: s.value,
      roll: r.value,
      adm: a.value
    };
    updateFormAssignmentDisplay(studentData);
  }
  
  return allValid;
}

// ===== INITIALIZATION =====
fetch('Answers/Key')
  .then(res => {
    if (!res.ok) throw new Error('Key file not found or not accessible');
    return res.text();
  })
  .then(text => {
    answerKey = text.trim().split('\n').map(line => line.trim().split('')).flat();
    
    console.log("Building image paths for", answerKey.length, "questions");
    for (let i = 1; i <= answerKey.length; i++) {
      images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    clearErrors();
    validateStudentInputs();
    console.log('Loaded answer key:', answerKey);
    console.log('Image paths:', images);
  })
  .catch(err => {
    console.error('Failed to load Answers/Key:', err);
    showError("Answer key not loaded - exam disabled. Contact administrator.");
    validateStudentInputs();
  });

function shuffleArray(arr) {
    const c = arr.slice();
    for (let i = c.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [c[i], c[j]] = [c[j], c[i]];
    }
    return c;
}

function prepareExamData() {
  examData.files = []; examData.subjectNames = []; examData.keys = []; examData.originalOrder = [];
  
  const subjectRanges = [
    { name: "Maths", start: 1, end: 30 },
    { name: "Physics", start: 31, end: 45 },
    { name: "Chemistry", start: 46, end: 60 }
  ];
  
  let groups = [];
  
  subjectRanges.forEach(subject => {
    const subjectQuestions = [];
    const subjectKeys = [];
    const subjectOriginalOrder = [];
    
    for (let i = subject.start; i <= subject.end; i++) {
      const imgIndex = i - 1;
      if (images[imgIndex] && answerKey[imgIndex]) {
        subjectQuestions.push(images[imgIndex]);
        subjectKeys.push(answerKey[imgIndex]);
        subjectOriginalOrder.push(imgIndex);
      }
    }
    
    const shuffledIndices = shuffleArray([...Array(subjectQuestions.length).keys()]);
    
    groups.push({
      name: subject.name,
      imgs: shuffledIndices.map(i => subjectQuestions[i]),
      keys: shuffledIndices.map(i => subjectKeys[i]),
      originalOrder: shuffledIndices.map(i => subjectOriginalOrder[i])
    });
  });
  
  const shuffledGroups = shuffleArray(groups);
  
  shuffledGroups.forEach(g => {
    g.imgs.forEach((img, i) => {
      examData.files.push(img);
      examData.keys.push(g.keys[i]);
      examData.subjectNames.push(g.name);
      examData.originalOrder.push(g.originalOrder[i]);
    });
  });
  
  console.log("Final exam structure:");
  console.log("Total questions:", examData.files.length);
}

["stuName", "stuSection", "stuRoll", "stuAdm"].forEach(id => {
  document.getElementById(id).addEventListener("input", validateStudentInputs);
});

document.getElementById('stuStartBtn').onclick = () => { 
  if (!validateStudentInputs()) return; 
  showConfirm("Start Exam?", startExam); 
};

function startExam(ok) {
  if (!ok) return;
  
  const stuName = document.getElementById('stuName');
  const stuSection = document.getElementById('stuSection');
  const stuRoll = document.getElementById('stuRoll');
  const stuAdm = document.getElementById('stuAdm');

  prepareExamData();
  progress = {
    answers: Array(examData.files.length).fill(null),
    review: Array(examData.files.length).fill(false),
    currentIndex: 0,
    student: {name: stuName.value, sec: stuSection.value, roll: stuRoll.value, adm: stuAdm.value},
    timeLeftSec: EXAM_DURATION_MINUTES * 60
  };

  examStartTime = Date.now();
  
  document.getElementById('studentEntry').style.display = "none";
  document.getElementById('examArea').style.display = "block";
  renderQuestion(); renderPalette(); startTimer(); updateNavButtons();
  
  preloadQuestionImages();
  setupScreenshotProtection();
}

function startTimer() {
  const timerEl = document.getElementById('timerEl');
  const stuInfo = document.getElementById('stuInfo');
  const stuQInfo = document.getElementById('stuQInfo');
  const examHeader = document.getElementById('examHeader');
  
  timerInterval = setInterval(() => {
    if (progress.timeLeftSec <= 0) { clearInterval(timerInterval); submitExam(); return; }
    progress.timeLeftSec--;
    let m = Math.floor(progress.timeLeftSec / 60), s = progress.timeLeftSec % 60;
    timerEl.textContent = `üïí ${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
    stuInfo.textContent = `${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;
    stuQInfo.textContent = `${examData.subjectNames[progress.currentIndex]} | Q ${progress.currentIndex + 1}/${examData.files.length}`;

    if (progress.timeLeftSec <= 300 && progress.timeLeftSec > 60) {
        timerEl.classList.add("blink");
    } else { timerEl.classList.remove("blink"); }

    if (progress.timeLeftSec <= 60) {
        timerEl.classList.add("blink");
        examHeader.classList.add("blinkLine");
    } else {
        examHeader.classList.remove("blinkLine");
    }
  }, 1000);
}

function renderQuestion() {
  const i = progress.currentIndex;
  const f = examData.files[i];
  const questionContainer = document.getElementById('questionContainer');
  
  questionContainer.style.opacity = '0';
  
  setTimeout(() => {
    if (preloadedImages[f]) {
      questionContainer.innerHTML = '';
      const img = preloadedImages[f].cloneNode();
      img.className = "questionImg question-fade-in";
      img.alt = `Question ${i + 1}`;
      questionContainer.appendChild(img);
      questionContainer.appendChild(document.createElement('br'));
      renderOptions(i, questionContainer);
      questionContainer.style.opacity = '1';
    } else {
      questionContainer.innerHTML = '<div class="loading-message">Loading question...</div>';
      
      const img = new Image();
      img.className = "questionImg";
      img.src = f;
      img.alt = `Question ${i + 1}`;
      
      img.onerror = function() {
        console.error(`Failed to load image: ${f}`);
        questionContainer.innerHTML = `
          <div class="image-error">
            <h3>‚ùå Image Not Found</h3>
            <p>Could not load: ${f}</p>
            <p>Please check that the image file exists in the questions folder.</p>
            <p><strong>Expected file:</strong> ${f}</p>
          </div>
          <br>`;
        
        renderOptions(i, questionContainer);
        questionContainer.style.opacity = '1';
      };
      
      img.onload = function() {
        questionContainer.innerHTML = '';
        questionContainer.appendChild(img);
        questionContainer.appendChild(document.createElement('br'));
        renderOptions(i, questionContainer);
        questionContainer.style.opacity = '1';
        
        preloadedImages[f] = img.cloneNode();
      };
    }
  }, 150);
}

function renderOptions(questionIndex, container) {
  const optsDiv = document.createElement("div");
  optsDiv.className = "options-container";
  optsDiv.style.marginTop = "50px";
  
  ["A", "B", "C", "D"].forEach(opt => {
    let b = document.createElement("button"); 
    b.className = "optBtn"; 
    b.style.margin = "0 40px";
    b.textContent = opt;
    b.tabIndex = 0;
    
    if (progress.answers[questionIndex] === opt) {
        b.classList.add("selected");
    }
    
    b.onclick = () => { 
        if (progress.answers[questionIndex] === opt) {
            progress.answers[questionIndex] = null;
            b.classList.remove("selected");
        } else {
            progress.answers[questionIndex] = opt;
            
            const allOptions = optsDiv.querySelectorAll('.optBtn');
            allOptions.forEach(btn => btn.classList.remove("selected"));
            
            b.classList.add("selected");
        }
        
        renderPalette(); 
    };
    
    optsDiv.appendChild(b);
  });
  
  container.appendChild(optsDiv);
}

document.getElementById('prevBtn').onclick = () => { 
  if (progress.currentIndex > 0) { 
    progress.currentIndex--; 
    renderQuestion(); 
    renderPalette(); 
    updateNavButtons(); 
  } 
};

document.getElementById('nextBtn').onclick = () => { 
  if (progress.currentIndex < examData.files.length - 1) { 
    progress.currentIndex++; 
    renderQuestion(); 
    renderPalette(); 
    updateNavButtons(); 
  } 
};

document.getElementById('markReviewBtn').onclick = () => { 
  progress.review[progress.currentIndex] = !progress.review[progress.currentIndex]; 
  document.getElementById('markReviewBtn').textContent = progress.review[progress.currentIndex] ? "Unreview" : "Review"; 
  renderPalette(); 
};

document.getElementById('submitBtn').onclick = () => showConfirm("Submit Exam?", x => { if (x) submitExam(); });

function updateNavButtons() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const markReviewBtn = document.getElementById('markReviewBtn');
  
  prevBtn.style.display = progress.currentIndex === 0 ? "none" : "inline-block";
  nextBtn.style.display = progress.currentIndex === examData.files.length - 1 ? "none" : "inline-block";
  markReviewBtn.textContent = progress.review[progress.currentIndex] ? "Unreview" : "Review";
}

function preloadQuestionImages() {
    console.log("Preloading question images...");
    examData.files.forEach((file, index) => {
        if (!preloadedImages[file]) {
            const img = new Image();
            img.src = file;
            img.onload = function() {
                preloadedImages[file] = img;
                console.log(`Preloaded image: ${file}`);
            };
            img.onerror = function() {
                console.error(`Failed to preload image: ${file}`);
            };
        }
    });
}

function identifySubject(subjectName) {
    const name = subjectName.toLowerCase().trim();
    
    if (name.includes('math') || name === 'maths') {
        return 'Mathematics';
    } else if (name.includes('phys')) {
        return 'Physics';
    } else if (name.includes('chem')) {
        return 'Chemistry';
    }
    
    return subjectName;
}

function showSummaryInterface(subjData) {
  document.getElementById('examArea').style.display = "none";
  document.getElementById('summaryArea').style.display = "block";
  
  document.getElementById('summaryStudentName').textContent = progress.student.name;
  document.getElementById('summarySection').textContent = progress.student.sec;
  document.getElementById('summaryRoll').textContent = progress.student.roll;
  document.getElementById('summaryAdm').textContent = progress.student.adm;
  document.getElementById('summaryForm').textContent = assignedForm;
  
  renderSummaryTable(subjData);
}

function renderSummaryTable(subjData) {
  const container = document.getElementById('summaryTableContainer');
  
  let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalQs = 0, totalMarks = 0;
  
  for (let s in subjData) {
    totalCorrect += subjData[s].correct;
    totalWrong += subjData[s].wrong;
    totalBlank += subjData[s].blank;
    totalQs += subjData[s].total;
    totalMarks += subjData[s].marks;
  }
  
  let totalPer = totalQs > 0 ? ((totalCorrect / totalQs) * 100).toFixed(2) : 0;
  
  let html = `<table class="results-table" border="1">
    <tr style="background:#E6E6FA;">
      <th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Score</th><th>Percentage</th>
    </tr>`;

  for (let s in subjData) {
    let v = subjData[s];
    let per = ((v.correct / v.total) * 100).toFixed(2);
    html += `<tr>
      <td>${s}</td>
      <td>${v.correct}</td>
      <td>${v.wrong}</td>
      <td>${v.blank}</td>
      <td>${v.marks.toFixed(2)}</td>
      <td>${per}%</td>
    </tr>`;
  }

  html += `<tr style="font-weight:bold;background:#D8BFD8;">
    <td>Total</td>
    <td>${totalCorrect}</td>
    <td>${totalWrong}</td>
    <td>${totalBlank}</td>
    <td>${totalMarks.toFixed(2)}</td>
    <td>${totalPer}%</td>
  </tr></table>`;

  container.innerHTML = html;
}

// ===== SECURITY MEASURES =====
document.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

function setupScreenshotProtection() {
    const protection = document.getElementById('screenshotProtection');
    const block = document.getElementById('screenshotBlock');
    
    protection.innerHTML = '<div class="screenshot-dots"></div>';
    
    const style = document.createElement('style');
    style.textContent = `
        body * {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
        }
        
        ::selection {
            background: transparent !important;
        }
        ::-moz-selection {
            background: transparent !important;
        }
        
        @media print {
            body * {
                visibility: hidden !important;
            }
        }
    `;
    document.head.appendChild(style);
}

// ===== CONFIRMATION MODAL =====
function showConfirm(msg, cb) {
  const confirmText = document.getElementById('confirmText');
  const confirmModal = document.getElementById('confirmModal');
  const confirmYes = document.getElementById('confirmYes');
  const confirmNo = document.getElementById('confirmNo');
  
  confirmText.textContent = msg;
  confirmModal.style.display = "flex";
  
  confirmYes.onclick = () => { confirmModal.style.display = "none"; cb(true); };
  confirmNo.onclick = () => { confirmModal.style.display = "none"; cb(false); };
  
  setTimeout(() => confirmYes.focus(), 100);
}

// ===== UTILITY FUNCTIONS =====
function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div class="error-message">${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== EVENT LISTENERS =====
document.getElementById('verifyAccess').addEventListener('click', verifyAccessCode);

document.getElementById('accessCode').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    verifyAccessCode();
  }
});

document.getElementById('closeSummaryBtn').onclick = () => {
  document.getElementById('summaryArea').style.display = "none";
  document.getElementById('studentEntry').style.display = "flex";
  resetExamState();
};

function resetExamState() {
  progress = null;
  currentSubjData = null;
  hasSubmitted = false;
  
  if (timerInterval) clearInterval(timerInterval);
  
  document.getElementById('stuName').value = '';
  document.getElementById('stuSection').value = '';
  document.getElementById('stuRoll').value = '';
  document.getElementById('stuAdm').value = '';
  document.getElementById('formAssignment').style.display = 'none';
  
  clearErrors();
}

// ===== INITIAL SETUP =====
window.addEventListener('load', function() {
  console.log('LFJC Online Exam System Initialized');
  
  document.getElementById('accessDenied').style.display = 'flex';
  document.getElementById('studentEntry').style.display = 'none';
  document.getElementById('examArea').style.display = 'none';
  document.getElementById('summaryArea').style.display = 'none';
  
  document.getElementById('accessCode').focus();
  
  setupScreenshotProtection();
});

console.log("üéØ LFJC Online Exam System Loaded Successfully");
</script>
</body>
</html>
