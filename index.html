<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LFJC ONLINE EXAMINATION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #9b59b6;
            --success: #27ae60;
            --warning: #e67e22;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --text: #333333;
            --text-light: #7f8c8d;
            --border: #bdc3c7;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            color: var(--text);
        }

        .container {
            max-width: 100%;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 600;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--warning), var(--accent), var(--success));
        }

        /* Student Entry Section */
        .student-entry {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .student-entry h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.6em;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--primary);
            font-size: 1em;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: white;
            box-shadow: inset 0 2px 4px var(--shadow);
        }

        .input-group input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
            outline: none;
            transform: translateY(-2px);
        }

        .input-group input.error {
            border-color: var(--danger);
            background-color: #fff5f5;
        }

        .prompt {
            font-size: 0.85em;
            margin-top: 3px;
            display: none;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .prompt.error {
            color: var(--danger);
            background: #ffe6e6;
            display: block;
            border-left: 2px solid var(--danger);
        }

        .start-btn {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        /* Demo Access Section */
        .demo-access {
            background: linear-gradient(135deg, #e8f4fd, #d1ecf1);
            border: 2px dashed var(--secondary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .demo-access h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .demo-btn {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .demo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        /* Exam Area */
        .exam-area {
            display: none;
            flex-grow: 1;
            background: linear-gradient(135deg, #f8f9ff 0%, #e6f3ff 100%);
            overflow: hidden;
        }

        .exam-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 10px rgba(44, 62, 80, 0.3);
            flex-shrink: 0;
        }

        .timer {
            font-size: 1.2em;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .timer.blink {
            animation: blink 1s infinite;
            background: linear-gradient(135deg, var(--danger), #FF8E53);
        }

        .timer.blink-line {
            animation: blink-line 0.5s infinite;
            background: linear-gradient(135deg, #FF416C, #FF4B2B);
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes blink-line {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Main Exam Content */
        .exam-main-content {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding: 0;
            gap: 0;
        }

        .question-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            margin: 5px;
        }

        .question-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .question-container {
            flex-grow: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .question-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--warning), var(--accent), var(--success));
            border-radius: 12px 12px 0 0;
        }

        .question-img-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-bottom: 0;
            background: #f8f9fa;
            border-radius: 0;
            padding: 5px;
            min-height: 350px;
            overflow: auto;
        }

        .options-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 0;
            padding: 10px;
        }

        .optBtn {
            padding: 12px;
            border: 2px solid var(--border);
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text);
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .optBtn:hover {
            border-color: var(--secondary);
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .optBtn.selected {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            border-color: var(--success);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        /* Palette Section */
        .palette-section {
            width: 250px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            flex-shrink: 0;
            margin: 5px;
        }

        .palette-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .palette-container {
            flex-grow: 1;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            overflow-y: auto;
        }

        .palette-btn {
            width: 35px;
            height: 35px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 13px;
        }

        .palette-btn:hover {
            border-color: var(--secondary);
            background: var(--secondary);
            color: white;
            transform: scale(1.05);
        }

        .palette-btn.selected {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            border-color: var(--success);
            transform: scale(1.05);
        }

        .palette-btn.reviewed {
            background: linear-gradient(135deg, var(--warning), #FFA500);
            color: #333;
            border-color: var(--warning);
        }

        .palette-btn.current {
            border: 2px solid var(--secondary);
            background: var(--secondary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.5);
        }

        /* Navigation */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: white;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .nav-btn {
            padding: 10px 20px;
            border: 2px solid var(--secondary);
            background: white;
            color: var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 13px;
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .mark-review {
            background: linear-gradient(135deg, var(--warning), #FFA500);
            border-color: var(--warning);
            color: white;
        }

        .mark-review:hover {
            background: linear-gradient(135deg, #FFA500, #FF8C00);
            color: white;
        }

        .mark-review.reviewed {
            background: linear-gradient(135deg, var(--danger), #FF8E53);
            border-color: var(--danger);
            color: white;
        }

        /* Submit Button */
        .submit-section {
            text-align: center;
            padding: 10px;
            background: white;
            border-top: 1px solid var(--border);
            flex-shrink: 0;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--danger), #e35d6a);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
            background: linear-gradient(135deg, #c82333, var(--danger));
        }

        /* Summary & Review Areas */
        .summary-area, .review-area {
            display: none;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9ff, #e6f3ff);
            flex-grow: 1;
            overflow-y: auto;
        }

        .summary-area h2, .review-area h2 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 600;
        }

        .student-info-bar {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            box-shadow: 0 3px 10px rgba(44, 62, 80, 0.3);
        }

        .student-info-bar div {
            text-align: center;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            backdrop-filter: blur(10px);
        }

        .results-table, .detailed-results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .results-table th, .detailed-results-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px;
            text-align: left;
            font-size: 1em;
            font-weight: 600;
        }

        .results-table td, .detailed-results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 0.95em;
        }

        .results-table tr:hover, .detailed-results-table tr:hover {
            background: #f8f9ff;
        }

        .total-row {
            background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
            font-weight: bold;
            font-size: 1em;
        }

        .highlight {
            background: #d4edda !important;
            border-left: 3px solid var(--success);
        }

        /* Question Review */
        .question-review-item {
            border: 2px solid #E6E6FA;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background: white;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            position: relative;
        }

        .question-review-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--success), #44A08D);
            border-radius: 10px 10px 0 0;
        }

        .answer-status {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .answer-status.correct {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid var(--success);
        }

        .answer-status.wrong {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid var(--danger);
        }

        .answer-status.not-attempted {
            background: linear-gradient(135deg, #e2e3e5, #d6d8db);
            color: #383d41;
            border: 1px solid var(--text-light);
        }

        .correct-answer {
            color: var(--success);
            font-weight: bold;
            font-size: 1em;
        }

        .wrong-answer {
            color: var(--danger);
            font-weight: bold;
            font-size: 1em;
        }

        /* Modals & Overlays */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            padding: 25px;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            border: 2px solid var(--primary);
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--warning), var(--danger), var(--success));
            border-radius: 12px 12px 0 0;
        }

        .modal h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            min-width: 100px;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, var(--success), #20c997);
            color: white;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        .modal-btn.confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .modal-btn.cancel {
            background: linear-gradient(135deg, var(--text-light), #5a6268);
            color: white;
            box-shadow: 0 3px 10px rgba(127, 140, 141, 0.3);
        }

        .modal-btn.cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(127, 140, 141, 0.4);
        }

        /* Warning Messages */
        .warning-message {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid var(--warning);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            color: #856404;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(230, 126, 34, 0.3);
        }

        /* Network Warning */
        #networkWarning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--warning), #ff6b00);
            color: white;
            text-align: center;
            padding: 12px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
            font-size: 1em;
        }

        /* Screenshot Protection */
        .screenshot-dots {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(255,0,0,0.1) 2px, transparent 2px),
                radial-gradient(circle at 75% 75%, rgba(255,0,0,0.1) 2px, transparent 2px);
            background-size: 100px 100px;
            z-index: 9999;
            opacity: 0.3;
        }

        /* Additional Elements */
        #waitingMessage, #autoTransitionMessage {
            background: linear-gradient(135deg, #e7f3ff, #d1ecf1);
            border: 1px solid var(--secondary);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #0c5460;
        }

        #autoTransitionMessage {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: var(--warning);
            color: #856404;
        }

        /* Countdown Animations */
        #countdown, #waitingTimer, #tabSwitchCountdown {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .exam-main-content {
                flex-direction: column;
            }
            
            .palette-section {
                width: 100%;
                height: 180px;
            }
            
            .palette-container {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        @media (max-width: 900px) {
            .palette-container {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .options-container {
                grid-template-columns: 1fr;
            }
            
            .navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-btn {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .palette-container {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .exam-header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .student-info-bar {
                grid-template-columns: 1fr;
            }
            
            .modal-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>LFJC ONLINE EXAMINATION</h1>
            <p style="opacity: 0.9; font-size: 1em;">Secure ‚Ä¢ Reliable ‚Ä¢ Efficient</p>
        </div>

        <!-- Student Entry Section -->
        <div id="studentEntry" class="student-entry">
            <h2>üéì Student Information</h2>
            
            <div class="input-group">
                <label for="stuName">üìõ Full Name</label>
                <input type="text" id="stuName" placeholder="Enter your full name" maxlength="50">
                <div id="namePrompt" class="prompt error">‚ùå Only letters, spaces and dots allowed (min 2 characters)</div>
            </div>

            <div class="input-group">
                <label for="stuSection">üè´ Section</label>
                <input type="text" id="stuSection" placeholder="Enter your section" maxlength="10">
                <div id="sectionPrompt" class="prompt error">‚ùå Only letters and digits allowed</div>
            </div>

            <div class="input-group">
                <label for="stuRoll">üéØ Roll Number</label>
                <input type="text" id="stuRoll" placeholder="Enter your roll number" maxlength="10">
                <div id="rollPrompt" class="prompt error">‚ùå Only digits allowed</div>
            </div>

            <div class="input-group">
                <label for="stuAdm">üé´ Admission Number</label>
                <input type="text" id="stuAdm" placeholder="Enter your admission number" maxlength="15">
                <div id="admPrompt" class="prompt error">‚ùå Only digits allowed</div>
            </div>

            <!-- Demo Access Section -->
            <div class="demo-access">
                <h3>üöÄ Quick Start</h3>
                <p>Click below to auto-fill demo data and start immediately:</p>
                <button id="demoStudentBtn" class="demo-btn">üéì Demo Student</button>
                <button id="demoAdminBtn" class="demo-btn">üîß Demo Admin</button>
                <button id="demoTeacherBtn" class="demo-btn">üë®‚Äçüè´ Demo Teacher</button>
            </div>

            <button id="stuStartBtn" class="start-btn">üöÄ START EXAM</button>
        </div>

        <!-- Exam Area -->
        <div id="examArea" class="exam-area">
            <div class="exam-header">
                <div id="stuInfo">üë§ Student Information</div>
                <div id="timerEl" class="timer">‚è∞ 60:00</div>
            </div>

            <div id="examWarning" class="warning-message">
                ‚ö†Ô∏è <strong>Important:</strong> Do not refresh, close the tab, or switch applications during the exam. 
                Any attempt may result in automatic submission.
            </div>

            <div class="exam-main-content">
                <!-- Question Section -->
                <div class="question-section">
                    <div class="question-header">
                        <div id="stuQInfo">üìö Subject - Question 1/70</div>
                    </div>
                    <div id="questionContainer" class="question-container">
                        <!-- Questions will be loaded here -->
                    </div>
                </div>

                <!-- Palette Section -->
                <div class="palette-section">
                    <div class="palette-header">
                        üìã Question Palette
                    </div>
                    <div id="paletteContainer" class="palette-container">
                        <!-- Question palette will be generated here -->
                    </div>
                </div>
            </div>

            <div class="navigation">
                <button id="prevBtn" class="nav-btn">‚óÄ Previous</button>
                <button id="markReviewBtn" class="nav-btn mark-review">üìå Mark Review</button>
                <button id="nextBtn" class="nav-btn">Next ‚ñ∂</button>
            </div>

            <div class="submit-section">
                <button id="submitBtn" class="submit-btn">‚úÖ SUBMIT EXAM</button>
            </div>
        </div>

        <!-- Summary Area -->
        <div id="summaryArea" class="summary-area">
            <h2>üìä Exam Summary</h2>
            
            <div class="student-info-bar">
                <div><strong>üë§ Name:</strong> <span id="summaryStudentName">-</span></div>
                <div><strong>üè´ Section:</strong> <span id="summarySection">-</span></div>
                <div><strong>üéØ Roll No:</strong> <span id="summaryRoll">-</span></div>
                <div><strong>üé´ Admission No:</strong> <span id="summaryAdm">-</span></div>
                <div><strong>üìã Assigned Form:</strong> <span id="summaryForm">-</span></div>
            </div>

            <div id="summaryTableContainer">
                <!-- Summary table will be generated here -->
            </div>

            <div id="waitingMessage">
                <h3>‚è≥ Please Wait</h3>
                <p>Your results are being processed. This page will automatically transition in <span id="waitingTimer">05:00</span></p>
            </div>

            <div id="autoTransitionMessage" style="display: none;">
                <h3>üìà Detailed Results</h3>
                <p>Transitioning to detailed results in <span id="countdown">5</span> seconds...</p>
            </div>
        </div>

        <!-- Review Area -->
        <div id="reviewArea" class="review-area">
            <h2>üîç Detailed Results & Solutions</h2>
            
            <div class="student-info-bar">
                <div><strong>üë§ Name:</strong> <span id="reviewStudentName">-</span></div>
                <div><strong>üè´ Section:</strong> <span id="reviewSection">-</span></div>
                <div><strong>üéØ Roll No:</strong> <span id="reviewRoll">-</span></div>
                <div><strong>üé´ Admission No:</strong> <span id="reviewAdm">-</span></div>
                <div><strong>üìã Assigned Form:</strong> <span id="reviewForm">-</span></div>
            </div>

            <div id="detailedResultsContainer">
                <!-- Detailed results table will be generated here -->
            </div>

            <div id="reviewQuestionsContainer">
                <!-- Question review will be generated here -->
            </div>
        </div>
    </div>

    <!-- Modals & Overlays -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>ü§î Confirm Submission</h3>
            <p id="confirmText">Are you sure you want to submit the exam?</p>
            <div class="modal-buttons">
                <button id="confirmYes" class="modal-btn confirm">‚úÖ Yes, Submit</button>
                <button id="confirmNo" class="modal-btn cancel">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <div id="tabSwitchWarning" class="modal">
        <div class="modal-content">
            <h3>üö´ Tab Switch Detected</h3>
            <p>You have switched tabs/windows during the exam.</p>
            <p style="color: var(--danger); font-weight: bold;">The exam will be automatically submitted.</p>
            <p id="tabSwitchCountdown">Submitting in 5 seconds...</p>
        </div>
    </div>

    <!-- Screenshot Protection -->
    <div id="screenshotProtection"></div>

    <!-- Network Warning -->
    <div id="networkWarning"></div>

    <script>
        // ===== CONFIGURATION =====
        const MARK_PER_CORRECT = 4, MARK_PER_WRONG = -1;
        const EXAM_DURATION_MINUTES = 1;
        const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
        const STORAGE_KEY_PREFIX = "lfjc_exam_";
        const MAX_QUESTIONS = 70;
        const COOLDOWN_HOURS = 24;
        const MAX_RETRY_ATTEMPTS = 3;
        const RETRY_DELAY = 2000;

        // ===== GOOGLE FORMS CONFIGURATION =====
        const GOOGLE_FORMS = {
            'A': "https://docs.google.com/forms/d/e/1FAIpQLSe4uuphhY4-p5jdTZqxG_ZZUKAhQZF1ytyNizPXb0n3L85JIw/formResponse",
            'B': "https://docs.google.com/forms/d/e/1FAIpQLSc3JIcnUysvUtH12QWpHG9wAF4vd1NgEYqeyHwNP0UEkPqi5w/formResponse", 
            'C': "https://docs.google.com/forms/d/e/1FAIpQLScqYdTGoD4l0jJvzYw0tdBNRSMPepnGtOOowOXYwDFov43KHg/formResponse",
            'D': "https://docs.google.com/forms/d/e/1FAIpQLSfjAyDlY-5BAF5rPvzQS0AeTI6Vs2Rkri0V6_miA0mRivZAEg/formResponse",
            'E': "https://docs.google.com/forms/d/e/1FAIpQLSfK6Skl6Uxj8VyGnhhqfdPHcJ8mbcgpzIKLpWFElzdeQSKMgA/formResponse",
            'F': "https://docs.google.com/forms/d/e/1FAIpQLSeP-Gx2XnUg_Q17asOOeYzkoGtLykVIcQ2W006YTqTpE7xY6g/formResponse",
            'G': "https://docs.google.com/forms/d/e/1FAIpQLSe1vg_I5XR3ljr-UNFi-MXxUgjdTDyrVbHxqi_dkvtmYGUTEA/formResponse",
            'H': "https://docs.google.com/forms/d/e/1FAIpQLScyv8cps4StN2UXrsXqNdLu5UBR7t0Vwk8WSnynU2tvracs1g/formResponse",
            'I': "https://docs.google.com/forms/d/e/1FAIpQLSeyen2hSdhRwztpWnH6lyuL91ZROqwDMKIaa4gN_e-Xvyvb_g/formResponse",
            'J': "https://docs.google.com/forms/d/e/1FAIpQLSelbDi1n1EKWu7G0I92hTML6vWUO2c55p2dqrEOQ7cWflaSNg/formResponse"
        };

        const TOTAL_STUDENTS = 150;

        // Form field mappings
        const FORM_FIELDS = {
            STUDENT_NAME: "entry.217666919",
            SECTION: "entry.2006392966",
            ROLL_NUMBER: "entry.547275105",
            ADMISSION_NUMBER: "entry.1234063852",
            MATHS_MARKS: "entry.1989859216",
            PHYSICS_MARKS: "entry.1953974928",
            CHEMISTRY_MARKS: "entry.296331194",
            TOTAL_MARKS: "entry.1289040887",
            TIMESTAMP: "entry.2139100252"
        };

        // ===== ENCRYPTED ANSWER KEY =====
        const ENCRYPTED_ANSWER_KEY = "QkNBREJDQUJEQ0FEQkNBREJDQURCQ0FEQkNBREJDQURCQ0FEQkNBREJDQURCQ0FEQkNBREJDQURCQ0FEQkNBREJDQURCQ0FEQkNBRA==";
        function getDecryptedAnswerKey() {
            try {
                const decoded = atob(ENCRYPTED_ANSWER_KEY);
                return decoded.split('');
            } catch (error) {
                console.error('Answer key decryption failed');
                return Array(70).fill('B');
            }
        }

        // ===== GLOBAL VARIABLES =====
        let images = [];
        let answerKey = getDecryptedAnswerKey();
        let hasSubmitted = false;
        let examStartTime = null;
        let waitingTimerInterval = null;
        let autoTransitionTimer = null;
        let examInProgress = false;
        let currentSubjData = null;
        let assignedForm = 'A';
        let tabSwitchDetected = false;
        let tabSwitchTimeout = null;
        let sessionId = null;

        const subjects = ["Maths", "Physics", "Chemistry"];
        let examData = {files: [], subjectNames: [], keys: [], originalOrder: []};
        let progress = null, timerInterval = null;

        // Initialize the submission manager
        const submissionManager = new EnhancedSubmissionManager();

        // ===== DEMO DATA FUNCTIONS =====
        function fillDemoStudent() {
            document.getElementById('stuName').value = "Demo Student";
            document.getElementById('stuSection').value = "A";
            document.getElementById('stuRoll').value = "25";
            document.getElementById('stuAdm').value = "12345";
            validateStudentInputs();
        }

        function fillDemoAdmin() {
            document.getElementById('stuName').value = "Admin User";
            document.getElementById('stuSection').value = "Admin";
            document.getElementById('stuRoll').value = "1";
            document.getElementById('stuAdm').value = "1001";
            validateStudentInputs();
        }

        function fillDemoTeacher() {
            document.getElementById('stuName').value = "Teacher User";
            document.getElementById('stuSection').value = "Staff";
            document.getElementById('stuRoll').value = "0";
            document.getElementById('stuAdm').value = "2001";
            validateStudentInputs();
        }

        // ===== ENHANCED SUBJECT ORGANIZATION =====
        function shuffleQuestionsForStudent(studentData) {
            const shuffledData = {
                files: [],
                keys: [],
                subjectNames: [],
                originalOrder: []
            };
            
            // Categorize questions by subject
            const mathsQuestions = Array.from({length: 30}, (_, i) => i);
            const physicsQuestions = Array.from({length: 20}, (_, i) => i + 30);
            const chemistryQuestions = Array.from({length: 20}, (_, i) => i + 50);
            
            // Shuffle within each subject
            const shuffledMaths = shuffleArray(mathsQuestions);
            const shuffledPhysics = shuffleArray(physicsQuestions);
            const shuffledChemistry = shuffleArray(chemistryQuestions);
            
            // Get subject order pattern for this student
            const subjectOrder = createSubjectPermutation(studentData);
            
            console.log(`üìö Subject order for ${studentData.name}: ${subjectOrder.join(', ')}`);
            
            let currentIndex = 0;
            
            // Combine subjects according to the pattern
            subjectOrder.forEach(subject => {
                let subjectQuestions = [];
                
                switch(subject) {
                    case 'Maths':
                        subjectQuestions = shuffledMaths;
                        break;
                    case 'Physics':
                        subjectQuestions = shuffledPhysics;
                        break;
                    case 'Chemistry':
                        subjectQuestions = shuffledChemistry;
                        break;
                }
                
                // Add all questions from this subject
                subjectQuestions.forEach(qIndex => {
                    shuffledData.files[currentIndex] = images[qIndex];
                    shuffledData.keys[currentIndex] = answerKey[qIndex];
                    shuffledData.subjectNames[currentIndex] = subject;
                    shuffledData.originalOrder[currentIndex] = qIndex;
                    currentIndex++;
                });
            });
            
            console.log(`‚úÖ Final question distribution:`, {
                Maths: shuffledData.subjectNames.filter(s => s === 'Maths').length,
                Physics: shuffledData.subjectNames.filter(s => s === 'Physics').length,
                Chemistry: shuffledData.subjectNames.filter(s => s === 'Chemistry').length
            });
            
            return shuffledData;
        }

        function createSubjectPermutation(studentData) {
            const subjectOrders = [
                ['Maths', 'Physics', 'Chemistry'],
                ['Physics', 'Chemistry', 'Maths'],
                ['Chemistry', 'Maths', 'Physics'],
                ['Maths', 'Chemistry', 'Physics'],
                ['Physics', 'Maths', 'Chemistry'],
                ['Chemistry', 'Physics', 'Maths']
            ];
            
            const hashString = `${studentData.name}${studentData.roll}${studentData.adm}${sessionId}`;
            let hash = 0;
            for (let i = 0; i < hashString.length; i++) {
                hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
                hash = hash & hash;
            }
            
            const patternIndex = Math.abs(hash) % subjectOrders.length;
            return subjectOrders[patternIndex];
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            const seed = parseInt(sessionId) || Date.now();
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(secureRandom(seed + i) * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function secureRandom(seed) {
            const x = Math.sin(seed) * 10000;
            return x - Math.floor(x);
        }

        // ===== ENHANCED SUBMISSION SYSTEM =====
        class EnhancedSubmissionManager {
            constructor() {
                this.submissionLocks = new Map();
                this.completedSubmissions = new Set();
                this.retryQueues = new Map();
                this.initializeFromStorage();
                this.cleanupOldSubmissions();
            }
            
            initializeFromStorage() {
                try {
                    const completed = JSON.parse(localStorage.getItem('completed_submissions') || '[]');
                    completed.forEach(submissionId => {
                        this.completedSubmissions.add(submissionId);
                    });
                } catch (error) {
                    console.error('Error loading completed submissions:', error);
                }
            }
            
            async submitOnce(studentData, subjData) {
                const studentId = this.generateStudentId(studentData);
                const submissionId = `sub_${studentId}_${Date.now()}`;
                
                if (this.isSubmissionLocked(studentId)) {
                    console.log(`‚è≥ Submission locked: ${studentId}`);
                    return true;
                }
                
                if (this.completedSubmissions.has(submissionId) || this.hasStudentSubmitted(studentData)) {
                    console.log(`‚úÖ Already completed: ${studentId}`);
                    return true;
                }
                
                try {
                    this.acquireLock(studentId);
                    
                    if (this.completedSubmissions.has(submissionId) || this.hasStudentSubmitted(studentData)) {
                        console.log(`‚úÖ Completed during lock: ${studentId}`);
                        this.releaseLock(studentId);
                        return true;
                    }
                    
                    console.log(`üì§ Attempting Google Form submission for: ${studentData.name}`);
                    const success = await this.enhancedFormSubmission(studentData, subjData);
                    
                    if (success) {
                        this.markAsCompleted(submissionId, studentData);
                        console.log(`üéâ ENHANCED SUBMISSION SUCCESS: ${studentData.name}`);
                    } else {
                        console.error(`‚ùå Enhanced submission failed: ${studentData.name}`);
                        this.queueForRetry(studentData, subjData);
                    }
                    
                    return success;
                    
                } catch (error) {
                    console.error(`üí• Submission error: ${studentData.name}`, error);
                    this.queueForRetry(studentData, subjData);
                    return false;
                } finally {
                    setTimeout(() => this.releaseLock(studentId), 15000);
                }
            }
            
            async enhancedFormSubmission(studentData, subjData, attempt = 1) {
                const FORM_URL = GOOGLE_FORMS[assignedForm];
                
                for (let currentAttempt = attempt; currentAttempt <= MAX_RETRY_ATTEMPTS; currentAttempt++) {
                    try {
                        console.log(`üì® Attempt ${currentAttempt}/${MAX_RETRY_ATTEMPTS} for: ${studentData.name}`);
                        
                        const formData = this.createFormData(studentData, subjData);
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000);
                        
                        const response = await fetch(FORM_URL, {
                            method: "POST",
                            mode: "no-cors",
                            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                            body: formData,
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        console.log(`‚úÖ Form submission attempt ${currentAttempt} completed`);
                        return true;
                        
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Attempt ${currentAttempt} failed:`, error);
                        
                        if (currentAttempt < MAX_RETRY_ATTEMPTS) {
                            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY * currentAttempt));
                        } else {
                            return false;
                        }
                    }
                }
            }
            
            createFormData(studentData, subjData) {
                const marks = this.calculateMarks(subjData);
                const formData = new URLSearchParams();
                
                formData.append(FORM_FIELDS.STUDENT_NAME, studentData.name);
                formData.append(FORM_FIELDS.SECTION, studentData.sec);
                formData.append(FORM_FIELDS.ROLL_NUMBER, studentData.roll);
                formData.append(FORM_FIELDS.ADMISSION_NUMBER, studentData.adm);
                formData.append(FORM_FIELDS.MATHS_MARKS, marks.mathsMarks.toFixed(2));
                formData.append(FORM_FIELDS.PHYSICS_MARKS, marks.physicsMarks.toFixed(2));
                formData.append(FORM_FIELDS.CHEMISTRY_MARKS, marks.chemistryMarks.toFixed(2));
                formData.append(FORM_FIELDS.TOTAL_MARKS, marks.totalMarks.toFixed(2));
                formData.append(FORM_FIELDS.TIMESTAMP, new Date().toLocaleString());
                
                return formData;
            }
            
            calculateMarks(subjData) {
                let mathsMarks = 0, physicsMarks = 0, chemistryMarks = 0, totalMarks = 0;
                
                for (let subject in subjData) {
                    const subjectLower = subject.toLowerCase().trim();
                    const marks = subjData[subject].marks;
                    
                    if (subjectLower.includes('math')) mathsMarks = marks;
                    else if (subjectLower.includes('phys')) physicsMarks = marks;
                    else if (subjectLower.includes('chem')) chemistryMarks = marks;
                    
                    totalMarks += marks;
                }
                
                return { mathsMarks, physicsMarks, chemistryMarks, totalMarks };
            }
            
            isSubmissionLocked(studentId) {
                const lock = this.submissionLocks.get(studentId);
                return lock && (Date.now() - lock.timestamp) < 15000;
            }
            
            acquireLock(studentId) {
                this.submissionLocks.set(studentId, {
                    timestamp: Date.now(),
                    sessionId: sessionId
                });
                localStorage.setItem(`lock_${studentId}`, Date.now().toString());
            }
            
            releaseLock(studentId) {
                this.submissionLocks.delete(studentId);
                localStorage.removeItem(`lock_${studentId}`);
            }
            
            generateStudentId(studentData) {
                return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`
                    .toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');
            }
            
            markAsCompleted(submissionId, studentData) {
                this.completedSubmissions.add(submissionId);
                
                try {
                    const completedArray = Array.from(this.completedSubmissions);
                    localStorage.setItem('completed_submissions', JSON.stringify(completedArray));
                    
                    const studentId = this.generateStudentId(studentData);
                    const timestamp = Date.now().toString();
                    
                    localStorage.setItem(`submitted_${studentId}`, timestamp);
                    sessionStorage.setItem(`submitted_${studentId}`, timestamp);
                    localStorage.setItem(`final_submission_${studentId}`, timestamp);
                    localStorage.setItem(`last_submission_${studentId}`, timestamp);
                    
                    console.log(`‚úÖ PERMANENTLY MARKED AS SUBMITTED: ${studentData.name}`);
                    
                } catch (error) {
                    console.error('Error saving completion status:', error);
                }
            }
            
            hasStudentSubmitted(studentData) {
                const studentId = this.generateStudentId(studentData);
                return localStorage.getItem(`submitted_${studentId}`) !== null ||
                       sessionStorage.getItem(`submitted_${studentId}`) !== null ||
                       localStorage.getItem(`final_submission_${studentId}`) !== null;
            }
            
            queueForRetry(studentData, subjData) {
                const studentId = this.generateStudentId(studentData);
                const queue = this.retryQueues.get(studentId) || [];
                queue.push({ studentData, subjData, attempts: 0 });
                this.retryQueues.set(studentId, queue);
                this.processRetryQueue(studentId);
            }
            
            async processRetryQueue(studentId) {
                const queue = this.retryQueues.get(studentId);
                if (!queue || queue.length === 0) return;
                
                const item = queue[0];
                item.attempts++;
                
                if (item.attempts <= MAX_RETRY_ATTEMPTS) {
                    console.log(`üîÑ Retry attempt ${item.attempts} for ${item.studentData.name}`);
                    const success = await this.enhancedFormSubmission(item.studentData, item.subjData, item.attempts);
                    if (success) {
                        this.markAsCompleted(`sub_${studentId}_${Date.now()}`, item.studentData);
                        queue.shift();
                    }
                } else {
                    console.error(`üí• Max retries exceeded for ${item.studentData.name}`);
                    queue.shift();
                }
                
                if (queue.length > 0) {
                    setTimeout(() => this.processRetryQueue(studentId), RETRY_DELAY);
                } else {
                    this.retryQueues.delete(studentId);
                }
            }
            
            cleanupOldSubmissions() {
                const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
                const currentSubmissions = Array.from(this.completedSubmissions);
                const recentSubmissions = currentSubmissions.filter(subId => {
                    const timestamp = parseInt(subId.split('_').pop());
                    return timestamp > twentyFourHoursAgo;
                });
                
                this.completedSubmissions = new Set(recentSubmissions);
                
                try {
                    localStorage.setItem('completed_submissions', JSON.stringify(recentSubmissions));
                    
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && (key.startsWith('submitted_') || key.startsWith('last_submission_') || key.startsWith('final_submission_'))) {
                            const value = localStorage.getItem(key);
                            if (value && parseInt(value) < twentyFourHoursAgo) {
                                localStorage.removeItem(key);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Cleanup error:', error);
                }
            }
        }

        // ===== INPUT VALIDATION =====
        function validateNameInput(input) {
            const value = input.value.toUpperCase();
            input.value = value;
            
            const namePrompt = document.getElementById('namePrompt');
            const isValid = /^[A-Z\s\.]{2,50}$/.test(value);
            
            if (!isValid && value !== '') {
                input.classList.add('error');
                namePrompt.textContent = '‚ùå Only letters, spaces and dots allowed (min 2 characters)';
                namePrompt.style.display = 'block';
            } else {
                input.classList.remove('error');
                namePrompt.style.display = 'none';
            }
            
            return isValid;
        }

        function validateSectionInput(input) {
            const value = input.value.toUpperCase();
            input.value = value;
            
            const sectionPrompt = document.getElementById('sectionPrompt');
            const isValid = /^[A-Z0-9]{1,10}$/.test(value);
            
            if (!isValid && value !== '') {
                input.classList.add('error');
                sectionPrompt.textContent = '‚ùå Only letters and digits allowed';
                sectionPrompt.style.display = 'block';
            } else {
                input.classList.remove('error');
                sectionPrompt.style.display = 'none';
            }
            
            return isValid;
        }

        function validateRollInput(input) {
            const value = input.value;
            const rollPrompt = document.getElementById('rollPrompt');
            const isValid = /^\d{1,10}$/.test(value);
            
            if (!isValid && value !== '') {
                input.classList.add('error');
                rollPrompt.textContent = '‚ùå Only digits allowed';
                rollPrompt.style.display = 'block';
            } else {
                input.classList.remove('error');
                rollPrompt.style.display = 'none';
            }
            
            return isValid;
        }

        function validateAdmInput(input) {
            const value = input.value;
            const admPrompt = document.getElementById('admPrompt');
            const isValid = /^\d{1,15}$/.test(value);
            
            if (!isValid && value !== '') {
                input.classList.add('error');
                admPrompt.textContent = '‚ùå Only digits allowed';
                admPrompt.style.display = 'block';
            } else {
                input.classList.remove('error');
                admPrompt.style.display = 'none';
            }
            
            return isValid;
        }

        function validateStudentInputs() {
            const name = document.getElementById('stuName').value.trim();
            const section = document.getElementById('stuSection').value.trim();
            const roll = document.getElementById('stuRoll').value.trim();
            const adm = document.getElementById('stuAdm').value.trim();
            
            const nameValid = validateNameInput(document.getElementById('stuName'));
            const sectionValid = validateSectionInput(document.getElementById('stuSection'));
            const rollValid = validateRollInput(document.getElementById('stuRoll'));
            const admValid = validateAdmInput(document.getElementById('stuAdm'));
            
            const allValid = nameValid && sectionValid && rollValid && admValid && 
                            name.length >= 2 && section.length >= 1 && roll.length >= 1 && adm.length >= 1;
            
            document.getElementById('stuStartBtn').style.display = allValid ? 'block' : 'none';
            
            return allValid;
        }

        // ===== FORM ASSIGNMENT =====
        function getAssignedForm(studentData) {
            const forms = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            const formsCount = forms.length;
            
            if (studentData.roll && !isNaN(studentData.roll)) {
                const rollNumber = parseInt(studentData.roll);
                const studentsPerForm = Math.ceil(TOTAL_STUDENTS / formsCount);
                const formIndex = Math.floor((rollNumber - 1) / studentsPerForm) % formsCount;
                return forms[formIndex];
            }
            
            const hashString = `${studentData.name}|${studentData.roll}|${studentData.adm}|${sessionId}`;
            let hash = 0;
            for (let i = 0; i < hashString.length; i++) {
                hash = ((hash << 5) - hash) + hashString.charCodeAt(i);
                hash = hash & hash;
            }
            return forms[Math.abs(hash) % formsCount];
        }

        // ===== SECURITY SYSTEMS =====
        function check24HourCooldown(studentData) {
            const studentId = generateStudentId(studentData);
            const lastSubmission = localStorage.getItem(`last_submission_${studentId}`);
            
            if (lastSubmission) {
                const lastSubmissionTime = parseInt(lastSubmission);
                const currentTime = Date.now();
                const hoursSinceLastSubmission = (currentTime - lastSubmissionTime) / (1000 * 60 * 60);
                
                if (hoursSinceLastSubmission < COOLDOWN_HOURS) {
                    return false;
                }
            }
            
            return true;
        }

        function generateStudentId(studentData) {
            return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`
                .toLowerCase()
                .replace(/\s+/g, '_')
                .replace(/[^a-z0-9_]/g, '');
        }

        function setupTabSwitchDetection() {
            let blurTime = 0;
            
            document.addEventListener('visibilitychange', function() {
                if (document.hidden && examInProgress && !hasSubmitted) {
                    blurTime = Date.now();
                    handleTabSwitch();
                } else if (!document.hidden && blurTime > 0) {
                    const blurDuration = Date.now() - blurTime;
                    if (blurDuration > 3000) {
                        handleTabSwitch();
                    }
                    blurTime = 0;
                }
            });
        }

        function handleTabSwitch() {
            if (tabSwitchDetected || hasSubmitted) return;
            
            tabSwitchDetected = true;
            console.log('üö´ Tab switch/developer tools detected - auto-submitting exam');
            
            const warningDiv = document.getElementById('tabSwitchWarning');
            warningDiv.style.display = 'flex';
            
            let countdown = 5;
            const countdownEl = document.getElementById('tabSwitchCountdown');
            countdownEl.textContent = `Submitting in ${countdown} seconds...`;
            
            tabSwitchTimeout = setInterval(() => {
                countdown--;
                countdownEl.textContent = `Submitting in ${countdown} seconds...`;
                
                if (countdown <= 0) {
                    clearInterval(tabSwitchTimeout);
                    warningDiv.style.display = 'none';
                    calculateAndShowResults();
                }
            }, 1000);
        }

        function setupScreenshotProtection() {
            const protection = document.getElementById('screenshotProtection');
            protection.innerHTML = '<div class="screenshot-dots"></div>';
            
            document.addEventListener('contextmenu', function(e) {
                if (examInProgress && !hasSubmitted) {
                    e.preventDefault();
                    return false;
                }
            });
            
            document.addEventListener('selectstart', function(e) {
                if (examInProgress && !hasSubmitted) {
                    e.preventDefault();
                    return false;
                }
            });
        }

        // ===== TIMER FUNCTIONS =====
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            const startTime = Date.now();
            
            timerInterval = setInterval(() => {
                if (!progress) return;
                
                const currentTime = Date.now();
                const elapsed = Math.floor((currentTime - startTime) / 1000);
                progress.timeLeftSec = Math.max(0, (EXAM_DURATION_MS / 1000) - elapsed);
                
                const minutes = Math.floor(progress.timeLeftSec / 60);
                const seconds = Math.floor(progress.timeLeftSec % 60);
                const timerEl = document.getElementById('timerEl');
                timerEl.textContent = `‚è∞ ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (progress.timeLeftSec <= 300 && progress.timeLeftSec > 60) {
                    timerEl.classList.add('blink');
                }
                
                if (progress.timeLeftSec <= 60) {
                    timerEl.classList.remove('blink');
                    timerEl.classList.add('blink-line');
                }
                
                if (progress.timeLeftSec <= 0) {
                    clearInterval(timerInterval);
                    calculateAndShowResults();
                }
            }, 1000);
        }

        // ===== QUESTION DISPLAY FUNCTIONS =====
        function getCurrentSubject(qIndex) {
            return examData.subjectNames[qIndex] || "Unknown";
        }

        function showQuestion(qIndex) {
            if (!progress || qIndex < 0 || qIndex >= examData.files.length) return;
            
            progress.currentQ = qIndex;
            
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';
            
            const qInfo = document.getElementById('stuQInfo');
            const currentSubject = getCurrentSubject(qIndex);
            qInfo.textContent = `üìö ${currentSubject} - Question ${qIndex + 1}/${examData.files.length}`;
            
            const imgContainer = document.createElement('div');
            imgContainer.className = 'question-img-container';
            
            // Demo content since we don't have actual images
            imgContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; width: 100%;">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 10px;">
                        <h3 style="font-size: 1.5em; margin-bottom: 15px;">Question ${qIndex + 1}</h3>
                        <p style="font-size: 1.1em; opacity: 0.9;">This is a demo question for ${currentSubject}</p>
                        <p style="margin-top: 15px; font-size: 0.9em; opacity: 0.7;">In actual implementation, question images will be loaded here</p>
                    </div>
                </div>
            `;
            
            container.appendChild(imgContainer);
            
            // Create options
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'options-container';
            
            const options = ['A', 'B', 'C', 'D'];
            options.forEach(option => {
                const optBtn = document.createElement('button');
                optBtn.className = 'optBtn';
                if (progress.answers[qIndex] === option) {
                    optBtn.classList.add('selected');
                }
                optBtn.textContent = `Option ${option}`;
                optBtn.onclick = () => selectOption(option);
                optionsContainer.appendChild(optBtn);
            });
            
            container.appendChild(optionsContainer);
            updatePalette();
            updateNavigationButtons();
        }

        function selectOption(option) {
            if (!progress || hasSubmitted) return;
            
            const currentQ = progress.currentQ;
            progress.answers[currentQ] = option;
            
            // Update UI
            const optBtns = document.querySelectorAll('.optBtn');
            optBtns.forEach(btn => {
                btn.classList.remove('selected');
                if (btn.textContent.includes(option)) {
                    btn.classList.add('selected');
                }
            });
            
            updatePalette();
        }

        function updatePalette() {
            const paletteContainer = document.getElementById('paletteContainer');
            paletteContainer.innerHTML = '';
            
            for (let i = 0; i < examData.files.length; i++) {
                const paletteBtn = document.createElement('div');
                paletteBtn.className = 'palette-btn';
                paletteBtn.textContent = i + 1;
                
                if (progress.answers[i]) {
                    paletteBtn.classList.add('selected');
                }
                
                if (progress.reviewFlags[i]) {
                    paletteBtn.classList.add('reviewed');
                }
                
                if (i === progress.currentQ) {
                    paletteBtn.classList.add('current');
                }
                
                paletteBtn.onclick = () => showQuestion(i);
                paletteContainer.appendChild(paletteBtn);
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const markReviewBtn = document.getElementById('markReviewBtn');
            
            prevBtn.disabled = progress.currentQ === 0;
            nextBtn.disabled = progress.currentQ === examData.files.length - 1;
            
            if (progress.reviewFlags[progress.currentQ]) {
                markReviewBtn.classList.add('reviewed');
                markReviewBtn.textContent = '‚ùå Remove Review';
            } else {
                markReviewBtn.classList.remove('reviewed');
                markReviewBtn.textContent = 'üìå Mark Review';
            }
        }

        function navigateToNext() {
            if (progress.currentQ < examData.files.length - 1) {
                showQuestion(progress.currentQ + 1);
            }
        }

        function navigateToPrev() {
            if (progress.currentQ > 0) {
                showQuestion(progress.currentQ - 1);
            }
        }

        function toggleMarkReview() {
            if (!progress) return;
            
            const currentQ = progress.currentQ;
            progress.reviewFlags[currentQ] = !progress.reviewFlags[currentQ];
            
            updateNavigationButtons();
            updatePalette();
        }

        // ===== EXAM INITIALIZATION =====
        function initializeExam(studentData) {
            // Check for duplicate submission
            if (!check24HourCooldown(studentData)) {
                alert('‚ö†Ô∏è You have already submitted an exam in the last 24 hours. Please try again later.');
                return;
            }
            
            // Generate session ID
            sessionId = Date.now().toString();
            
            // Assign form
            assignedForm = getAssignedForm(studentData);
            console.log(`üìã Assigned Form: ${assignedForm}`);
            
            // Initialize images array with demo data
            images = Array.from({length: MAX_QUESTIONS}, (_, i) => `question_${i + 1}.png`);
            
            // Shuffle questions for this student
            examData = shuffleQuestionsForStudent(studentData);
            
            // Initialize progress
            progress = {
                currentQ: 0,
                answers: Array(MAX_QUESTIONS).fill(null),
                reviewFlags: Array(MAX_QUESTIONS).fill(false),
                timeLeftSec: EXAM_DURATION_MS / 1000,
                startTime: Date.now()
            };
            
            // Update student info display
            document.getElementById('stuInfo').textContent = 
                `üë§ ${studentData.name} | üè´ ${studentData.sec} | üéØ ${studentData.roll}`;
            
            // Show exam area
            document.getElementById('studentEntry').style.display = 'none';
            document.getElementById('examArea').style.display = 'flex';
            
            // Start security systems
            examInProgress = true;
            setupTabSwitchDetection();
            setupScreenshotProtection();
            
            // Start timer and show first question
            startTimer();
            showQuestion(0);
        }

        // ===== RESULTS CALCULATION =====
        function calculateAndShowResults() {
            if (hasSubmitted) return;
            hasSubmitted = true;
            examInProgress = false;
            
            clearInterval(timerInterval);
            if (tabSwitchTimeout) clearInterval(tabSwitchTimeout);
            
            // Calculate results
            const studentData = {
                name: document.getElementById('stuName').value,
                sec: document.getElementById('stuSection').value,
                roll: document.getElementById('stuRoll').value,
                adm: document.getElementById('stuAdm').value
            };
            
            const results = calculateResults();
            currentSubjData = results.subjectData;
            
            // Show summary area
            document.getElementById('examArea').style.display = 'none';
            document.getElementById('summaryArea').style.display = 'block';
            
            // Update student info in summary
            document.getElementById('summaryStudentName').textContent = studentData.name;
            document.getElementById('summarySection').textContent = studentData.sec;
            document.getElementById('summaryRoll').textContent = studentData.roll;
            document.getElementById('summaryAdm').textContent = studentData.adm;
            document.getElementById('summaryForm').textContent = assignedForm;
            
            // Generate summary table
            generateSummaryTable(results);
            
            // Start waiting timer
            startWaitingTimer();
            
            // Submit to Google Forms
            submissionManager.submitOnce(studentData, currentSubjData);
        }

        function calculateResults() {
            const subjectData = {};
            let totalCorrect = 0;
            let totalWrong = 0;
            let totalMarks = 0;
            
            // Initialize subject data
            subjects.forEach(subject => {
                subjectData[subject] = {
                    correct: 0,
                    wrong: 0,
                    notAttempted: 0,
                    marks: 0
                };
            });
            
            // Calculate results for each question
            for (let i = 0; i < examData.files.length; i++) {
                const subject = examData.subjectNames[i];
                const studentAnswer = progress.answers[i];
                const correctAnswer = examData.keys[i];
                
                if (!studentAnswer) {
                    subjectData[subject].notAttempted++;
                } else if (studentAnswer === correctAnswer) {
                    subjectData[subject].correct++;
                    totalCorrect++;
                    subjectData[subject].marks += MARK_PER_CORRECT;
                    totalMarks += MARK_PER_CORRECT;
                } else {
                    subjectData[subject].wrong++;
                    totalWrong++;
                    subjectData[subject].marks += MARK_PER_WRONG;
                    totalMarks += MARK_PER_WRONG;
                }
            }
            
            return {
                subjectData,
                totalCorrect,
                totalWrong,
                totalMarks,
                totalQuestions: examData.files.length
            };
        }

        function generateSummaryTable(results) {
            const container = document.getElementById('summaryTableContainer');
            container.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'results-table';
            
            // Table header
            const header = table.createTHead();
            const headerRow = header.insertRow();
            const headers = ['Subject', 'Correct', 'Wrong', 'Not Attempted', 'Marks'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            // Table body
            const tbody = table.createTBody();
            
            // Add subject rows
            subjects.forEach(subject => {
                const row = tbody.insertRow();
                const data = results.subjectData[subject];
                
                row.insertCell().textContent = subject;
                row.insertCell().textContent = data.correct;
                row.insertCell().textContent = data.wrong;
                row.insertCell().textContent = data.notAttempted;
                row.insertCell().textContent = data.marks.toFixed(2);
            });
            
            // Add total row
            const totalRow = tbody.insertRow();
            totalRow.className = 'total-row';
            
            totalRow.insertCell().textContent = 'TOTAL';
            totalRow.insertCell().textContent = results.totalCorrect;
            totalRow.insertCell().textContent = results.totalWrong;
            totalRow.insertCell().textContent = results.totalQuestions - results.totalCorrect - results.totalWrong;
            totalRow.insertCell().textContent = results.totalMarks.toFixed(2);
            
            container.appendChild(table);
        }

        function startWaitingTimer() {
            let waitingTime = 5 * 60; // 5 minutes in seconds
            
            waitingTimerInterval = setInterval(() => {
                waitingTime--;
                
                const minutes = Math.floor(waitingTime / 60);
                const seconds = waitingTime % 60;
                
                document.getElementById('waitingTimer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (waitingTime <= 0) {
                    clearInterval(waitingTimerInterval);
                    transitionToDetailedResults();
                }
            }, 1000);
        }

        function transitionToDetailedResults() {
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('autoTransitionMessage').style.display = 'block';
            
            let countdown = 5;
            document.getElementById('countdown').textContent = countdown;
            
            autoTransitionTimer = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(autoTransitionTimer);
                    showDetailedResults();
                }
            }, 1000);
        }

        function showDetailedResults() {
            document.getElementById('summaryArea').style.display = 'none';
            document.getElementById('reviewArea').style.display = 'block';
            
            // Update student info in review
            document.getElementById('reviewStudentName').textContent = document.getElementById('stuName').value;
            document.getElementById('reviewSection').textContent = document.getElementById('stuSection').value;
            document.getElementById('reviewRoll').textContent = document.getElementById('stuRoll').value;
            document.getElementById('reviewAdm').textContent = document.getElementById('stuAdm').value;
            document.getElementById('reviewForm').textContent = assignedForm;
            
            // Generate detailed results
            generateDetailedResultsTable();
            generateQuestionReview();
        }

        function generateDetailedResultsTable() {
            const container = document.getElementById('detailedResultsContainer');
            container.innerHTML = '';
            
            const results = calculateResults();
            
            const table = document.createElement('table');
            table.className = 'detailed-results-table';
            
            // Table header
            const header = table.createTHead();
            const headerRow = header.insertRow();
            const headers = ['Subject', 'Questions', 'Correct', 'Wrong', 'Not Attempted', 'Marks', 'Percentage'];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            // Table body
            const tbody = table.createTBody();
            
            // Add subject rows
            subjects.forEach(subject => {
                const row = tbody.insertRow();
                const data = results.subjectData[subject];
                const totalQuestions = data.correct + data.wrong + data.notAttempted;
                const percentage = totalQuestions > 0 ? (data.marks / (totalQuestions * MARK_PER_CORRECT)) * 100 : 0;
                
                row.insertCell().textContent = subject;
                row.insertCell().textContent = totalQuestions;
                row.insertCell().textContent = data.correct;
                row.insertCell().textContent = data.wrong;
                row.insertCell().textContent = data.notAttempted;
                row.insertCell().textContent = data.marks.toFixed(2);
                row.insertCell().textContent = percentage.toFixed(2) + '%';
            });
            
            // Add total row
            const totalRow = tbody.insertRow();
            totalRow.className = 'total-row highlight';
            
            const totalQuestions = results.totalQuestions;
            const totalPercentage = (results.totalMarks / (totalQuestions * MARK_PER_CORRECT)) * 100;
            
            totalRow.insertCell().textContent = 'TOTAL';
            totalRow.insertCell().textContent = totalQuestions;
            totalRow.insertCell().textContent = results.totalCorrect;
            totalRow.insertCell().textContent = results.totalWrong;
            totalRow.insertCell().textContent = totalQuestions - results.totalCorrect - results.totalWrong;
            totalRow.insertCell().textContent = results.totalMarks.toFixed(2);
            totalRow.insertCell().textContent = totalPercentage.toFixed(2) + '%';
            
            container.appendChild(table);
        }

        function generateQuestionReview() {
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '<h3 style="margin: 20px 0; color: var(--primary);">Question-wise Analysis</h3>';
            
            for (let i = 0; i < examData.files.length; i++) {
                const questionItem = document.createElement('div');
                questionItem.className = 'question-review-item';
                
                const subject = examData.subjectNames[i];
                const studentAnswer = progress.answers[i];
                const correctAnswer = examData.keys[i];
                const originalIndex = examData.originalOrder[i] + 1;
                
                let status = '';
                let statusClass = '';
                let answerText = '';
                
                if (!studentAnswer) {
                    status = 'Not Attempted';
                    statusClass = 'not-attempted';
                    answerText = `Correct Answer: <span class="correct-answer">${correctAnswer}</span>`;
                } else if (studentAnswer === correctAnswer) {
                    status = 'Correct';
                    statusClass = 'correct';
                    answerText = `Your Answer: <span class="correct-answer">${studentAnswer}</span>`;
                } else {
                    status = 'Wrong';
                    statusClass = 'wrong';
                    answerText = `Your Answer: <span class="wrong-answer">${studentAnswer}</span> | Correct Answer: <span class="correct-answer">${correctAnswer}</span>`;
                }
                
                questionItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: var(--primary);">Question ${i + 1} (Original: Q${originalIndex}) - ${subject}</h4>
                        <div class="answer-status ${statusClass}">${status}</div>
                    </div>
                    <div style="margin: 10px 0;">
                        ${answerText}
                    </div>
                    <div style="font-size: 0.9em; color: var(--text-light); margin-top: 10px;">
                        ${studentAnswer === correctAnswer ? 
                          '‚úÖ Well done! You answered this question correctly.' : 
                          !studentAnswer ? 
                          '‚è≠Ô∏è You did not attempt this question.' : 
                          '‚ùå Your answer was incorrect. Review this concept.'}
                    </div>
                `;
                
                container.appendChild(questionItem);
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Input validation
            document.getElementById('stuName').addEventListener('input', function() {
                validateNameInput(this);
                validateStudentInputs();
            });
            
            document.getElementById('stuSection').addEventListener('input', function() {
                validateSectionInput(this);
                validateStudentInputs();
            });
            
            document.getElementById('stuRoll').addEventListener('input', function() {
                validateRollInput(this);
                validateStudentInputs();
            });
            
            document.getElementById('stuAdm').addEventListener('input', function() {
                validateAdmInput(this);
                validateStudentInputs();
            });
            
            // Demo buttons
            document.getElementById('demoStudentBtn').addEventListener('click', fillDemoStudent);
            document.getElementById('demoAdminBtn').addEventListener('click', fillDemoAdmin);
            document.getElementById('demoTeacherBtn').addEventListener('click', fillDemoTeacher);
            
            // Start exam button
            document.getElementById('stuStartBtn').addEventListener('click', function() {
                const studentData = {
                    name: document.getElementById('stuName').value,
                    sec: document.getElementById('stuSection').value,
                    roll: document.getElementById('stuRoll').value,
                    adm: document.getElementById('stuAdm').value
                };
                
                // Check for existing submission
                if (submissionManager.hasStudentSubmitted(studentData)) {
                    if (confirm('You have already submitted an exam. Do you want to start a new attempt?')) {
                        initializeExam(studentData);
                    }
                } else {
                    initializeExam(studentData);
                }
            });
            
            // Navigation buttons
            document.getElementById('prevBtn').addEventListener('click', navigateToPrev);
            document.getElementById('nextBtn').addEventListener('click', navigateToNext);
            document.getElementById('markReviewBtn').addEventListener('click', toggleMarkReview);
            
            // Submit button
            document.getElementById('submitBtn').addEventListener('click', function() {
                document.getElementById('confirmModal').style.display = 'flex';
                document.getElementById('confirmText').textContent = 
                    'Are you sure you want to submit the exam? This action cannot be undone.';
            });
            
            // Confirm submission
            document.getElementById('confirmYes').addEventListener('click', function() {
                document.getElementById('confirmModal').style.display = 'none';
                calculateAndShowResults();
            });
            
            // Cancel submission
            document.getElementById('confirmNo').addEventListener('click', function() {
                document.getElementById('confirmModal').style.display = 'none';
            });
            
            // Initialize
            validateStudentInputs();
        });

        // ===== NETWORK DETECTION =====
        window.addEventListener('online', function() {
            document.getElementById('networkWarning').style.display = 'none';
        });

        window.addEventListener('offline', function() {
            if (examInProgress && !hasSubmitted) {
                document.getElementById('networkWarning').textContent = 
                    '‚ö†Ô∏è Network connection lost. Your answers are being saved locally.';
                document.getElementById('networkWarning').style.display = 'block';
            }
        });
    </script>
</body>
</html>
