<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LFJC Online Exam System</title>
<style>
/* ===== BASE STYLES ===== */
:root {
  --primary-color: #4B0082;
  --secondary-color: #D8BFD8;
  --light-purple: #E6E6FA;
  --white: #fff;
  --black: #000;
  --success: #32CD32;
  --warning: #ff9900;
  --danger: #ff6666;
  --shadow: 0 5px 15px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
}

body {
  font-family: "SF Pro Display", Arial, sans-serif;
  margin: 0;
  background: var(--white);
  color: var(--black);
  line-height: 1.6;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Disable right-click context menu */
body {
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* Enhanced Screenshot protection */
#screenshotProtection {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483647;
  pointer-events: none;
}

.screenshot-dots {
  position: absolute;
  width: 100%;
  height: 100%;
  background: 
    radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 30% 40%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 50% 60%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 70% 80%, rgba(255,255,255,0.02) 1px, transparent 1px),
    radial-gradient(circle at 90% 10%, rgba(255,255,255,0.02) 1px, transparent 1px);
  background-size: 200px 200px;
  animation: flicker 0.5s infinite;
}

@keyframes flicker {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.9; }
}

/* Additional screenshot protection */
#screenshotBlock {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  z-index: 2147483646;
  pointer-events: none;
}

/* ===== HEADER & FOOTER ===== */
header {
  background: linear-gradient(145deg, var(--light-purple), var(--secondary-color));
  color: var(--primary-color);
  text-align: center;
  padding: 20px;
  font-size: 36px;
  font-weight: 700;
  letter-spacing: 1.5px;
  box-shadow: var(--shadow);
  text-shadow: 0 1px 2px var(--white);
}

footer {
  background: var(--light-purple);
  color: var(--primary-color);
  padding: 10px;
  text-align: center;
  font-weight: bold;
  position: fixed;
  width: 100%;
  bottom: 0;
}

/* ===== STUDENT ENTRY SECTION ===== */
#studentEntry {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-height: calc(100vh - 140px);
  padding: 16px;
  text-align: center;
}

.form-group {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  margin-bottom: 60px;
  width: 100%;
  max-width: 500px;
}

.form-group label {
  font-size: 1.15rem;
  font-weight: 600;
  margin-right: 10px;
  color: var(--primary-color);
  width: 180px;
  text-align: right;
}

input[type="text"] {
  padding: 12px 14px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: 1.5px solid var(--primary-color);
  outline: none;
  min-width: 250px;
  transition: var(--transition);
  text-transform: uppercase;
}

input[type="text"]:focus {
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(75, 0, 130, 0.2);
}

input.error {
  animation: glowRed 0.5s alternate infinite;
  border-color: var(--danger);
  background-color: #ffe6e6;
}

@keyframes glowRed {
  0% { box-shadow: 0 0 5px var(--danger); }
  100% { box-shadow: 0 0 15px var(--danger); }
}

/* ===== BUTTON STYLES ===== */
button {
  position: relative;
  overflow: hidden;
  cursor: pointer;
  border: none;
  border-radius: 12px;
  transition: var(--transition);
  box-shadow: 0 6px #aaa;
  background: linear-gradient(to bottom, #fafaff, #dcd6f7);
  color: var(--primary-color);
  font-weight: 600;
  padding: 12px 24px;
  font-size: 18px;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 15px rgba(0,0,0,.28);
}

button:active {
  transform: translateY(3px) scale(.98);
}

button:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

.optBtn {
  font-size: 16px;
  padding: 8px 18px;
  margin: 6px;
  border: 2px solid var(--primary-color);
  background: var(--white);
  border-radius: 8px;
  box-shadow: 0 5px #aaa;
}

.optBtn.selected {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

.optBtn.correct {
  background: #32CD32;
  color: white;
  border-color: #228B22;
}

.optBtn.wrong {
  background: #FF6B6B;
  color: white;
  border-color: #DC143C;
}

.optBtn.not-attempted {
  background: #B0B0B0;
  color: white;
  border-color: #808080;
}

.navBtn {
  font-size: 16px;
  padding: 10px 20px;
  border-radius: 8px;
  color: var(--white);
  font-weight: bold;
  cursor: pointer;
  background: linear-gradient(145deg, #1E90FF, #4682B4);
  margin: 0 15px;
}

#markReviewBtn {
  background: linear-gradient(145deg, #ffb84d, var(--warning));
}

#submitBtn {
  background: linear-gradient(145deg, #c8b88a, #b49e60);
}

/* ===== TIMER STYLES ===== */
#timerEl {
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
  padding: 6px 12px;
  border-radius: 6px;
  background: #f0f0ff;
  display: inline-block;
  transition: var(--transition);
}

#timerEl.blink {
  animation: blinkTimer 1s infinite;
}

@keyframes blinkTimer {
  0% { background: var(--danger); color: var(--white); }
  50% { background: var(--white); color: var(--primary-color); }
  100% { background: var(--danger); color: var(--white); }
}

/* ===== PALETTE STYLES ===== */
#paletteContainer {
  display: grid;
  gap: 8px;
  margin: 20px auto;
  max-width: 100%;
  padding: 0 10px;
  justify-content: center;
}

#paletteContainer button {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 14px;
  margin: 2px;
  border: 1px solid var(--primary-color);
  background: var(--light-purple);
  color: var(--primary-color);
  display: flex;
  align-items: center;
  justify-content: center;
}

#paletteContainer button.answered {
  background: var(--success);
  color: var(--white);
  border-color: #2fa92f;
}

#paletteContainer button.marked-review {
  background: yellow;
  color: var(--black);
  border-color: #ff9900;
}

#paletteContainer button.current {
  border: 3px solid red;
}

/* ===== EXAM AREA STYLES ===== */
#examArea {
  padding: 16px;
  text-align: center;
  display: none;
}

#examHeader {
  display: flex;
  align-items: center;
  width: 100%;
  font-weight: bold;
  margin-bottom: 20px;
}

#stuInfo {
  flex: 0 0 auto;
  text-align: left;
  white-space: nowrap;
}

#stuQInfo {
  flex: 1;
  text-align: center;
  white-space: nowrap;
  font-size: 20px;
  font-weight: bold;
  color: var(--primary-color);
}

.sectionTitle {
  font-size: 22px;
  color: var(--primary-color);
  font-weight: bold;
  margin-bottom: 8px;
}

img.questionImg {
  max-width: 95vw;
  width: auto;
  height: auto;
  border-radius: 10px;
  -webkit-user-drag: none;
  -khtml-user-drag: none;
  -moz-user-drag: none;
  -o-user-drag: none;
  user-drag: none;
  display: block;
  margin-left: auto;
  margin-right: auto;
  transition: opacity 0.3s ease;
}

/* ===== ANIMATIONS ===== */
.glow {
  animation: glowPulse 1.6s infinite alternate;
  box-shadow: 0 8px 18px rgba(75,0,130,0.12);
}

@keyframes glowPulse {
  0% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
  50% { box-shadow: 0 12px 30px rgba(75,0,130,0.14); transform: translateY(-2px); }
  100% { box-shadow: 0 6px 10px rgba(75,0,130,0.06); transform: translateY(0); }
}

/* ===== SECURITY OVERLAY STYLES ===== */
#fullRedOverlay {
  position: fixed;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  display: none;
  background: red;
  z-index: 9999;
  pointer-events: auto;
}

#accessDeniedBox {
  position: fixed;
  left: 50%;
  top: 40%;
  transform: translate(-50%, -50%);
  z-index: 10000;
  color: var(--white);
  text-align: center;
  display: none;
  pointer-events: auto;
}

#accessDeniedBox h1 {
  font-size: 48px;
  font-weight: 900;
  margin: 0 0 18px 0;
  color: var(--white);
  text-shadow: 0 2px 6px rgba(0,0,0,0.4);
}

#callAdminBtn {
  padding: 12px 22px;
  border-radius: 12px;
  font-weight: 800;
}

/* ===== MODAL STYLES ===== */
.confirmModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10001;
}

.confirmBox {
  background: var(--white);
  padding: 20px;
  border-radius: 12px;
  min-width: 280px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.confirmBox p {
  font-size: 18px;
  color: var(--primary-color);
  margin-bottom: 15px;
}

.confirmBox button {
  margin: 0 10px;
  padding: 8px 16px;
  font-size: 16px;
  cursor: pointer;
}

#adminPassModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 20000;
}

#adminPassBox {
  background: var(--white);
  padding: 20px;
  text-align: center;
  width: 260px;
  border-radius: 12px;
}

#adminPassBox input {
  width: 90%;
  padding: 10px;
  border: 1px solid var(--primary-color);
  border-radius: 8px;
  margin-bottom: 10px;
}

/* ===== TIMER WARNING STYLES ===== */
.blinkLine {
  animation: blinkLineAnim 1s infinite;
}

@keyframes blinkLineAnim {
  0% { background: #ffcccc; }
  50% { background: var(--white); }
  100% { background: #ffcccc; }
}

/* ===== FONT SIZE ADJUSTMENTS ===== */
#stuInfo, #stuQInfo, #timerEl {
  font-size: 20px !important;
}

/* ===== RESPONSIVE STYLES ===== */
@media (max-width: 600px) {
  #accessDeniedBox h1 {
    font-size: 28px;
  }
  
  #callAdminBtn {
    padding: 10px 14px;
  }
  
  .form-group {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .form-group label {
    text-align: left;
    width: auto;
    margin-bottom: 5px;
  }
  
  #examHeader {
    flex-direction: column;
    gap: 10px;
  }
  
  #stuInfo, #stuQInfo {
    text-align: center;
  }
  
  .navContainer {
    flex-direction: column;
    align-items: center;
  }
  
  .navBtn {
    width: 80%;
    margin-bottom: 10px;
    margin-left: 0;
    margin-right: 0;
  }
  
  #paletteContainer {
    grid-template-columns: repeat(5, 1fr) !important;
    gap: 6px;
  }
  
  #paletteContainer button {
    width: 35px;
    height: 35px;
    font-size: 12px;
  }
}

@media (min-width: 601px) and (max-width: 900px) {
  #paletteContainer {
    grid-template-columns: repeat(10, 1fr) !important;
  }
}

@media (min-width: 901px) and (max-width: 1200px) {
  #paletteContainer {
    grid-template-columns: repeat(15, 1fr) !important;
  }
}

@media (min-width: 1201px) {
  #paletteContainer {
    grid-template-columns: repeat(20, 1fr) !important;
  }
}

/* ===== ERROR MESSAGE STYLES ===== */
.error-message {
  color: #ff3333;
  font-weight: 600;
  padding: 10px;
  margin: 10px 0;
  border-radius: 6px;
  background: rgba(255, 102, 102, 0.1);
  border: 1px solid #ff6666;
  animation: blinkRed 1s infinite;
}

@keyframes blinkRed {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}

/* ===== RESULTS TABLE STYLES ===== */
.results-table {
  width: 100%;
  max-width: 900px;
  margin: 20px auto;
  border-collapse: collapse;
  font-size: 18px;
  text-align: center;
}

.results-table th {
  background: #E6E6FA;
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table td {
  padding: 15px;
  border: 1px solid var(--primary-color);
}

.results-table tr:nth-child(even) {
  background: #f9f9f9;
}

.results-table tr:hover {
  background: #f0f0ff;
}

/* ===== REVIEW MODE STYLES ===== */
.answer-status {
  margin: 10px 0;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
}

.answer-status.correct {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.answer-status.wrong {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.answer-status.not-attempted {
  background: #e2e3e5;
  color: #383d41;
  border: 1px solid #d6d8db;
}

.correct-answer {
  color: #155724;
  font-weight: bold;
}

.wrong-answer {
  color: #721c24;
  font-weight: bold;
}

/* ===== AREA STYLES ===== */
#summaryArea, #reviewArea {
  display: none;
  padding: 20px;
}

.area-header {
  text-align: center;
  margin-bottom: 30px;
}

.area-header h2 {
  color: #4B0082;
  margin-bottom: 10px;
}

/* ===== VERTICAL GAP STYLES ===== */
.options-container {
  margin-bottom: 60px;
}

.navContainer {
  margin-top: 40px;
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

/* ===== SECURITY MESSAGE STYLES ===== */
.security-message {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  color: #856404;
  padding: 15px;
  border-radius: 8px;
  margin: 20px 0;
  text-align: center;
  font-weight: bold;
}

/* ===== SUBJECT DISPLAY STYLES ===== */
.subject-display {
  background: linear-gradient(145deg, #4B0082, #6A0DAD);
  color: white;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: bold;
  margin: 10px 0;
  display: inline-block;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.current-subject {
  font-size: 18px;
  text-align: center;
  margin: 15px 0;
  padding: 10px;
  background: #f0f0ff;
  border-radius: 8px;
  border-left: 4px solid #4B0082;
}

/* ===== ACCESS DENIED OVERLAY ===== */
.access-denied-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: red;
  z-index: 99999;
  display: none;
  justify-content: center;
  align-items: center;
  color: white;
  text-align: center;
}

.access-denied-content {
  background: rgba(0,0,0,0.9);
  padding: 40px;
  border-radius: 15px;
  max-width: 500px;
}

.access-denied-content h1 {
  font-size: 48px;
  margin-bottom: 20px;
  color: white;
}

.access-denied-content p {
  font-size: 18px;
  margin-bottom: 20px;
}

.password-input {
  padding: 10px;
  font-size: 16px;
  border: none;
  border-radius: 5px;
  margin-bottom: 15px;
  width: 200px;
}
</style>
</head>

<body>

<header>LFJC ONLINE EXAMINATION - SECURE EXAM SYSTEM</header>

<div id="studentEntry">
  <div class="warning-banner" id="examWarning" style="display:none;">
    <p>‚ö†Ô∏è WARNING: Exam in progress. Do not refresh or close this window!</p>
  </div>
  
  <div class="form-group">
    <label>NAME</label>
    <input type="text" id="stuName" placeholder="Only letters & spaces" autocomplete="off" oninput="validateName(this)">
  </div>
  <div class="form-group">
    <label>SECTION</label>
    <input type="text" id="stuSection" placeholder="Letters & digits" autocomplete="off" oninput="validateSection(this)">
  </div>
  <div class="form-group">
    <label>ROLL NUMBER</label>
    <input type="text" id="stuRoll" placeholder="Digits only" autocomplete="off" oninput="validateRoll(this)">
  </div>
  <div class="form-group">
    <label>ADMISSION NUMBER</label>
    <input type="text" id="stuAdm" placeholder="Digits only" autocomplete="off" oninput="validateAdmission(this)">
  </div>
  
  <div class="form-group">
    <button id="stuStartBtn" style="display:none;">Start Exam</button>
  </div>
  <p id="studentMsg"></p>
  <div id="errorMessages"></div>
</div>

<div id="examArea" style="display:none;">
  <div id="examHeader" style="display:flex;align-items:center;width:100%;font-weight:bold;">
    <div id="stuInfo" style="flex:0 0 auto;text-align:left; white-space:nowrap;"></div>
    <div id="stuQInfo" style="flex:1;text-align:center; white-space:nowrap;"></div>
    <div style="flex:0 0 auto;text-align:right; white-space:nowrap;">
        <span id="timerEl">üïí 00:00</span>
    </div>
  </div>

  <!-- Subject Display -->
  <div id="subjectDisplay" class="current-subject"></div>

  <div id="questionContainer" style="text-align:center;margin-top:10px;"></div>

  <div class="navContainer">
    <button class="navBtn" id="prevBtn">‚¨Ö Previous</button>
    <button class="navBtn" id="markReviewBtn">Mark Review</button>
    <button class="navBtn" id="nextBtn">Next ‚û°</button>
    <button class="navBtn" id="submitBtn">Submit Exam</button>
  </div>

  <div id="paletteContainer"></div>
</div>

<!-- Summary Area -->
<div id="summaryArea">
  <div class="area-header">
    <h2>üìä Exam Summary - <span id="summaryStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="summarySection"></span> | 
      <b>Roll:</b> <span id="summaryRoll"></span> | 
      <b>Admission No:</b> <span id="summaryAdm"></span>
    </div>
  </div>
  
  <div id="summaryTableContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeSummaryBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close Exam</button>
  </div>
</div>

<!-- Review Area -->
<div id="reviewArea">
  <div class="area-header">
    <h2>üìù Detailed Solutions - <span id="reviewStudentName"></span></h2>
    <div>
      <b>Section:</b> <span id="reviewSection"></span> | 
      <b>Roll:</b> <span id="reviewRoll"></span> | 
      <b>Admission No:</b> <span id="reviewAdm"></span>
    </div>
  </div>
  
  <div id="detailedResultsContainer" style="overflow-x:auto;display:flex;justify-content:center;width:100%;margin:30px 0;"></div>
  
  <div id="reviewQuestionsContainer"></div>
  
  <div style="text-align:center; margin:30px 0;">
    <button id="closeReviewBtn" class="navBtn" style="background:linear-gradient(145deg, #dc3545, #c82333);">Close Exam</button>
  </div>
</div>

<footer>LFJC@2025 All rights reserved - Secure Exam System</footer>

<!-- Access Denied Overlay -->
<div id="accessDeniedOverlay" class="access-denied-overlay">
  <div class="access-denied-content">
    <h1>ACCESS DENIED</h1>
    <p>You cannot enter the same details within 24 hours.</p>
    <p>Enter password to override:</p>
    <input type="password" id="accessPassword" class="password-input" placeholder="Enter password">
    <br>
    <button onclick="checkAccessPassword()" class="navBtn">Submit</button>
  </div>
</div>

<!-- Enhanced Screenshot Protection -->
<div id="screenshotProtection">
  <div class="screenshot-dots"></div>
</div>
<div id="screenshotBlock"></div>

<script>
// ===== CONFIGURATION =====
const MARK_PER_CORRECT = 4;
const MARK_PER_WRONG = -1;
const EXAM_DURATION_MINUTES = 180; // 3 hours
const EXAM_DURATION_MS = EXAM_DURATION_MINUTES * 60 * 1000;
const ACCESS_PASSWORD = "lfjc2025";

// ===== GLOBAL VARIABLES =====
let images = [];
let answerKey = [];
let keyLoaded = false;
let hasSubmitted = false;
let examStartTime = null;
let examInProgress = false;
let assignedForm = 'A';
let progress = null;
let timerInterval = null;

let examData = {
    files: [],
    subjectNames: [],
    keys: [],
    originalOrder: [],
    subjectBoundaries: { maths: 30, physics: 50, chemistry: 60 }
};

// ===== INPUT VALIDATION FUNCTIONS =====
function validateName(input) {
    const value = input.value.toUpperCase();
    input.value = value;
    
    // Allow only letters, spaces, and dots
    const isValid = /^[A-Z\s\.]*$/.test(value) && value.length >= 2;
    
    if (!isValid && value !== '') {
        input.classList.add('error');
    } else {
        input.classList.remove('error');
    }
    
    validateStudentInputs();
}

function validateSection(input) {
    const value = input.value.toUpperCase();
    input.value = value;
    
    // Allow only letters and digits
    const isValid = /^[A-Z0-9]*$/.test(value) && value.length >= 1;
    
    if (!isValid && value !== '') {
        input.classList.add('error');
    } else {
        input.classList.remove('error');
    }
    
    validateStudentInputs();
}

function validateRoll(input) {
    const value = input.value;
    
    // Allow only digits
    const isValid = /^\d*$/.test(value) && value.length >= 1;
    
    if (!isValid && value !== '') {
        input.classList.add('error');
    } else {
        input.classList.remove('error');
    }
    
    validateStudentInputs();
}

function validateAdmission(input) {
    const value = input.value;
    
    // Allow only digits
    const isValid = /^\d*$/.test(value) && value.length >= 1;
    
    if (!isValid && value !== '') {
        input.classList.add('error');
    } else {
        input.classList.remove('error');
    }
    
    validateStudentInputs();
}

function validateStudentInputs() {
    const name = document.getElementById('stuName').value.trim();
    const section = document.getElementById('stuSection').value.trim();
    const roll = document.getElementById('stuRoll').value.trim();
    const adm = document.getElementById('stuAdm').value.trim();
    
    const nameValid = /^[A-Z\s\.]+$/.test(name) && name.length >= 2;
    const sectionValid = /^[A-Z0-9]+$/.test(section) && section.length >= 1;
    const rollValid = /^\d+$/.test(roll) && roll.length >= 1;
    const admValid = /^\d+$/.test(adm) && adm.length >= 1;
    const keyValid = keyLoaded;
    
    const allValid = nameValid && sectionValid && rollValid && admValid && keyValid;
    
    document.getElementById('stuStartBtn').style.display = allValid ? 'block' : 'none';
    
    if (!keyLoaded) {
        showError("Answer key not loaded - exam disabled. Contact administrator.");
    }
    
    return allValid;
}

// ===== SECURITY FUNCTIONS =====
function setupScreenshotProtection() {
    // Prevent right-click
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });
    
    // Prevent keyboard shortcuts for screenshots
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey && e.key === 'PrintScreen') || 
            e.key === 'PrintScreen' || 
            (e.ctrlKey && e.shiftKey && e.key === 'S') || 
            (e.metaKey && e.shiftKey && e.key === '4')) {
            e.preventDefault();
            return false;
        }
    });
    
    // Prevent drag and drop
    document.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
    });
    
    document.addEventListener('drop', function(e) {
        e.preventDefault();
        return false;
    });
}

function checkDuplicateEntry(studentData) {
    const studentId = generateStudentId(studentData);
    const lastEntry = localStorage.getItem(`last_entry_${studentId}`);
    
    if (lastEntry) {
        const timeDiff = Date.now() - parseInt(lastEntry);
        const hoursDiff = timeDiff / (1000 * 60 * 60);
        
        if (hoursDiff < 24) {
            showAccessDenied();
            return true;
        }
    }
    
    // Store current entry time
    localStorage.setItem(`last_entry_${studentId}`, Date.now().toString());
    return false;
}

function showAccessDenied() {
    document.getElementById('accessDeniedOverlay').style.display = 'flex';
}

function checkAccessPassword() {
    const password = document.getElementById('accessPassword').value;
    if (password === ACCESS_PASSWORD) {
        document.getElementById('accessDeniedOverlay').style.display = 'none';
        startExamWithCurrentData();
    } else {
        alert('Incorrect password! Access denied.');
    }
}

function generateStudentId(studentData) {
    return `${studentData.name}_${studentData.sec}_${studentData.roll}_${studentData.adm}`
        .toLowerCase()
        .replace(/\s+/g, '_')
        .replace(/[^a-z0-9_]/g, '');
}

// ===== ANSWER KEY LOADING =====
function loadAnswerKey() {
    // Simulate answer key loading - replace with actual fetch
    console.log("Loading answer key...");
    
    // Create sample answer key for 60 questions
    answerKey = [];
    for (let i = 0; i < 60; i++) {
        const answers = ['A', 'B', 'C', 'D'];
        answerKey.push(answers[Math.floor(Math.random() * answers.length)]);
    }
    
    // Create image paths
    images = [];
    for (let i = 1; i <= 60; i++) {
        images.push(`questions/${i}.png`);
    }
    
    keyLoaded = true;
    console.log('‚úÖ Answer key loaded successfully');
    validateStudentInputs();
}

// ===== QUESTION SHUFFLING FUNCTIONS =====
function shuffleQuestions() {
    const totalQuestions = 60;
    const mathsQuestions = 30;
    const physicsQuestions = 20;
    const chemistryQuestions = 10;
    
    // Create arrays for each subject
    const mathsIndices = Array.from({length: mathsQuestions}, (_, i) => i);
    const physicsIndices = Array.from({length: physicsQuestions}, (_, i) => i + mathsQuestions);
    const chemistryIndices = Array.from({length: chemistryQuestions}, (_, i) => i + mathsQuestions + physicsQuestions);
    
    // Shuffle within each subject
    shuffleArray(mathsIndices);
    shuffleArray(physicsIndices);
    shuffleArray(chemistryIndices);
    
    // Create subject permutations
    const subjectOrders = [
        ['Maths', 'Physics', 'Chemistry'],
        ['Physics', 'Chemistry', 'Maths'],
        ['Chemistry', 'Maths', 'Physics'],
        ['Maths', 'Chemistry', 'Physics'],
        ['Physics', 'Maths', 'Chemistry'],
        ['Chemistry', 'Physics', 'Maths']
    ];
    
    const selectedOrder = subjectOrders[Math.floor(Math.random() * subjectOrders.length)];
    
    // Combine based on selected order
    let shuffledIndices = [];
    let shuffledKeys = [];
    let shuffledFiles = [];
    let subjectNames = [];
    
    selectedOrder.forEach(subject => {
        if (subject === 'Maths') {
            shuffledIndices = shuffledIndices.concat(mathsIndices);
            subjectNames = subjectNames.concat(Array(mathsQuestions).fill('Maths'));
        } else if (subject === 'Physics') {
            shuffledIndices = shuffledIndices.concat(physicsIndices);
            subjectNames = subjectNames.concat(Array(physicsQuestions).fill('Physics'));
        } else if (subject === 'Chemistry') {
            shuffledIndices = shuffledIndices.concat(chemistryIndices);
            subjectNames = subjectNames.concat(Array(chemistryQuestions).fill('Chemistry'));
        }
    });
    
    // Update exam data with shuffled order
    shuffledIndices.forEach(originalIndex => {
        shuffledKeys.push(answerKey[originalIndex]);
        shuffledFiles.push(images[originalIndex]);
    });
    
    examData.files = shuffledFiles;
    examData.keys = shuffledKeys;
    examData.subjectNames = subjectNames;
    examData.originalOrder = shuffledIndices;
    
    console.log('‚úÖ Questions shuffled with order:', selectedOrder);
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// ===== EXAM FUNCTIONS =====
function startExamWithCurrentData() {
    const studentData = {
        name: document.getElementById('stuName').value.trim(),
        sec: document.getElementById('stuSection').value.trim(),
        roll: document.getElementById('stuRoll').value.trim(),
        adm: document.getElementById('stuAdm').value.trim()
    };
    
    startExam(studentData);
}

document.getElementById('stuStartBtn').addEventListener('click', function() {
    if (!validateStudentInputs()) return;
    
    const studentData = {
        name: document.getElementById('stuName').value.trim(),
        sec: document.getElementById('stuSection').value.trim(),
        roll: document.getElementById('stuRoll').value.trim(),
        adm: document.getElementById('stuAdm').value.trim()
    };
    
    if (checkDuplicateEntry(studentData)) {
        return;
    }
    
    startExam(studentData);
});

function startExam(studentData) {
    examInProgress = true;
    examStartTime = Date.now();
    
    // Shuffle questions for this student
    shuffleQuestions();
    
    // Initialize progress
    progress = {
        student: studentData,
        answers: new Array(examData.files.length).fill(null),
        currentQ: 0,
        timeLeftSec: EXAM_DURATION_MS / 1000,
        markedReview: new Set()
    };
    
    // Show exam area
    document.getElementById('studentEntry').style.display = 'none';
    document.getElementById('examArea').style.display = 'block';
    document.getElementById('examWarning').style.display = 'block';
    
    // Update student info
    document.getElementById('stuInfo').textContent = 
        `${studentData.name} | ${studentData.sec} | Roll: ${studentData.roll}`;
    
    // Start timer
    startTimer();
    
    // Initialize question palette
    initPalette();
    
    // Load first question
    showQuestion(0);
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    
    timerInterval = setInterval(() => {
        if (!progress) return;
        
        progress.timeLeftSec--;
        
        // Update timer display
        const minutes = Math.floor(progress.timeLeftSec / 60);
        const seconds = Math.floor(progress.timeLeftSec % 60);
        const timerEl = document.getElementById('timerEl');
        timerEl.textContent = `üïí ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Blink when 5 minutes left
        if (progress.timeLeftSec <= 300) {
            timerEl.classList.add('blink');
        }
        
        // Auto-submit when time's up
        if (progress.timeLeftSec <= 0) {
            clearInterval(timerInterval);
            autoSubmitExam();
        }
    }, 1000);
}

function autoSubmitExam() {
    if (hasSubmitted) return;
    console.log('‚è∞ Time up! Auto-submitting exam...');
    calculateAndShowResults();
}

// ===== QUESTION DISPLAY FUNCTIONS =====
function getCurrentSubject(qIndex) {
    return examData.subjectNames[qIndex];
}

function showQuestion(qIndex) {
    if (!progress || qIndex < 0 || qIndex >= examData.files.length) return;
    
    progress.currentQ = qIndex;
    
    const container = document.getElementById('questionContainer');
    container.innerHTML = '';
    
    // Question number info with subject
    const currentSubject = getCurrentSubject(qIndex);
    const qInfo = document.getElementById('stuQInfo');
    qInfo.textContent = `${currentSubject} Question ${qIndex + 1}/${examData.files.length}`;
    
    // Update subject display
    document.getElementById('subjectDisplay').textContent = `üìö Current Subject: ${currentSubject}`;
    
    // Create question image
    const img = new Image();
    img.src = examData.files[qIndex];
    img.className = 'questionImg';
    img.alt = `Question ${qIndex + 1}`;
    
    img.onerror = function() {
        container.innerHTML = `
            <div style="background: #ffebee; border: 2px solid #ffcdd2; color: #c62828; 
                       padding: 20px; border-radius: 8px; margin: 20px 0; text-align: center;">
                <h3>‚ùå Image Load Error</h3>
                <p>Failed to load question ${qIndex + 1}. Please contact administrator.</p>
            </div>
        `;
    };
    
    container.appendChild(img);
    
    // Create options (without "Select your answer" and "Clear Response")
    const optionsContainer = document.createElement('div');
    optionsContainer.className = 'options-container';
    optionsContainer.innerHTML = `
        <button class="optBtn" data-opt="A">A</button>
        <button class="optBtn" data-opt="B">B</button>
        <button class="optBtn" data-opt="C">C</button>
        <button class="optBtn" data-opt="D">D</button>
    `;
    
    container.appendChild(optionsContainer);
    
    // Set current selected option
    const currentAnswer = progress.answers[qIndex];
    if (currentAnswer !== null) {
        const selectedBtn = optionsContainer.querySelector(`[data-opt="${currentAnswer}"]`);
        if (selectedBtn) selectedBtn.classList.add('selected');
    }
    
    // Add event listeners to options
    const optBtns = optionsContainer.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.addEventListener('click', () => selectOption(qIndex, btn.dataset.opt));
    });
    
    // Update palette
    updatePalette();
    
    // Update navigation buttons
    updateNavigationButtons();
}

function selectOption(qIndex, option) {
    if (!progress || hasSubmitted) return;
    
    progress.answers[qIndex] = option;
    
    // Update button states
    const optBtns = document.querySelectorAll('.optBtn');
    optBtns.forEach(btn => {
        btn.classList.remove('selected');
        if (btn.dataset.opt === option) {
            btn.classList.add('selected');
        }
    });
    
    // Update palette
    updatePalette();
}

// ===== PALETTE FUNCTIONS =====
function initPalette() {
    const palette = document.getElementById('paletteContainer');
    palette.innerHTML = '';
    
    // Determine grid columns based on screen size
    let columns = 20;
    if (window.innerWidth <= 600) columns = 5;
    else if (window.innerWidth <= 900) columns = 10;
    else if (window.innerWidth <= 1200) columns = 15;
    
    palette.style.gridTemplateColumns = `repeat(${columns}, 1fr)`;
    
    for (let i = 0; i < examData.files.length; i++) {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.dataset.qIndex = i;
        
        btn.addEventListener('click', () => {
            if (!hasSubmitted) {
                showQuestion(i);
            }
        });
        
        palette.appendChild(btn);
    }
    
    updatePalette();
}

function updatePalette() {
    if (!progress) return;
    
    const paletteBtns = document.querySelectorAll('#paletteContainer button');
    paletteBtns.forEach(btn => {
        const qIndex = parseInt(btn.dataset.qIndex);
        
        // Remove all state classes
        btn.classList.remove('answered', 'marked-review', 'current');
        
        // Current question
        if (qIndex === progress.currentQ) {
            btn.classList.add('current');
        }
        
        // Answered questions (green)
        if (progress.answers[qIndex] !== null) {
            btn.classList.add('answered');
        }
        
        // Marked for review (yellow)
        if (progress.markedReview.has(qIndex)) {
            btn.classList.add('marked-review');
        }
    });
}

// ===== NAVIGATION FUNCTIONS =====
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const markReviewBtn = document.getElementById('markReviewBtn');
    
    // Previous button
    prevBtn.disabled = progress.currentQ === 0;
    
    // Next button
    nextBtn.disabled = progress.currentQ === examData.files.length - 1;
    
    // Mark review button
    if (progress.markedReview.has(progress.currentQ)) {
        markReviewBtn.textContent = 'Unmark Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
    } else {
        markReviewBtn.textContent = 'Mark Review';
        markReviewBtn.style.background = 'linear-gradient(145deg, #ffb84d, var(--warning))';
    }
}

// Navigation event listeners
document.getElementById('prevBtn').addEventListener('click', () => {
    if (progress.currentQ > 0) {
        showQuestion(progress.currentQ - 1);
    }
});

document.getElementById('nextBtn').addEventListener('click', () => {
    if (progress.currentQ < examData.files.length - 1) {
        showQuestion(progress.currentQ + 1);
    }
});

document.getElementById('markReviewBtn').addEventListener('click', () => {
    if (!progress) return;
    
    const currentQ = progress.currentQ;
    if (progress.markedReview.has(currentQ)) {
        progress.markedReview.delete(currentQ);
    } else {
        progress.markedReview.add(currentQ);
    }
    
    updatePalette();
    updateNavigationButtons();
});

// ===== EXAM SUBMISSION =====
document.getElementById('submitBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to submit the exam?')) {
        calculateAndShowResults();
    }
});

function calculateAndShowResults() {
    if (hasSubmitted) return;
    
    hasSubmitted = true;
    examInProgress = false;
    
    console.log('üìä Calculating results...');
    
    // Clear timers
    clearInterval(timerInterval);
    
    // Calculate subject-wise marks
    const subjData = calculateSubjectMarks();
    
    // Show summary
    showSummary(subjData);
}

function calculateSubjectMarks() {
    const subjData = {};
    
    for (let i = 0; i < examData.files.length; i++) {
        const subjectName = examData.subjectNames[i];
        
        if (!subjData[subjectName]) {
            subjData[subjectName] = {
                correct: 0,
                wrong: 0,
                blank: 0,
                total: 0,
                marks: 0
            };
        }
        
        const answer = progress.answers[i];
        const correctAnswer = examData.keys[i];
        
        if (answer === null) {
            subjData[subjectName].blank++;
        } else if (answer === correctAnswer) {
            subjData[subjectName].correct++;
            subjData[subjectName].marks += MARK_PER_CORRECT;
        } else {
            subjData[subjectName].wrong++;
            subjData[subjectName].marks += MARK_PER_WRONG;
        }
        
        subjData[subjectName].total++;
    }
    
    return subjData;
}

function showSummary(subjData) {
    document.getElementById('examArea').style.display = 'none';
    document.getElementById('summaryArea').style.display = 'block';
    
    // Update student info in summary
    const student = progress.student;
    document.getElementById('summaryStudentName').textContent = student.name;
    document.getElementById('summarySection').textContent = student.sec;
    document.getElementById('summaryRoll').textContent = student.roll;
    document.getElementById('summaryAdm').textContent = student.adm;
    
    // Create summary table
    const tableContainer = document.getElementById('summaryTableContainer');
    tableContainer.innerHTML = createSummaryTable(subjData);
}

function createSummaryTable(subjData) {
    let tableHTML = `
        <table class="results-table">
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>Correct</th>
                    <th>Wrong</th>
                    <th>Blank</th>
                    <th>Total</th>
                    <th>Marks</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    let totalCorrect = 0, totalWrong = 0, totalBlank = 0, totalMarks = 0;
    
    for (const [subject, data] of Object.entries(subjData)) {
        tableHTML += `
            <tr>
                <td>${subject}</td>
                <td>${data.correct}</td>
                <td>${data.wrong}</td>
                <td>${data.blank}</td>
                <td>${data.total}</td>
                <td>${data.marks.toFixed(2)}</td>
            </tr>
        `;
        
        totalCorrect += data.correct;
        totalWrong += data.wrong;
        totalBlank += data.blank;
        totalMarks += data.marks;
    }
    
    tableHTML += `
            <tr style="background: #E6E6FA; font-weight: bold;">
                <td>Total</td>
                <td>${totalCorrect}</td>
                <td>${totalWrong}</td>
                <td>${totalBlank}</td>
                <td>${totalCorrect + totalWrong + totalBlank}</td>
                <td>${totalMarks.toFixed(2)}</td>
            </tr>
        </tbody>
        </table>
    `;
    
    return tableHTML;
}

// ===== CLOSE BUTTONS =====
document.getElementById('closeSummaryBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to close the exam?')) {
        window.close();
    }
});

document.getElementById('closeReviewBtn').addEventListener('click', () => {
    if (confirm('Are you sure you want to close the exam?')) {
        window.close();
    }
});

// ===== ERROR HANDLING =====
function showError(message) {
    const errorDiv = document.getElementById('errorMessages');
    errorDiv.innerHTML = `<div class="error-message">‚ùå ${message}</div>`;
}

function clearErrors() {
    document.getElementById('errorMessages').innerHTML = '';
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    setupScreenshotProtection();
    loadAnswerKey();
    
    // Initialize event listeners
    initializeEventListeners();
});

function initializeEventListeners() {
    // Student input validation
    const inputs = ['stuName', 'stuSection', 'stuRoll', 'stuAdm'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', validateStudentInputs);
    });
}

// Prevent leaving the page during exam
window.addEventListener('beforeunload', function(e) {
    if (examInProgress && !hasSubmitted) {
        e.preventDefault();
        e.returnValue = 'Your exam is in progress. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// Prevent F12, Ctrl+Shift+I, etc.
document.addEventListener('keydown', function(e) {
    if (examInProgress && (
        e.key === 'F12' ||
        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
        (e.ctrlKey && e.key === 'U')
    )) {
        e.preventDefault();
        return false;
    }
});

console.log('‚úÖ LFJC Secure Examination System initialized successfully');
</script>
</body>
</html>
